!function(){"use strict";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var n,r={exports:{}};
/*!
 * jQuery JavaScript Library v3.7.1
 * https://jquery.com/
 *
 * Copyright OpenJS Foundation and other contributors
 * Released under the MIT license
 * https://jquery.org/license
 *
 * Date: 2023-08-28T13:37Z
 */n=r,function(e,t){n.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}}("undefined"!=typeof window?window:e,function(e,t){var n=[],r=Object.getPrototypeOf,a=n.slice,o=n.flat?function(e){return n.flat.call(e)}:function(e){return n.concat.apply([],e)},i=n.push,s=n.indexOf,c={},l=c.toString,u=c.hasOwnProperty,d=u.toString,p=d.call(Object),h={},f=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType&&"function"!=typeof e.item},g=function(e){return null!=e&&e===e.window},m=e.document,y={type:!0,src:!0,nonce:!0,noModule:!0};function b(e,t,n){var r,a,o=(n=n||m).createElement("script");if(o.text=e,t)for(r in y)(a=t[r]||t.getAttribute&&t.getAttribute(r))&&o.setAttribute(r,a);n.head.appendChild(o).parentNode.removeChild(o)}function v(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?c[l.call(e)]||"object":typeof e}var w="3.7.1",$=/HTML$/i,k=function(e,t){return new k.fn.init(e,t)};function x(e){var t=!!e&&"length"in e&&e.length,n=v(e);return!f(e)&&!g(e)&&("array"===n||0===t||"number"==typeof t&&t>0&&t-1 in e)}function S(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}k.fn=k.prototype={jquery:w,constructor:k,length:0,toArray:function(){return a.call(this)},get:function(e){return null==e?a.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=k.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return k.each(this,e)},map:function(e){return this.pushStack(k.map(this,function(t,n){return e.call(t,n,t)}))},slice:function(){return this.pushStack(a.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(k.grep(this,function(e,t){return(t+1)%2}))},odd:function(){return this.pushStack(k.grep(this,function(e,t){return t%2}))},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(n>=0&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:i,sort:n.sort,splice:n.splice},k.extend=k.fn.extend=function(){var e,t,n,r,a,o,i=arguments[0]||{},s=1,c=arguments.length,l=!1;for("boolean"==typeof i&&(l=i,i=arguments[s]||{},s++),"object"==typeof i||f(i)||(i={}),s===c&&(i=this,s--);s<c;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&i!==r&&(l&&r&&(k.isPlainObject(r)||(a=Array.isArray(r)))?(n=i[t],o=a&&!Array.isArray(n)?[]:a||k.isPlainObject(n)?n:{},a=!1,i[t]=k.extend(l,o,r)):void 0!==r&&(i[t]=r));return i},k.extend({expando:"jQuery"+(w+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==l.call(e)||(t=r(e))&&("function"!=typeof(n=u.call(t,"constructor")&&t.constructor)||d.call(n)!==p))},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t,n){b(e,{nonce:t&&t.nonce},n)},each:function(e,t){var n,r=0;if(x(e))for(n=e.length;r<n&&!1!==t.call(e[r],r,e[r]);r++);else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},text:function(e){var t,n="",r=0,a=e.nodeType;if(!a)for(;t=e[r++];)n+=k.text(t);return 1===a||11===a?e.textContent:9===a?e.documentElement.textContent:3===a||4===a?e.nodeValue:n},makeArray:function(e,t){var n=t||[];return null!=e&&(x(Object(e))?k.merge(n,"string"==typeof e?[e]:e):i.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:s.call(t,e,n)},isXMLDoc:function(e){var t=e&&e.namespaceURI,n=e&&(e.ownerDocument||e).documentElement;return!$.test(t||n&&n.nodeName||"HTML")},merge:function(e,t){for(var n=+t.length,r=0,a=e.length;r<n;r++)e[a++]=t[r];return e.length=a,e},grep:function(e,t,n){for(var r=[],a=0,o=e.length,i=!n;a<o;a++)!t(e[a],a)!==i&&r.push(e[a]);return r},map:function(e,t,n){var r,a,i=0,s=[];if(x(e))for(r=e.length;i<r;i++)null!=(a=t(e[i],i,n))&&s.push(a);else for(i in e)null!=(a=t(e[i],i,n))&&s.push(a);return o(s)},guid:1,support:h}),"function"==typeof Symbol&&(k.fn[Symbol.iterator]=n[Symbol.iterator]),k.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){c["[object "+t+"]"]=t.toLowerCase()});var T=n.pop,C=n.sort,N=n.splice,j="[\\x20\\t\\r\\n\\f]",A=new RegExp("^"+j+"+|((?:^|[^\\\\])(?:\\\\.)*)"+j+"+$","g");k.contains=function(e,t){var n=t&&t.parentNode;return e===n||!(!n||1!==n.nodeType||!(e.contains?e.contains(n):e.compareDocumentPosition&&16&e.compareDocumentPosition(n)))};var E=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\x80-\uFFFF\w-]/g;function O(e,t){return t?"\0"===e?"ï¿½":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e}k.escapeSelector=function(e){return(e+"").replace(E,O)};var D=m,I=i;!function(){var t,r,o,i,c,l,d,p,f,g,m=I,y=k.expando,b=0,v=0,w=ee(),$=ee(),x=ee(),E=ee(),O=function(e,t){return e===t&&(c=!0),0},M="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",L="(?:\\\\[\\da-fA-F]{1,6}"+j+"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",R="\\["+j+"*("+L+")(?:"+j+"*([*^$|!~]?=)"+j+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+L+"))|)"+j+"*\\]",P=":("+L+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+R+")*)|.*)\\)|)",V=new RegExp(j+"+","g"),F=new RegExp("^"+j+"*,"+j+"*"),H=new RegExp("^"+j+"*([>+~]|"+j+")"+j+"*"),q=new RegExp(j+"|>"),z=new RegExp(P),W=new RegExp("^"+L+"$"),B={ID:new RegExp("^#("+L+")"),CLASS:new RegExp("^\\.("+L+")"),TAG:new RegExp("^("+L+"|[*])"),ATTR:new RegExp("^"+R),PSEUDO:new RegExp("^"+P),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+j+"*(even|odd|(([+-]|)(\\d*)n|)"+j+"*(?:([+-]|)"+j+"*(\\d+)|))"+j+"*\\)|)","i"),bool:new RegExp("^(?:"+M+")$","i"),needsContext:new RegExp("^"+j+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+j+"*((?:-\\d)?\\d*)"+j+"*\\)|)(?=[^-]|$)","i")},U=/^(?:input|select|textarea|button)$/i,_=/^h\d$/i,G=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,X=/[+~]/,Y=new RegExp("\\\\[\\da-fA-F]{1,6}"+j+"?|\\\\([^\\r\\n\\f])","g"),J=function(e,t){var n="0x"+e.slice(1)-65536;return t||(n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320))},K=function(){ce()},Q=pe(function(e){return!0===e.disabled&&S(e,"fieldset")},{dir:"parentNode",next:"legend"});try{m.apply(n=a.call(D.childNodes),D.childNodes),n[D.childNodes.length].nodeType}catch(e){m={apply:function(e,t){I.apply(e,a.call(t))},call:function(e){I.apply(e,a.call(arguments,1))}}}function Z(e,t,n,r){var a,o,i,s,c,u,d,g=t&&t.ownerDocument,b=t?t.nodeType:9;if(n=n||[],"string"!=typeof e||!e||1!==b&&9!==b&&11!==b)return n;if(!r&&(ce(t),t=t||l,p)){if(11!==b&&(c=G.exec(e)))if(a=c[1]){if(9===b){if(!(i=t.getElementById(a)))return n;if(i.id===a)return m.call(n,i),n}else if(g&&(i=g.getElementById(a))&&Z.contains(t,i)&&i.id===a)return m.call(n,i),n}else{if(c[2])return m.apply(n,t.getElementsByTagName(e)),n;if((a=c[3])&&t.getElementsByClassName)return m.apply(n,t.getElementsByClassName(a)),n}if(!(E[e+" "]||f&&f.test(e))){if(d=e,g=t,1===b&&(q.test(e)||H.test(e))){for((g=X.test(e)&&se(t.parentNode)||t)==t&&h.scope||((s=t.getAttribute("id"))?s=k.escapeSelector(s):t.setAttribute("id",s=y)),o=(u=ue(e)).length;o--;)u[o]=(s?"#"+s:":scope")+" "+de(u[o]);d=u.join(",")}try{return m.apply(n,g.querySelectorAll(d)),n}catch(t){E(e,!0)}finally{s===y&&t.removeAttribute("id")}}}return be(e.replace(A,"$1"),t,n,r)}function ee(){var e=[];return function t(n,a){return e.push(n+" ")>r.cacheLength&&delete t[e.shift()],t[n+" "]=a}}function te(e){return e[y]=!0,e}function ne(e){var t=l.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function re(e){return function(t){return S(t,"input")&&t.type===e}}function ae(e){return function(t){return(S(t,"input")||S(t,"button"))&&t.type===e}}function oe(e){return function(t){return"form"in t?t.parentNode&&!1===t.disabled?"label"in t?"label"in t.parentNode?t.parentNode.disabled===e:t.disabled===e:t.isDisabled===e||t.isDisabled!==!e&&Q(t)===e:t.disabled===e:"label"in t&&t.disabled===e}}function ie(e){return te(function(t){return t=+t,te(function(n,r){for(var a,o=e([],n.length,t),i=o.length;i--;)n[a=o[i]]&&(n[a]=!(r[a]=n[a]))})})}function se(e){return e&&void 0!==e.getElementsByTagName&&e}function ce(e){var t,n=e?e.ownerDocument||e:D;return n!=l&&9===n.nodeType&&n.documentElement?(d=(l=n).documentElement,p=!k.isXMLDoc(l),g=d.matches||d.webkitMatchesSelector||d.msMatchesSelector,d.msMatchesSelector&&D!=l&&(t=l.defaultView)&&t.top!==t&&t.addEventListener("unload",K),h.getById=ne(function(e){return d.appendChild(e).id=k.expando,!l.getElementsByName||!l.getElementsByName(k.expando).length}),h.disconnectedMatch=ne(function(e){return g.call(e,"*")}),h.scope=ne(function(){return l.querySelectorAll(":scope")}),h.cssHas=ne(function(){try{return l.querySelector(":has(*,:jqfake)"),!1}catch(e){return!0}}),h.getById?(r.filter.ID=function(e){var t=e.replace(Y,J);return function(e){return e.getAttribute("id")===t}},r.find.ID=function(e,t){if(void 0!==t.getElementById&&p){var n=t.getElementById(e);return n?[n]:[]}}):(r.filter.ID=function(e){var t=e.replace(Y,J);return function(e){var n=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return n&&n.value===t}},r.find.ID=function(e,t){if(void 0!==t.getElementById&&p){var n,r,a,o=t.getElementById(e);if(o){if((n=o.getAttributeNode("id"))&&n.value===e)return[o];for(a=t.getElementsByName(e),r=0;o=a[r++];)if((n=o.getAttributeNode("id"))&&n.value===e)return[o]}return[]}}),r.find.TAG=function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):t.querySelectorAll(e)},r.find.CLASS=function(e,t){if(void 0!==t.getElementsByClassName&&p)return t.getElementsByClassName(e)},f=[],ne(function(e){var t;d.appendChild(e).innerHTML="<a id='"+y+"' href='' disabled='disabled'></a><select id='"+y+"-\r\\' disabled='disabled'><option selected=''></option></select>",e.querySelectorAll("[selected]").length||f.push("\\["+j+"*(?:value|"+M+")"),e.querySelectorAll("[id~="+y+"-]").length||f.push("~="),e.querySelectorAll("a#"+y+"+*").length||f.push(".#.+[+~]"),e.querySelectorAll(":checked").length||f.push(":checked"),(t=l.createElement("input")).setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),d.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&f.push(":enabled",":disabled"),(t=l.createElement("input")).setAttribute("name",""),e.appendChild(t),e.querySelectorAll("[name='']").length||f.push("\\["+j+"*name"+j+"*="+j+"*(?:''|\"\")")}),h.cssHas||f.push(":has"),f=f.length&&new RegExp(f.join("|")),O=function(e,t){if(e===t)return c=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)==(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!h.sortDetached&&t.compareDocumentPosition(e)===n?e===l||e.ownerDocument==D&&Z.contains(D,e)?-1:t===l||t.ownerDocument==D&&Z.contains(D,t)?1:i?s.call(i,e)-s.call(i,t):0:4&n?-1:1)},l):l}for(t in Z.matches=function(e,t){return Z(e,null,null,t)},Z.matchesSelector=function(e,t){if(ce(e),p&&!E[t+" "]&&(!f||!f.test(t)))try{var n=g.call(e,t);if(n||h.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){E(t,!0)}return Z(t,l,null,[e]).length>0},Z.contains=function(e,t){return(e.ownerDocument||e)!=l&&ce(e),k.contains(e,t)},Z.attr=function(e,t){(e.ownerDocument||e)!=l&&ce(e);var n=r.attrHandle[t.toLowerCase()],a=n&&u.call(r.attrHandle,t.toLowerCase())?n(e,t,!p):void 0;return void 0!==a?a:e.getAttribute(t)},Z.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},k.uniqueSort=function(e){var t,n=[],r=0,o=0;if(c=!h.sortStable,i=!h.sortStable&&a.call(e,0),C.call(e,O),c){for(;t=e[o++];)t===e[o]&&(r=n.push(o));for(;r--;)N.call(e,n[r],1)}return i=null,e},k.fn.uniqueSort=function(){return this.pushStack(k.uniqueSort(a.apply(this)))},r=k.expr={cacheLength:50,createPseudo:te,match:B,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(Y,J),e[3]=(e[3]||e[4]||e[5]||"").replace(Y,J),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||Z.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&Z.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return B.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&z.test(n)&&(t=ue(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(Y,J).toLowerCase();return"*"===e?function(){return!0}:function(e){return S(e,t)}},CLASS:function(e){var t=w[e+" "];return t||(t=new RegExp("(^|"+j+")"+e+"("+j+"|$)"))&&w(e,function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(e,t,n){return function(r){var a=Z.attr(r,e);return null==a?"!="===t:!t||(a+="","="===t?a===n:"!="===t?a!==n:"^="===t?n&&0===a.indexOf(n):"*="===t?n&&a.indexOf(n)>-1:"$="===t?n&&a.slice(-n.length)===n:"~="===t?(" "+a.replace(V," ")+" ").indexOf(n)>-1:"|="===t&&(a===n||a.slice(0,n.length+1)===n+"-"))}},CHILD:function(e,t,n,r,a){var o="nth"!==e.slice(0,3),i="last"!==e.slice(-4),s="of-type"===t;return 1===r&&0===a?function(e){return!!e.parentNode}:function(t,n,c){var l,u,d,p,h,f=o!==i?"nextSibling":"previousSibling",g=t.parentNode,m=s&&t.nodeName.toLowerCase(),v=!c&&!s,w=!1;if(g){if(o){for(;f;){for(d=t;d=d[f];)if(s?S(d,m):1===d.nodeType)return!1;h=f="only"===e&&!h&&"nextSibling"}return!0}if(h=[i?g.firstChild:g.lastChild],i&&v){for(w=(p=(l=(u=g[y]||(g[y]={}))[e]||[])[0]===b&&l[1])&&l[2],d=p&&g.childNodes[p];d=++p&&d&&d[f]||(w=p=0)||h.pop();)if(1===d.nodeType&&++w&&d===t){u[e]=[b,p,w];break}}else if(v&&(w=p=(l=(u=t[y]||(t[y]={}))[e]||[])[0]===b&&l[1]),!1===w)for(;(d=++p&&d&&d[f]||(w=p=0)||h.pop())&&(!(s?S(d,m):1===d.nodeType)||!++w||(v&&((u=d[y]||(d[y]={}))[e]=[b,w]),d!==t)););return(w-=a)===r||w%r===0&&w/r>=0}}},PSEUDO:function(e,t){var n,a=r.pseudos[e]||r.setFilters[e.toLowerCase()]||Z.error("unsupported pseudo: "+e);return a[y]?a(t):a.length>1?(n=[e,e,"",t],r.setFilters.hasOwnProperty(e.toLowerCase())?te(function(e,n){for(var r,o=a(e,t),i=o.length;i--;)e[r=s.call(e,o[i])]=!(n[r]=o[i])}):function(e){return a(e,0,n)}):a}},pseudos:{not:te(function(e){var t=[],n=[],r=ye(e.replace(A,"$1"));return r[y]?te(function(e,t,n,a){for(var o,i=r(e,null,a,[]),s=e.length;s--;)(o=i[s])&&(e[s]=!(t[s]=o))}):function(e,a,o){return t[0]=e,r(t,null,o,n),t[0]=null,!n.pop()}}),has:te(function(e){return function(t){return Z(e,t).length>0}}),contains:te(function(e){return e=e.replace(Y,J),function(t){return(t.textContent||k.text(t)).indexOf(e)>-1}}),lang:te(function(e){return W.test(e||"")||Z.error("unsupported lang: "+e),e=e.replace(Y,J).toLowerCase(),function(t){var n;do{if(n=p?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return(n=n.toLowerCase())===e||0===n.indexOf(e+"-")}while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===d},focus:function(e){return e===function(){try{return l.activeElement}catch(e){}}()&&l.hasFocus()&&!!(e.type||e.href||~e.tabIndex)},enabled:oe(!1),disabled:oe(!0),checked:function(e){return S(e,"input")&&!!e.checked||S(e,"option")&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!r.pseudos.empty(e)},header:function(e){return _.test(e.nodeName)},input:function(e){return U.test(e.nodeName)},button:function(e){return S(e,"input")&&"button"===e.type||S(e,"button")},text:function(e){var t;return S(e,"input")&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:ie(function(){return[0]}),last:ie(function(e,t){return[t-1]}),eq:ie(function(e,t,n){return[n<0?n+t:n]}),even:ie(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:ie(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:ie(function(e,t,n){var r;for(r=n<0?n+t:n>t?t:n;--r>=0;)e.push(r);return e}),gt:ie(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}},r.pseudos.nth=r.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})r.pseudos[t]=re(t);for(t in{submit:!0,reset:!0})r.pseudos[t]=ae(t);function le(){}function ue(e,t){var n,a,o,i,s,c,l,u=$[e+" "];if(u)return t?0:u.slice(0);for(s=e,c=[],l=r.preFilter;s;){for(i in n&&!(a=F.exec(s))||(a&&(s=s.slice(a[0].length)||s),c.push(o=[])),n=!1,(a=H.exec(s))&&(n=a.shift(),o.push({value:n,type:a[0].replace(A," ")}),s=s.slice(n.length)),r.filter)!(a=B[i].exec(s))||l[i]&&!(a=l[i](a))||(n=a.shift(),o.push({value:n,type:i,matches:a}),s=s.slice(n.length));if(!n)break}return t?s.length:s?Z.error(e):$(e,c).slice(0)}function de(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function pe(e,t,n){var r=t.dir,a=t.next,o=a||r,i=n&&"parentNode"===o,s=v++;return t.first?function(t,n,a){for(;t=t[r];)if(1===t.nodeType||i)return e(t,n,a);return!1}:function(t,n,c){var l,u,d=[b,s];if(c){for(;t=t[r];)if((1===t.nodeType||i)&&e(t,n,c))return!0}else for(;t=t[r];)if(1===t.nodeType||i)if(u=t[y]||(t[y]={}),a&&S(t,a))t=t[r]||t;else{if((l=u[o])&&l[0]===b&&l[1]===s)return d[2]=l[2];if(u[o]=d,d[2]=e(t,n,c))return!0}return!1}}function he(e){return e.length>1?function(t,n,r){for(var a=e.length;a--;)if(!e[a](t,n,r))return!1;return!0}:e[0]}function fe(e,t,n,r,a){for(var o,i=[],s=0,c=e.length,l=null!=t;s<c;s++)(o=e[s])&&(n&&!n(o,r,a)||(i.push(o),l&&t.push(s)));return i}function ge(e,t,n,r,a,o){return r&&!r[y]&&(r=ge(r)),a&&!a[y]&&(a=ge(a,o)),te(function(o,i,c,l){var u,d,p,h,f=[],g=[],y=i.length,b=o||function(e,t,n){for(var r=0,a=t.length;r<a;r++)Z(e,t[r],n);return n}(t||"*",c.nodeType?[c]:c,[]),v=!e||!o&&t?b:fe(b,f,e,c,l);if(n?n(v,h=a||(o?e:y||r)?[]:i,c,l):h=v,r)for(u=fe(h,g),r(u,[],c,l),d=u.length;d--;)(p=u[d])&&(h[g[d]]=!(v[g[d]]=p));if(o){if(a||e){if(a){for(u=[],d=h.length;d--;)(p=h[d])&&u.push(v[d]=p);a(null,h=[],u,l)}for(d=h.length;d--;)(p=h[d])&&(u=a?s.call(o,p):f[d])>-1&&(o[u]=!(i[u]=p))}}else h=fe(h===i?h.splice(y,h.length):h),a?a(null,i,h,l):m.apply(i,h)})}function me(e){for(var t,n,a,i=e.length,c=r.relative[e[0].type],l=c||r.relative[" "],u=c?1:0,d=pe(function(e){return e===t},l,!0),p=pe(function(e){return s.call(t,e)>-1},l,!0),h=[function(e,n,r){var a=!c&&(r||n!=o)||((t=n).nodeType?d(e,n,r):p(e,n,r));return t=null,a}];u<i;u++)if(n=r.relative[e[u].type])h=[pe(he(h),n)];else{if((n=r.filter[e[u].type].apply(null,e[u].matches))[y]){for(a=++u;a<i&&!r.relative[e[a].type];a++);return ge(u>1&&he(h),u>1&&de(e.slice(0,u-1).concat({value:" "===e[u-2].type?"*":""})).replace(A,"$1"),n,u<a&&me(e.slice(u,a)),a<i&&me(e=e.slice(a)),a<i&&de(e))}h.push(n)}return he(h)}function ye(e,t){var n,a=[],i=[],s=x[e+" "];if(!s){for(t||(t=ue(e)),n=t.length;n--;)(s=me(t[n]))[y]?a.push(s):i.push(s);s=x(e,function(e,t){var n=t.length>0,a=e.length>0,i=function(i,s,c,u,d){var h,f,g,y=0,v="0",w=i&&[],$=[],x=o,S=i||a&&r.find.TAG("*",d),C=b+=null==x?1:Math.random()||.1,N=S.length;for(d&&(o=s==l||s||d);v!==N&&null!=(h=S[v]);v++){if(a&&h){for(f=0,s||h.ownerDocument==l||(ce(h),c=!p);g=e[f++];)if(g(h,s||l,c)){m.call(u,h);break}d&&(b=C)}n&&((h=!g&&h)&&y--,i&&w.push(h))}if(y+=v,n&&v!==y){for(f=0;g=t[f++];)g(w,$,s,c);if(i){if(y>0)for(;v--;)w[v]||$[v]||($[v]=T.call(u));$=fe($)}m.apply(u,$),d&&!i&&$.length>0&&y+t.length>1&&k.uniqueSort(u)}return d&&(b=C,o=x),w};return n?te(i):i}(i,a)),s.selector=e}return s}function be(e,t,n,a){var o,i,s,c,l,u="function"==typeof e&&e,d=!a&&ue(e=u.selector||e);if(n=n||[],1===d.length){if((i=d[0]=d[0].slice(0)).length>2&&"ID"===(s=i[0]).type&&9===t.nodeType&&p&&r.relative[i[1].type]){if(!(t=(r.find.ID(s.matches[0].replace(Y,J),t)||[])[0]))return n;u&&(t=t.parentNode),e=e.slice(i.shift().value.length)}for(o=B.needsContext.test(e)?0:i.length;o--&&(s=i[o],!r.relative[c=s.type]);)if((l=r.find[c])&&(a=l(s.matches[0].replace(Y,J),X.test(i[0].type)&&se(t.parentNode)||t))){if(i.splice(o,1),!(e=a.length&&de(i)))return m.apply(n,a),n;break}}return(u||ye(e,d))(a,t,!p,n,!t||X.test(e)&&se(t.parentNode)||t),n}le.prototype=r.filters=r.pseudos,r.setFilters=new le,h.sortStable=y.split("").sort(O).join("")===y,ce(),h.sortDetached=ne(function(e){return 1&e.compareDocumentPosition(l.createElement("fieldset"))}),k.find=Z,k.expr[":"]=k.expr.pseudos,k.unique=k.uniqueSort,Z.compile=ye,Z.select=be,Z.setDocument=ce,Z.tokenize=ue,Z.escape=k.escapeSelector,Z.getText=k.text,Z.isXML=k.isXMLDoc,Z.selectors=k.expr,Z.support=k.support,Z.uniqueSort=k.uniqueSort}();var M=function(e,t,n){for(var r=[],a=void 0!==n;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(a&&k(e).is(n))break;r.push(e)}return r},L=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},R=k.expr.match.needsContext,P=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function V(e,t,n){return f(t)?k.grep(e,function(e,r){return!!t.call(e,r,e)!==n}):t.nodeType?k.grep(e,function(e){return e===t!==n}):"string"!=typeof t?k.grep(e,function(e){return s.call(t,e)>-1!==n}):k.filter(t,e,n)}k.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?k.find.matchesSelector(r,e)?[r]:[]:k.find.matches(e,k.grep(t,function(e){return 1===e.nodeType}))},k.fn.extend({find:function(e){var t,n,r=this.length,a=this;if("string"!=typeof e)return this.pushStack(k(e).filter(function(){for(t=0;t<r;t++)if(k.contains(a[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)k.find(e,a[t],n);return r>1?k.uniqueSort(n):n},filter:function(e){return this.pushStack(V(this,e||[],!1))},not:function(e){return this.pushStack(V(this,e||[],!0))},is:function(e){return!!V(this,"string"==typeof e&&R.test(e)?k(e):e||[],!1).length}});var F,H=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(k.fn.init=function(e,t,n){var r,a;if(!e)return this;if(n=n||F,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&e.length>=3?[null,e,null]:H.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof k?t[0]:t,k.merge(this,k.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:m,!0)),P.test(r[1])&&k.isPlainObject(t))for(r in t)f(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(a=m.getElementById(r[2]))&&(this[0]=a,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):f(e)?void 0!==n.ready?n.ready(e):e(k):k.makeArray(e,this)}).prototype=k.fn,F=k(m);var q=/^(?:parents|prev(?:Until|All))/,z={children:!0,contents:!0,next:!0,prev:!0};function W(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}k.fn.extend({has:function(e){var t=k(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(k.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,a=this.length,o=[],i="string"!=typeof e&&k(e);if(!R.test(e))for(;r<a;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(i?i.index(n)>-1:1===n.nodeType&&k.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(o.length>1?k.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?s.call(k(e),this[0]):s.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(k.uniqueSort(k.merge(this.get(),k(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),k.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return M(e,"parentNode")},parentsUntil:function(e,t,n){return M(e,"parentNode",n)},next:function(e){return W(e,"nextSibling")},prev:function(e){return W(e,"previousSibling")},nextAll:function(e){return M(e,"nextSibling")},prevAll:function(e){return M(e,"previousSibling")},nextUntil:function(e,t,n){return M(e,"nextSibling",n)},prevUntil:function(e,t,n){return M(e,"previousSibling",n)},siblings:function(e){return L((e.parentNode||{}).firstChild,e)},children:function(e){return L(e.firstChild)},contents:function(e){return null!=e.contentDocument&&r(e.contentDocument)?e.contentDocument:(S(e,"template")&&(e=e.content||e),k.merge([],e.childNodes))}},function(e,t){k.fn[e]=function(n,r){var a=k.map(this,t,n);return"Until"!==e.slice(-5)&&(r=n),r&&"string"==typeof r&&(a=k.filter(r,a)),this.length>1&&(z[e]||k.uniqueSort(a),q.test(e)&&a.reverse()),this.pushStack(a)}});var B=/[^\x20\t\r\n\f]+/g;function U(e){return e}function _(e){throw e}function G(e,t,n,r){var a;try{e&&f(a=e.promise)?a.call(e).done(t).fail(n):e&&f(a=e.then)?a.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}k.Callbacks=function(e){e="string"==typeof e?function(e){var t={};return k.each(e.match(B)||[],function(e,n){t[n]=!0}),t}(e):k.extend({},e);var t,n,r,a,o=[],i=[],s=-1,c=function(){for(a=a||e.once,r=t=!0;i.length;s=-1)for(n=i.shift();++s<o.length;)!1===o[s].apply(n[0],n[1])&&e.stopOnFalse&&(s=o.length,n=!1);e.memory||(n=!1),t=!1,a&&(o=n?[]:"")},l={add:function(){return o&&(n&&!t&&(s=o.length-1,i.push(n)),function t(n){k.each(n,function(n,r){f(r)?e.unique&&l.has(r)||o.push(r):r&&r.length&&"string"!==v(r)&&t(r)})}(arguments),n&&!t&&c()),this},remove:function(){return k.each(arguments,function(e,t){for(var n;(n=k.inArray(t,o,n))>-1;)o.splice(n,1),n<=s&&s--}),this},has:function(e){return e?k.inArray(e,o)>-1:o.length>0},empty:function(){return o&&(o=[]),this},disable:function(){return a=i=[],o=n="",this},disabled:function(){return!o},lock:function(){return a=i=[],n||t||(o=n=""),this},locked:function(){return!!a},fireWith:function(e,n){return a||(n=[e,(n=n||[]).slice?n.slice():n],i.push(n),t||c()),this},fire:function(){return l.fireWith(this,arguments),this},fired:function(){return!!r}};return l},k.extend({Deferred:function(t){var n=[["notify","progress",k.Callbacks("memory"),k.Callbacks("memory"),2],["resolve","done",k.Callbacks("once memory"),k.Callbacks("once memory"),0,"resolved"],["reject","fail",k.Callbacks("once memory"),k.Callbacks("once memory"),1,"rejected"]],r="pending",a={state:function(){return r},always:function(){return o.done(arguments).fail(arguments),this},catch:function(e){return a.then(null,e)},pipe:function(){var e=arguments;return k.Deferred(function(t){k.each(n,function(n,r){var a=f(e[r[4]])&&e[r[4]];o[r[1]](function(){var e=a&&a.apply(this,arguments);e&&f(e.promise)?e.promise().progress(t.notify).done(t.resolve).fail(t.reject):t[r[0]+"With"](this,a?[e]:arguments)})}),e=null}).promise()},then:function(t,r,a){var o=0;function i(t,n,r,a){return function(){var s=this,c=arguments,l=function(){var e,l;if(!(t<o)){if((e=r.apply(s,c))===n.promise())throw new TypeError("Thenable self-resolution");l=e&&("object"==typeof e||"function"==typeof e)&&e.then,f(l)?a?l.call(e,i(o,n,U,a),i(o,n,_,a)):(o++,l.call(e,i(o,n,U,a),i(o,n,_,a),i(o,n,U,n.notifyWith))):(r!==U&&(s=void 0,c=[e]),(a||n.resolveWith)(s,c))}},u=a?l:function(){try{l()}catch(e){k.Deferred.exceptionHook&&k.Deferred.exceptionHook(e,u.error),t+1>=o&&(r!==_&&(s=void 0,c=[e]),n.rejectWith(s,c))}};t?u():(k.Deferred.getErrorHook?u.error=k.Deferred.getErrorHook():k.Deferred.getStackHook&&(u.error=k.Deferred.getStackHook()),e.setTimeout(u))}}return k.Deferred(function(e){n[0][3].add(i(0,e,f(a)?a:U,e.notifyWith)),n[1][3].add(i(0,e,f(t)?t:U)),n[2][3].add(i(0,e,f(r)?r:_))}).promise()},promise:function(e){return null!=e?k.extend(e,a):a}},o={};return k.each(n,function(e,t){var i=t[2],s=t[5];a[t[1]]=i.add,s&&i.add(function(){r=s},n[3-e][2].disable,n[3-e][3].disable,n[0][2].lock,n[0][3].lock),i.add(t[3].fire),o[t[0]]=function(){return o[t[0]+"With"](this===o?void 0:this,arguments),this},o[t[0]+"With"]=i.fireWith}),a.promise(o),t&&t.call(o,o),o},when:function(e){var t=arguments.length,n=t,r=Array(n),o=a.call(arguments),i=k.Deferred(),s=function(e){return function(n){r[e]=this,o[e]=arguments.length>1?a.call(arguments):n,--t||i.resolveWith(r,o)}};if(t<=1&&(G(e,i.done(s(n)).resolve,i.reject,!t),"pending"===i.state()||f(o[n]&&o[n].then)))return i.then();for(;n--;)G(o[n],s(n),i.reject);return i.promise()}});var X=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;k.Deferred.exceptionHook=function(t,n){e.console&&e.console.warn&&t&&X.test(t.name)&&e.console.warn("jQuery.Deferred exception: "+t.message,t.stack,n)},k.readyException=function(t){e.setTimeout(function(){throw t})};var Y=k.Deferred();function J(){m.removeEventListener("DOMContentLoaded",J),e.removeEventListener("load",J),k.ready()}k.fn.ready=function(e){return Y.then(e).catch(function(e){k.readyException(e)}),this},k.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--k.readyWait:k.isReady)||(k.isReady=!0,!0!==e&&--k.readyWait>0||Y.resolveWith(m,[k]))}}),k.ready.then=Y.then,"complete"===m.readyState||"loading"!==m.readyState&&!m.documentElement.doScroll?e.setTimeout(k.ready):(m.addEventListener("DOMContentLoaded",J),e.addEventListener("load",J));var K=function(e,t,n,r,a,o,i){var s=0,c=e.length,l=null==n;if("object"===v(n))for(s in a=!0,n)K(e,t,s,n[s],!0,o,i);else if(void 0!==r&&(a=!0,f(r)||(i=!0),l&&(i?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(k(e),n)})),t))for(;s<c;s++)t(e[s],n,i?r:r.call(e[s],s,t(e[s],n)));return a?e:l?t.call(e):c?t(e[0],n):o},Q=/^-ms-/,Z=/-([a-z])/g;function ee(e,t){return t.toUpperCase()}function te(e){return e.replace(Q,"ms-").replace(Z,ee)}var ne=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function re(){this.expando=k.expando+re.uid++}re.uid=1,re.prototype={cache:function(e){var t=e[this.expando];return t||(t={},ne(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,a=this.cache(e);if("string"==typeof t)a[te(t)]=n;else for(r in t)a[te(r)]=t[r];return a},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][te(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(te):(t=te(t))in r?[t]:t.match(B)||[]).length;for(;n--;)delete r[t[n]]}(void 0===t||k.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!k.isEmptyObject(t)}};var ae=new re,oe=new re,ie=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,se=/[A-Z]/g;function ce(e,t,n){var r;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(se,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n=function(e){return"true"===e||"false"!==e&&("null"===e?null:e===+e+""?+e:ie.test(e)?JSON.parse(e):e)}(n)}catch(e){}oe.set(e,t,n)}else n=void 0;return n}k.extend({hasData:function(e){return oe.hasData(e)||ae.hasData(e)},data:function(e,t,n){return oe.access(e,t,n)},removeData:function(e,t){oe.remove(e,t)},_data:function(e,t,n){return ae.access(e,t,n)},_removeData:function(e,t){ae.remove(e,t)}}),k.fn.extend({data:function(e,t){var n,r,a,o=this[0],i=o&&o.attributes;if(void 0===e){if(this.length&&(a=oe.get(o),1===o.nodeType&&!ae.get(o,"hasDataAttrs"))){for(n=i.length;n--;)i[n]&&0===(r=i[n].name).indexOf("data-")&&(r=te(r.slice(5)),ce(o,r,a[r]));ae.set(o,"hasDataAttrs",!0)}return a}return"object"==typeof e?this.each(function(){oe.set(this,e)}):K(this,function(t){var n;if(o&&void 0===t)return void 0!==(n=oe.get(o,e))||void 0!==(n=ce(o,e))?n:void 0;this.each(function(){oe.set(this,e,t)})},null,t,arguments.length>1,null,!0)},removeData:function(e){return this.each(function(){oe.remove(this,e)})}}),k.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=ae.get(e,t),n&&(!r||Array.isArray(n)?r=ae.access(e,t,k.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=k.queue(e,t),r=n.length,a=n.shift(),o=k._queueHooks(e,t);"inprogress"===a&&(a=n.shift(),r--),a&&("fx"===t&&n.unshift("inprogress"),delete o.stop,a.call(e,function(){k.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return ae.get(e,n)||ae.access(e,n,{empty:k.Callbacks("once memory").add(function(){ae.remove(e,[t+"queue",n])})})}}),k.fn.extend({queue:function(e,t){var n=2;return"string"!=typeof e&&(t=e,e="fx",n--),arguments.length<n?k.queue(this[0],e):void 0===t?this:this.each(function(){var n=k.queue(this,e,t);k._queueHooks(this,e),"fx"===e&&"inprogress"!==n[0]&&k.dequeue(this,e)})},dequeue:function(e){return this.each(function(){k.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,a=k.Deferred(),o=this,i=this.length,s=function(){--r||a.resolveWith(o,[o])};for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";i--;)(n=ae.get(o[i],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),a.promise(t)}});var le=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,ue=new RegExp("^(?:([+-])=|)("+le+")([a-z%]*)$","i"),de=["Top","Right","Bottom","Left"],pe=m.documentElement,he=function(e){return k.contains(e.ownerDocument,e)},fe={composed:!0};pe.getRootNode&&(he=function(e){return k.contains(e.ownerDocument,e)||e.getRootNode(fe)===e.ownerDocument});var ge=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&he(e)&&"none"===k.css(e,"display")};function me(e,t,n,r){var a,o,i=20,s=r?function(){return r.cur()}:function(){return k.css(e,t,"")},c=s(),l=n&&n[3]||(k.cssNumber[t]?"":"px"),u=e.nodeType&&(k.cssNumber[t]||"px"!==l&&+c)&&ue.exec(k.css(e,t));if(u&&u[3]!==l){for(c/=2,l=l||u[3],u=+c||1;i--;)k.style(e,t,u+l),(1-o)*(1-(o=s()/c||.5))<=0&&(i=0),u/=o;u*=2,k.style(e,t,u+l),n=n||[]}return n&&(u=+u||+c||0,a=n[1]?u+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=u,r.end=a)),a}var ye={};function be(e){var t,n=e.ownerDocument,r=e.nodeName,a=ye[r];return a||(t=n.body.appendChild(n.createElement(r)),a=k.css(t,"display"),t.parentNode.removeChild(t),"none"===a&&(a="block"),ye[r]=a,a)}function ve(e,t){for(var n,r,a=[],o=0,i=e.length;o<i;o++)(r=e[o]).style&&(n=r.style.display,t?("none"===n&&(a[o]=ae.get(r,"display")||null,a[o]||(r.style.display="")),""===r.style.display&&ge(r)&&(a[o]=be(r))):"none"!==n&&(a[o]="none",ae.set(r,"display",n)));for(o=0;o<i;o++)null!=a[o]&&(e[o].style.display=a[o]);return e}k.fn.extend({show:function(){return ve(this,!0)},hide:function(){return ve(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){ge(this)?k(this).show():k(this).hide()})}});var we,$e,ke=/^(?:checkbox|radio)$/i,xe=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,Se=/^$|^module$|\/(?:java|ecma)script/i;we=m.createDocumentFragment().appendChild(m.createElement("div")),($e=m.createElement("input")).setAttribute("type","radio"),$e.setAttribute("checked","checked"),$e.setAttribute("name","t"),we.appendChild($e),h.checkClone=we.cloneNode(!0).cloneNode(!0).lastChild.checked,we.innerHTML="<textarea>x</textarea>",h.noCloneChecked=!!we.cloneNode(!0).lastChild.defaultValue,we.innerHTML="<option></option>",h.option=!!we.lastChild;var Te={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function Ce(e,t){var n;return n=void 0!==e.getElementsByTagName?e.getElementsByTagName(t||"*"):void 0!==e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&S(e,t)?k.merge([e],n):n}function Ne(e,t){for(var n=0,r=e.length;n<r;n++)ae.set(e[n],"globalEval",!t||ae.get(t[n],"globalEval"))}Te.tbody=Te.tfoot=Te.colgroup=Te.caption=Te.thead,Te.th=Te.td,h.option||(Te.optgroup=Te.option=[1,"<select multiple='multiple'>","</select>"]);var je=/<|&#?\w+;/;function Ae(e,t,n,r,a){for(var o,i,s,c,l,u,d=t.createDocumentFragment(),p=[],h=0,f=e.length;h<f;h++)if((o=e[h])||0===o)if("object"===v(o))k.merge(p,o.nodeType?[o]:o);else if(je.test(o)){for(i=i||d.appendChild(t.createElement("div")),s=(xe.exec(o)||["",""])[1].toLowerCase(),c=Te[s]||Te._default,i.innerHTML=c[1]+k.htmlPrefilter(o)+c[2],u=c[0];u--;)i=i.lastChild;k.merge(p,i.childNodes),(i=d.firstChild).textContent=""}else p.push(t.createTextNode(o));for(d.textContent="",h=0;o=p[h++];)if(r&&k.inArray(o,r)>-1)a&&a.push(o);else if(l=he(o),i=Ce(d.appendChild(o),"script"),l&&Ne(i),n)for(u=0;o=i[u++];)Se.test(o.type||"")&&n.push(o);return d}var Ee=/^([^.]*)(?:\.(.+)|)/;function Oe(){return!0}function De(){return!1}function Ie(e,t,n,r,a,o){var i,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)Ie(e,s,n,r,t[s],o);return e}if(null==r&&null==a?(a=n,r=n=void 0):null==a&&("string"==typeof n?(a=r,r=void 0):(a=r,r=n,n=void 0)),!1===a)a=De;else if(!a)return e;return 1===o&&(i=a,a=function(e){return k().off(e),i.apply(this,arguments)},a.guid=i.guid||(i.guid=k.guid++)),e.each(function(){k.event.add(this,t,a,r,n)})}function Me(e,t,n){n?(ae.set(e,t,!1),k.event.add(e,t,{namespace:!1,handler:function(e){var n,r=ae.get(this,t);if(1&e.isTrigger&&this[t]){if(r)(k.event.special[t]||{}).delegateType&&e.stopPropagation();else if(r=a.call(arguments),ae.set(this,t,r),this[t](),n=ae.get(this,t),ae.set(this,t,!1),r!==n)return e.stopImmediatePropagation(),e.preventDefault(),n}else r&&(ae.set(this,t,k.event.trigger(r[0],r.slice(1),this)),e.stopPropagation(),e.isImmediatePropagationStopped=Oe)}})):void 0===ae.get(e,t)&&k.event.add(e,t,Oe)}k.event={global:{},add:function(e,t,n,r,a){var o,i,s,c,l,u,d,p,h,f,g,m=ae.get(e);if(ne(e))for(n.handler&&(n=(o=n).handler,a=o.selector),a&&k.find.matchesSelector(pe,a),n.guid||(n.guid=k.guid++),(c=m.events)||(c=m.events=Object.create(null)),(i=m.handle)||(i=m.handle=function(t){return void 0!==k&&k.event.triggered!==t.type?k.event.dispatch.apply(e,arguments):void 0}),l=(t=(t||"").match(B)||[""]).length;l--;)h=g=(s=Ee.exec(t[l])||[])[1],f=(s[2]||"").split(".").sort(),h&&(d=k.event.special[h]||{},h=(a?d.delegateType:d.bindType)||h,d=k.event.special[h]||{},u=k.extend({type:h,origType:g,data:r,handler:n,guid:n.guid,selector:a,needsContext:a&&k.expr.match.needsContext.test(a),namespace:f.join(".")},o),(p=c[h])||((p=c[h]=[]).delegateCount=0,d.setup&&!1!==d.setup.call(e,r,f,i)||e.addEventListener&&e.addEventListener(h,i)),d.add&&(d.add.call(e,u),u.handler.guid||(u.handler.guid=n.guid)),a?p.splice(p.delegateCount++,0,u):p.push(u),k.event.global[h]=!0)},remove:function(e,t,n,r,a){var o,i,s,c,l,u,d,p,h,f,g,m=ae.hasData(e)&&ae.get(e);if(m&&(c=m.events)){for(l=(t=(t||"").match(B)||[""]).length;l--;)if(h=g=(s=Ee.exec(t[l])||[])[1],f=(s[2]||"").split(".").sort(),h){for(d=k.event.special[h]||{},p=c[h=(r?d.delegateType:d.bindType)||h]||[],s=s[2]&&new RegExp("(^|\\.)"+f.join("\\.(?:.*\\.|)")+"(\\.|$)"),i=o=p.length;o--;)u=p[o],!a&&g!==u.origType||n&&n.guid!==u.guid||s&&!s.test(u.namespace)||r&&r!==u.selector&&("**"!==r||!u.selector)||(p.splice(o,1),u.selector&&p.delegateCount--,d.remove&&d.remove.call(e,u));i&&!p.length&&(d.teardown&&!1!==d.teardown.call(e,f,m.handle)||k.removeEvent(e,h,m.handle),delete c[h])}else for(h in c)k.event.remove(e,h+t[l],n,r,!0);k.isEmptyObject(c)&&ae.remove(e,"handle events")}},dispatch:function(e){var t,n,r,a,o,i,s=new Array(arguments.length),c=k.event.fix(e),l=(ae.get(this,"events")||Object.create(null))[c.type]||[],u=k.event.special[c.type]||{};for(s[0]=c,t=1;t<arguments.length;t++)s[t]=arguments[t];if(c.delegateTarget=this,!u.preDispatch||!1!==u.preDispatch.call(this,c)){for(i=k.event.handlers.call(this,c,l),t=0;(a=i[t++])&&!c.isPropagationStopped();)for(c.currentTarget=a.elem,n=0;(o=a.handlers[n++])&&!c.isImmediatePropagationStopped();)c.rnamespace&&!1!==o.namespace&&!c.rnamespace.test(o.namespace)||(c.handleObj=o,c.data=o.data,void 0!==(r=((k.event.special[o.origType]||{}).handle||o.handler).apply(a.elem,s))&&!1===(c.result=r)&&(c.preventDefault(),c.stopPropagation()));return u.postDispatch&&u.postDispatch.call(this,c),c.result}},handlers:function(e,t){var n,r,a,o,i,s=[],c=t.delegateCount,l=e.target;if(c&&l.nodeType&&!("click"===e.type&&e.button>=1))for(;l!==this;l=l.parentNode||this)if(1===l.nodeType&&("click"!==e.type||!0!==l.disabled)){for(o=[],i={},n=0;n<c;n++)void 0===i[a=(r=t[n]).selector+" "]&&(i[a]=r.needsContext?k(a,this).index(l)>-1:k.find(a,this,null,[l]).length),i[a]&&o.push(r);o.length&&s.push({elem:l,handlers:o})}return l=this,c<t.length&&s.push({elem:l,handlers:t.slice(c)}),s},addProp:function(e,t){Object.defineProperty(k.Event.prototype,e,{enumerable:!0,configurable:!0,get:f(t)?function(){if(this.originalEvent)return t(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[e]},set:function(t){Object.defineProperty(this,e,{enumerable:!0,configurable:!0,writable:!0,value:t})}})},fix:function(e){return e[k.expando]?e:new k.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return ke.test(t.type)&&t.click&&S(t,"input")&&Me(t,"click",!0),!1},trigger:function(e){var t=this||e;return ke.test(t.type)&&t.click&&S(t,"input")&&Me(t,"click"),!0},_default:function(e){var t=e.target;return ke.test(t.type)&&t.click&&S(t,"input")&&ae.get(t,"click")||S(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},k.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},k.Event=function(e,t){if(!(this instanceof k.Event))return new k.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?Oe:De,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&k.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[k.expando]=!0},k.Event.prototype={constructor:k.Event,isDefaultPrevented:De,isPropagationStopped:De,isImmediatePropagationStopped:De,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=Oe,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=Oe,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=Oe,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},k.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,char:!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:!0},k.event.addProp),k.each({focus:"focusin",blur:"focusout"},function(e,t){function n(e){if(m.documentMode){var n=ae.get(this,"handle"),r=k.event.fix(e);r.type="focusin"===e.type?"focus":"blur",r.isSimulated=!0,n(e),r.target===r.currentTarget&&n(r)}else k.event.simulate(t,e.target,k.event.fix(e))}k.event.special[e]={setup:function(){var r;if(Me(this,e,!0),!m.documentMode)return!1;(r=ae.get(this,t))||this.addEventListener(t,n),ae.set(this,t,(r||0)+1)},trigger:function(){return Me(this,e),!0},teardown:function(){var e;if(!m.documentMode)return!1;(e=ae.get(this,t)-1)?ae.set(this,t,e):(this.removeEventListener(t,n),ae.remove(this,t))},_default:function(t){return ae.get(t.target,e)},delegateType:t},k.event.special[t]={setup:function(){var r=this.ownerDocument||this.document||this,a=m.documentMode?this:r,o=ae.get(a,t);o||(m.documentMode?this.addEventListener(t,n):r.addEventListener(e,n,!0)),ae.set(a,t,(o||0)+1)},teardown:function(){var r=this.ownerDocument||this.document||this,a=m.documentMode?this:r,o=ae.get(a,t)-1;o?ae.set(a,t,o):(m.documentMode?this.removeEventListener(t,n):r.removeEventListener(e,n,!0),ae.remove(a,t))}}}),k.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,t){k.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=e.relatedTarget,a=e.handleObj;return r&&(r===this||k.contains(this,r))||(e.type=a.origType,n=a.handler.apply(this,arguments),e.type=t),n}}}),k.fn.extend({on:function(e,t,n,r){return Ie(this,e,t,n,r)},one:function(e,t,n,r){return Ie(this,e,t,n,r,1)},off:function(e,t,n){var r,a;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,k(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(a in e)this.off(a,t,e[a]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=De),this.each(function(){k.event.remove(this,e,n,t)})}});var Le=/<script|<style|<link/i,Re=/checked\s*(?:[^=]|=\s*.checked.)/i,Pe=/^\s*<!\[CDATA\[|\]\]>\s*$/g;function Ve(e,t){return S(e,"table")&&S(11!==t.nodeType?t:t.firstChild,"tr")&&k(e).children("tbody")[0]||e}function Fe(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function He(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function qe(e,t){var n,r,a,o,i,s;if(1===t.nodeType){if(ae.hasData(e)&&(s=ae.get(e).events))for(a in ae.remove(t,"handle events"),s)for(n=0,r=s[a].length;n<r;n++)k.event.add(t,a,s[a][n]);oe.hasData(e)&&(o=oe.access(e),i=k.extend({},o),oe.set(t,i))}}function ze(e,t){var n=t.nodeName.toLowerCase();"input"===n&&ke.test(e.type)?t.checked=e.checked:"input"!==n&&"textarea"!==n||(t.defaultValue=e.defaultValue)}function We(e,t,n,r){t=o(t);var a,i,s,c,l,u,d=0,p=e.length,g=p-1,m=t[0],y=f(m);if(y||p>1&&"string"==typeof m&&!h.checkClone&&Re.test(m))return e.each(function(a){var o=e.eq(a);y&&(t[0]=m.call(this,a,o.html())),We(o,t,n,r)});if(p&&(i=(a=Ae(t,e[0].ownerDocument,!1,e,r)).firstChild,1===a.childNodes.length&&(a=i),i||r)){for(c=(s=k.map(Ce(a,"script"),Fe)).length;d<p;d++)l=a,d!==g&&(l=k.clone(l,!0,!0),c&&k.merge(s,Ce(l,"script"))),n.call(e[d],l,d);if(c)for(u=s[s.length-1].ownerDocument,k.map(s,He),d=0;d<c;d++)l=s[d],Se.test(l.type||"")&&!ae.access(l,"globalEval")&&k.contains(u,l)&&(l.src&&"module"!==(l.type||"").toLowerCase()?k._evalUrl&&!l.noModule&&k._evalUrl(l.src,{nonce:l.nonce||l.getAttribute("nonce")},u):b(l.textContent.replace(Pe,""),l,u))}return e}function Be(e,t,n){for(var r,a=t?k.filter(t,e):e,o=0;null!=(r=a[o]);o++)n||1!==r.nodeType||k.cleanData(Ce(r)),r.parentNode&&(n&&he(r)&&Ne(Ce(r,"script")),r.parentNode.removeChild(r));return e}k.extend({htmlPrefilter:function(e){return e},clone:function(e,t,n){var r,a,o,i,s=e.cloneNode(!0),c=he(e);if(!(h.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||k.isXMLDoc(e)))for(i=Ce(s),r=0,a=(o=Ce(e)).length;r<a;r++)ze(o[r],i[r]);if(t)if(n)for(o=o||Ce(e),i=i||Ce(s),r=0,a=o.length;r<a;r++)qe(o[r],i[r]);else qe(e,s);return(i=Ce(s,"script")).length>0&&Ne(i,!c&&Ce(e,"script")),s},cleanData:function(e){for(var t,n,r,a=k.event.special,o=0;void 0!==(n=e[o]);o++)if(ne(n)){if(t=n[ae.expando]){if(t.events)for(r in t.events)a[r]?k.event.remove(n,r):k.removeEvent(n,r,t.handle);n[ae.expando]=void 0}n[oe.expando]&&(n[oe.expando]=void 0)}}}),k.fn.extend({detach:function(e){return Be(this,e,!0)},remove:function(e){return Be(this,e)},text:function(e){return K(this,function(e){return void 0===e?k.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return We(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Ve(this,e).appendChild(e)})},prepend:function(){return We(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Ve(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return We(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return We(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(k.cleanData(Ce(e,!1)),e.textContent="");return this},clone:function(e,t){return e=e??!1,t=t??e,this.map(function(){return k.clone(this,e,t)})},html:function(e){return K(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!Le.test(e)&&!Te[(xe.exec(e)||["",""])[1].toLowerCase()]){e=k.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(k.cleanData(Ce(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=[];return We(this,arguments,function(t){var n=this.parentNode;k.inArray(this,e)<0&&(k.cleanData(Ce(this)),n&&n.replaceChild(t,this))},e)}}),k.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){k.fn[e]=function(e){for(var n,r=[],a=k(e),o=a.length-1,s=0;s<=o;s++)n=s===o?this:this.clone(!0),k(a[s])[t](n),i.apply(r,n.get());return this.pushStack(r)}});var Ue=new RegExp("^("+le+")(?!px)[a-z%]+$","i"),_e=/^--/,Ge=function(t){var n=t.ownerDocument.defaultView;return n&&n.opener||(n=e),n.getComputedStyle(t)},Xe=function(e,t,n){var r,a,o={};for(a in t)o[a]=e.style[a],e.style[a]=t[a];for(a in r=n.call(e),t)e.style[a]=o[a];return r},Ye=new RegExp(de.join("|"),"i");function Je(e,t,n){var r,a,o,i,s=_e.test(t),c=e.style;return(n=n||Ge(e))&&(i=n.getPropertyValue(t)||n[t],s&&i&&(i=i.replace(A,"$1")||void 0),""!==i||he(e)||(i=k.style(e,t)),!h.pixelBoxStyles()&&Ue.test(i)&&Ye.test(t)&&(r=c.width,a=c.minWidth,o=c.maxWidth,c.minWidth=c.maxWidth=c.width=i,i=n.width,c.width=r,c.minWidth=a,c.maxWidth=o)),void 0!==i?i+"":i}function Ke(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function t(){if(u){l.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",u.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",pe.appendChild(l).appendChild(u);var t=e.getComputedStyle(u);r="1%"!==t.top,c=12===n(t.marginLeft),u.style.right="60%",i=36===n(t.right),a=36===n(t.width),u.style.position="absolute",o=12===n(u.offsetWidth/3),pe.removeChild(l),u=null}}function n(e){return Math.round(parseFloat(e))}var r,a,o,i,s,c,l=m.createElement("div"),u=m.createElement("div");u.style&&(u.style.backgroundClip="content-box",u.cloneNode(!0).style.backgroundClip="",h.clearCloneStyle="content-box"===u.style.backgroundClip,k.extend(h,{boxSizingReliable:function(){return t(),a},pixelBoxStyles:function(){return t(),i},pixelPosition:function(){return t(),r},reliableMarginLeft:function(){return t(),c},scrollboxSize:function(){return t(),o},reliableTrDimensions:function(){var t,n,r,a;return null==s&&(t=m.createElement("table"),n=m.createElement("tr"),r=m.createElement("div"),t.style.cssText="position:absolute;left:-11111px;border-collapse:separate",n.style.cssText="box-sizing:content-box;border:1px solid",n.style.height="1px",r.style.height="9px",r.style.display="block",pe.appendChild(t).appendChild(n).appendChild(r),a=e.getComputedStyle(n),s=parseInt(a.height,10)+parseInt(a.borderTopWidth,10)+parseInt(a.borderBottomWidth,10)===n.offsetHeight,pe.removeChild(t)),s}}))}();var Qe=["Webkit","Moz","ms"],Ze=m.createElement("div").style,et={};function tt(e){var t=k.cssProps[e]||et[e];return t||(e in Ze?e:et[e]=function(e){for(var t=e[0].toUpperCase()+e.slice(1),n=Qe.length;n--;)if((e=Qe[n]+t)in Ze)return e}(e)||e)}var nt=/^(none|table(?!-c[ea]).+)/,rt={position:"absolute",visibility:"hidden",display:"block"},at={letterSpacing:"0",fontWeight:"400"};function ot(e,t,n){var r=ue.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function it(e,t,n,r,a,o){var i="width"===t?1:0,s=0,c=0,l=0;if(n===(r?"border":"content"))return 0;for(;i<4;i+=2)"margin"===n&&(l+=k.css(e,n+de[i],!0,a)),r?("content"===n&&(c-=k.css(e,"padding"+de[i],!0,a)),"margin"!==n&&(c-=k.css(e,"border"+de[i]+"Width",!0,a))):(c+=k.css(e,"padding"+de[i],!0,a),"padding"!==n?c+=k.css(e,"border"+de[i]+"Width",!0,a):s+=k.css(e,"border"+de[i]+"Width",!0,a));return!r&&o>=0&&(c+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-c-s-.5))||0),c+l}function st(e,t,n){var r=Ge(e),a=(!h.boxSizingReliable()||n)&&"border-box"===k.css(e,"boxSizing",!1,r),o=a,i=Je(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if(Ue.test(i)){if(!n)return i;i="auto"}return(!h.boxSizingReliable()&&a||!h.reliableTrDimensions()&&S(e,"tr")||"auto"===i||!parseFloat(i)&&"inline"===k.css(e,"display",!1,r))&&e.getClientRects().length&&(a="border-box"===k.css(e,"boxSizing",!1,r),(o=s in e)&&(i=e[s])),(i=parseFloat(i)||0)+it(e,t,n||(a?"border":"content"),o,r,i)+"px"}function ct(e,t,n,r,a){return new ct.prototype.init(e,t,n,r,a)}k.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Je(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,aspectRatio:!0,borderImageSlice:!0,columnCount:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,scale:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeMiterlimit:!0,strokeOpacity:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var a,o,i,s=te(t),c=_e.test(t),l=e.style;if(c||(t=tt(s)),i=k.cssHooks[t]||k.cssHooks[s],void 0===n)return i&&"get"in i&&void 0!==(a=i.get(e,!1,r))?a:l[t];"string"==(o=typeof n)&&(a=ue.exec(n))&&a[1]&&(n=me(e,t,a),o="number"),null!=n&&n==n&&("number"!==o||c||(n+=a&&a[3]||(k.cssNumber[s]?"":"px")),h.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),i&&"set"in i&&void 0===(n=i.set(e,n,r))||(c?l.setProperty(t,n):l[t]=n))}},css:function(e,t,n,r){var a,o,i,s=te(t);return _e.test(t)||(t=tt(s)),(i=k.cssHooks[t]||k.cssHooks[s])&&"get"in i&&(a=i.get(e,!0,n)),void 0===a&&(a=Je(e,t,r)),"normal"===a&&t in at&&(a=at[t]),""===n||n?(o=parseFloat(a),!0===n||isFinite(o)?o||0:a):a}}),k.each(["height","width"],function(e,t){k.cssHooks[t]={get:function(e,n,r){if(n)return!nt.test(k.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?st(e,t,r):Xe(e,rt,function(){return st(e,t,r)})},set:function(e,n,r){var a,o=Ge(e),i=!h.scrollboxSize()&&"absolute"===o.position,s=(i||r)&&"border-box"===k.css(e,"boxSizing",!1,o),c=r?it(e,t,r,s,o):0;return s&&i&&(c-=Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-parseFloat(o[t])-it(e,t,"border",!1,o)-.5)),c&&(a=ue.exec(n))&&"px"!==(a[3]||"px")&&(e.style[t]=n,n=k.css(e,t)),ot(0,n,c)}}}),k.cssHooks.marginLeft=Ke(h.reliableMarginLeft,function(e,t){if(t)return(parseFloat(Je(e,"marginLeft"))||e.getBoundingClientRect().left-Xe(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),k.each({margin:"",padding:"",border:"Width"},function(e,t){k.cssHooks[e+t]={expand:function(n){for(var r=0,a={},o="string"==typeof n?n.split(" "):[n];r<4;r++)a[e+de[r]+t]=o[r]||o[r-2]||o[0];return a}},"margin"!==e&&(k.cssHooks[e+t].set=ot)}),k.fn.extend({css:function(e,t){return K(this,function(e,t,n){var r,a,o={},i=0;if(Array.isArray(t)){for(r=Ge(e),a=t.length;i<a;i++)o[t[i]]=k.css(e,t[i],!1,r);return o}return void 0!==n?k.style(e,t,n):k.css(e,t)},e,t,arguments.length>1)}}),k.Tween=ct,ct.prototype={constructor:ct,init:function(e,t,n,r,a,o){this.elem=e,this.prop=n,this.easing=a||k.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(k.cssNumber[n]?"":"px")},cur:function(){var e=ct.propHooks[this.prop];return e&&e.get?e.get(this):ct.propHooks._default.get(this)},run:function(e){var t,n=ct.propHooks[this.prop];return this.options.duration?this.pos=t=k.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):ct.propHooks._default.set(this),this}},ct.prototype.init.prototype=ct.prototype,ct.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=k.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){k.fx.step[e.prop]?k.fx.step[e.prop](e):1!==e.elem.nodeType||!k.cssHooks[e.prop]&&null==e.elem.style[tt(e.prop)]?e.elem[e.prop]=e.now:k.style(e.elem,e.prop,e.now+e.unit)}}},ct.propHooks.scrollTop=ct.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},k.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},k.fx=ct.prototype.init,k.fx.step={};var lt,ut,dt=/^(?:toggle|show|hide)$/,pt=/queueHooks$/;function ht(){ut&&(!1===m.hidden&&e.requestAnimationFrame?e.requestAnimationFrame(ht):e.setTimeout(ht,k.fx.interval),k.fx.tick())}function ft(){return e.setTimeout(function(){lt=void 0}),lt=Date.now()}function gt(e,t){var n,r=0,a={height:e};for(t=t?1:0;r<4;r+=2-t)a["margin"+(n=de[r])]=a["padding"+n]=e;return t&&(a.opacity=a.width=e),a}function mt(e,t,n){for(var r,a=(yt.tweeners[t]||[]).concat(yt.tweeners["*"]),o=0,i=a.length;o<i;o++)if(r=a[o].call(n,t,e))return r}function yt(e,t,n){var r,a,o=0,i=yt.prefilters.length,s=k.Deferred().always(function(){delete c.elem}),c=function(){if(a)return!1;for(var t=lt||ft(),n=Math.max(0,l.startTime+l.duration-t),r=1-(n/l.duration||0),o=0,i=l.tweens.length;o<i;o++)l.tweens[o].run(r);return s.notifyWith(e,[l,r,n]),r<1&&i?n:(i||s.notifyWith(e,[l,1,0]),s.resolveWith(e,[l]),!1)},l=s.promise({elem:e,props:k.extend({},t),opts:k.extend(!0,{specialEasing:{},easing:k.easing._default},n),originalProperties:t,originalOptions:n,startTime:lt||ft(),duration:n.duration,tweens:[],createTween:function(t,n){var r=k.Tween(e,l.opts,t,n,l.opts.specialEasing[t]||l.opts.easing);return l.tweens.push(r),r},stop:function(t){var n=0,r=t?l.tweens.length:0;if(a)return this;for(a=!0;n<r;n++)l.tweens[n].run(1);return t?(s.notifyWith(e,[l,1,0]),s.resolveWith(e,[l,t])):s.rejectWith(e,[l,t]),this}}),u=l.props;for(function(e,t){var n,r,a,o,i;for(n in e)if(a=t[r=te(n)],o=e[n],Array.isArray(o)&&(a=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(i=k.cssHooks[r])&&"expand"in i)for(n in o=i.expand(o),delete e[r],o)n in e||(e[n]=o[n],t[n]=a);else t[r]=a}(u,l.opts.specialEasing);o<i;o++)if(r=yt.prefilters[o].call(l,e,u,l.opts))return f(r.stop)&&(k._queueHooks(l.elem,l.opts.queue).stop=r.stop.bind(r)),r;return k.map(u,mt,l),f(l.opts.start)&&l.opts.start.call(e,l),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always),k.fx.timer(k.extend(c,{elem:e,anim:l,queue:l.opts.queue})),l}k.Animation=k.extend(yt,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return me(n.elem,e,ue.exec(t),n),n}]},tweener:function(e,t){f(e)?(t=e,e=["*"]):e=e.match(B);for(var n,r=0,a=e.length;r<a;r++)n=e[r],yt.tweeners[n]=yt.tweeners[n]||[],yt.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,a,o,i,s,c,l,u,d="width"in t||"height"in t,p=this,h={},f=e.style,g=e.nodeType&&ge(e),m=ae.get(e,"fxshow");for(r in n.queue||(null==(i=k._queueHooks(e,"fx")).unqueued&&(i.unqueued=0,s=i.empty.fire,i.empty.fire=function(){i.unqueued||s()}),i.unqueued++,p.always(function(){p.always(function(){i.unqueued--,k.queue(e,"fx").length||i.empty.fire()})})),t)if(a=t[r],dt.test(a)){if(delete t[r],o=o||"toggle"===a,a===(g?"hide":"show")){if("show"!==a||!m||void 0===m[r])continue;g=!0}h[r]=m&&m[r]||k.style(e,r)}if((c=!k.isEmptyObject(t))||!k.isEmptyObject(h))for(r in d&&1===e.nodeType&&(n.overflow=[f.overflow,f.overflowX,f.overflowY],null==(l=m&&m.display)&&(l=ae.get(e,"display")),"none"===(u=k.css(e,"display"))&&(l?u=l:(ve([e],!0),l=e.style.display||l,u=k.css(e,"display"),ve([e]))),("inline"===u||"inline-block"===u&&null!=l)&&"none"===k.css(e,"float")&&(c||(p.done(function(){f.display=l}),null==l&&(u=f.display,l="none"===u?"":u)),f.display="inline-block")),n.overflow&&(f.overflow="hidden",p.always(function(){f.overflow=n.overflow[0],f.overflowX=n.overflow[1],f.overflowY=n.overflow[2]})),c=!1,h)c||(m?"hidden"in m&&(g=m.hidden):m=ae.access(e,"fxshow",{display:l}),o&&(m.hidden=!g),g&&ve([e],!0),p.done(function(){for(r in g||ve([e]),ae.remove(e,"fxshow"),h)k.style(e,r,h[r])})),c=mt(g?m[r]:0,r,p),r in m||(m[r]=c.start,g&&(c.end=c.start,c.start=0))}],prefilter:function(e,t){t?yt.prefilters.unshift(e):yt.prefilters.push(e)}}),k.speed=function(e,t,n){var r=e&&"object"==typeof e?k.extend({},e):{complete:n||!n&&t||f(e)&&e,duration:e,easing:n&&t||t&&!f(t)&&t};return k.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in k.fx.speeds?r.duration=k.fx.speeds[r.duration]:r.duration=k.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){f(r.old)&&r.old.call(this),r.queue&&k.dequeue(this,r.queue)},r},k.fn.extend({fadeTo:function(e,t,n,r){return this.filter(ge).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var a=k.isEmptyObject(e),o=k.speed(t,n,r),i=function(){var t=yt(this,k.extend({},e),o);(a||ae.get(this,"finish"))&&t.stop(!0)};return i.finish=i,a||!1===o.queue?this.each(i):this.queue(o.queue,i)},stop:function(e,t,n){var r=function(e){var t=e.stop;delete e.stop,t(n)};return"string"!=typeof e&&(n=t,t=e,e=void 0),t&&this.queue(e||"fx",[]),this.each(function(){var t=!0,a=null!=e&&e+"queueHooks",o=k.timers,i=ae.get(this);if(a)i[a]&&i[a].stop&&r(i[a]);else for(a in i)i[a]&&i[a].stop&&pt.test(a)&&r(i[a]);for(a=o.length;a--;)o[a].elem!==this||null!=e&&o[a].queue!==e||(o[a].anim.stop(n),t=!1,o.splice(a,1));!t&&n||k.dequeue(this,e)})},finish:function(e){return!1!==e&&(e=e||"fx"),this.each(function(){var t,n=ae.get(this),r=n[e+"queue"],a=n[e+"queueHooks"],o=k.timers,i=r?r.length:0;for(n.finish=!0,k.queue(this,e,[]),a&&a.stop&&a.stop.call(this,!0),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;t<i;t++)r[t]&&r[t].finish&&r[t].finish.call(this);delete n.finish})}}),k.each(["toggle","show","hide"],function(e,t){var n=k.fn[t];k.fn[t]=function(e,r,a){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate(gt(t,!0),e,r,a)}}),k.each({slideDown:gt("show"),slideUp:gt("hide"),slideToggle:gt("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){k.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}}),k.timers=[],k.fx.tick=function(){var e,t=0,n=k.timers;for(lt=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||k.fx.stop(),lt=void 0},k.fx.timer=function(e){k.timers.push(e),k.fx.start()},k.fx.interval=13,k.fx.start=function(){ut||(ut=!0,ht())},k.fx.stop=function(){ut=null},k.fx.speeds={slow:600,fast:200,_default:400},k.fn.delay=function(t,n){return t=k.fx&&k.fx.speeds[t]||t,n=n||"fx",this.queue(n,function(n,r){var a=e.setTimeout(n,t);r.stop=function(){e.clearTimeout(a)}})},function(){var e=m.createElement("input"),t=m.createElement("select").appendChild(m.createElement("option"));e.type="checkbox",h.checkOn=""!==e.value,h.optSelected=t.selected,(e=m.createElement("input")).value="t",e.type="radio",h.radioValue="t"===e.value}();var bt,vt=k.expr.attrHandle;k.fn.extend({attr:function(e,t){return K(this,k.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){k.removeAttr(this,e)})}}),k.extend({attr:function(e,t,n){var r,a,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return void 0===e.getAttribute?k.prop(e,t,n):(1===o&&k.isXMLDoc(e)||(a=k.attrHooks[t.toLowerCase()]||(k.expr.match.bool.test(t)?bt:void 0)),void 0!==n?null===n?void k.removeAttr(e,t):a&&"set"in a&&void 0!==(r=a.set(e,n,t))?r:(e.setAttribute(t,n+""),n):a&&"get"in a&&null!==(r=a.get(e,t))?r:(r=k.find.attr(e,t))??void 0)},attrHooks:{type:{set:function(e,t){if(!h.radioValue&&"radio"===t&&S(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,a=t&&t.match(B);if(a&&1===e.nodeType)for(;n=a[r++];)e.removeAttribute(n)}}),bt={set:function(e,t,n){return!1===t?k.removeAttr(e,n):e.setAttribute(n,n),n}},k.each(k.expr.match.bool.source.match(/\w+/g),function(e,t){var n=vt[t]||k.find.attr;vt[t]=function(e,t,r){var a,o,i=t.toLowerCase();return r||(o=vt[i],vt[i]=a,a=null!=n(e,t,r)?i:null,vt[i]=o),a}});var wt=/^(?:input|select|textarea|button)$/i,$t=/^(?:a|area)$/i;function kt(e){return(e.match(B)||[]).join(" ")}function xt(e){return e.getAttribute&&e.getAttribute("class")||""}function St(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(B)||[]}k.fn.extend({prop:function(e,t){return K(this,k.prop,e,t,arguments.length>1)},removeProp:function(e){return this.each(function(){delete this[k.propFix[e]||e]})}}),k.extend({prop:function(e,t,n){var r,a,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&k.isXMLDoc(e)||(t=k.propFix[t]||t,a=k.propHooks[t]),void 0!==n?a&&"set"in a&&void 0!==(r=a.set(e,n,t))?r:e[t]=n:a&&"get"in a&&null!==(r=a.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=k.find.attr(e,"tabindex");return t?parseInt(t,10):wt.test(e.nodeName)||$t.test(e.nodeName)&&e.href?0:-1}}},propFix:{for:"htmlFor",class:"className"}}),h.optSelected||(k.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),k.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){k.propFix[this.toLowerCase()]=this}),k.fn.extend({addClass:function(e){var t,n,r,a,o,i;return f(e)?this.each(function(t){k(this).addClass(e.call(this,t,xt(this)))}):(t=St(e)).length?this.each(function(){if(r=xt(this),n=1===this.nodeType&&" "+kt(r)+" "){for(o=0;o<t.length;o++)a=t[o],n.indexOf(" "+a+" ")<0&&(n+=a+" ");i=kt(n),r!==i&&this.setAttribute("class",i)}}):this},removeClass:function(e){var t,n,r,a,o,i;return f(e)?this.each(function(t){k(this).removeClass(e.call(this,t,xt(this)))}):arguments.length?(t=St(e)).length?this.each(function(){if(r=xt(this),n=1===this.nodeType&&" "+kt(r)+" "){for(o=0;o<t.length;o++)for(a=t[o];n.indexOf(" "+a+" ")>-1;)n=n.replace(" "+a+" "," ");i=kt(n),r!==i&&this.setAttribute("class",i)}}):this:this.attr("class","")},toggleClass:function(e,t){var n,r,a,o,i=typeof e,s="string"===i||Array.isArray(e);return f(e)?this.each(function(n){k(this).toggleClass(e.call(this,n,xt(this),t),t)}):"boolean"==typeof t&&s?t?this.addClass(e):this.removeClass(e):(n=St(e),this.each(function(){if(s)for(o=k(this),a=0;a<n.length;a++)r=n[a],o.hasClass(r)?o.removeClass(r):o.addClass(r);else void 0!==e&&"boolean"!==i||((r=xt(this))&&ae.set(this,"__className__",r),this.setAttribute&&this.setAttribute("class",r||!1===e?"":ae.get(this,"__className__")||""))}))},hasClass:function(e){var t,n,r=0;for(t=" "+e+" ";n=this[r++];)if(1===n.nodeType&&(" "+kt(xt(n))+" ").indexOf(t)>-1)return!0;return!1}});var Tt=/\r/g;k.fn.extend({val:function(e){var t,n,r,a=this[0];return arguments.length?(r=f(e),this.each(function(n){var a;1===this.nodeType&&(null==(a=r?e.call(this,n,k(this).val()):e)?a="":"number"==typeof a?a+="":Array.isArray(a)&&(a=k.map(a,function(e){return null==e?"":e+""})),(t=k.valHooks[this.type]||k.valHooks[this.nodeName.toLowerCase()])&&"set"in t&&void 0!==t.set(this,a,"value")||(this.value=a))})):a?(t=k.valHooks[a.type]||k.valHooks[a.nodeName.toLowerCase()])&&"get"in t&&void 0!==(n=t.get(a,"value"))?n:"string"==typeof(n=a.value)?n.replace(Tt,""):n??"":void 0}}),k.extend({valHooks:{option:{get:function(e){var t=k.find.attr(e,"value");return null!=t?t:kt(k.text(e))}},select:{get:function(e){var t,n,r,a=e.options,o=e.selectedIndex,i="select-one"===e.type,s=i?null:[],c=i?o+1:a.length;for(r=o<0?c:i?o:0;r<c;r++)if(((n=a[r]).selected||r===o)&&!n.disabled&&(!n.parentNode.disabled||!S(n.parentNode,"optgroup"))){if(t=k(n).val(),i)return t;s.push(t)}return s},set:function(e,t){for(var n,r,a=e.options,o=k.makeArray(t),i=a.length;i--;)((r=a[i]).selected=k.inArray(k.valHooks.option.get(r),o)>-1)&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),k.each(["radio","checkbox"],function(){k.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=k.inArray(k(e).val(),t)>-1}},h.checkOn||(k.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var Ct=e.location,Nt={guid:Date.now()},jt=/\?/;k.parseXML=function(t){var n,r;if(!t||"string"!=typeof t)return null;try{n=(new e.DOMParser).parseFromString(t,"text/xml")}catch(e){}return r=n&&n.getElementsByTagName("parsererror")[0],n&&!r||k.error("Invalid XML: "+(r?k.map(r.childNodes,function(e){return e.textContent}).join("\n"):t)),n};var At=/^(?:focusinfocus|focusoutblur)$/,Et=function(e){e.stopPropagation()};k.extend(k.event,{trigger:function(t,n,r,a){var o,i,s,c,l,d,p,h,y=[r||m],b=u.call(t,"type")?t.type:t,v=u.call(t,"namespace")?t.namespace.split("."):[];if(i=h=s=r=r||m,3!==r.nodeType&&8!==r.nodeType&&!At.test(b+k.event.triggered)&&(b.indexOf(".")>-1&&(v=b.split("."),b=v.shift(),v.sort()),l=b.indexOf(":")<0&&"on"+b,(t=t[k.expando]?t:new k.Event(b,"object"==typeof t&&t)).isTrigger=a?2:3,t.namespace=v.join("."),t.rnamespace=t.namespace?new RegExp("(^|\\.)"+v.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,t.result=void 0,t.target||(t.target=r),n=null==n?[t]:k.makeArray(n,[t]),p=k.event.special[b]||{},a||!p.trigger||!1!==p.trigger.apply(r,n))){if(!a&&!p.noBubble&&!g(r)){for(c=p.delegateType||b,At.test(c+b)||(i=i.parentNode);i;i=i.parentNode)y.push(i),s=i;s===(r.ownerDocument||m)&&y.push(s.defaultView||s.parentWindow||e)}for(o=0;(i=y[o++])&&!t.isPropagationStopped();)h=i,t.type=o>1?c:p.bindType||b,(d=(ae.get(i,"events")||Object.create(null))[t.type]&&ae.get(i,"handle"))&&d.apply(i,n),(d=l&&i[l])&&d.apply&&ne(i)&&(t.result=d.apply(i,n),!1===t.result&&t.preventDefault());return t.type=b,a||t.isDefaultPrevented()||p._default&&!1!==p._default.apply(y.pop(),n)||!ne(r)||l&&f(r[b])&&!g(r)&&((s=r[l])&&(r[l]=null),k.event.triggered=b,t.isPropagationStopped()&&h.addEventListener(b,Et),r[b](),t.isPropagationStopped()&&h.removeEventListener(b,Et),k.event.triggered=void 0,s&&(r[l]=s)),t.result}},simulate:function(e,t,n){var r=k.extend(new k.Event,n,{type:e,isSimulated:!0});k.event.trigger(r,null,t)}}),k.fn.extend({trigger:function(e,t){return this.each(function(){k.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return k.event.trigger(e,t,n,!0)}});var Ot=/\[\]$/,Dt=/\r?\n/g,It=/^(?:submit|button|image|reset|file)$/i,Mt=/^(?:input|select|textarea|keygen)/i;function Lt(e,t,n,r){var a;if(Array.isArray(t))k.each(t,function(t,a){n||Ot.test(e)?r(e,a):Lt(e+"["+("object"==typeof a&&null!=a?t:"")+"]",a,n,r)});else if(n||"object"!==v(t))r(e,t);else for(a in t)Lt(e+"["+a+"]",t[a],n,r)}k.param=function(e,t){var n,r=[],a=function(e,t){var n=f(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(n??"")};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!k.isPlainObject(e))k.each(e,function(){a(this.name,this.value)});else for(n in e)Lt(n,e[n],t,a);return r.join("&")},k.fn.extend({serialize:function(){return k.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=k.prop(this,"elements");return e?k.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!k(this).is(":disabled")&&Mt.test(this.nodeName)&&!It.test(e)&&(this.checked||!ke.test(e))}).map(function(e,t){var n=k(this).val();return null==n?null:Array.isArray(n)?k.map(n,function(e){return{name:t.name,value:e.replace(Dt,"\r\n")}}):{name:t.name,value:n.replace(Dt,"\r\n")}}).get()}});var Rt=/%20/g,Pt=/#.*$/,Vt=/([?&])_=[^&]*/,Ft=/^(.*?):[ \t]*([^\r\n]*)$/gm,Ht=/^(?:GET|HEAD)$/,qt=/^\/\//,zt={},Wt={},Bt="*/".concat("*"),Ut=m.createElement("a");function _t(e){return function(t,n){"string"!=typeof t&&(n=t,t="*");var r,a=0,o=t.toLowerCase().match(B)||[];if(f(n))for(;r=o[a++];)"+"===r[0]?(r=r.slice(1)||"*",(e[r]=e[r]||[]).unshift(n)):(e[r]=e[r]||[]).push(n)}}function Gt(e,t,n,r){var a={},o=e===Wt;function i(s){var c;return a[s]=!0,k.each(e[s]||[],function(e,s){var l=s(t,n,r);return"string"!=typeof l||o||a[l]?o?!(c=l):void 0:(t.dataTypes.unshift(l),i(l),!1)}),c}return i(t.dataTypes[0])||!a["*"]&&i("*")}function Xt(e,t){var n,r,a=k.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((a[n]?e:r||(r={}))[n]=t[n]);return r&&k.extend(!0,e,r),e}Ut.href=Ct.href,k.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Ct.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(Ct.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Bt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":k.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Xt(Xt(e,k.ajaxSettings),t):Xt(k.ajaxSettings,e)},ajaxPrefilter:_t(zt),ajaxTransport:_t(Wt),ajax:function(t,n){"object"==typeof t&&(n=t,t=void 0),n=n||{};var r,a,o,i,s,c,l,u,d,p,h=k.ajaxSetup({},n),f=h.context||h,g=h.context&&(f.nodeType||f.jquery)?k(f):k.event,y=k.Deferred(),b=k.Callbacks("once memory"),v=h.statusCode||{},w={},$={},x="canceled",S={readyState:0,getResponseHeader:function(e){var t;if(l){if(!i)for(i={};t=Ft.exec(o);)i[t[1].toLowerCase()+" "]=(i[t[1].toLowerCase()+" "]||[]).concat(t[2]);t=i[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return l?o:null},setRequestHeader:function(e,t){return null==l&&(e=$[e.toLowerCase()]=$[e.toLowerCase()]||e,w[e]=t),this},overrideMimeType:function(e){return null==l&&(h.mimeType=e),this},statusCode:function(e){var t;if(e)if(l)S.always(e[S.status]);else for(t in e)v[t]=[v[t],e[t]];return this},abort:function(e){var t=e||x;return r&&r.abort(t),T(0,t),this}};if(y.promise(S),h.url=((t||h.url||Ct.href)+"").replace(qt,Ct.protocol+"//"),h.type=n.method||n.type||h.method||h.type,h.dataTypes=(h.dataType||"*").toLowerCase().match(B)||[""],null==h.crossDomain){c=m.createElement("a");try{c.href=h.url,c.href=c.href,h.crossDomain=Ut.protocol+"//"+Ut.host!=c.protocol+"//"+c.host}catch(e){h.crossDomain=!0}}if(h.data&&h.processData&&"string"!=typeof h.data&&(h.data=k.param(h.data,h.traditional)),Gt(zt,h,n,S),l)return S;for(d in(u=k.event&&h.global)&&0===k.active++&&k.event.trigger("ajaxStart"),h.type=h.type.toUpperCase(),h.hasContent=!Ht.test(h.type),a=h.url.replace(Pt,""),h.hasContent?h.data&&h.processData&&0===(h.contentType||"").indexOf("application/x-www-form-urlencoded")&&(h.data=h.data.replace(Rt,"+")):(p=h.url.slice(a.length),h.data&&(h.processData||"string"==typeof h.data)&&(a+=(jt.test(a)?"&":"?")+h.data,delete h.data),!1===h.cache&&(a=a.replace(Vt,"$1"),p=(jt.test(a)?"&":"?")+"_="+Nt.guid+++p),h.url=a+p),h.ifModified&&(k.lastModified[a]&&S.setRequestHeader("If-Modified-Since",k.lastModified[a]),k.etag[a]&&S.setRequestHeader("If-None-Match",k.etag[a])),(h.data&&h.hasContent&&!1!==h.contentType||n.contentType)&&S.setRequestHeader("Content-Type",h.contentType),S.setRequestHeader("Accept",h.dataTypes[0]&&h.accepts[h.dataTypes[0]]?h.accepts[h.dataTypes[0]]+("*"!==h.dataTypes[0]?", "+Bt+"; q=0.01":""):h.accepts["*"]),h.headers)S.setRequestHeader(d,h.headers[d]);if(h.beforeSend&&(!1===h.beforeSend.call(f,S,h)||l))return S.abort();if(x="abort",b.add(h.complete),S.done(h.success),S.fail(h.error),r=Gt(Wt,h,n,S)){if(S.readyState=1,u&&g.trigger("ajaxSend",[S,h]),l)return S;h.async&&h.timeout>0&&(s=e.setTimeout(function(){S.abort("timeout")},h.timeout));try{l=!1,r.send(w,T)}catch(e){if(l)throw e;T(-1,e)}}else T(-1,"No Transport");function T(t,n,i,c){var d,p,m,w,$,x=n;l||(l=!0,s&&e.clearTimeout(s),r=void 0,o=c||"",S.readyState=t>0?4:0,d=t>=200&&t<300||304===t,i&&(w=function(e,t,n){for(var r,a,o,i,s=e.contents,c=e.dataTypes;"*"===c[0];)c.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(a in s)if(s[a]&&s[a].test(r)){c.unshift(a);break}if(c[0]in n)o=c[0];else{for(a in n){if(!c[0]||e.converters[a+" "+c[0]]){o=a;break}i||(i=a)}o=o||i}if(o)return o!==c[0]&&c.unshift(o),n[o]}(h,S,i)),!d&&k.inArray("script",h.dataTypes)>-1&&k.inArray("json",h.dataTypes)<0&&(h.converters["text script"]=function(){}),w=function(e,t,n,r){var a,o,i,s,c,l={},u=e.dataTypes.slice();if(u[1])for(i in e.converters)l[i.toLowerCase()]=e.converters[i];for(o=u.shift();o;)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!c&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),c=o,o=u.shift())if("*"===o)o=c;else if("*"!==c&&c!==o){if(!(i=l[c+" "+o]||l["* "+o]))for(a in l)if((s=a.split(" "))[1]===o&&(i=l[c+" "+s[0]]||l["* "+s[0]])){!0===i?i=l[a]:!0!==l[a]&&(o=s[0],u.unshift(s[1]));break}if(!0!==i)if(i&&e.throws)t=i(t);else try{t=i(t)}catch(e){return{state:"parsererror",error:i?e:"No conversion from "+c+" to "+o}}}return{state:"success",data:t}}(h,w,S,d),d?(h.ifModified&&(($=S.getResponseHeader("Last-Modified"))&&(k.lastModified[a]=$),($=S.getResponseHeader("etag"))&&(k.etag[a]=$)),204===t||"HEAD"===h.type?x="nocontent":304===t?x="notmodified":(x=w.state,p=w.data,d=!(m=w.error))):(m=x,!t&&x||(x="error",t<0&&(t=0))),S.status=t,S.statusText=(n||x)+"",d?y.resolveWith(f,[p,x,S]):y.rejectWith(f,[S,x,m]),S.statusCode(v),v=void 0,u&&g.trigger(d?"ajaxSuccess":"ajaxError",[S,h,d?p:m]),b.fireWith(f,[S,x]),u&&(g.trigger("ajaxComplete",[S,h]),--k.active||k.event.trigger("ajaxStop")))}return S},getJSON:function(e,t,n){return k.get(e,t,n,"json")},getScript:function(e,t){return k.get(e,void 0,t,"script")}}),k.each(["get","post"],function(e,t){k[t]=function(e,n,r,a){return f(n)&&(a=a||r,r=n,n=void 0),k.ajax(k.extend({url:e,type:t,dataType:a,data:n,success:r},k.isPlainObject(e)&&e))}}),k.ajaxPrefilter(function(e){var t;for(t in e.headers)"content-type"===t.toLowerCase()&&(e.contentType=e.headers[t]||"")}),k._evalUrl=function(e,t,n){return k.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){k.globalEval(e,t,n)}})},k.fn.extend({wrapAll:function(e){var t;return this[0]&&(f(e)&&(e=e.call(this[0])),t=k(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(e){return f(e)?this.each(function(t){k(this).wrapInner(e.call(this,t))}):this.each(function(){var t=k(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=f(e);return this.each(function(n){k(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(e){return this.parent(e).not("body").each(function(){k(this).replaceWith(this.childNodes)}),this}}),k.expr.pseudos.hidden=function(e){return!k.expr.pseudos.visible(e)},k.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},k.ajaxSettings.xhr=function(){try{return new e.XMLHttpRequest}catch(e){}};var Yt={0:200,1223:204},Jt=k.ajaxSettings.xhr();h.cors=!!Jt&&"withCredentials"in Jt,h.ajax=Jt=!!Jt,k.ajaxTransport(function(t){var n,r;if(h.cors||Jt&&!t.crossDomain)return{send:function(a,o){var i,s=t.xhr();if(s.open(t.type,t.url,t.async,t.username,t.password),t.xhrFields)for(i in t.xhrFields)s[i]=t.xhrFields[i];for(i in t.mimeType&&s.overrideMimeType&&s.overrideMimeType(t.mimeType),t.crossDomain||a["X-Requested-With"]||(a["X-Requested-With"]="XMLHttpRequest"),a)s.setRequestHeader(i,a[i]);n=function(e){return function(){n&&(n=r=s.onload=s.onerror=s.onabort=s.ontimeout=s.onreadystatechange=null,"abort"===e?s.abort():"error"===e?"number"!=typeof s.status?o(0,"error"):o(s.status,s.statusText):o(Yt[s.status]||s.status,s.statusText,"text"!==(s.responseType||"text")||"string"!=typeof s.responseText?{binary:s.response}:{text:s.responseText},s.getAllResponseHeaders()))}},s.onload=n(),r=s.onerror=s.ontimeout=n("error"),void 0!==s.onabort?s.onabort=r:s.onreadystatechange=function(){4===s.readyState&&e.setTimeout(function(){n&&r()})},n=n("abort");try{s.send(t.hasContent&&t.data||null)}catch(e){if(n)throw e}},abort:function(){n&&n()}}}),k.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),k.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return k.globalEval(e),e}}}),k.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),k.ajaxTransport("script",function(e){var t,n;if(e.crossDomain||e.scriptAttrs)return{send:function(r,a){t=k("<script>").attr(e.scriptAttrs||{}).prop({charset:e.scriptCharset,src:e.url}).on("load error",n=function(e){t.remove(),n=null,e&&a("error"===e.type?404:200,e.type)}),m.head.appendChild(t[0])},abort:function(){n&&n()}}});var Kt,Qt=[],Zt=/(=)\?(?=&|$)|\?\?/;k.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Qt.pop()||k.expando+"_"+Nt.guid++;return this[e]=!0,e}}),k.ajaxPrefilter("json jsonp",function(t,n,r){var a,o,i,s=!1!==t.jsonp&&(Zt.test(t.url)?"url":"string"==typeof t.data&&0===(t.contentType||"").indexOf("application/x-www-form-urlencoded")&&Zt.test(t.data)&&"data");if(s||"jsonp"===t.dataTypes[0])return a=t.jsonpCallback=f(t.jsonpCallback)?t.jsonpCallback():t.jsonpCallback,s?t[s]=t[s].replace(Zt,"$1"+a):!1!==t.jsonp&&(t.url+=(jt.test(t.url)?"&":"?")+t.jsonp+"="+a),t.converters["script json"]=function(){return i||k.error(a+" was not called"),i[0]},t.dataTypes[0]="json",o=e[a],e[a]=function(){i=arguments},r.always(function(){void 0===o?k(e).removeProp(a):e[a]=o,t[a]&&(t.jsonpCallback=n.jsonpCallback,Qt.push(a)),i&&f(o)&&o(i[0]),i=o=void 0}),"script"}),h.createHTMLDocument=((Kt=m.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===Kt.childNodes.length),k.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(h.createHTMLDocument?((r=(t=m.implementation.createHTMLDocument("")).createElement("base")).href=m.location.href,t.head.appendChild(r)):t=m),o=!n&&[],(a=P.exec(e))?[t.createElement(a[1])]:(a=Ae([e],t,o),o&&o.length&&k(o).remove(),k.merge([],a.childNodes)));var r,a,o},k.fn.load=function(e,t,n){var r,a,o,i=this,s=e.indexOf(" ");return s>-1&&(r=kt(e.slice(s)),e=e.slice(0,s)),f(t)?(n=t,t=void 0):t&&"object"==typeof t&&(a="POST"),i.length>0&&k.ajax({url:e,type:a||"GET",dataType:"html",data:t}).done(function(e){o=arguments,i.html(r?k("<div>").append(k.parseHTML(e)).find(r):e)}).always(n&&function(e,t){i.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},k.expr.pseudos.animated=function(e){return k.grep(k.timers,function(t){return e===t.elem}).length},k.offset={setOffset:function(e,t,n){var r,a,o,i,s,c,l=k.css(e,"position"),u=k(e),d={};"static"===l&&(e.style.position="relative"),s=u.offset(),o=k.css(e,"top"),c=k.css(e,"left"),("absolute"===l||"fixed"===l)&&(o+c).indexOf("auto")>-1?(i=(r=u.position()).top,a=r.left):(i=parseFloat(o)||0,a=parseFloat(c)||0),f(t)&&(t=t.call(e,n,k.extend({},s))),null!=t.top&&(d.top=t.top-s.top+i),null!=t.left&&(d.left=t.left-s.left+a),"using"in t?t.using.call(e,d):u.css(d)}},k.fn.extend({offset:function(e){if(arguments.length)return void 0===e?this:this.each(function(t){k.offset.setOffset(this,e,t)});var t,n,r=this[0];return r?r.getClientRects().length?(t=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:t.top+n.pageYOffset,left:t.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],a={top:0,left:0};if("fixed"===k.css(r,"position"))t=r.getBoundingClientRect();else{for(t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;e&&(e===n.body||e===n.documentElement)&&"static"===k.css(e,"position");)e=e.parentNode;e&&e!==r&&1===e.nodeType&&((a=k(e).offset()).top+=k.css(e,"borderTopWidth",!0),a.left+=k.css(e,"borderLeftWidth",!0))}return{top:t.top-a.top-k.css(r,"marginTop",!0),left:t.left-a.left-k.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent;e&&"static"===k.css(e,"position");)e=e.offsetParent;return e||pe})}}),k.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,t){var n="pageYOffset"===t;k.fn[e]=function(r){return K(this,function(e,r,a){var o;if(g(e)?o=e:9===e.nodeType&&(o=e.defaultView),void 0===a)return o?o[t]:e[r];o?o.scrollTo(n?o.pageXOffset:a,n?a:o.pageYOffset):e[r]=a},e,r,arguments.length)}}),k.each(["top","left"],function(e,t){k.cssHooks[t]=Ke(h.pixelPosition,function(e,n){if(n)return n=Je(e,t),Ue.test(n)?k(e).position()[t]+"px":n})}),k.each({Height:"height",Width:"width"},function(e,t){k.each({padding:"inner"+e,content:t,"":"outer"+e},function(n,r){k.fn[r]=function(a,o){var i=arguments.length&&(n||"boolean"!=typeof a),s=n||(!0===a||!0===o?"margin":"border");return K(this,function(t,n,a){var o;return g(t)?0===r.indexOf("outer")?t["inner"+e]:t.document.documentElement["client"+e]:9===t.nodeType?(o=t.documentElement,Math.max(t.body["scroll"+e],o["scroll"+e],t.body["offset"+e],o["offset"+e],o["client"+e])):void 0===a?k.css(t,n,s):k.style(t,n,a,s)},t,i?a:void 0,i)}})}),k.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){k.fn[t]=function(e){return this.on(t,e)}}),k.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)},hover:function(e,t){return this.on("mouseenter",e).on("mouseleave",t||e)}}),k.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,t){k.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}});var en=/^[\s\uFEFF\xA0]+|([^\s\uFEFF\xA0])[\s\uFEFF\xA0]+$/g;k.proxy=function(e,t){var n,r,o;if("string"==typeof t&&(n=e[t],t=e,e=n),f(e))return r=a.call(arguments,2),o=function(){return e.apply(t||this,r.concat(a.call(arguments)))},o.guid=e.guid=e.guid||k.guid++,o},k.holdReady=function(e){e?k.readyWait++:k.ready(!0)},k.isArray=Array.isArray,k.parseJSON=JSON.parse,k.nodeName=S,k.isFunction=f,k.isWindow=g,k.camelCase=te,k.type=v,k.now=Date.now,k.isNumeric=function(e){var t=k.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},k.trim=function(e){return null==e?"":(e+"").replace(en,"$1")};var tn=e.jQuery,nn=e.$;return k.noConflict=function(t){return e.$===k&&(e.$=nn),t&&e.jQuery===k&&(e.jQuery=tn),k},void 0===t&&(e.jQuery=e.$=k),k});var a=t(r.exports);const{fromCharCode:o}=String,i="audio,blockquote,canvas,div,h1,h2,h3,h4,h5,hr,ol,p,pre,table,ul,video,tw-align,tw-story,tw-passage,tw-sidebar,tw-columns,tw-column,tw-meter".split(","),s="a,b,i,em,strong,sup,sub,abbr,acronym,s,strike,del,big,small,script,img,button,input,tw-link,tw-broken-link,tw-verbatim,tw-collapsed,tw-error,tw-colour,tw-icon".split(","),c=["audio"],[l,u,d]=[e=>o(e)!==o(e).toLowerCase(),e=>o(e)!==o(e).toUpperCase(),e=>o(e).toLowerCase()!==o(e).toUpperCase()].map(e=>`[${Array.from(Array(57343)).map((e,t)=>t).filter(e).map((e,t,n)=>e===n[t-1]+1&&e===n[t+1]-1?"-":o(e)).join("").replace(/-+/g,"-")}]`);function p(e){return"instant"===e?0:800}let h,f,g={speedMultiplier:1},m=[],y={},b=0,v={},w=0,k={x:0,y:0};function x(e,t,n,r,a){let o=0,i=0,s=t+n;function c(n=0){let l;1&e[0].compareDocumentPosition(document)&&(s=0),o&&(l=n-o,s-=l),o=n,r>0&&b+w>0&&e.data("expediteAnim")(r),s<=t&&(i+=l||0,"paused"===e.css("animation-play-state")&&e.css({visibility:"","animation-play-state":"running"})),s<=0?(e.removeData("expediteAnim"),a()):requestAnimationFrame(c)}e.data("expediteAnim",t=>{var n;void 0===t&&(t=i),s-=t,"running"===e.css("animation-play-state")&&e.css("animation-delay",(((n=(n=e.css("animation-delay")).toLowerCase()).endsWith("ms")?+n.slice(0,-2)||0:n.endsWith("s")&&1e3*+n.slice(0,-1)||0)||0)-t+"ms")}),s?requestAnimationFrame(c):c()}const S=/-|_/g,T=e=>{let t=9;for(let n=e.length;n>0;)n-=1,t=Math.imul(t^e.charCodeAt(n),9**9);return(t^t>>>9)>>>0},C=(...e)=>{const{length:t}=e,n=[[...e]],r=Array(t).fill(0);let a,o,i=1;for(;i<t;)r[i]<i?(a=i%2&&r[i],o=e[i],e[i]=e[a],e[a]=o,++r[i],i=1,n.push([...e])):(r[i]=0,++i);return n},N=e=>{const t=""+ +e;return e+(!t.endsWith("1")||1!==t.length&&"1"===t[t.length-2]?!t.endsWith("2")||1!==t.length&&"1"===t[t.length-2]?!t.endsWith("3")||1!==t.length&&"1"===t[t.length-2]?"th":"rd":"nd":"st")},j=(e,t,n="")=>`${e} ${1!==Math.abs(e)?n||`${t}s`:t}`,A=e=>e.length<=1?e[0]:`${e.slice(0,-1).join(", ")} and ${e.at(-1)}`,E="[ \\n\\r\\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]",O="[\\dA-Za-z\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171\\uD800-\\uDFFF]",D=e=>e.replace(/[&><"']/g,e=>({"&":"&amp;",">":"&gt;","<":"&lt;",'"':"&quot;","'":"&#39;"}[e]||"")),I=e=>`${e}`.toLowerCase().replace(S,""),M=e=>{const t={colour:null,backgroundColour:null},n=/^\w+a\(.+?,\s*0\s*\)$|^transparent$/;for(;e.length&&e[0]!==document;e=e.parent()){if(!t.backgroundColour){const r=e.css("background-color");r.match(n)||(t.backgroundColour=r)}if(!t.colour){const r=e.css("color");r.match(n)||(t.colour=r)}if(t.colour&&t.backgroundColour)return t}return{colour:"#fff",backgroundColour:"#000"}},L=e=>{const t=[];for(const n of e.findAndFilter("*"))if(!(n.hidden||/none|inline/.test(n.style.display)||/display: (none|inline)/.test(n.getAttribute("style")||""))){if(i.includes(n.tagName.toLowerCase())||/display: (?!none|inline|inherit|unset)/.test(n.getAttribute("style")||""))return!1;s.includes(n.tagName.toLowerCase())||t.push(n)}return t.every(e=>/inline|none/.test(window.getComputedStyle(e).display))},R=(e,t,n,r=0,o=0,i=0,s)=>{if(0===e.length)return;n||=p(t);const l=e.length>1||!L(e)||!["tw-hook","tw-passage","tw-sidebar","tw-expression"].includes(e.tag());l&&(e=e.wrapAll("<tw-transition-container>").parent()),s&&("string"==typeof s||s instanceof Function?e.css("transform-origin",s):e.css(s)),e.attr("data-t8n",t).addClass("transition-in").css({"animation-duration":`${n}ms`,"animation-delay":-i+"ms",...r-i?{visibility:"hidden","animation-play-state":"paused"}:{}}),requestAnimationFrame(()=>{L(e)?e.css("display","inline"):e.parent().is("tw-backdrop,tw-story")||e[0].setAttribute("style",`${e[0].getAttribute("style")}display:block !important;width:100%`)}),x(e,n,r-i,o,()=>{const t=0===e.filter(c.join(",")).length;if(l&&t){e.find("tw-transition-container, .transition-in, .transition-out").each((e,t)=>{(a(t).data("expediteAnim")||Object)()});const t=[],n=e.find("*");for(let e=0;e<n.length;e+=1){const r=n[e];0===r.scrollTop&&0===r.scrollLeft||t.push([r,r.scrollLeft,r.scrollTop])}const r=document.activeElement&&e.find(document.activeElement);e.contents().unwrap();for(let[e,n,r]of t)e.scrollLeft=n,e.scrollTop=r;r?.length&&r[0].focus()}else e.removeClass("transition-in").removeAttr("data-t8n")})},P=(e,{batch:t=!1,recur:n=!1,maxWait:r=1/0}={})=>{let a,o=[],i=0,s=0,c=!1;const l=()=>{Date.now()-i>300||s>=r?(a=0,s=0,c=!n,t?(e(o),o=[]):e(...o),c=!1):a=requestAnimationFrame(l)};return(...e)=>{if(c)return;const n=Date.now();s+=n-i,i=n,t?o.push(e):o=e,a&&cancelAnimationFrame(a),a=requestAnimationFrame(l)}},V=e=>{m?m.push(e):e()},F=()=>{document.documentElement.contains(h[0])||(f||a(document.body)).append(h.parents().length?h.parents().last():h)};function H(e,t){if(!e){const e=Error(`Assertion failed: ${t}`);throw console.error(e),e}}a(document.documentElement).on("keydown keyup mousedown mouseup",({key:e,button:t,type:n})=>{const r=n.includes("down"),a=e?y:v,o=e&&I(e)||`${t}`||"";a[o]&&!r?e?b=Math.max(b-1,0):w=Math.max(w-1,0):!a[o]&&r&&(e?b+=1:w+=1),a[o]=r}).on("mousemove",({pageX:e,pageY:t})=>{k.x=e,k.y=t}),a(()=>{h=a("tw-story"),m?.forEach(e=>e()),m=null});const q=class extends Error{},{isNaN:z}=Number;
/*!
* Natural Sort algorithm for Javascript - Version 0.7 - Released under MIT license
* Author: Jim Palmer (based on chunking idea from Dave Koelle)
* http://www.overset.com/2008/09/01/javascript-natural-sort-algorithm-with-unicode-support/
* Expanded by Leon Arnott to use Intl.Collator, 2015.
* Expanded by Leon Arnott to take a string-obtaining helper function, 2019.
*/var W=(e,t=String)=>function(n,r){let a,o,i,s,c=/(^-?[0-9]+(\.?[0-9]*)[df]?e?[0-9]?$|^0x[0-9a-f]+$|[0-9]+)/gi,l=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[/-]\d{1,4}[/-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,u=/^0x[0-9a-f]+$/i,d=/^0/,p=t(n).trim(),h=t(r).trim(),f=p.replace(c,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),g=h.replace(c,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),m=parseInt(`${p.match(u)}`)||1!==f.length&&p.match(l)&&Date.parse(p),y=parseInt(`${h.match(u)}`)||m&&h.match(l)&&Date.parse(h)||null;if(e&&window.Intl?.Collator&&(i=window.Intl.Collator(e)),y&&null!==y){if(Number(m)<+y)return-1;if(Number(m)>+y)return 1}for(let e=0,t=Math.max(f.length,g.length);e<t;e++){if(a=!(f[e]||"").match(d)&&parseFloat(f[e])||f[e]||0,o=!(g[e]||"").match(d)&&parseFloat(g[e])||g[e]||0,z(a)!==z(o))return z(a)?1:-1;if(typeof a!=typeof o)a+="",o+="";else if("string"==typeof a&&i&&(s=i.compare(a,o),0!==s))return s;if(a<o)return-1;if(a>o)return 1}return 0};function B(e){return e&&"object"==typeof e?(Object.keys(e).forEach(t=>{e[t]=B(e[t])}),e):`${e}`.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&")}function U(e){return(...t)=>`(${e}${t.join("|")})`}const _=U("?:"),G=U("?!"),X=U("?="),Y="[ \\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]*",J=Y.replace("*","+"),K="\\b",Q="[\\w\\-\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171\\uD800-\\uDFFF]",Z=Q.replace("\\-",""),ee=_("\\n","$"),te=`${Y}(\\*+)${J}`,ne=`${Y}((?:0\\.)+)${J}`,re=`${Y}-{3,}${Y}${ee}`,ae=`${Y}(#{1,6})${Y}`,oe=`${Y}(==+>|<=+|=+><=+|<==+>)${Y}${ee}`,ie=`${Y}(=+\\|+|\\|+=+|=+\\|+=+|\\|=+\\|)${Y}${ee}`,se={opener:"\\[\\[(?!\\[)",main:void 0,text:`(${function(...e){return`[^${e.map(B).join("")}]*`}("]")})`,rightSeparator:_("\\->","\\|"),leftSeparator:"<\\-",closer:"\\]\\]",legacySeparator:"\\|",legacyText:`(${_("[^\\|\\]]",`\\]${G("\\]")}`)}+)`},ce=`${Z}*${Z.replace("\\w","a-zA-Z")}${Z}*`,le=`\\$(${ce})`,ue=`_(${ce})`,de=`${Y}'s${J}${G("_")}(${ce})`,pe=`(${ce})${J}of${K}${G(`it${K}`)}`,he=`'s${J}`,fe=`of${K}`,ge=_("it","time","turns?","visits?","exits?","user","pos")+K,me=`its${J}(${ce})`,ye=`its${K}`,be=`(${ce})${J}of${J}it${K}`,ve=`of${J}it${K}`,we={opener:"\\(",name:`(${_("\\$","_")}?${Q}+):${G("\\/")}`},$e=_("=<","=>",`[gl]te?${K}`,`n?eq${K}`,`isnot${K}`,`are${K}`,`x${K}`,`isa${K}`,`or${J}a${K}`),ke="[a-zA-Z][\\w\\-]*",xe="(?:\"[^\"]*\"|'[^']*'|[^'\">])*?",Se=`\\|(${Q}+)(>|\\))`,Te=`(<|\\()(${Q}+)\\|`,Ce=`((?:\\b\\d+(?:\\.\\d+)?|\\.\\d+)(?:[eE][+\\-]?\\d+)?)${G("m?s")}${K}`;se.main=se.opener+_(se.text+se.rightSeparator,se.text.replace("*","*?")+se.leftSeparator)+se.text;const Ne={upperLetter:"[A-Z\\u00c0-\\u00de\\u0150\\u0170]",lowerLetter:"[a-z0-9_\\-\\u00df-\\u00ff\\u0151\\u0171]",anyLetter:Q,anyLetterStrict:Z,whitespace:J.replace("[","[\\n\\r"),comment:"\\-\\-",escapedLine:"\\\\\\n\\\\?|\\n\\\\",br:"\\n(?!\\\\)",tag:`<\\/?${ke}${xe}>`,scriptStyleTag:`<(${_("script","style","textarea")})${xe}>[^]*?<\\/\\1>`,scriptStyleTagOpener:"<",url:`(${_("https?","mailto","javascript","ftp","data")}:\\/\\/[^\\s<]+[^<.,:;"')\\]\\s])`,bullet:"\\*",hr:re,heading:ae,align:oe,column:ie,bulleted:te,numbered:ne,verbatimOpener:"`+",hookAppendedFront:`\\[${G("=+")}`,hookPrependedFront:`${Se}\\[${G("=+")}`,hookFront:`\\[${G("=+")}`,hookBack:`\\]${G(Te)}`,hookAppendedBack:`\\]${Te}`,unclosedHook:"\\[=+",unclosedHookPrepended:`${Se}\\[=+`,unclosedCollapsed:"\\{=+",passageLink:se.main+se.closer,legacyLink:se.opener+se.legacyText+se.legacySeparator+se.legacyText+se.closer,simpleLink:se.opener+se.legacyText+se.closer,macroFront:we.opener+X(we.name),macroName:we.name,groupingFront:`\\(${G(we.name)}`,twine1Macro:"<<[^>\\s]+\\s*(?:\\\\.|'(?:[^'\\\\]*\\\\.)*[^'\\\\]*'|\"(?:[^\"\\\\]*\\\\.)*[^\"\\\\]*\"|[^'\"\\\\>]|>(?!>))*>>",validPropertyName:ce,property:de,belongingProperty:pe,possessiveOperator:he,belongingOperator:fe,itsOperator:ye,belongingItOperator:ve,variable:le,tempVariable:ue,hookName:`\\?(${Q}+)\\b`,cssMeasure:`(\\-?\\d+\\.?\\d*|\\d*\\.?\\d+)(m?s|px|r?em|w|l?h)${K}`,colour:_(_("Red","Orange","Yellow","Lime","Green","Cyan","Aqua","Blue","Navy","Purple","Fuchsia","Magenta","White","Gray","Grey","Black","Transparent"),"#[\\dA-Fa-f]{3}(?:[\\dA-Fa-f]{3})?"),datatype:_("alnum","alphanumeric","any(?:case)?","array","bool(?:ean)?","changer","codehook","colou?r","const","command","dm",`data${_("map","type","set")}`,"ds","digit","gradient","empty","even","image",`int${G("o")}(?:eger)?`,"lambda","lowercase","macro","measure","linebreak","newline","num(?:ber)?","odd","str(?:ing)?","uppercase","whitespace")+K,number:Ce,boolean:_("true","false")+K,identifier:ge,itsProperty:me,belongingItProperty:be,escapedStringChar:"\\\\[^\\n]",singleStringOpener:"'",doubleStringOpener:'"',singleStringCloser:"'",doubleStringCloser:'"',is:`is${G(`${J}not${K}`,`${J}an?${K}`,`${J}in${K}`,`${J}<`,`${J}>`)}${K}`,isNot:`is${J}not${G(J+_("an?","in")+K)}${K}`,isA:`is${J}an?${K}`,isNotA:`is${J}not${J}an?${K}`,matches:`matches${K}`,doesNotMatch:`does${J}not${J}match${K}`,and:`and${K}`,or:`or${K}`,not:`not${K}`,inequality:`((?:is(?:${J}not)?${Y})*)(${_("<(?!=)","<=",">(?!=)",">=")})`,isIn:`is${J}in${K}`,contains:`contains${K}`,doesNotContain:`does${J}not${J}contain${K}`,isNotIn:`is${J}not${J}in${K}`,addition:B("+")+G("="),subtraction:B("-")+G("=","type"),multiplication:B("*")+G("="),division:_("/","%")+G("="),spread:`\\.\\.\\.${G("\\.")}`,to:_(`to${K}`,"="),into:`into${K}`,making:`making${K}`,where:`where${K}`,when:`when${K}`,via:`via${K}`,each:`each${K}`,bind:`2?bind${K}`,typeSignature:B("-type")+K,incorrectOperator:$e,PlainCompare:{comma:",",htmlCommentFront:"\x3c!--",htmlCommentBack:"--\x3e",strikeOpener:"~~",italicOpener:"//",boldOpener:"''",supOpener:"^^",strongFront:"**",strongBack:"**",emFront:"*",emBack:"*",collapsedFront:"{",collapsedBack:"}",groupingBack:")"}},{assign:je}=Object,Ae={};class Ee{start=0;end=0;children=[];innerText="";constructor(e){je(this,e)}addChild(e){const t=this.lastChildEnd()||0,n=new Ee(e);return n.start=t,n.end=t+e.text?.length||0,n.place=this.place,n.children=[],n.innerText&&Oe(n),this.children.push(n),n}lastChildEnd(){const e=this.children&&this.children[this.children.length-1]||null;return e?e.end:this.start+Math.max(0,this.text.indexOf(this.innerText))}tokenAt(e){if(e<this.start||e>=this.end)return null;if(this.children.length)for(let t=0;t<this.children.length;t+=1)if(e>=this.children[t].start&&e<this.children[t].end){const n=this.children[t].tokenAt(e);if(n)return n}return this}pathAt(e){if(e<this.start||e>=this.end)return[];let t=[];if(this.children.length)for(let n=0;n<this.children.length;n+=1)if(e>=this.children[n].start&&e<this.children[n].end){const r=this.children[n].pathAt(e);if(r.length){t=t.concat(r);break}}return t.concat(this)}nearestTokenAt(e){return e<this.start||e>=this.end?null:this.children?this.children.reduce((t,n)=>t||(e>=n.start&&e<n.end?n:null),null):this}everyLeaf(e){return this.children&&0!==this.children.length?this.children.reduce((t,n)=>t&&n.everyLeaf(e),!0):!!e(this)}demote(){this.type="text"}debugRender(e=0){return`${"\t".repeat(e)}â¢ ${this.type}\n${this.children.map(t=>t.debugRender(e+1)).join("")}`}error(e){this.type="error",this.message=e}toString(){let e=`${this.type}(${this.start}â${this.end})`;return this.children&&this.children.length>0&&(e+=`[${this.children}]`),e}copy(){const e=new Ee(this);return e.children=e.children.slice(),e}foldChildren(){let e=[];const t=this.children.slice();for(let n=0;n<t.length;n+=1){const r=t[n];let a=!1;if(r.matches)for(let t=0;t<e.length;t+=1){let{type:n}=e[t];n in r.matches&&(De(this,r,e[t]),e=e.slice(t+1),a=!0)}!a&&r.isFront&&e.unshift(r)}}}function Oe(e,t){const n=e.innerText;let r=null,a=0,o=a,i=n.length,s=null;for(;a<i;){const i=n.slice(a);let c=(r?.length?r[0]:e).innerMode,l=0,u=c.length;for(;l<u;l+=1){const u=Ae[c[l]];if(u.constraint&&!u.constraint(s)||u.cannotFollowText&&("text"===s?.type||o<a)||(u.plainCompare?!i.startsWith(u.pattern):!u.pattern.test(i)))continue;const d=u.fn(u.plainCompare?u.pattern:u.pattern.exec(i)||"");let p=!1,h=0;if(d.matches){for(;r&&h<r.length;h+=1){let{type:e,aka:t}=r[h];if(e in d.matches){p=!0;break}t&&(e=t),d.cannotCross?.includes(e)&&(h=r.length-1)}if((!r||h>=r.length)&&!d.isFront)continue}o<a&&e.addChild({type:"text",text:n.slice(o,a),innerMode:c}),s=e.addChild(d),a+=s.text.length,o=a;let f=!1;p&&r&&(t&&De(e,s,r[h]),r=r.slice(h+1),f=!0),!f&&s.isFront&&(r?r.unshift(s):r=[s]);break}l===u&&(a+=1,null===s&&(s=new Ee({type:"text",text:"",innerMode:c})))}for(o<a&&e.addChild({type:"text",text:n.slice(o,a),innerMode:(r?.length?r[0]:e).innerMode});r?.length;)r.shift()?.demote();return e}function De(e,t,n){const r=e.children.indexOf(t),a=e.children.indexOf(n);if(t.children=e.children.splice(a+1,r-(a+1)),!t.matches?.[n.type])throw Error(`Couldn't fold backToken ${t.type} to match frontToken ${n.type}`);t.type=t.matches[n.type]||"",t.innerText="";for(let e=0,n=t.children.length;e<n;e++)t.innerText+=t.children[e].text;t.start=n.start,t.text=n.text+t.innerText+t.text;for(let e in n)e in n&&!(e in t)&&(t[e]=n[e]);e.children.splice(a,1)}const Ie={lex:(e,t="",n="start",r=!1)=>Oe(new Ee({type:"root",place:t,start:0,end:e.length,text:e,innerText:e,children:[],innerMode:Ie.modes[n]}),!r),rules:Ae,modes:{}},Me=["boolean","is","to","into","where","when","via","making","each","and","or","not","isNot","contains","doesNotContain","isIn","isA","isNotA","isNotIn","matches","doesNotMatch","typifies","untypifies","bind"],Le=["comma","spread","typeSignature","addition","subtraction","multiplication","division"],{keys:Re,assign:Pe}=Object;let Ve=Object.freeze({lex:function(e){function t(e){return e||="innerText",t=>({[e]:"string"==typeof t?t:t.reduceRight((e,t,n)=>e||(n?t:""),"")})}function n(e,t){const n={};return n[e]=t,()=>({isFront:!0,matches:n,cannotCross:["verbatimOpener"]})}const r=Object.bind(0,null);function a(e,t){for(let n of Re(t)){let r=t[n];if(!r)continue;const a=r.fn;r.fn=t=>{const r=a(t);return r.text||(r.text="string"==typeof t?t:t[0]),r.type||(r.type=n),r.innerMode||(r.innerMode=e),r}}return t}const o=[],i=[],s=[],c=a(o,{hr:{fn:r},bulleted:{fn:e=>({depth:e[1].length})},numbered:{fn:e=>({depth:e[1].length/2})},heading:{fn:e=>({depth:e[1].length})},align:{fn(e){let t;const n=e[1],r=n.indexOf("><");return~r?(t=Math.round(r/(n.length-2)*50),25===t&&(t="center")):n.startsWith("<")&&n.endsWith(">")?t="justify":n.indexOf(">")>-1?t="right":n.indexOf("<")>-1&&(t="left"),{align:t}}},column:{fn(e){let t;const n=e[1],r=n.indexOf("|");return t=r&&r<n.length-1?"center":n.startsWith("|")&&n.endsWith("|")?"none":r===n.length-1?"right":"left",{column:t,width:/\|+/.exec(n)?.[0].length,marginLeft:/^=*/.exec(n)?.[0].length,marginRight:/=*$/.exec(n)?.[0].length}}}}),l=e=>{switch(e?e.type:e){case null:case"br":case"hr":case"bulleted":case"numbered":case"heading":case"align":case"column":case"escapedLine":return!0}return!1};for(const e in c){const t=c[e];t&&(t.constraint=l),t&&(t.cannotFollowText=!0)}const u=a(o,{twine1Macro:{fn:()=>({type:"error",message:"Harlowe macros use a different syntax to Twine 1, SugarCube, and Yarn macros."})},emBack:{fn:()=>({matches:{emFront:"em"},cannotCross:["verbatimOpener"]})},strongBack:{fn:()=>({matches:{strongFront:"strong"},cannotCross:["verbatimOpener"]})},strongFront:{fn:()=>({isFront:!0})},emFront:{fn:()=>({isFront:!0})},boldOpener:{fn:n("boldOpener","bold")},italicOpener:{fn:n("italicOpener","italic")},strikeOpener:{fn:n("strikeOpener","strike")},supOpener:{fn:n("supOpener","sup")},comment:{fn:r},htmlCommentFront:{fn:()=>({isFront:!0})},htmlCommentBack:{fn:()=>({matches:{htmlCommentFront:"htmlComment"}})},scriptStyleTag:{fn:r},tag:{fn:r},url:{fn:r},hookPrependedFront:{fn:e=>({name:e[1],hidden:")"===e[2],isFront:!0,tagPosition:"prepended"})},hookFront:{fn:()=>({isFront:!0})},hookBack:{fn:()=>({matches:{hookPrependedFront:"hook",hookFront:"hook"},cannotCross:["verbatimOpener"]})},hookAppendedBack:{fn:e=>({name:e[2],hidden:"("===e[1],tagPosition:"appended",matches:{hookFront:"hook"},cannotCross:["verbatimOpener"]})},unclosedHook:{fn:r},unclosedHookPrepended:{fn:e=>({type:"unclosedHook",name:e[1],hidden:")"===e[2]})},verbatimOpener:{fn(e){let t=e[0].length,n={};return n[`verbatim${t}`]="verbatim",{type:`verbatim${t}`,isFront:!0,matches:n,aka:"verbatimOpener"}}},unclosedCollapsed:{fn:r},collapsedFront:{fn:()=>({isFront:!0})},collapsedBack:{fn:()=>({matches:{collapsedFront:"collapsed"},cannotCross:["verbatimOpener"]})},escapedLine:{fn:r},legacyLink:{fn:e=>({type:"twineLink",innerText:e[1],passage:e[2],innerMode:o})},br:{fn:r}}),d=Pe(a(i,{macroFront:{fn:e=>({isFront:!0,name:e[1]})},groupingBack:{fn:()=>({matches:{groupingFront:"grouping",macroFront:"macro"},cannotCross:["singleStringOpener","doubleStringOpener","hookFront"]})},passageLink:{fn(e){const t=e[1]||"",n=e[2]||"",r=e[3]||"";return{type:"twineLink",innerText:n?r:t,passage:t?r:n,innerMode:o}}},simpleLink:{fn:e=>({type:"twineLink",innerText:e[1]||"",passage:e[1]||"",innerMode:o})},variable:{constraint:e=>!e||"macroFront"!==e.type,fn:t("name")},tempVariable:{constraint:e=>!e||"macroFront"!==e.type,fn:t("name")}}),{hookFront:u.hookFront,hookBack:u.hookBack}),p=a(i,{htmlCommentBack:{fn:()=>({matches:{htmlCommentFront:"htmlComment"}})},comment:{fn:r},macroName:{constraint:e=>!!e&&"macroFront"===e.type,fn:t("name")},groupingFront:{fn:()=>({isFront:!0})},property:{fn:t("name"),constraint(e){if(e)switch(e.type){case"variable":case"hookName":case"property":case"tempVariable":case"colour":case"itsProperty":case"belongingItProperty":case"macro":case"grouping":case"string":case"datatype":case"hook":case"boolean":case"number":return!0;case"identifier":{let t=e.text?.toLowerCase();return"user"===t||"it"===t}}return!1}},possessiveOperator:{fn:r},itsProperty:{cannotFollowText:!0,fn:t("name")},itsOperator:{cannotFollowText:!0,fn:r},belongingItProperty:{cannotFollowText:!0,fn:t("name")},belongingItOperator:{cannotFollowText:!0,fn:r},belongingProperty:{cannotFollowText:!0,fn:t("name")},belongingOperator:{cannotFollowText:!0,fn:r},escapedStringChar:{fn:()=>({type:"text"})},singleStringOpener:{fn:()=>({isFront:!0,matches:{singleStringOpener:"string"},innerMode:s})},doubleStringOpener:{fn:()=>({isFront:!0,matches:{doubleStringOpener:"string"},innerMode:s})},hookName:{fn:t("name")},cssMeasure:{fn(e){let t=e[2].toLowerCase();return"ms"===t||"s"===t?{unit:t,value:+e[1]*("s"===t?1e3:1)}:{unit:t,value:+e[1]}}},datatype:{cannotFollowText:!0,fn:e=>({name:e[0].toLowerCase()})},colour:{cannotFollowText:!0,fn(e){let t,n=e[0].toLowerCase();const r={red:"e61919",orange:"e68019",yellow:"e5e619",lime:"80e619",green:"19e619",cyan:"19e5e6",aqua:"19e5e6",blue:"197fe6",navy:"1919e6",purple:"7f19e6",fuchsia:"e619e5",magenta:"e619e5",white:"fff",black:"000",gray:"888",grey:"888"};return t=n in r?`#${r[n]}`:n,{colour:t}}},number:{fn:e=>({value:parseFloat(e[0])})},inequality:{fn:e=>({operator:e[2],negate:e[1].indexOf("not")>-1})},identifier:{fn:t("name"),cannotFollowText:!0},whitespace:{fn:r,cannotFollowText:!0},incorrectOperator:{fn:e=>{const t={"=>":">=","=<":"<=",gte:">=",lte:"<=",gt:">",lt:"<",eq:"is",isnot:"is not",neq:"is not",isa:"is a",are:"is",x:"*","or a":"or"}[e[0].toLowerCase().replace(/\s+/g," ")];return{type:"error",message:`Please say ${t?`'${t}'`:"something else"} instead of '${e[0]}'.`,explanation:"In the interests of readability, I want certain operators to be in a specific form."}},cannotFollowText:!0},...Me.reduce((e,t)=>(e[t]={fn:r,cannotFollowText:!0},e),{}),...Le.reduce((e,t)=>(e[t]={fn:r},e),{})}),h=a(s,{singleStringCloser:p.singleStringOpener,doubleStringCloser:p.doubleStringOpener,escapedStringChar:p.escapedStringChar});o.push(...Re(c),...Re(d),...Re(u)),i.push(...Re(d),...Re(p)),s.push(...Re(h));const f={...c,...u,...d,...p,...h};for(const e in f){const t=f[e];t&&(e in Ne.PlainCompare?(t.pattern=Ne.PlainCompare[e],t.plainCompare=!0):t.pattern=RegExp(`^(?:${Ne[e]})`,"i"))}Pe(e.rules,f);const{modes:g}=e;return g.start=g.markup=o,g.macro=i,g.string=s,e}(Ie).lex,Patterns:Ne});a(document.documentElement).on("click","tw-folddown",({target:e})=>{(e=a(e)).toggleClass("open");const t=e.popData("folddown");for("function"==typeof t&&t(e);e&&!e.next().length;)e=e.parent();e?.next().toggle()});const Fe={syntax:"The markup seems to contain a mistake.",saving:"I tried to save or load the game, but I couldn't do it.",operation:"I tried to perform an operation on some data, but the data's type was incorrect.",macrocall:"I tried to run a macro, but its call wasn't written correctly.",datatype:"I tried to run a macro, but was given the wrong type of data to it.",custommacro:"I tried to run a custom macro, but its code hook had a mistake in it.",infinite:"I almost ended up doing the same thing over and over, forever.",property:"I tried to access a value in a string/array/datamap, but I couldn't find it.",unimplemented:"I currently don't have this particular feature. I'm sorry.",propagated:"Click the 'Open' button to see the code hook as it was executed.",user:"This is a custom error created by (error:). It usually means you used a custom macro incorrectly.",assertion:"This command exists to provide a helpful error if a certain important condition wasn't true.",debugonly:"This macro is not meant to be used outside of debugging your story."},He=[];class qe{constructor(e,t,n,r){"user"!==e&&(t=t[0].toUpperCase()+t.slice(1)),Object.assign(this,{type:e,message:t,explanation:n,source:void 0,innerDOM:r,appendTitleText:!1})}static containsError(...e){for(let t=0;t<e.length;t+=1){const n=e[t];if(n instanceof qe)return n;if(Array.isArray(n))for(let e=0;e<n.length;e+=1){const t=n[e];if(t instanceof qe)return t;if(Array.isArray(t)){const e=qe.containsError(...t);if(e)return e}}}return!1}static createWarning(e,t){return Object.assign(new qe(e,t),{warning:!0})}render(e="",t=!1){e="string"==typeof e?e:this.source||"";const n=a(`<tw-error class='${this.warning?"warning":"error"}' title='${D(e)}'>${D(this.message+(this.appendTitleText?` ${e}`:""))}</tw-error>`),r=a("<tw-error-explanation>").text(this.explanation||Fe[this.type]).hide(),o=a("<tw-folddown tabindex=0>"),{innerDOM:i}=this;return i&&a("<tw-open-button label='Open'>").on("click",()=>{const e=a("<tw-backdrop><tw-dialog></tw-backdrop>");e.find("tw-dialog").prepend(i,a("<tw-link tabindex=0>OK</tw-link>").on("click",()=>{i.detach(),e.remove()}).wrap("<tw-dialog-links>").parent()),h.prepend(e)}).appendTo(n),n.append(o).append(r),n.data("TwineError",this),t||He.forEach(t=>t(this,e)),n}static on(e){return"function"!=typeof e||He.includes(e)||He.push(e),qe}}Object.preventExtensions(qe),Object.preventExtensions(qe.prototype);const{assign:ze}=Object,We=RegExp(Ve.Patterns.macroFront+Ve.Patterns.macroName,"ig");class Be extends Map{constructor(e){super();const t=e.attr("name")||"",n=e.html().replace(/&(?:amp|lt|gt|quot|nbsp|zwnj|#39|#96);/g,e=>({"&amp;":"&","&gt;":">","&lt;":"<","&quot;":'"',"&#39;":"'","&nbsp;":String.fromCharCode(160),"&zwnj;":String.fromCharCode(8204)}[e]||""));this.metadata=function(e,t){const n=["metadata","storylet","exclusivity","urgency","define"];if(!(e.match(We)||[]).some(e=>n.some(t=>I(e.slice(1,-1))===t)))return{};let r=!1;const a={};return Ve.lex(e,t).children.forEach(function e(t,o,i){if("comment"!==i[o-1]?.type)if("macro"===t.type){const e=I(t.name);if(n.some(t=>e===t)){if(a[e]instanceof qe)return;if(r)return void(a[e]=new qe("syntax",`The (${t.name}:) macro can't appear after non-metadata macros.`));if(a[e]&&"define"!==e)return void(a[e]=new qe("syntax",`There is more than one (${t.name}:) macro in this passage.`));(a[e]||=[]).push(t)}else r=!0;t.children.forEach(function e(t){const r="name"in t&&"string"==typeof t.name&&I(t.name);r&&"macro"===t.type&&n.some(e=>r===e)?a[r]=new qe("syntax",`The (${t.name}:) macro can't be inside another macro.`):t.children.forEach(e)})}else t.children.forEach(e)}),a}(n,t),this.set("source",n).set("tags",(e.attr("tags")||"").split(/\s/)||[]).set("name",t)}static{Object.assign(this.prototype,{typeID:"datamap",typeName:"a passage datamap"})}get objectName(){return`the "\`${this.get("name")}\`" passage's datamap`}toSource(){return this.get("source")}}let Ue,_e=Object.create(null),Ge=[];const Xe=ze(new Map,{typeID:"datamap",typeName:"the Passages datamap",objectName:"the Passages datamap",getTagged(e){if(_e[e])return _e[e];const t=W("en",e=>e.get("name")),n=[];return this.forEach(t=>{const r=t instanceof Map&&t.get("tags");Array.isArray(r)&&r.includes(e)&&n.push(t)}),n.sort(t),_e[e]=n,n},clearTagCache(){_e=Object.create(null)},clear(){Map.prototype.clear.call(this),this.clearTagCache(),this.clearTreeCache(),this.clearStoryletCache()},delete(e){Map.prototype.delete.call(this,e),this.clearTagCache(),this.clearTreeCache(),this.clearStoryletCache()},getTree(e){H(this.has(e),"No passage name!");const t=this.get(e);H(t,`No passage named '${t}'`);const n=t.get("tags");if(n.includes("header")||n.includes("footer")||n.includes("debug-header")||n.includes("debug-footer"))return t.tree||(t.tree=Ve.lex(t.get("source"),e)),t.tree;for(let t=0;t<Ge.length;t+=1)if(Ge[t]&&Ge[t].place===e){const e=Ge.splice(t,1)[0];return Ge.unshift(e),e}const r=Ve.lex(t.get("source"),e);return Ge.unshift(r),Ge.length>16&&Ge.pop(),r},clearTreeCache(){Ge=[]},getStorylets(e,t){const n=t?t.filter(e,[...Xe.values()]):[...Xe.values()];if(n instanceof qe)return n;const r=[];let a=-1/0;const o=n.reduce((t,n)=>{if(t)return t;const o=n.get("storylet");if(o){const t=e.speculate(o,n.get("name"),"a (storylet:) macro");if(t instanceof qe)return t.message=`There's an error in the storylet passage "${n.get("name")}":\n${t.message}`,t.source=o.toSource(),t;if(t){const e=n.get("exclusivity");a=Math.max(a,"number"==typeof e?e:0),r.push(n)}}},void 0);if(o)return o;const i=W("en");return r.filter(e=>{let t=e.get("exclusivity");return t="number"==typeof t?t:0,t===a}).sort((e,t)=>{let n=e.get("urgency"),r=t.get("urgency");return n="number"==typeof n?n:0,r="number"==typeof r?r:0,n!==r?r-n:i(e.get("name"),t.get("name"))})},allStorylets:()=>(Ue||(Ue=[...Xe.values()].filter(e=>e.get("storylet"))),Ue),clearStoryletCache(){Ue=void 0},loadMetadata(e){const t=[];for(const n of Array.from(Xe.values()).sort(W("en",e=>e.get("name"))))if(n.metadata){for(let[r,a]of Object.entries(n.metadata))if(a instanceof qe)t.push(a);else for(let o of a){const a=e.speculate(o,n.get("name"),`a (${r}:) macro`),i=`In "${n.get("name")}":\n`;if(a instanceof qe){a.message=i+a.message,a.source=o.text,t.push(a);break}if("define"===r){Ga.addDefinitions();continue}const s=(e,r)=>{n.has(e)?t.push(new qe("syntax",`This passage's datamap already has a '${JSON.stringify(e)}' data name.`)):n.set(e,r)};a instanceof Map?a.forEach((e,t)=>s(t,e)):s(r,a)}n.metadata=void 0}return t},hasValid(e){const t=this.get(e);return!!t&&t instanceof Map&&t.has("source")},create:e=>new Be(e)});V(()=>{a("tw-storydata > tw-passagedata").get().forEach(e=>{let t=a(e);Xe.set(t.attr("name")||"",new Be(t))})});const{validPropertyName:Ye}=Ne;function Je(e){return!!e&&("object"==typeof e||"function"==typeof e)}const{isArray:Ke}=Array;function Qe(e){return!!e&&"object"==typeof e&&Object.getPrototypeOf(e)===Object.prototype}function Ze(e){return Ke(e)?"array":e instanceof Map?"datamap":e instanceof Set?"dataset":"string"==typeof e?"string":e&&"object"==typeof e?"object":""}function et(e){return Je(e)&&"unstorable"in e&&e?.unstorable&&e||Ke(e)&&e.find(et)||e instanceof Map&&[...e.values()].find(et)||e instanceof Set&&[...e].find(et)}function tt(e,t){if(t instanceof qe)return t;if("string"!=typeof t&&"number"!=typeof t)return new qe("property",`Only strings and numbers can be used as data names for ${it(e)}, not ${it(t)}.`);const n="string"==typeof t?+t:`${t}`;return!(!Number.isNaN(n)&&e.has(n))||new qe("property",`You mustn't use both ${it(t)} and ${it(n)} as data names in the same datamap.`)}function nt(e,t){return!!e&&"object"==typeof e&&t in e&&"function"==typeof e[t]}function rt(e){return"string"==typeof e||Ke(e)||e instanceof fa}function at(e){if(!Je(e))return e;if("clone"in e&&"function"==typeof e.clone)return e.clone();if(Ke(e))return[...e];if(e instanceof Map)return new Map(e);if(e instanceof Set)return new Set(e);throw Error(`The value ${e} cannot be cloned!`)}function ot(e,t,n,r){let a="",o=0;for(;a.length<=t&&o<e.length;){const i=r(e[o]);if(!(i.length+a.length<=t)){a+=(o>0?" and ":"")+j(e.length-o,(o>0?"other ":"")+n);break}a+=(o>0&&o===e.length-1?" and ":"")+i+(o<e.length-1?", ":""),o+=1}return a}function it(e){if(e instanceof qe)throw Error("a TwineError wasn't propagated!");if(Je(e)&&"objectName"in e)return e.objectName;if(Ke(e))return 0===e.length?"an empty array":`an array (with ${ot(e,48,"item",it)})`;if(e instanceof Map)return 0===e.size?"an empty datamap":`a datamap (with ${ot([...e.keys()],48,"dataname",ut)})`;if(e instanceof Set)return 0===e.size?"an empty dataset":`a dataset (with ${ot([...e.values()],48,"item",it)})`;if("string"==typeof e){if(0===e.length)return"an empty string";let t=[...e];return t.length>48?`a ${t.length}-character string starting with ${JSON.stringify(t.slice(0,48).join(""))}`:`the string ${JSON.stringify(e)}`}return"boolean"==typeof e?`the boolean value '${e}'`:"number"==typeof e?`the number ${JSON.stringify(e)}`:void 0===e?"an empty variable":`...whatever this is (${"object"==typeof e?"object":e})`}function st(e){const t=Qe(e);if(t&&"innerType"in e)return"lambda"===e.pattern?e.typeName:"insensitive set"===e.pattern?"a case-insensitive string name":"either"===e.pattern?(H(Ke(e.innerType),'"either" pattern had non-array inner type'),e.innerType.map(st).join(" or ")):"optional"===e.pattern?`(optional) ${st(e.innerType)}`:st(e.innerType);if(t&&"pattern"in e&&"range"===e.pattern&&"number"==typeof e.min&&"number"==typeof e.max){const{min:t,max:n}=e;return`a${t>0?" positive":""}${"integer"in e?" whole":""} number${0===t?` between 0 and ${n}`:n<1/0?` up to ${n}`:""}`}return e===String||e===Number||e===Boolean?"a "+typeof e():e===parseInt?"a whole number":e===Map?"a datamap":e===Set?"a dataset":e===Array?"an array":Je(e)&&"typeName"in e?e.typeName:"function"==typeof e&&"prototype"in e&&"typeName"in e.prototype?e.prototype.typeName:it(e)}function ct(e){return"boolean"==typeof e||"string"==typeof e||"number"==typeof e?typeof e:Ke(e)?"array":e instanceof Map?"datamap":e instanceof Set?"dataset":"typeID"in e&&e.typeID||""}const lt=(e,t)=>[e[0],t[0]].sort(W("en"))[0]===e[0]?-1:1;function ut(e,t){if(H(!(e instanceof qe||qe.containsError(e)),`received a TwineError: ${e.message}`),e&&"object"==typeof e&&"toSource"in e&&"function"==typeof e.toSource)return e.toSource();if(Qe(e)&&"first"in e&&"last"in e&&"number"==typeof e.first&&"number"==typeof e.last)return`${e.first<0?`${-1!==e.first?N(-e.first):""}last`:N(e.first+1)}to${e.last<0?`${-1!==e.last?N(-e.last):""}last`:N(e.last+1)}`;if(Ke(e)){let n="";for(let r of e)n+=n?",":"(a:",n+="property"===t?r+(r>0):ut(r);return n+(n?")":"(a:)")}if(e instanceof Map){const t=Array.from(e.entries()).sort(lt);let n="";for(let[e,r]of t)n+=`${(n?",":"(dm:")+ut(e)},${ut(r)}`;return n+(n?")":"(dm:)")}return e instanceof Set?`(ds:${Array.from(e).sort(W("en")).map(ut)})`:"number"==typeof e&&"property"===t?e<0?-1===e?"last":`${N(-e)}last`:N(e+1):"string"==typeof e&&"property"===t?RegExp(Ye).test(e)?e:`(${JSON.stringify(e)})`:JSON.stringify(e)}function dt(e,t){if("object"!=typeof e&&"object"!=typeof t)return e===t;if(Ke(e)&&Ke(t))return e.length===t.length&&e.every((e,n)=>dt(t[n],e));if(e instanceof Map&&t instanceof Map)return dt(Array.from(e.entries()).sort(),Array.from(t.entries()).sort());if(e instanceof Set&&t instanceof Set){let n=[...e],r=[...t];return n.length===r.length&&n.every(e=>r.some(t=>dt(e,t)))}return e&&"object"==typeof e&&"is"in e&&"function"==typeof e.is?e.is(t):e&&"object"==typeof e&&t&&"object"==typeof t&&Qe(e)&&Qe(t)?dt(Object.getOwnPropertyNames(e).map(t=>[t,e[t]]),Object.getOwnPropertyNames(t).map(e=>[e,t[e]])):Object.is(e,t)}function pt(e,t){if(e||""===e){if("string"==typeof e)return"string"!=typeof t?new qe("operation",`${it(e)} can only contain strings, not ${it(t)}.`):e.includes(t);if(Ke(e))return e.some(e=>dt(e,t));if(e instanceof Set||e instanceof Map)return Array.from(e.keys()).some(e=>dt(e,t))}return new qe("operation",`${it(e)} cannot contain any values, let alone ${it(t)}`)}function ht(e,t){return t&&"object"==typeof t&&"isTypeOf"in t&&"function"==typeof t.isTypeOf?t.isTypeOf(e):new qe("operation",`"is a" should only be used to compare type names, not ${it(t)}.`)}function ft(e,t){let n=!1;if(e&&"object"==typeof e&&"isTypeOf"in e&&"function"==typeof e.isTypeOf){const r=e.isTypeOf(t);if(r instanceof qe)return r;n||=r}if(t&&"object"==typeof t&&"isTypeOf"in t&&"function"==typeof t.isTypeOf){const r=t.isTypeOf(e);if(r instanceof qe)return r;n||=r}if(n)return!0;if(Ke(e)&&Ke(t)){let n=0,r=0,a=!0;for(;a&&n<e.length&&r<t.length;){let o=e[n],i=t[r];if(o.rest){for(;r<t.length&&ft(o,i);)r+=1,i=t[r];n+=1}else if(i.rest){for(;n<e.length&&ft(o,i);)n+=1,o=e[n];r+=1}else ft(o,i)?(n+=1,r+=1):a=!1}return a&&n>=e.length&&r>=t.length}return e instanceof Map&&t instanceof Map?ft(Array.from(e.entries()).sort(),Array.from(t.entries()).sort()):e instanceof Set&&t instanceof Set?(e=[...e],C(...t).some(t=>ft(e,t))):dt(e,t)}function gt(e,t,n){if(!t||!n)return new qe("macrocall",`The sub${Ze(e)} index value must not be ${t&&n}.`);let r=!1;if("string"==typeof e&&(r=!0,e=Array.from(e)),t<0&&(t=Math.max(0,e.length+t+1)),n<0&&(n=Math.max(0,e.length+n+1)),t>n)return gt(arguments[0],n,t);const a=e.slice(t>0?t-1:t,n).map(at);return r?a.join(""):a}function mt(e){return Array.from(e).sort(W("en"))}function yt(e){let t;if(t=qe.containsError(e))return t;if(e&&"object"==typeof e&&"print"in e&&"function"==typeof e.print)return e.print();if(e instanceof Map){let n=Array.from(e.entries());return(t=qe.containsError(n))?t:`${n.reduce((e,[t,n])=>`${e}<tr><td>\`${yt(t)}\`</td><td>\`${yt(n)}\`</td></tr>`,"<table class=datamap>")}</table>`}return e instanceof Set?`${Array.from(e.values()).map(yt)}`:Ke(e)?`${e.map(yt)}`:e&&"object"==typeof e&&"jquery"in e?e.html():Je(e)?new qe("unimplemented","I don't know how to print this value yet."):`${e}`}function bt(e,t){if(e>t)return bt(t,e);const n=[e];for(t-=e;t-- >0;)n.push(++e);return n}function vt(e){return"string"==typeof e||"boolean"==typeof e||"number"==typeof e&&!Number.isNaN(e)&&Math.abs(e)!==1/0||Array.isArray(e)&&e.every(vt)||e instanceof Set&&[...e].every(vt)||e instanceof Map&&[...e.values()].every(vt)&&[...e.keys()].every(e=>"string"==typeof e)}const wt=(e,t,n)=>n.findIndex(t=>dt(e,t))===t,{isArray:$t}=Array,{hasOwn:kt}=Object,xt={},St=(e=0,t=1/0)=>({pattern:"range",min:e,max:t,range:n=>"number"==typeof n&&!Number.isNaN(n)&&n>=e&&n<=t}),Tt={optional:e=>({pattern:"optional",innerType:e}),zeroOrMore:e=>({pattern:"zero or more",innerType:e}),either:(...e)=>({pattern:"either",innerType:e}),rest:e=>({pattern:"rest",innerType:e}),insensitiveSet:(...e)=>({pattern:"insensitive set",innerType:e}),numberRange:St,nonNegativeInteger:{pattern:"range",integer:!0,min:0,max:1/0,range:e=>"number"==typeof e&&!Number.isNaN(e)&&e>=0&&!`${e}`.includes(".")},positiveInteger:{pattern:"range",integer:!0,min:1,max:1/0,range:e=>"number"==typeof e&&!Number.isNaN(e)&&e>=1&&!`${e}`.includes(".")},positiveNumber:St(Number.EPSILON,1/0),nonNegativeNumber:St(0,1/0),percent:St(0,1),wrapped:(e,t)=>({pattern:"wrapped",innerType:e,message:t}),Any:{typeName:"anything"},Everything:{typeName:"everything"}};function Ct(e,t){if(!t)return void 0===e;const n=typeof e;if("function"!=typeof t&&"pattern"in t){if("optional"===t.pattern||"zero or more"===t.pattern)return void 0===e||Ct(e,t.innerType);if("either"===t.pattern){for(let n=0;n<t.innerType.length;n+=1)if(Ct(e,t.innerType[n]))return!0;return!1}if("lambda"===t.pattern&&"object"==typeof e&&Ct(e,t.innerType))return t.clauses.includes("where")===("where"in e||"each"in e)&&t.clauses.includes("making")==="making"in e&&t.clauses.includes("via")==="via"in e&&t.clauses.includes("with")==="with"in e;if("insensitive set"===t.pattern)return"string"==typeof e&&t.innerType.includes(I(e));if("range"===t.pattern)return t.range(e);if("wrapped"===t.pattern)return Ct(e,t.innerType)}if(void 0!==t&&void 0===e)return!1;if("typeName"in t){if("anything"===t.typeName&&void 0!==e&&!(e&&"object"==typeof e&&"unstorable"in e&&e.unstorable))return!0;if("everything"===t.typeName&&void 0!==e)return!0}return t===String?"string"===n:t===Boolean?"boolean"===n:t===parseInt?"number"===n&&!Number.isNaN(e)&&!`${e}`.includes("."):t===Number?"number"===n&&!Number.isNaN(e):t===Array?$t(e):!("function"!=typeof t||!Object.hasOwn(t,"prototype"))&&e instanceof t}function Nt(e){return e===Tt.Any||!!e&&"object"==typeof e&&"innerType"in e&&($t(e.innerType)?e.innerType.some(Nt):!!e.innerType&&Nt(e.innerType))}function jt(e,{fn:t,typeSignature:n,returnType:r=""},a,o){let i,s=function(e){const t=[];for(let n=0;n<e.length;n+=1){if(!(n in e))continue;let r=e[n];if(r instanceof Da){const e="value"in r&&r.value,n=qe.containsError(e);if(n)return n;if($t(e)||"string"==typeof e)t.push(...e);else{if(!(e instanceof Set))throw Error(`${e} is not a string, dataset or array`);t.push(...mt(e))}}else t.push(r)}return t}(o);if(s instanceof qe)return s;"string"!=typeof e&&(i=e,e="");const c=i?"":`(${$t(e)&&e.length>1?e[0]:e}:)`;let l,u;e=i?"knownName"in i?`the custom macro, ${i.knownName}`:"an unnamed custom macro":`the ${c} macro`,l=n.length>0?1===n.length&&Nt(n[0])?1===s.length?"That value can't be given to macros as-is.":"Give only a single value to this macro.":`${e} must only be given ${A(n.map(st))}${n.length>1?", in that order":"."}`:`${e} must not be given any data.${i?"":` Just write ${c}`}`;for(let t=0,a=Math.max(s.length,n.length);t<a;t+=1){let a=n[t],o=s[t];if(qe.containsError(o))return o;if(!a&&!u)return new qe("datatype",`${s.length-n.length} too many values were given to ${e}.`,l);if(a||=u,a&&"innerType"in a&&a.innerType&&("rest"===a.pattern||"zero or more"===a.pattern)&&(u=a.innerType,"rest"===a.pattern&&(a=a.innerType)),!Ct(o,a)){if(void 0===o){let r=n.filter(e=>!("pattern"in e&&("optional"===e.pattern||"zero or more"===e.pattern))).length;return new qe("datatype",`${e} was given ${s.length?A(s.map(it)):"nothing"}, but needs ${r-t} more value${r-t>1?"s":""}.`,l)}if("object"==typeof o&&"unstorable"in o&&o.unstorable&&Nt(a))return new qe("datatype",`${e}'s ${N(t+1)} value, ${it(o)}, is not valid data for this macro.`,l);if(o instanceof ar&&"Changer"===r)return new qe("syntax",`Please put this hook outside the parentheses of ${e}, not inside it.`,"Hooks should appear after a macro"+(i?".":`: ${c}[Some text]`));if(o&&o instanceof va&&a&&"pattern"in a&&"lambda"===a.pattern){let n=a;return new qe("datatype",`${e}'s ${N(t+1)} value (a lambda) should have ${A(["where","when","making","via","with"].filter(e=>n.clauses.includes(e)).map(e=>`a '${e}' clause`))}, not ${A(["where","when","making","via","with"].filter(e=>"object"==typeof o&&e in o).map(e=>`a '${e}' clause`))}.`)}return a&&"pattern"in a&&"insensitive set"===a.pattern?new qe("datatype",`${it(o)} is not a valid name string for ${e}.`,`Only the following names are recognised (capitalisation and hyphens ignored): ${A(a.innerType)}.`):new qe("datatype",`${e}'s ${N(t+1)} value is ${it(o)}, but should be ${st(a)}.`,l)}}return t(a,...s)}function At(e,t,n,r){const a={fn:n,typeSignature:r?[].concat(r):[],returnType:t};Object.freeze(a),[].concat(e).forEach(e=>Object.defineProperty(xt,I(e),{value:a}))}const Et={has:e=>(e=I(e),kt(xt,e)),get:e=>(H((e=I(e))in xt,`No macro named ${e} registered!`),xt[e]),add:function e(t,n,r,a){return At(t,n,r,a),e},addChanger:function e(t,n,r,a){return At(t,"Changer",n,a),rr.register($t(t)?t[0]:t,r),e},addCommand:function e(t,n,r,a,o){const i=[].concat(t)[0];return At(t,"Command",(e,...t)=>{const a=n(...t);return a||Xr.create({...o??{},runFn:(e,n)=>!1!==o?.attachable?r(e,n,...t):r(n,...t),name:i,source:`(${i}:${t.map(ut)})`})},a),e},TypeSignature:Tt,run:(e,t,n)=>Et.has(e)?jt(e,Et.get(e),t,n):new qe("macrocall",`I can't run the macro '${e}' because it doesn't exist.`,"Did you mean to run a macro? If you have a word written like (this:), it is regarded as a macro name."),runCustom:(e,t,n)=>e instanceof ta?jt(e,e,t,n):e instanceof qe?e:new qe("macrocall",`I can't call ${it(e)} because it isn't a custom macro.`)};function Ot(e,t,n,r){return n||="do this to",(a,o)=>{let i;return 1===t.length&&(o=a),(i=qe.containsError(a,o))?i:typeof a!==e||typeof o!==e?new qe("operation",`I can only ${n} ${e}s, not ${it(typeof a!==e?a:o)}.`,r):t(a,o)}}function Dt(e){return(t,n)=>{let r;if(r=qe.containsError(t,n))return r;if(typeof t!=typeof n||Je(t)&&"typeName"in t&&Je(n)&&"typeName"in n&&t.typeName!==n.typeName||Ze(t)!==Ze(n)){const e=`${it(t)} isn't the same type of data as ${it(n)}`;let r;return typeof t+typeof n!="stringnumber"&&typeof t+typeof n!="numberstring"||(r="You might want to convert one side to a number using (num:), or to a string using (str:)."),new qe("operation",e[0].toUpperCase()+e.slice(1),r)}return e(t,n)}}function It(e,t,n=!1){const r=(a,o)=>{let i;if(i=qe.containsError(a,o))return i;let[s,c]=a instanceof Pn?[a,o]:o instanceof Pn?[o,a]:[];if(s){const{determiner:e,determined:i}=s;if("start"===e||"end"===e){if(t)return new qe("operation",`I can't use '${t}' with the 'start' or 'end' of ${it(i)}.`);if(c instanceof Pn){if("start"===c.determiner||"end"===c.determiner)return new qe("operation","I can't compare one value's 'start' or 'end' with another value's 'start' or 'end'.","Please change one of them to use an exact range, such as '1stto4th' or '2ndlasttolast'.");[s,c]=[c,s]}const l=s.string||s.array;for(let t=0;t<l.length+1;t+=1){const i=t?"end"===e?l.slice(-t):l.slice(0,t):l.constructor(),c=s===a?r(i,o):r(a,i);if(c instanceof qe)return c;if(c!==n)return c}return n}const l="all"===e;return s.array.reduce((e,t)=>{if(e instanceof qe)return e;let n=s===a?r(t,o):r(a,t);return n instanceof qe?n:!!(l?e&&n:e||n)},l)}return e(a,o)};return r}function Mt(e,t){return It((t,n)=>{const r=e(t,n);return r instanceof qe?r:!r},t,!0)}Object.freeze(Et);const Lt="If one of these values is a number, you may want to write a check that it 'is not 0'. Also, if one is a string, you may want to write a check that it 'is not \"\" '.";let Rt,Pt,Vt={and:Ot("boolean",Dt((e,t)=>e&&t),"use 'and' to join",Lt),or:Ot("boolean",Dt((e,t)=>e||t),"use 'or' to join",Lt),not:Ot("boolean",e=>!e,"use 'not' to invert",Lt),"+":Dt((e,t)=>{if(Array.isArray(e))return[...e,...t];if(e instanceof Map){let n=new Map(e);return t.forEach((e,t)=>n.set(t,e)),n}return e instanceof Set?new Set([...e,...t].filter(wt).map(at)):"object"==typeof e&&"+"in e&&"function"==typeof e["+"]?e["+"](t):"string"==typeof e||"number"==typeof e?e+t:"boolean"==typeof e?e||t:new qe("operation",`I can't use + on ${it(e)}.`)}),"-":Dt((e,t)=>{if(Array.isArray(e))return e.filter(e=>!t.some(t=>dt(e,t)));if(e instanceof Set){const n=[...t];return new Set([...e].filter(e=>!n.some(t=>dt(e,t))))}return"object"==typeof e&&"-"in e&&"function"==typeof e["-"]?e["-"](t):"string"==typeof e?e.split(t).join(""):"number"==typeof e?e-t:new qe("operation",`I can't use - on ${it(e)}.`)}),"*":(e,t)=>{let n;if(n=qe.containsError(e,t))return n;const r="number"==typeof e,a="number"==typeof t;return"object"==typeof e&&a&&e&&"*"in e&&"function"==typeof e["*"]?e["*"](t):"object"==typeof t&&r&&t&&"*"in t&&"function"==typeof t["*"]?t["*"](e):a&&r?t*e:new qe("operation",`I can't use * on ${it(e)} and ${it(t)}.`)},"/":(e,t)=>{let n;if(n=qe.containsError(e,t))return n;const r="number"==typeof e,a="number"==typeof t;return"object"==typeof e&&a&&e&&"/"in e&&"function"==typeof e["/"]?e["/"](t):"object"==typeof t&&r&&t&&"/"in t&&"function"==typeof t["/"]?t["/"](e):a&&r?0===t?new qe("operation",`I can't divide ${it(e)} by zero.`):e/t:new qe("operation",`I can't use / on ${it(e)} and ${it(t)}.`)},"%":Ot("number",Dt((e,t)=>0===t?new qe("operation",`I can't modulo ${it(e)} by zero.`):e%t),"modulus"),"<":It(Ot("number",Dt((e,t)=>e<t),"do < to"),"<"),">":It(Ot("number",Dt((e,t)=>e>t),"do > to"),">"),"<=":It(Ot("number",Dt((e,t)=>e<=t),"do <= to"),"<="),">=":It(Ot("number",Dt((e,t)=>e>=t),"do >= to"),">="),is:It(dt),isNot:Mt(dt),contains:It(pt,"contains"),doesNotContain:Mt(pt,"does not contain"),isIn:It((e,t)=>pt(t,e),"is in"),isNotIn:Mt((e,t)=>pt(t,e),"is not in"),isA:It(ht,"is a"),isNotA:Mt(ht,"is not a"),typifies:It((e,t)=>ht(t,e)),untypifies:Mt((e,t)=>ht(t,e)),matches:It(ft),doesNotMatch:Mt(ft)};Object.freeze(Vt);const{imul:Ft}=Math;function Ht(e=String.fromCodePoint(Date.now()%1114112),t=0){Rt=t,Pt=e;let n,r=0,a=2166136261;for(;r<e.length;r+=1)n=Ft(e.charCodeAt(r),3432918353),n=n<<15|n>>>17,a^=Ft(n,461845907),a=a<<13|a>>>19,a=Ft(a,5)+3864292196|0;return a^=e.length,a^=a>>>16,a=Ft(a,2246822507),a^=a>>>13,a=Ft(a,3266489909),a^=a>>>16,a=(a>>>0)+1831565813*t,()=>{Rt+=1;let e=a+=1831565813;return e=Ft(e^e>>>15,1|e),e^=e+Ft(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296}}let qt=Ht();function zt(e,t){qt=Ht(e,t)}const{lex:Wt}=Ve,{isArray:Bt}=Array;function Ut(e,t,n){const r="it"===n?"its":`${n}'s`;let a="";if(Bt(t)&&Bt(e)&&t.length){let o=t.length===e.length;a="(a:";for(let n=0;n<t.length;n+=1){const i=t[n];if(dt(i,e[n])){const e=ut(i),t=`${r} ${n+1}th`;a+=`${e.length<t.length?e:t},`;continue}o=!1;const s=e.indexOf(i);if(s>-1){const e=ut(i),t=`${r} ${s+1}th`;a+=`${e.length<t.length?e:t},`;continue}a+=`${Ut(e[n],i,`${r} ${n+1}th`)},`}a=o?n:`${a.slice(0,-1)})`}else if(t instanceof Map&&e instanceof Map&&t.size){let o=t.size===e.size;a="(dm:";for(let[n,i]of t.entries()){if(a+=`${ut(n)},`,dt(i,e.get(n))){const e=ut(i),t=`${r} (${ut(n)})`;a+=`${e.length<t.length?e:t},`;continue}o=!1,a+=`${Ut(e.get(n),i,`${r} (${ut(n)})`)},`}a=o?n:`${a.slice(0,-1)})`}else if(t instanceof Set&&e instanceof Set&&t.size){const r=new Set,o=new Set;for(let n of e)t.has(n)||r.add(n);for(let n of t)e.has(n)||o.add(n);r.size||o.size||(a=n),a=r.size+o.size>t.size?ut(t):n+(o.size?`+${ut(o)}`:"")+(r.size?`-${ut(r)}`:"")}else"string"==typeof t&&"string"==typeof e&&t&&(t.startsWith(e)?a=`${n}+${ut(t.slice(e.length))}`:t.endsWith(e)&&(a=`${ut(t.slice(0,t.length-e.length))}+${n}`));return a||ut(t)}class _t{at;from;to;hash;seed;seedIter;via;constructor(e){Object.assign(this,e)}static modifierRef(e,t,n="it"){let r=Ut(e,t,n);return r?new _t({via:r}):void 0}isValueRefJSON(e){return"object"==typeof e&&e&&("at"in e||"via"in e||"changer"in e)}static dereference(e,t,n,r){if("at"in t){const{at:n,from:a,to:o,hash:i,seed:s,seedIter:c}=t;if(!Xe.has(n))throw new q(`The data refers to a passage named \`"${n}"\`, but it isn't in this story.`);const l=Xe.get(n).get("source");let u=l.slice(a,o);if(void 0!==i){let t=0,r=o-a;for(;T(u).toString(16)!==i;){if(t+r>=l.length)throw new q(`The value (or type) of the variable \`$${e}\` couldn't be found in the passage \`"${n}"\`.`);t+=1,t===a&&(t+=1),u=l.slice(t,t+r)}}const d=Wt(u,"","macro");void 0!==s&&void 0!==c&&zt(s,c);const p=r.eval(d);let h;if(h=et(p))throw new q(`The data refers to a value that can't be stored in variables (${it(h)})`);return p}if("via"in t){for(let t=n.length-1;t>=0;t-=1)if(e in n[t].variableStore){r.Identifiers.it=n[t].variableStore[e]??void 0;break}let a,o=r.eval(Wt(t.via,"","macro"));if(a=et(o))throw new q(`The variable data refers to a value that can't be stored in variables (${it(a)})`);return r.Identifiers.it=void 0,o}throw new q(`The value (or type) of the variable \`$${e}\` was malformed (no "at" or "via" property).`)}}function Gt(e){return"whitespace"===e.type}const Xt=[["comment"],["error","text"],["comma"],["to","into"],["where","when","via","making","each"],["typeSignature"],["and","or"],["is","isNot"],["contains","doesNotContain","isIn","isNotIn"],["isA","isNotA","matches","doesNotMatch"],["inequality"],["addition","subtraction"],["multiplication","division"],{rightAssociative:["spread","bind"]},{rightAssociative:["not","positive","negative"]},{rightAssociative:["belongingProperty","belongingItProperty","belongingOperator","belongingItOperator"]},["property","itsProperty","possessiveOperator","itsOperator"],["twineLink","macro","identifier","variable","tempVariable","hookName","number","cssMeasure","boolean","string","hook","colour","datatype","root"],["grouping"]];function Yt(e,t){let n,r,a;for(n=0,r=Xt.length,a=1;n!==r;n+=1){let t=Xt[n],r=NaN;if(Array.isArray(t)){for(let n=e.length-1;n>=0;n-=1)if(t.includes(e[n].type)){r=n;break}}else for(let n=0;n<e.length;n+=1)if(t.rightAssociative.includes(e[n].type)){r=n;break}if(!Number.isNaN(r)&&r>-1)return[e[r],r]}throw Error("No precedent token found!")}const Jt=["inequality","is","isNot","isIn","contains","doesNotContain","isNotIn","isA","typifies","isNotA","untypifies","matches","doesNotMatch"],Kt={">":"<=","<":">=",">=":"<","<=":">"};function Qt(e){return"inequality"===e.type?e.negate?Kt[e.operator]:e.operator:e.type}const Zt={">":"<","<":">",">=":"<=","<=":">=",contains:"isIn",doesNotContain:"isNotIn",isIn:"contains",isA:"typifies",typifies:"isA",isNotA:"untypifies",untypifies:"isNotA"};function en(e){const t=Qt(e);return Zt[t]||t}const tn={error:"neither",identifier:"neither",variable:"neither",tempVariable:"neither",hookName:"neither",number:"neither",boolean:"neither",string:"neither",hook:"neither",colour:"neither",datatype:"neither",root:"neither",twineLink:"neither",macro:"neither",grouping:"neither",itsProperty:"neither",belongingItProperty:"neither",to:"both",into:"both",typeSignature:"both",and:"both",or:"both",belongingOperator:"both",possessiveOperator:"both",multiplication:"both",division:"both",spread:"after",bind:"after",not:"after",belongingProperty:"after",each:"after",itsOperator:"after",positive:"after",negative:"after",belongingItOperator:"before",property:"before"};function nn(e,t,n){return new qe("syntax",`I need usable code to be ${e?"left ":""}${e&&t?"and ":""}${t?"right ":""}of ${n.text}.`)}function rn(e,t,n){return H(e||t,"wrongSideError called with no tokens!"),e?.length||(e=null),t?.length||(t=null),"macro"===e?.[0]?.type&&"hook"===n.type?new qe("syntax","Macros can only be attached to hooks like this in passage prose, not nested in a macro call.","You can place the hook and the attached macro outside of this macro call."):new qe("syntax",`There can't be a ${e&&t?`${e.map(e=>e.text).join("")} or ${t.map(e=>e.text).join("")}`:(e||t).map(e=>e.text).join("")} to the ${e?"left ":""}${e&&t?"or ":""}${t?"right ":""}of ${n.text}.`,"If you are trying to provide both values to a macro call, place a comma between them.")}function an(e,{val:t,fromCode:n,toCode:r,toDesc:a,reason:o,it:i,tokens:s,i:c}){if(e.length>=200)return;let l=s[c],u=s.slice(0,c),d=s.slice(c+1);if(1===s.length&&(u=d=void 0,l=s[0]),e[e.length-1].error)return;const p=qe.containsError(t)||void 0,h=e[e.length-1].code,{basis:f=0}=e[0];u?.length&&d?.length&&u[0].start>d[0].start&&([u,d]=[d,u]);let g=r||`${u?.length&&Gt(u[u.length-1])?" ":""}${p?" ð ":ut(t)}${d?.length&&(Gt(d[0])||"addition"===l.type||"subtraction"===l.type)?" ":""}`,m=(u?.length?Gt(u[0])?u[0].end:u[0].start:l.start)-f,y=(d?.length?Gt(d[d.length-1])?d[d.length-1].start:d[d.length-1].end:l.end)-f;for(let t of e)t.start<m?(m+=t.diff,y+=t.diff):t.start<y&&(y+=t.diff);if(!n&&(n=h.slice(m,y),r&&r.trim()===n.trim()))return;const b=g.length-(y-m);e.push({code:h.slice(0,m)+g+h.slice(y),fromCode:n,toCode:p?void 0:r,toDesc:!p&&!r&&(a||it(t))||void 0,start:m,end:y,diff:b,reason:o,itIdentifier:void 0!==i?it(i):i,error:p?.render(h.slice(m,y),!0)})}function on(e,t){return t instanceof Un||t instanceof ka?(e.Identifiers.it=t.get(),t):t}function sn(e,t,n=!1,r=!1){const{evalReplay:a}=e,o=!!a?.length;let i,s,c=!1;const l=Vt;let u,d,p,h,f;H(!(Array.isArray(t)&&!t.length),"No tokens to run!"),Array.isArray(t)||(t=[t]),1===t.length?(u=t[0],h=f=[],p=0):([u,p]=Yt(t),h=t.slice(0,p),f=t.slice(p+1),h.every(Gt)&&(h.length=0),f.every(Gt)&&(f.length=0));const m=!h?.length,y=!f?.length,{type:b}=u,v=tn[b]||"";"both"===v&&(m||y)?d=nn(m,y,u):"neither"!==v||m&&y?"before"===v?m?d=nn(!0,!1,u):y||(d=rn(null,f,u)):"after"===v&&(y?d=nn(!1,!0,u):m||(d=rn(h,null,u))):d=rn(h,f,u),e.freeVariables&&"object"==typeof e.freeVariables&&function(e,t){const n=e.freeVariables;if(n&&"object"==typeof n)if("macro"===t.type){const r=I(t.name);"current-time"===r||"current-date"===r||"monthday"===r||"weekday"===r||"history"===r||"visited"===r||"passage"===r?e.freeVariables=!0:!t.blockedValue||"object"==typeof n&&n?.blockedValues?"random"!==r&&"either"!==r&&"shuffled"!==r||n.seed||(n.seed=Pt,n.seedIter=Rt):n.blockedValues=e.stackTop.blockedValues?.concat()||[]}else if("identifier"===t.type){const n=I(t.text);"time"!==n&&"exits"!==n&&"user"!==n&&"it"!==n&&"visits"!==n&&"turns"!==n||(e.freeVariables=!0)}else"property"===t.type||"belongingProperty"===t.type?"random"!==I(t.name)||n.seed||(n.seed=Pt,n.seedIter=Rt):"variable"!==t.type&&"tempVariable"!==t.type||(e.freeVariables=!0)}(e,u);const w=!0,$=!0;if(H("comma"!==b,"a comma token was run() somehow."),d);else if("root"===b)d=sn(e,u.children);else if("identifier"===b)d=n?Un.create(e.Identifiers,u.text.toLowerCase()):e.Identifiers.getProperty(u.text.toLowerCase());else if("variable"===b||"tempVariable"===b)if(d=Un.create("tempVariable"===b?e.stackTop.tempVariables:Ga.variables,u.name),r){let e=new ia("any");d=ka.create(e,d),i=o&&"Variables in 'to' or 'into' expressions with no -type to their left are considered to be 'any-type' variables that can store any storable value."}else if(n||d instanceof qe)c=!0;else{const e=d.get();d=e}else if("hookName"===b)d=new fa({type:"name",data:u.name}),c=!0;else if("number"===b)d=u.value;else if("cssMeasure"===b)"ms"===u.unit||"s"===u.unit?(d=u.value,i=o&&"cssMeasure"===b&&("ms"===u.unit?"The letters 'ms' at the end of numbers are ignored, so you can use them to indicate that a number represents milliseconds.":"s"===u.unit&&"The letter 's' at the end of numbers represents 'seconds'. Harlowe converts them to milliseconds (multiplies them by 1000)."),c=!i):(d=new xa(u.value,u.unit),c=!0);else if("boolean"===b)d="true"===u.text.toLowerCase(),c=!0;else if("string"===b){const e=u.text.replace(/(.?)\n/g,(e,t)=>`${"\\"===t?"\\\\":"\n"===t?"\\n":t}\\n`).replace(/(\\*)\\0/g,(e,t)=>`${t?"\\".repeat(2*t.length):""}0`);d=window.eval(e),c=!0}else if("hook"===b)d=new ar(u.children,u.text),c=!0;else if("colour"===b)d=new Gr(u.colour),c=!0;else if("datatype"===b)d=new ia(u.name),c=!0;else if("spread"===b)d=Da.create(sn(e,f,!1,r));else if("bind"===b){const t=sn(e,f,w);if(t instanceof qe)d=t;else{if(!(t instanceof Un))throw Error("bind wasn't followed by a VarRef!");d=Ta.create(t,u.text.startsWith("2")?"two way":"")}c=!0}else if("to"===b||"into"===b){const t="to"===b?on(e,sn(e,h,w,$)):sn(e,f,w,$);if(qe.containsError(t))d=t;else{(t instanceof Un&&t.propertyChain.length<=1||t instanceof ka&&t.varRef.propertyChain.length<=1)&&(e.freeVariables=Object.create(null));const n="to"===b?sn(e,f,w):on(e,sn(e,h,w));if(qe.containsError(n))d=n;else{const r=e.freeVariables;let a;e.freeVariables=null,u.place&&r&&"object"==typeof r&&"boolean"!=typeof n&&"number"!=typeof n&&!g.uncompressedPureValues&&(a=new _t({at:u.place,from:f[0].start,to:f[f.length-1].end,hash:T(f.reduce((e,t)=>e+t.text,"")).toString(16),seed:r.seed,seedIter:r.seedIter}),JSON.stringify(a).length>=ut(n).length&&(a=void 0)),d=t instanceof qe?t:n instanceof qe?n:new Gn(t,n,b,a),c=!0,s=e.Identifiers.it}}}else if("typeSignature"===b){const t=sn(e,h),n=e.freeVariables;e.freeVariables=null;const r=sn(e,f,w);e.freeVariables=n,d=t instanceof qe?d:r instanceof qe?r:ka.create(t,r),c=!0}else if("where"===b||"when"===b||"via"===b)if(y)d=nn(!1,!0,u);else{const n=m?void 0:sn(e,h,w),r=t.map(e=>e.text).join("");d=va.create(n,b,f,r),c=!0}else if("making"===b||"each"===b)if(y)d=nn(!1,!0,u);else{const n=t.map(e=>e.text).join("");if("each"===b){const t=sn(e,f,w);d=t instanceof qe?t:va.create(t,"each",void 0,n)}else{const t=m?void 0:sn(e,h,w),r=sn(e,f,w);d=t instanceof qe?t:r instanceof qe?r:va.create(t,b,r,n)}c=!0}else if("and"===b||"or"===b){const n=e=>{const[t,r]=Yt(e);if(t&&!Gt(t))return Jt.includes(t.type)?t:t.type===b?n(e.slice(0,r))||n(e.slice(r+1)):void 0},r=n(h),i=n(f),s=new qe("operation",`This use of "is not" and "${b}" is grammatically ambiguous.`,`Maybe try rewriting this as "__ is not __ ${b} __ is not __"`);let c;const g=t=>{const[n,r]=Yt(t);if(!n||Gt(n))return[];if(n.type===b)return[...g(t.slice(0,r)),...g(t.slice(r+1))];const i=sn(e,t);if(o&&"boolean"!=typeof i){const n=c.replace(/[A-Z]/g,e=>` ${e.toLowerCase()}`);an(a,{toCode:` it ${n} ${ut(i)} `,reason:`A missing 'it ${n}' was inferred to correct the '${b}' operation.`,tokens:t,i:r}),an(a,{toCode:` ${ut(e.Identifiers.it)} ${n} ${ut(i)} `,tokens:t,i:r})}return[{val:i,tokens:t,i:r}]},m=(...t)=>t.reduce((t,{val:n,tokens:r,i})=>{if("boolean"==typeof n||n instanceof qe)return n;if(t instanceof qe)return t;const s=Vt[c](e.Identifiers.it,n),l=s instanceof qe?s:Vt[u.type](t,s);return o&&an(a,{val:l,tokens:r,i}),l},"and"===u.type);if(r&&!i){const t=r;if(c=Qt(t),"isNot"===t.type||"isNotA"===t.type||"untypifies"===t.type)d=s;else{const t=sn(e,h),n=m(...g(f));d=t instanceof qe?t:n instanceof qe?n:l[b](t,n)}}else if(!r&&i){const n=i,r=t.indexOf(n);if(c=en(n),"isNot"===n.type||"isNotA"===n.type||"untypifies"===n.type)d=s;else{const a=[...t.slice(r+1),Object.setPrototypeOf({["inequality"===n.type?"operator":"type"]:en(n)},n),...t.slice(p+1,r)],o=sn(e,a),i=m(...g(h));d=o instanceof qe?o:i instanceof qe?i:l[b](o,i)}}else{const t=sn(e,h),n=sn(e,f);d=t instanceof qe?t:n instanceof qe?n:l[b](t,n)}}else if(Jt.includes(b))if(y)d=nn(!1,!0,u);else{const t=m?e.Identifiers.it??nn(!0,!1,u):sn(e,h);if(t instanceof qe)d=t;else{const n=sn(e,f);d=n instanceof qe?n:l[Qt(u)](t,n),e.Identifiers.it=s=t,i=o&&m&&"A missing 'it' was inferred to complete the operation."}}else if("addition"===b||"subtraction"===b)if(y)d=nn(!1,!0,u);else{let n=m;if(!m){const[e,t]=Yt(h),r=tn[e.type],a=e.type;n=("both"===r||"after"===r||"addition"===a||"subtraction"===a)&&(t===h.length-1||t===h.length-2&&Gt(h[h.length-1]))}if(n)u.type="addition"===b?"positive":"negative",d=sn(e,t),u.type=b,c=!0;else{const t=sn(e,h),n=sn(e,f);d=t instanceof qe?t:n instanceof qe?n:l[u.text](t,n)}}else if("multiplication"===b||"division"===b){const t=sn(e,h),n=sn(e,f);d=t instanceof qe?t:n instanceof qe?n:l[u.text](t,n)}else if("positive"===b||"negative"===b){let t=sn(e,f);d=t instanceof qe?t:l["*"]("negative"===b?-1:1,t),c=!0}else if("not"===b){let t=sn(e,f);d=t instanceof qe?t:l.not(t,!0)}else if("belongingProperty"===b){const r=sn(e,f,n);d=Un.create(r,u.name),d=n||d instanceof qe?d:d.get();n||d instanceof qe||(o&&r instanceof Un?an(a,{toCode:` ${u.name} of ${ut(r instanceof Un?r.get():r)} `,tokens:t,i:p}):r instanceof qe||(i=`The value to the right of 'of', ${st(r)}, had a "${u.name}" data name corresponding to that data value.`))}else if("belongingOperator"===b||"belongingItOperator"===b){const r=sn(e,h);if("random"===r&&e.freeVariables&&"object"==typeof e.freeVariables&&!e.freeVariables.seed&&(e.freeVariables.seed=Pt,e.freeVariables.seedIter=Rt),r instanceof qe)d=r;else{const i="belongingItOperator"===b?e.Identifiers.it:sn(e,f,n);d=i instanceof qe?i:Un.create(i,{computed:!0,value:r}),d=n||d instanceof qe?d:d.get(),"belongingItOperator"===b&&o&&an(a,{toCode:` ${ut(r)} of ${ut(e.Identifiers.it)} `,tokens:t,i:p})}}else if("property"===b){const r=sn(e,h,w);d=r instanceof qe?r:Un.create(r,u.name),d=n||d instanceof qe?d:d.get();n||d instanceof qe||(o&&r instanceof Un?an(a,{toCode:` ${ut(r.get())}'s ${u.name} `,tokens:t,i:p}):r instanceof qe||(i=`The value to the left of 's, ${st(r)}, had a "${u.name}" data name corresponding to that data value.`))}else if("itsProperty"===b||"belongingItProperty"===b)d=Un.create(e.Identifiers.it,u.name),d=n||d instanceof qe?d:d.get(),o&&an(a,{toCode:"itsProperty"===b?` ${ut(e.Identifiers.it)}'s ${u.name} `:` ${u.name} of ${ut(e.Identifiers.it)} `,tokens:t,i:p});else if("possessiveOperator"===b||"itsOperator"===b)if(y||m&&"itsOperator"!==u.type)d=nn(m,y,u);else{const r=sn(e,f);if(r instanceof qe)d=r;else{"random"===r&&e.freeVariables&&"object"==typeof e.freeVariables&&!e.freeVariables.seed&&(e.freeVariables.seed=Pt,e.freeVariables.seedIter=Rt);const i="itsOperator"===u.type?e.Identifiers.it:sn(e,h,n);d=i instanceof qe?i:Un.create(i,{computed:!0,value:r}),d=n||d instanceof qe?d:d.get(),"itsOperator"===b&&o&&an(a,{toCode:` ${ut(e.Identifiers.it)}'s ${ut(r)} `,tokens:t,i:p})}}else if("twineLink"===b)d=Et.run("link-goto",e,[u.innerText,u.passage]),i=o&&"Passage links are the same as (link-goto:) macro calls.";else if("macro"===b)if(u.blockedValue&&!e.blocked)d=e.blockedValue();else{const t=u.children[0],n=t.text.startsWith("$")||t.text.startsWith("_");let a;H("macroName"===t.type||n,"macro token had no macroName child token"),n?(a=Un.create(t.text.startsWith("_")?e.stackTop.tempVariables:Ga.variables,t.text.trim().slice(1,-1)),a instanceof qe||(a=a.get())):a=u.name;let s=a instanceof qe?[]:u.children.slice(1).reduce((e,t)=>("comma"===t.type?e.push([]):e[e.length-1].push(t),e),[[]]).filter(e=>e.length&&(e.length>1||!Gt(e[0]))).reduce((t,n)=>{if(t instanceof qe)return t;let a=sn(e,n,!1,r);return a instanceof qe?a:(t.push(a),t)},[]);d=a instanceof qe?a:s instanceof qe?s:(n?Et.runCustom:Et.run)(a,e,s),i=o&&n&&(a instanceof qe?"The macro was actually an error.":`I called ${it(a)}.`)}else if("grouping"===b)d=sn(e,u.children,n),c=!0;else if("comment"===b)d=sn(e,h.concat(f.slice(1)),n),c=!0;else if("error"===b)d=new qe("syntax",u.message,u.explanation||"");else{if("text"!==b)throw Error(`unknown syntax token type: ${b}!!`);{let e="";u.text.trim().match(/^\d+(?:th|nd|st|rd)(?:last)?(?:to\d+(?:nth|nd|st|rd)(?:last)?)?$/g)&&(e=`Position data names like "${u.text}" need to be either left of "of" or right of "'s".`),d=new qe("syntax",e||`"${u.text}" isn't valid Harlowe syntax for the inside of a macro call.`,"Maybe you misspelled something? Also, as of 3.3.0, Javascript syntax is not allowed inside macro calls.")}}return H(void 0!==d,`token ${b}${"name"in u?` (${u.name}:)`:""} produced undefined`),o&&!c&&an(a,{val:d,reason:i,it:s,tokens:t,i:p}),d}function cn(e,t,n=""){return`<${t}${n?` ${n}`:""}>${e}</${t}>`}const ln="text-align: center; max-width:50%; ";function un(e,t){function n(e,n,r){const a=un(e.children,t);return a&&cn(a,n,r)}let r="",a=[];if(!e)return r;Array.isArray(e)||(e=[e]);const o=e.length;for(let i=0;i<o;i+=1){let s=e[i];switch(s.type){case"include":r+=n(s,`tw-${s.type}`,`type="${s.tag}" name="${s.name}"`);break;case"error":r+=new qe("syntax",s.message||"",s.explanation).render(D(s.text))[0].outerHTML;break;case"comment":i+=1;break;case"numbered":case"bulleted":{let n="numbered"===s.type?"ol":"ul";r+=`<${n}>`;let a=1;for(;i<o&&e[i];){let o=e[i];if("br"===o.type){if(r+="</li>",!e[i+1]||e[i+1].type!==s.type)break}else if(o.type===s.type){let e="depth"in o?o.depth:0;r+=`<${n}>`.repeat(Math.max(0,e-a)),r+=`</${n}>`.repeat(Math.max(0,a-e)),r+="<li>",a=e}else r+=un([o],t);i+=1}r+=`</${n}>`.repeat(a+1);break}case"align":for(;s&&"align"===s.type;){const{align:n}=s,a=i+=1;if("left"===n){i-=1;break}for(;i<o&&e[i]&&"align"!==e[i].type;)i+=1;const c=un(e.slice(a,i),t);let l="";switch(n){case"center":l+=`${ln}margin-left: auto; margin-right: auto;`;break;case"justify":case"right":l+=`text-align: ${n};`;break;default:+n&&(l+=`${ln}margin-left: ${n}%;`)}r+=`<tw-align ${l?`style="${l}"`:""}>${c}</tw-align>\n`,s=e[i]}break;case"column":{const n=[];for(;s&&"column"===s.type;){const{column:r}=s,a=i+=1;if("none"===r){i-=1;break}for(;i<o&&e[i]&&"column"!==e[i].type;)i+=1;n.push({text:s.text,type:r,body:un(e.slice(a,i),t),width:s.width,marginLeft:s.marginLeft,marginRight:s.marginRight}),s=e[i]}if(n.length){const e=n.reduce((e,t)=>e+t.width,0);r+=`<tw-columns>${n.map(t=>`<tw-column type=${t.type}  style="width:${t.width/e*100}%; margin-left: ${t.marginLeft}em; margin-right: ${t.marginRight}em;">${t.body}</tw-column>\n`).join("")}</tw-columns>`}break}case"heading":for(r+=`<h${s.depth}>`;++i<o&&e[i];){if("br"===e[i].type){r+=`</h${s.depth}>`;break}r+=un([e[i]],t)}break;case"br":if(!a.length||/td|th/.test(a[0])){r+="<br>";let t=e[i+1];for(;t&&("br"===t.type||"tag"===t.type&&/^<br\b/i.test(t.text));)r+=`<tw-consecutive-br${"tag"===t.type?" data-raw":""}></tw-consecutive-br>`,i+=1,t=e[i+1]}break;case"hr":r+="<hr>";break;case"escapedLine":case"htmlComment":break;case"inlineUrl":r+=`<a class="link" href="${D(s.text)}">${s.text}</a>`;break;case"scriptStyleTag":case"tag":{const e=s.text.toLowerCase();/^<\/?(?:table|thead|tbody|tr|tfoot|td|th|svg)\b/.test(e)&&!s.text.endsWith("/>")&&a[s.text.startsWith("</")?"shift":"unshift"](e),r+=s.text.startsWith("</")?s.text:s.text.replace(/(\/)?>$/,(e,t)=>` data-raw${t?`></${s.text.match(/[\w-]+/)}`:""}>`);break}case"sub":case"sup":case"strong":case"em":r+=n(s,s.type);break;case"strike":r+=n(s,"s");break;case"bold":r+=n(s,"b");break;case"italic":r+=n(s,"i");break;case"twineLink":{const[e]=Ve.lex(`(link-goto:${JSON.stringify(s.innerText)},${JSON.stringify(s.passage)})`).children;r+=`<tw-expression type="macro" name="link-goto"${g.debug?` title="${D(s.text)}"`:""} code="${t.code.length}"></tw-expression>`,t.code.push(e);break}case"hook":r+=`<tw-hook ${s.hidden?"hidden ":""}${s.name?`name="${I(s.name)}"`:""}${g.debug&&s.name?` title="Hook: ?${s.name}"`:""} source="${t.source.length}"></tw-hook>`,t.source.push(s.children||[]);break;case"unclosedHook":return r+=`<tw-hook ${s.hidden?"hidden ":""}${s.name?`name="${I(s.name)}"`:""}source="${t.source.length}"></tw-hook>`,t.source.push(e.slice(i+1,o)),r;case"verbatim":r+=cn(D(s.innerText).replace(/\n/g,"<br>"),"tw-verbatim");break;case"collapsed":r+=n(s,"tw-collapsed");break;case"unclosedCollapsed":return r+=`<tw-collapsed>${un(e.slice(i+1,o),t)}</tw-collapsed>`,r;case"variable":case"tempVariable":case"macro":{const e=[],n=[];if("macro"===s.type&&function t(r){"string"!==r.type&&"hook"!==r.type&&r.children?.every(t);const a="name"in r&&"string"==typeof r.name&&I(r.name);if("macro"!==r.type||"prompt"!==a&&"confirm"!==a){if("hook"===r.type&&!r.everyLeaf(e=>"error"!==e.type||(n.push(e),!1)))return!1}else e.push(r);return!0}(s),n.length)return new qe("syntax",`This code hook's markup contained ${n.length} error${n.length?"s":""}:<br>â${n.map(e=>e.message).join("<br>â")}`).render(D(s.text))[0].outerHTML;const a=e.map(e=>(e.blockerTree=t.blockers.length,t.blockers.push(e),e.blockerTree));r+=`<tw-expression type="${s.type}" name="${D(s.name||s.text)}"${g.debug?` title="${D(s.text)}"`:""}${a.length?` blockers="${a}"`:""} code="${t.code.length}"></tw-expression>`,t.code.push(s)}break;default:r+=s.children&&s.children.length?un(s.children,t):s.text}}return r}const dn={exec(e){const t={code:[],blockers:[],source:[]};const n=un("string"==typeof e?Ve.lex(e).children:e,t),r=a(a.parseHTML(n,document,!0));return r.findAndFilter("script:not([src])").each((e,t)=>{const n=t.getAttribute("type");n&&"text/javascript"!==n.toLowerCase()||t.setAttribute("type","application/x-harlowe")}),t.blockers=t.blockers.map(e=>{e.blockedValue=!0;const t=Object.create(e);return t.blockedValue=!1,t}),r.findAndFilter("tw-expression[code]:not([data-raw]), tw-expression[blockers]:not([data-raw]), tw-hook[source]:not([data-raw])").each((e,n)=>{let r=a(n);if(r.attr("blockers")){const e=r.popAttr("blockers").split(",").map(e=>t.blockers[+e]);r.data("blockers",e)}r.attr("source")&&r.data("source",t.source[+r.popAttr("source")]),r.attr("code")&&r.data("code",t.code[+r.popAttr("code")])}),r}};Object.freeze(dn);const pn=RegExp(`${E}+`);function hn(e,t,n){const r=e.length;if(t>=r)return[];let a;const o=[a=0===t?e:e.splitText(t)];return n&&(n<=0&&(n=r-n),n<r&&o.push(a.splitText(n-t))),o}const fn=(()=>{let e;return()=>{if(void 0!==e)return e;const t=a("<p>");return t[0].normalize?(t.append(document.createTextNode("0-"),document.createTextNode("2"),document.createTextNode(""))[0].normalize(),e=1===t.contents().length):e=!1}})();function gn(e){const t=e[0],n=e.parent();if(!n.length||e.findAndFilter("tw-story").length)return null;let r=n.textNodes().filter(e=>{const n=e.compareDocumentPosition(t);return 4&n&&!(8&n)});const a=r[r.length-1];return a||gn(n)}function mn(e){const t=e[0],n=e.parent();if(!n.length||e.findAndFilter("tw-story").length)return null;const r=n.textNodes().filter(e=>{const n=e.compareDocumentPosition(t);return 2&n&&!(8&n)})[0];return r||mn(n)}const yn="tw-collapsed,[collapsing=true]";const bn=/^(=*)([^=]+)=*$/;var vn=Object.freeze({dialog:function({section:e,parent:t=h,cd:n,message:r="",defaultValue:o,buttons:i=[{name:"OK",confirm:!0,callback:Object}]}={}){let s=r instanceof ar?r.code:r;const c=a(`<tw-backdrop><tw-dialog>${o||""===o?"<input type=text style='display:block;margin:0 auto'></input>\n":""}<tw-dialog-links>${i.length?i.reduce((e,{name:t},n)=>`${e}<tw-link style='margin:0 ${n===i.length-1?"0 0 0.5em":0===n?"0.5em 0 0":"0.5em"}' tabindex=0>${t}</tw-link>`,""):`<tw-link tabindex=0>${i[0].name}</tw-link>`}</tw-dialog-links></tw-dialog></tw-backdrop>`),l=c.find("tw-dialog");if(t.append(c),e){e.renderInto(s,l,{...n,append:"prepend"});const t=n?.transition&&c.find("tw-dialog > tw-transition-container");t&&t?.length&&t.appendTo(c).append(l.prepend(t.contents().detach()))}else l.prepend(dn.exec(s));if(o){const e=c.find("input").last();e.val(`${o}`).on("keypress",({which:e})=>{13===e&&(c.remove(),i.filter(e=>e.confirm).forEach(e=>e.callback()))}),setTimeout(()=>e.focus(),100)}return i.reverse().forEach((e,t)=>{a(c.find("tw-link").get(-t-1)).on("click",()=>{g.debug&&g.ignoreClickEvents&&!a(c).is(".eval-replay, .harlowe-crash")||(c.remove(),e.callback())})}),c},realWhitespace:pn,textNodeToChars:function(e){const t=[...e.data];return 1===t.length?[e]:t.reduce((e,t)=>(t.match(pn)&&e.length&&e[e.length-1].match(pn)?e[e.length-1]+=t:e.push(t),e),[]).reduce((t,n)=>{const r=e;return n.length<e.length&&(e=e.splitText(n.length)),t.concat(r)},[])},findTextInNodes:function e(t,n){let r=[],a="",o=[];if(!t.length||!n)return o;for(;t.length>0;){r.push(t[0]),a+=t[0].data,t.shift();let e=a.indexOf(n);if(e>-1){const i=a.length-(e+n.length);for(;e>=r[0].length;)e-=r[0].length,r.shift();if(1===r.length){const a=hn(r[0],e,e+n.length);o.push(a[0]),a[1]&&t.unshift(a[1]);break}o.push(hn(r[0],e,r[0].length)[0]),o.push(...r.slice(1,-1));const s=hn(r[r.length-1],0,r[r.length-1].length-i);o.push(s[0]),s[1]&&t.unshift(s[1]),o=o.filter(Boolean);break}}return[o,...e(t,n)]},collapse:function(e){function t(e){let t=void 0!==this?this:e;return"number"==typeof t||!t||0===a(t).parentsUntil(yn).filter("tw-verbatim, tw-expression, [collapsing=false]").length}let n=gn(e);n&&!a(n).parents(yn).length&&(n=null);let r=mn(e);r&&!a(r).parents(yn).length&&(r=null);const o="br:not([data-raw]),tw-consecutive-br:not([data-raw])";e.find(o).filter(t).replaceWith(document.createTextNode(" "));const i=(e=a(e.get().map(e=>a(e).filter(t).is(o)?a(document.createTextNode(" ")).replaceAll(e)[0]:e))).textNodes();let s=0;i.reduce((e,n)=>t(n)?(n.data=n.data.replace(RegExp(`${E}+`,"g")," "),n.data.startsWith(" ")&&(!e?.data||e.data.search(/\s$/)>-1)&&(n.data=n.data.slice(1)),n):document.createTextNode("A"),n),[...i].reverse().every(e=>{if(!t(e))return!1;let n=e.data;return n.match(/^\s*$/)?(s+=n.length,e.data="",!0):(e.data=n.replace(/\s+$/,e=>(s+=e.length,"")),!1)}),s>0&&r&&(i[i.length-1].data+=" "),e[0]&&fn()&&e[0].normalize()},geomStringRegExp:bn,geomParse:function(e){if(!e)return{marginLeft:0,size:0};const t=e.length,[n,r,a]=bn.exec(e)||[];return!n||a===e&&a.length>1?{marginLeft:0,size:0}:{marginLeft:r.length/t*100,size:a.length/t*100}}});const{collapse:wn}=vn,{assign:$n,keys:kn}=Object;class xn{desc;tempVariables;finalIter;evaluateOnly;collapses;speculativePassage;blocked;dom;blockedValues;lambdaPos;lastHookShown;constructor({desc:e,tempVariables:t,finalIter:n=!1,evaluateOnly:r,collapses:a=!1,speculativePassage:o}){this.desc=e,this.finalIter=n,this.tempVariables=t,this.collapses=a,this.evaluateOnly=r,this.speculativePassage=o}}function Sn(e){const{nextSibling:t}="jquery"in e?e[0]:e;if(t&&(t instanceof Text&&!t.data.trim()||["br","tw-consecutive-br"].includes((t.tagName||"").toLowerCase()))){const{whitespace:e,nextElem:n}=Sn(t);return{whitespace:a(t).add(e),nextElem:n}}return{whitespace:a(),nextElem:a(t)}}const Tn=e=>e?.length?a("<tw-open-button replay label='ð'>").data("evalReplay",e):a(),Cn={add:[],remove:[]};class Nn{static{Object.assign(this.prototype,{typeID:"keywords",typeName:"the keywords",objectName:"the keywords",properties:["it","time","turn","turns","visit","visits","exits","exit","pos","user"]})}getProperty(e){return H(e in this&&"function"!=typeof this[e],`No Section.Identifiers value named ${e}!`),this[e]}#e;constructor(e){this.#e=e}it;get time(){return this.#e.stackTop?.evaluateOnly?new qe("operation",`'time' can't be used in ${this.#e.stackTop.evaluateOnly}.`):(Date.now()-this.#e.timestamp)*(g.debug&&void 0!==g.speedMultiplier?g.speedMultiplier:1)}get turns(){return Ga.turns}get turn(){return Ga.turns}get visits(){const{stackTop:{speculativePassage:e}}=this.#e;return Ga.history().filter(t=>t===(e||Ga.passage)).length+ +(!e||e===Ga.passage)}get visit(){return this.visits}get exits(){return this.#e.stackTop?.evaluateOnly?new qe("operation",`'exit' and 'exits' can't be used in ${this.#e.stackTop.evaluateOnly}.`):this.#e.dom.find("tw-enchantment, tw-link").filter((e,t)=>{let n=a(t);return n.data("enchantmentEvent")||n.parent().data("linkPassageName")||n.parent().data("clickEvent")}).length}get exit(){return this.exits}get pos(){return this.#e.stackTop&&!this.#e.stackTop.evaluateOnly&&this.#e.stackTop.lambdaPos?+this.#e.stackTop.lambdaPos||1:new qe("operation","'pos' can only be used in lambdas that aren't 'when' lambdas.")}get user(){return new Map([["width",window.innerWidth],["height",window.innerHeight],["orientation",window.innerWidth>window.innerHeight?"landscape":"portrait"],["hover",matchMedia("(any-hover: hover)")?.matches??!1],["motion",matchMedia("(prefers-reduced-motion: true)")?.matches?"reduced":"any"],["contrast",matchMedia("(prefers-contrast: more)")?.matches?"more":matchMedia("(prefers-contrast: less)")?.matches?"less":"any"]])}}class jn{stack=[];enchantments=[];unblockCallbacks=[];freeVariables=null;evalReplay;loadedGame=!1;constructor(e=h){$n(this,{timestamp:Date.now(),dom:e,Identifiers:new Nn(this)})}#t(e,t){let n=this.eval(t);e.append(Tn(this.evalReplay)),e.append(((e,t)=>t instanceof Xr&&/a \((go-to|undo|redirect|restart):\) command/.exec(t.typeName)?a("<tw-open-button goto label='GO'>").data("goto",{section:e,command:t}):a())(this,n)),this.stackTop.evaluateOnly&&n&&(n instanceof rr||"object"==typeof n&&"runCommand"in n&&"function"==typeof n.runCommand)&&(n=new qe("syntax",`I can't work out what ${this.stackTop.evaluateOnly} should evaluate to, because it contains a ${n instanceof rr?"changer.":"command."}`,"Please rewrite this without putting changers or commands here."));let r,o,i=e,s=a();for(;n instanceof rr;){let t;if(({whitespace:t,nextElem:i}=Sn(i)),i[0]instanceof Text&&"+"===i[0].data.trim()){let e,r=i;if(({whitespace:e,nextElem:i}=Sn(r)),i.is("tw-expression")){const o=i.popData("code")||i[0]?.cachedData?.code;i[0]?.cachedData&&(i[0].cachedData.code=void 0);const s=this.eval(o);if(s instanceof qe){n=s;break}const c=Vt["+"](n,s);a(t).add(r).add(e).remove(),n=c instanceof qe?new qe("operation",`I can't combine ${it(n)} with ${it(s)}.`,"object"==typeof s&&"run"in s&&"function"==typeof s.run?`If you want to attach this changer to ${it(s)}, remove the + between them.`:"Changers can only be added to other changers."):c;continue}}if(i.is("tw-expression")){const t=i.popData("code")||i[0]?.cachedData?.code;i[0]?.cachedData&&(i[0].cachedData.code=void 0);const a=this.eval(t);if(i.append(Tn(this.evalReplay)),a instanceof qe){n=a;break}if(a&&"object"==typeof a&&a instanceof Xr){r||=new tr,r.section=this,n=n.run(r)||a;break}return a instanceof rr?void e.replaceWith(new qe("operation",`Changers like (${n.macroName}:) need to be combined using + between them.`,"Place the + between the changer macros, or the variables holding them. The + is absent only between a changer and its attached hook or command.").render(e.attr("title"))):void e.replaceWith(new qe("operation",`${it(a)} can't have changers like (${n.macroName}:) attached.`,"Changers placed just before hooks, links and commands will attempt to attach, but in this case it didn't work.").render(e.attr("title")))}if(i.is("tw-hook")){t.remove(),s=i;break}const o=e.attr("title")||`(${n.macroName}: ...)`;return void e.replaceWith(new qe("syntax",`The (${n.macroName}:) changer should be stored in a variable or attached to a hook.`,`Macros like this should appear before a hook: ${o}[Some text]`).render(e.attr("title")))}if(s=s.length?s:Sn(e).nextElem.filter("tw-hook"),o=qe.containsError(n))e.replaceWith(o.render(e.attr("title")).append(Tn(this.evalReplay)));else if(e.attr("return",ct(n)),n instanceof Jr)e.append(n.render());else if("object"==typeof n&&"runCommand"in n&&"function"==typeof n.runCommand){r||=new tr,r.section=this;let t=n.runCommand(this,r);if(t instanceof qe)e.replaceWith(t.render(e.attr("title")));else if(t instanceof Jr)g.debug&&e.replaceWith(t.render());else if(t instanceof tr){if(t.data?.live)return void e.replaceWith(new qe("unimplemented","I currently can't attach (live:) or (event:) macros to commands - only hooks.").render(e.attr("title")));t.section=this,t.target=i,this.renderInto("",i,t)}else{if(Je(t)&&"blocked"in t&&t.blocked)return this.stackTop.blocked=t.blocked,void e.data("code",{type:"macro",blockedValue:!0,text:e.attr("title")||"",start:0,end:(e.attr("title")||"").length});H(void 0===t,`runCommand() of ${it(n)} returned ${typeof t}: ${t}`)}}else{if(s.length&&this.#n(e,n,s))return;if("string"==typeof n||"number"==typeof n||n instanceof Map||n instanceof Set||Array.isArray(n)||"object"==typeof n&&"print"in n&&"function"==typeof n.print&&!(n instanceof rr)){let t=yt(n);t instanceof qe?e.replaceWith(t.render(e.attr("title"))):(H("string"==typeof t||Array.isArray(t),"printBuiltinValue() produced a non-string non-array "+typeof t),this.renderInto(t,e))}else H(n instanceof rr||"boolean"==typeof n,`The expression evaluated to an unknown value: ${n}`)}}#r(e,t,n){const{delay:r,event:a}=n.data("live");(t=Object.setPrototypeOf({...t,append:"replace",transitionDeferred:!1,enabled:!0},tr.prototype)).data={...t.data,live:void 0};const o=n.data("originalSource")||"",{tempVariables:i}=this.stackTop;let s,c,l=r;const u=e=>{s&&(l-=(e-s)*(g.debug&&void 0!==g.speedMultiplier?g.speedMultiplier:1)),s=e,l>0?requestAnimationFrame(u):(l=r,c())};c=this.whenUnblocked.bind(this,()=>{if(!this.inDOM())return;const r=a?.filter(this,[!0],i);qe.containsError(r)?r.render(this,e.attr("title")).replaceAll(e):!a||r[0]?(this.renderInto(o,n,t,i),r||n.find("tw-expression[name='stop']").length||this.inDOM()&&requestAnimationFrame(u)):requestAnimationFrame(u)}),requestAnimationFrame(u)}#n(e,t,n){if(t&&"object"==typeof t&&t instanceof rr){const r=n.popData("source")||n[0].cachedData?.source;n[0]?.cachedData&&(n[0].cachedData.source=void 0),n.data("originalSource",r);const a=new tr({target:n,source:r,section:this,append:"append"}),o=t.run(a);o instanceof qe&&e.replaceWith(o.render(e.attr("title")));if(!this.renderInto(r,void 0,a)){const t=I(e.attr("name"));return["if","elseif","unless","else","testfalse"].includes(t)&&(e.addClass("false"),"elseif"!==t&&(this.stackTop.lastHookShown=!1)),n.data("live")&&this.#r(e,a,n),!0}}else{if(!1===t){const t=n.popData("source")||n[0].cachedData?.source;return n[0]?.cachedData&&(n[0].cachedData.source=void 0),t&&(n.data("originalSource",t),n.data("hidden",!0)),e.addClass("false"),this.stackTop.lastHookShown=!1,!0}if(!0!==t)return!1}return this.stackTop.lastHookShown=!0,!0}eval(e){if(g.debug&&g.evalReplay){const t=Array.isArray(e)?e.reduce((e,t)=>e+t.text,""):e.text||"";this.evalReplay=[{code:t,fromCode:t,basis:(Array.isArray(e)?e[0]:e).start,start:0,end:t.length,diff:0}]}let t;try{t=sn(this,e)}catch(t){return window.console?.error(t),this.evalReplay=void 0,new qe("other",`An internal error occurred while trying to run ${[].concat(e).map(e=>e.text).join("")}.`,`The error was "${t.message}".\nIf this is the latest version of Harlowe, please consider reporting a bug (see the documentation).`)}return this.evalReplay&&2===this.evalReplay.length&&this.evalReplay.shift(),t}get stackTop(){return this.stack[0]}inDOM(){return h.find(this.dom).length>0}evaluateTwineMarkup(e,t){const n=a("<p>");let r;return this.stack.unshift(new xn({desc:new tr({target:n,source:e,section:this,append:"append"}),tempVariables:this.stackTop.tempVariables||void 0,evaluateOnly:t,finalIter:!0})),this.execute(),(r=n.find("tw-error")).length>0?r:n}speculate(e,t,n){this.stack.unshift(new xn({tempVariables:new Oa(n),finalIter:!0,evaluateOnly:n,speculativePassage:t}));const{evalReplay:r}=this;let a;return this.evalReplay=void 0,e instanceof va?a=e.apply(this,{loop:void 0,pos:1}):e&&(a=sn(this,e)),this.stack.shift(),this.evalReplay=r,a}renderInto(e,t,n,r=null){const a=new tr({target:t,source:e,section:this,append:"append"});if(n)if(n instanceof rr){const e=n.run(a);if(e instanceof qe&&t)return e.render(t.attr("title")).replaceAll(t),!1}else $n(a,n);const o="function"==typeof a.target?a.target():a.target;if(H(o,"No target!"),this.stack.length>=50){if(this.stack.reduce((e,{finalIter:t})=>e+ +!!t,0)>=50)return new qe("infinite","Printing this expression may have trapped me in an infinite loop.").render(o.attr("title")).replaceAll(o),!1}if(!r){const e=o?.tag();r=new Oa("tw-hook"===e?o.attr("name")?`?${o.attr("name")}`:"an unnamed hook":"tw-expression"===e?`a ${o.attr("type")} expression`:"tw-passage"===e?"this passage":"an unknown scope","temp",this.stack.length?this.stackTop.tempVariables:null)}const i=this.stackTop?.blocked;if(a.loopVars&&kn(a.loopVars).length){let e=Math.min(...Object.values(a.loopVars).map(e=>e.length));if(new Jr(`${e} loop${1!==e?"s":""}`).render().prependTo(o),e){for(let t=e-1;t>=0;t-=1){const n=new Oa("a (for:) loop's variables","temp",r);for(let e in a.loopVars)n.variableStore[e]=a.loopVars[e][t];this.stack.unshift(new xn({desc:a,tempVariables:n,finalIter:t===e-1,evaluateOnly:this.stackTop?.evaluateOnly,collapses:"jquery"in o&&o.is("tw-hook")&&o.parents("tw-collapsed,[collapsing=true]").length>0}))}for(let t=e-1;t>=0&&!this.stackTop.blocked;t-=1)this.execute()}}else this.stack.unshift(new xn({desc:a,tempVariables:r,finalIter:!0,evaluateOnly:this.stackTop?.evaluateOnly,collapses:"jquery"in o&&o.is("tw-hook")&&o.parents("tw-collapsed,[collapsing=true]").length>0})),this.execute();return(0===this.stack.length||!i&&this.stackTop?.blocked)&&this.updateEnchantments(),a.enabled}execute(){let{desc:e,dom:t,collapses:n,evaluateOnly:r}=this.stackTop;t||(H(e,"No dom or desc!"),t=e.render(),this.stackTop.dom=t,this.stackTop.desc=void 0),t.findAndFilter('tw-hook,tw-expression,script[type="application/x-harlowe"]').each((e,t)=>{let n=a(t).data();t.cachedData={blockers:n.blockers,code:n.code,source:n.source}}).each((e,t)=>{if(this.stackTop.blocked)return!1;let{cachedData:n}=t;n&&(t.cachedData=void 0);const o=a(t);switch(o.tag()){case"tw-hook":{let e=o.popData("source")||n?.source;if(e&&o.data("originalSource",e),o.data("tempVariables",this.stackTop.tempVariables),o.popAttr("hidden")){o.data("hidden",!0);break}e&&this.renderInto(e,o);break}case"tw-expression":{const e=o.data("blockers")||n?.blockers;if(e){if(r)return void o.removeData("blockers").removeData("code").replaceWith(new qe("syntax",`I can't use a macro like (prompt:) or (confirm:) in ${r}.`,"Please rewrite this without putting such macros here.").render(o.attr("title")));if(e.length){this.stackTop.blocked=!0;let t=this.eval(e.shift());return t instanceof qe&&(this.stackTop.blocked=!1,o.removeData("blockers").replaceWith(t.render(o.attr("title")))),!1}o.removeData("blockers")}const t=o.popData("code")||n?.code;t&&this.#t(o,t);break}case"script":if(F(),!o.text())break;try{i=o.text(),s=this.stackTop.tempVariables,Function("script","$","scope","with(scope){var scope=void 0,arguments=void 0;eval([script,script=void 0][0]);}")(i,a,Object.create(null,Object.keys(Ga.variables.variableStore).map(e=>`$${e}`).concat(Object.keys(s.variableStore).map(e=>`_${e}`)).reduce((e,t)=>(t&&(e[t]={get(){const e=(t.startsWith("$")?Ga.variables.variableStore:s.variableStore)[t.slice(1)];if(!vt(e))throw new qe("datatype",`The contents of the variable ${t}, ${it(e)}, couldn't be converted to a Javascript value.`,"Only booleans, strings, numbers, datamaps, datasets and arrays can be converted to Javascript values.");return at(e)},set(e){const n=t.startsWith("$")?Ga.variables:s;if(!vt(e))throw new qe("datatype",`The Javascript value, ${e}, couldn't be converted to a Harlowe value and assigned to the variable ${t}.`,"Only booleans, strings, numbers (except NaN and Infinity), Maps, Sets and Arrays can be converted to Harlowe values.");e=at(e);let r=Un.create(n,t.slice(1));if(r instanceof qe)throw r;let a=r.set(e);if(a instanceof qe)throw a}}),e),{})))}catch(e){e instanceof qe?o.replaceWith(e.render(o.text())):(window.console?.error(e),o.replaceWith(new qe("other","A Javascript error occurred while running this <script> element.",`The error was "${e}". Check the browser console for more details.`).render(o.text())))}}var i,s}),this.stackTop.blocked||(t.length&&n&&wn(t),t.findAndFilter("tw-collapsed,[collapsing=true]").each((e,t)=>{wn(a(t))}),setTimeout(()=>t.find("input, textarea").first().focus(),100),this.stack.shift())}updateEnchantments(){this.enchantments.forEach(e=>{e.disenchant(),e.enchantScope()})}static on(e,t){return Cn[e].push(t),this}addEnchantment(e){this.enchantments.push(e),Cn.add.forEach(t=>t(this,e))}removeEnchantment(e){const t=this.enchantments.indexOf(e);this.enchantments.splice(t,1),e.disenchant(),Cn.remove.forEach(t=>t(this,e))}unblock(e){for(H(this.stack.length,"stack is empty"),this.stackTop.blocked=!1,void 0!==e&&(this.stackTop.blockedValues=(this.stackTop.blockedValues||[]).concat(e));this.stack.length&&!this.stackTop.blocked;)this.execute();if(!this.stack.length)for(;this.unblockCallbacks.length>0;){const e=this.unblockCallbacks.shift();if(e?.(),this.stackTop?.blocked)return}}whenUnblocked(e,t=e){this.stack.length&&this.stackTop.blocked?this.unblockCallbacks=this.unblockCallbacks.concat(e):t()}blockedValue(){const{stackTop:e}=this;return H(e,"stack is empty"),H(e.blockedValues?.length,"blockedValues is missing or empty"),e.blockedValues.shift()}}Object.preventExtensions(jn),Object.preventExtensions(jn.prototype);const{isArray:An}=Array,{hasOwn:En}=Object;function On(e){return!!e&&"object"==typeof e&&"computed"in e}const Dn={set:[],delete:[]},In="You can only access position strings/numbers ('4th', 'last', '2ndlast', (2), etc.), slices ('1stTo2ndlast', '3rdTo5th'), ",Mn="You can't access the '0th' or '0thlast' position of ";function Ln(e,t){if(e instanceof Map){let n=tt(e,t);return n instanceof qe?n:t}if(rt(e)){let n;if("number"==typeof t){if(0===t)return new qe("property",`You can't access elements at position 0 of ${it(e)}.`,"Only positive and negative position values exist.");if(t>0)return t-1}else{if("string"==typeof t&&(n=/^(\d+)(?:st|[nr]d|th)last$/i.exec(t)))return"0"===n[1]?new qe("property",`${Mn+it(e)}.`):-n[1];if("string"==typeof t&&(n=/^(\d+)(?:st|[nr]d|th)$/i.exec(t)))return"0"===n[1]?new qe("property",`${Mn+it(e)}.`):+n[1]-1;if("string"==typeof t&&(n=/^(?:(\d+)(?:st|[nr]d|th)(last)?|last)to(?:(\d+)(?:st|[nr]d|th)(last)?|last)$/i.exec(t))){let[,e=0,t,r=0,a]=n;return e=t?-e:+e-1,r=a?-r:+r-1,{last:r,first:e}}if("last"===t)return-1;if("random"===t)return e instanceof fa||!e.length?new qe("property",`I can't get a random value from ${it(e)}, because it's empty.`):Ga.random()*Array.from(e).length|0;if(e instanceof fa)return"string"==typeof t&&e.properties.includes(t)?t:new qe("property",`${In+A(e.properties.map(e=>`'${e}'`))} of ${it(e)}, not ${"string"==typeof t?ut(t):it(t)}.`);if("string"!=typeof t||!["length","some","all","start","end","random"].includes(t))return new qe("property",`${In}'length', 'some', 'any', 'all', 'start', 'end', and 'random' of ${it(e)}, not ${"string"==typeof t?ut(t):it(t)}.`)}}else if(e instanceof Set){if(!["length","some","all"].includes(`${t}`))return new qe("property",`${In}'length', 'some', 'any', and 'all' of ${it(e)}.`,"You can't access specific individual data values from datasets.");if("length"===t)return"size"}else if(e&&"object"==typeof e&&"properties"in e&&An(e.properties)){if(!e.properties.includes(`${t}`))return new qe("property",`${In+A(e.properties.map(e=>`'${e}'`))} of ${it(e)}, not ${"string"==typeof t?ut(t):it(t)}.`)}else if(!(e instanceof Oa||e instanceof Nn))return new qe("property",`You can't get any data values, let alone ${it(t)}, from ${it(e)}`);return t}function Rn(e,t){return t-0<0&&Math.abs(t)<=e.length?e.length+(t-0):t}class Pn{#a;determiner;determined;array;string;static{Object.assign(this.prototype,{typeID:"determiner",unstorable:!0})}get objectName(){return this.#a+it(this.determined)}toSource(){return`${this.determiner} of ${ut(this.determined)}`}get typeName(){return`${this.#a}a data structure`}print(){return`\`[${this.typeName}]\``}constructor(e,t){this.#a=`"${t} value${"some"===t?"":"s"}" of `,this.string="string"==typeof e?e:void 0,this.determiner=t,this.determined=e,this.array=[...e]}}const Vn=/[^\uD801-\uDFFF]/,Fn=new Map;function Hn(e){if(On(e)){let{value:t}=e;return t instanceof Un&&(t=t.get()),"string"==typeof t?`('${t}')`:`(${t})`}return"object"==typeof e&&"last"in e?ut(e):"number"==typeof e?N(e):`'${e}'`}function qn(e,t,n){if(e instanceof Oa){if(e.typeDefs&&t in e.typeDefs){const r=e.typeDefs[t];if(e===Ga.variables&&void 0!==Ga.definitions.getProperty(t))return new qe("operation",`I can't alter $${t}, because it was created using (define:).`,"This variable can't be changed for the rest of the story.");if(r instanceof ia&&"const"===r.name){if(void 0!==e.variableStore[t])return new qe("operation",`I can't alter ${e===Ga.variables?"$":"_"}${t} because it's been restricted to a constant value.`,"This variable can't be changed for the rest of the story.")}else if(void 0!==n&&!ft(r,n))return new qe("operation",`I can't set ${e===Ga.variables?"$":"_"}${t} to ${st(n)} because it's been restricted to ${ut(r)}-type data.`,"You can restrict a variable or data name by giving a typed variable to (set:) or (put:).")}return!0}if(An(t)){for(let n of t){let t=qn(e,n);if(t instanceof qe)return t}return!0}return e instanceof Map?"string"==typeof t||new qe("operation",`${it(e)} can only have string data names, not ${it(t)}.`):rt(e)?["length","random","some","all","start","end"].includes(t)?new qe("operation",`I can't forcibly alter the '${Hn(t)}' of ${it(e)}.`,"start"===t||"end"===t?`Alter the values at actual positions, like 1st or 2ndlast, rather than just the '${t}'.`:void 0):"object"==typeof t?new qe("operation",`I can't alter a range of positions, like ${Hn(t)}.`,"Specify each position individually using (a:), such as (a:2,3,4) instead of 2ndto4th."):+t===(0|+t)||new qe("property",`${it(e)} can only have position data names ('3rd', '1st', (5), etc.), not ${Hn(t)}.`):new qe("operation",`I can't modify ${it(e)}`,e instanceof Set?"You should use an (array:) if you need to modify the data inside this dataset.":e instanceof fa?"You should alter hooks indirectly using macros like (replace:) or (enchant:).":void 0)}function zn(e,t,n,r){const a=t;if(e instanceof Map)e.set(t,n);else if(!rt(e)||e instanceof fa||(t=Rn(e,t)),nt(e,"set"))e.set(t,n,r);else{if(!Array.isArray(e))throw Error(`Tried to set ${t} on an invalid ${typeof e}!`);e[t]=n}Dn.set.forEach(t=>t(e,a,n))}function Wn(e,t){const n=t;if(!rt(e)||e instanceof fa||(t=Rn(e,t)),An(e)&&/^(?:[1-9]\d*|0)$/.exec(`${t}`))e.splice(+t,1);else if(e instanceof Map||e instanceof Set)e.delete(t);else{if(!nt(e,"delete"))throw Error(`Tried to delete ${t} from an invalid ${typeof e}!`);e.delete(t)}Dn.delete.forEach(t=>t(e,n))}function Bn(e,t,n=t,r=!1){if(t&&"object"==typeof t&&"last"in t){if(e instanceof fa)return e.getProperty(t);const{first:n,last:r}=t;if(rt(e))return gt(e,n+ +(n>=0),r+ +(r>=0));throw Error(`Tried to get a slice (${n} to ${r}) from a non-sequential!`)}if(An(t)){if(e instanceof fa)return e.getProperty(t);let n;for(let r of t){const t=Bn(e,r,r);if(t instanceof qe)return t;n=void 0===n?t:"string"==typeof e?n+t:(Array.isArray(n)?n:[n]).concat(t)}return n}const a=function(e,t){if(void 0===e)return e;if(e instanceof Map)return e.get(t);if(!("some"!==t&&"all"!==t&&"start"!==t&&"end"!==t||e instanceof Oa))return new Pn(e,t);if("string"==typeof e)if(Fn.has(e))e=Fn.get(e);else if(Vn.test(e)){const t=[...e];Fn.set(e,t),e=t}else Fn.set(e,e);if(rt(e)&&Number.isFinite(t)&&(t=Rn(e,t)),nt(e,"getProperty"))return e.getProperty(t);if((Array.isArray(e)||"string"==typeof e)&&("number"==typeof t||"length"===t)||e instanceof Set&&"size"===t)return e[t];throw Error(`Tried to get ${t} from an invalid ${typeof e}!`)}(e,t);if(void 0===a){if(r)return a;if(e instanceof Oa){if(e instanceof Oa&&"temp"===e.type){const t="temp"===e.type;return new qe("property",`There isn't a ${t?"temp ":""}variable named ${t?"_":"$"}${n} in this place yet.`,"Temp variables only exist inside the same passage, hook, or lambda in which they're created.")}return new qe("property",`There isn't a story-wide variable named $${n} yet.`,"Story-wide variables need to be created with (set:), (put:), or (unpack:) before being used.")}if(An(e)&&"number"==typeof t)return new qe("property",`This array of ${e.length} elements doesn't have a ${Hn("number"==typeof n?n+1:n)} element.`,e.length?`It contains: ${A(e.map(it))}.`:"The array is empty.");if(e instanceof Map){const t=Array.from(e.keys());return new qe("property",`I can't find a ${Hn(n)} data name in ${it(e)}`,e instanceof Map&&t.length?`Its names include: ${A(t)}.`:void 0)}if("string"==typeof e)return new qe("property",`I can't get the ${n} character in ${it(e)}, because it is only ${e.length} characters long.`);throw Error(`Getting ${t} from ${it(e)} produced undefined!`)}return a}class Un{#o(e,t){let n=this.compiledPropertyChain.reduce((e,t)=>{if(e instanceof qe)return e;let n;if(0===e.length)n=this.object;else if(n=Bn(...e[e.length-1]),n instanceof qe)return n;return e.push([n,t]),e},[]);if(n instanceof qe)return n;let r=n.reduceRight(e,t);return r instanceof qe?r:void 0}get(){let e=this.object;for(let t=0;t<this.compiledPropertyChain.length-1;t+=1){let n=Bn(e,this.compiledPropertyChain[t]);if(H(void 0!==n,"get() returned undefined!"),n instanceof qe)return n;e=n}const t=Bn(e,this.compiledPropertyChain.slice(-1)[0],this.propertyChain.slice(-1)[0]);return H(void 0!==t,"get() returned undefined!"),t}has(){let e=this.object;for(let t=0;t<this.compiledPropertyChain.length-1;t+=1){let n=Bn(e,this.compiledPropertyChain[t],this.propertyChain[t],!0);if(void 0===n)return!1;e=n}return void 0!==Bn(e,this.compiledPropertyChain.slice(-1)[0],this.propertyChain.slice(-1)[0],!0)}set(e,t){return e instanceof qe?e:this.object instanceof Nn?new qe("operation",`I can't alter the value of the '${this.getName()}' identifier.`,"You can only alter data in variables, not fixed identifiers."):!this.object||this.object instanceof Oa?this.#o((e,[n,r],a)=>{if(e instanceof qe)return e;let o;if(H(!(e instanceof Oa),"a VarScope is being set as a value!"),o=et(e))return new qe("operation",`${it(e)} can't be stored${o===e?"":Ze(e)?` because it holds ${it(o)}`:""}.`);let i=qn(n,r,e);if(i instanceof qe)return i;if(a>0)n=at(n);else if(n instanceof Oa&&"temp"===n.type&&"string"==typeof r){let e=n;for(;e instanceof Oa&&"temp"===e.type;){if(En(e.variableStore,r)){n=e;break}e=e.parent}}if("string"==typeof n){if("string"!=typeof e)return new qe("datatype",`I can't put this non-string value, ${it(e)}, in a string.`);if(e.length!==(An(r)?r.length:1))return new qe("datatype",`${it(e)}is not the right length to fit into this string location.`);let t=[...n];const a=[...e];[].concat(r).forEach(e=>{+e<0&&(e=t.length+ +e),t=[...t.slice(0,+e),a.shift(),...t.slice(+e+1)]}),n=t.join("")}else Je(n)&&(e instanceof ta&&void 0!==e.knownName&&(""!==e.knownName&&(e=at(e)),e.knownName=ut(this)),An(r)&&rt(e)?("string"==typeof e&&(e=[...e]),r.map((t,n)=>[t,e[n]]).forEach(([e,r])=>zn(n,e,r,t))):zn(n,r,e,t));return n},e):new qe("macrocall",`I can't (set:) ${it(this)}, if the ${(it(this.object).match(/ (.+$)/)||["","value"])[1]} isn't stored in a variable.`,"Modifying data structures that aren't in variables won't change the game state at all.")}delete(){return this.#o((e,[t,n],r)=>{if(e instanceof qe)return e;H(!(e instanceof Oa),"a VarScope is being deleted!");let a=qn(t,n,e??void 0);if(a instanceof qe)return a;if(r>0&&(t=at(t)),null===e){const e="string"==typeof t;e&&(t=[...t]),An(n)?(rt(t)&&(n=[...new Set(n)]).sort((e,n)=>Rn(t,+n)-Rn(t,+e)),n.forEach(e=>Wn(t,e))):Wn(t,n),e&&(t=t.join(""))}else zn(t,n,e);return t},null)}defineType(e){const{object:t,compiledPropertyChain:n}=this;if(!(t instanceof Oa))throw Error("Tried to defineType() on a non-variable VarRef!");const r=n[0],a=t.typeDefs,o=a[r];if(o&&!dt(o,e))return new qe("operation",`I can't redefine the type of ${it(this)} to ${it(e)}, as it is already ${it(o)}.`);nt(t,"defineType")?t.defineType(r,e):a[r]=e,e instanceof ia&&"const"===e.name&&delete t.variableStore[r]}matches(e,t){return this.object===e&&this.compiledPropertyChain[0]===t}getName(){if(!(this.object instanceof Oa||this.object instanceof Nn))throw Error(`This VarRef's base is ${it(this.object)}, not a VarScope!`);return this.compiledPropertyChain[0]}static create(e,t){if(!Array.isArray(t)&&(t=[].concat(t)),e instanceof Un&&(t=e.propertyChain.concat(t),e=e.object),!("string"==typeof(n=e)||n instanceof Map||n instanceof Set||Array.isArray(n)||n instanceof Oa||nt(n,"getProperty")))return new qe("operation",`${it(e)} doesn't have data names, let alone ${Hn(t[0])}`);var n;const r=function(e,t){let n=[];for(let r=0;r<t.length;r+=1){const a=t[r];let o,i=On(a)?a.value:a;if(i instanceof Un){let e=i.get();if(e instanceof qe)return e;i=e}if(An(i)){let t=[];for(let n=0;n<i.length;n+=1)if(t[n]=Ln(e,i[n]),t[n]instanceof qe)return t[n];o=t}else o=Ln(e,i);if(o instanceof qe)return o;if(r<t.length-1){const t=Bn(e,o);if(t instanceof qe)return t;e=t}n.push(o)}return n}(e,t);return r instanceof qe?r:new Un(e,t,r)}constructor(e,t,n){this.object=e,this.propertyChain=t,this.compiledPropertyChain=n}toSource(){const e=(e,t)=>!t&&this.object instanceof Oa?e:Hn(e);return(this.object===Ga.variables?"$":this.object instanceof Oa&&"temp"===this.object.type?"_":this.object instanceof Nn?"":`${ut(this.object)}'s `)+(this.object instanceof Nn?this.propertyChain[0]:1===this.propertyChain.length?e(this.propertyChain[0]):this.propertyChain.reduce((t,n,r)=>`${t}'s ${e(n,r)}`))}static{Object.assign(this.prototype,{typeID:"varref",typeName:"a variable reference"})}get objectName(){return this.object instanceof Oa?`the ${"temp"===this.object.type?"temp ":""}variable ${this.toSource()}`:this.object instanceof Nn?`the '${this.propertyChain[0]}' keyword`:`${it(this.object)}'s ${1===this.propertyChain.length?Hn(this.propertyChain[0]):this.propertyChain.reduce((e,t)=>`${e}'s ${Hn(t)}`)}`}static on(e,t){return"function"!=typeof t||Dn[e].includes(t)||Dn[e].push(t),Un}}function _n(e,t,n=!0){let r,a=[];if(t instanceof qe)return t;if(r=t instanceof Un?t.get():t,r instanceof qe)return r;if(Array.isArray(r)&&Array.isArray(e)){let o=0,i=0;for(;o<e.length&&i<r.length;){let n=e[o],s=r[i];if(n instanceof ka&&n.datatype instanceof ia&&n.datatype.rest||n instanceof ia&&n.rest){const e=i;for(;i<r.length&&ft(n,s);)i+=1,s=r[i];n instanceof ka?n.datatype=[n.datatype]:n instanceof ia&&(n=new ia("array"));let o=_n(n,t instanceof Un?Un.create(t,{first:e+1,last:i+1}):r.slice(e,i));if(o instanceof qe)return o;a=a.concat(o)}else{let e=_n(n,t instanceof Un?Un.create(t,i+1):s);if(e instanceof qe)return e;a=a.concat(e),i+=1}o+=1}return o<e.length?n?new qe("operation",`I can't unpack this array because it needs ${e.length-o} more value${e.length-o>0?"s":""}.`):[]:a}if(e instanceof Map&&r instanceof Map){for(const[o,i]of e.entries()){if(!r.has(o))return n?new qe("operation",`I can't unpack this datamap because it needs a '${o}' data name.`):[];const e=_n(i,t instanceof Un?Un.create(t,o):r.get(o));if(e instanceof qe)return e;a=a.concat(e)}return a}if(e instanceof ka){if(e.datatype instanceof ca){let n=e.datatype.destructure(r);return n instanceof qe?n:[{dest:e,value:r,src:t}].concat(n)}if(!ft(r,e.datatype))return n?new qe("operation",`I can't put ${it(r)} into ${e.varRef.toSource()} because it doesn't match ${e.varRef.toSource()}'s datatype, ${it(e.datatype)}.`):[];let o=_n(e.datatype,r);if(o instanceof qe)return o;a=a.concat(o)}if(e instanceof Un||e instanceof ka)return a.concat({dest:e,value:r,src:t});if(e instanceof ca){const t=e.destructure(r);return t instanceof qe?t:a.concat(t)}return ft(r,e)?a:n?new qe("operation",`I tried to unpack, but ${it(e)} in the pattern didn't match ${it(r)}.`):[]}Object.freeze(Un),Object.freeze(Un.prototype);class Gn{static{Object.assign(this.prototype,{typeID:"variabletovalue",typeName:"a VariableToValue (a 'to' or 'into' expression)",objectName:"a VariableToValue (a 'to' or 'into' expression)",unstorable:!0})}toSource(){return"into"===this.operator?`${ut(this.src)} ${this.operator} ${ut(this.dest)}`:`${ut(this.dest)} ${this.operator} ${ut(this.src)}`}set(e=!1){let t,n=[];const r=_n(this.dest,this.src);if(t=qe.containsError(r))return t;if(!Array.isArray(r)||!r.length)return new qe("operation",`I can't store a new value inside ${it(this.dest)} that isn't in a variable.`,"You need a variable, or a data structure containing variables at certain positions, to store the value.");for(let{dest:a,value:o,src:i}of r.reverse()){if(a instanceof ka){let e=a.defineType();if(e instanceof qe)return e;a=a.varRef}if(t=a.set(o,this.srcRef),t instanceof qe)return t;e&&i&&i.delete(),n.unshift(`${it(a)} is now ${it(o)}`)}return n.join("; ")}constructor(e,t,n,r){Object.assign(this,{dest:e,src:t,operator:n,srcRef:r})}}Object.freeze(Gn),Object.freeze(Gn.prototype);const{exec:Xn}=dn,{assign:Yn,keys:Jn,seal:Kn,hasOwn:Qn}=Object,{isArray:Zn}=Array,er=e=>("string"==typeof e?e:e.map(e=>e.text).join("")).split(/\n/g).reduce((e,t,n,{length:r})=>e.concat(document.createTextNode(t),n!==r-1?document.createElement(t.length?"br":"tw-consecutive-br"):[]),[]);class tr{loopVars=Object.create(null);styles=[];attr=[];data={};summary(){return["source","appendSource","enabled","verbatim","target","append","newTargets","transition","transitionTime","transitionDeferred","transitionDelay","transitionSkip","transitionOrigin","innerEnchantments","enablers","output"].filter(e=>Qn(this,e)).concat([this.attr.length&&"attr",this.styles?.length&&"styles",this.loopVars&&Jn(this.loopVars).length&&"loopVars",Jn(this.data).length&&"data"].filter(Boolean))}constructor(e){e&&Yn(this,e)}update(){const{newTargets:e,transition:t,transitionDeferred:n,append:r}=this;let{target:a}=this;if("function"==typeof a&&(a=a()),!a)return;const o=e=>{if(Zn(this.styles)&&this.styles.length>0){const[t,n]=this.styles.reduce((e,t)=>(Jn(t).forEach(n=>{const r=t[n];e[+("function"==typeof r)].push({[n]:r})}),e),[[],[]]);t.forEach(t=>e.css(t)),setTimeout(()=>{n.forEach(t=>e.css(t))})}this.attr&&this.attr.forEach(t=>e.attr(t)),this.data&&e.data(this.data)};let i=a;if(Zn(e)&&e.length&&(i=e.map(e=>e.target)),Zn(i))for(let e=0;e<i.length;e+=1){let t=i[e];"jquery"in t&&o(t)}else o(i);if(t&&!n&&!r){let e,n=a;do{e=n.data("timestamp"),!e&&(n=n.parent())}while(!e&&n.length);R(a,t,this.transitionTime,this.transitionDelay,this.transitionSkip,e?Date.now()-e:0,this.transitionOrigin)}}render(){const{transition:e,transitionTime:t,transitionDeferred:n,enabled:r,enablers:o,data:i,section:s,newTargets:c,innerEnchantments:l,appendSource:u,output:d}=this,p=this.source;let{target:h,append:f}=this;if("function"==typeof h&&(h=h()),!h)return a();let g=h;if(H(f,"This ChangeDescriptor doesn't have an 'append' method chosen!"),d)return a();if(o?.length){const{descriptor:e,changer:t}=o[0],n=e.render();if(t){const e=new tr({section:s,target:n});t.run(e),e.update()}return n}if(!r||void 0!==h.attr("hidden"))return new tr({target:h,attr:this.attr.filter(e=>!("style"in e)),data:{...i,originalSource:p,hidden:!0}}).update(),a();let m=h;Zn(c)&&c.length&&(m=c),H(m,"ChangeDescriptor has source but not a target!");let y=a();if([].concat(m).filter(e=>!("jquery"in e)).map(({append:e,before:t=!1,target:n})=>({elements:n.hooks(s).filter((e,n)=>!(t&&1&n.compareDocumentPosition(document)&&2&n.compareDocumentPosition(g[0]))),append:e}),[]).forEach(({elements:e,append:t})=>{e.each((e,n)=>{let r=a(n);y=y.add(Object.setPrototypeOf({target:r,append:t,newTargets:null},this).render()),r.filter("tw-pseudo-hook").contents().unwrap()})}),y.length||Zn(m))return y;let b=f;return H(b in m||"replace"===b,`The target doesn't have a '${b}' method.`),"replace"===b&&(m[0]instanceof Text?b="replaceWith":(m.empty(),b="append")),m[0]instanceof Text&&("append"===b&&(b="after"),"prepend"===b&&(b="before")),y=p?this.verbatim?a(er(p)):Xn(p):a(p),Zn(u)&&u.forEach(({source:e,append:t})=>{const n=this.verbatim?a(er(e)):Xn(e);y="append"===t?y.add(n):"prepend"===t?n.add(y):n}),m[b](y.length?y:void 0),m.data("timestamp",Date.now()),this.update(),e&&!n&&R("replace"===f?h:y,e,t,this.transitionDelay,this.transitionSkip,this.expedite,this.transitionOrigin),l&&l.map(e=>e(m)).forEach(e=>s.addEnchantment(e)),y}}Yn(tr.prototype,{source:"",enabled:!0,verbatim:!1,append:"replace",transition:"",output:!1,timestamp:0}),Kn(tr);const nr={};class rr{static{Object.assign(this.prototype,{typeID:"changer",typeName:"a changer"})}print(){return`\`[A (${this.macroName}:) changer]\``}toSource(){return`(${this.macroName}:${"else"===this.macroName?"":this.params.map(ut)})${this.next?`+${this.next.toSource()}`:""}`}get objectName(){let e;1===this.params.length&&(e=ut(this.params[0]),e.length>36&&(e=void 0));let t=`a (${this.macroName}:${e||""}) changer`,{next:n}=this;n&&(t+=" combined with ");let r=0;for(;n&&t.length<48;){const e=`(${n.macroName}:)`;t+=(r>0&&!n.next?" and ":"")+e+(n.next?", ":""),n=n.next,r+=1}let a=0;for(;n&&a<99;)n=n.next,a+=1;return a>0&&(t+=`${r>0?" and ":""}${j(a,"other changer")}`),t}summary(){const e=new tr;return this.run(e),e.summary()}constructor(e,t=[],n,r=!0){Object.assign(this,{macroName:e,params:t,next:n,canEnchant:r})}"+"(e){const t=this.clone();let n=t;for(;n.next;)n=n.next;return n.next=e,t.canEnchant=this.canEnchant&&e.canEnchant,t}is(e){if(e instanceof rr)return this.macroName===e.macroName&&dt(this.params,e.params)&&dt(this.next,e.next)}clone(){const e=new rr(this.macroName,this.params,this.next);let t=e;for(;t.next;)t=t.next=t.next.clone();return e.canEnchant=this.canEnchant,e}run(e,t){const n="output"===this.macroName?[t||this]:this.params,r=nr[this.macroName](e,...n);if(r instanceof qe)return r;this.next&&this.next.run(e,t||this)}static register(e,t){nr[e]=t}}Object.freeze(rr),Object.freeze(rr.prototype);class ar{static{Object.assign(this.prototype,{typeID:"codehook",typeName:"a code hook",objectName:"a code hook"})}#i;toSource(){return this.#i}print(){return this.code}is(e){return e instanceof ar&&this.#i===e.#i}clone(){return new ar(this.code,this.#i)}constructor(e,t){this.code=e,this.#i=t}}Object.freeze(ar),Object.freeze(ar.prototype);const{max:or,min:ir,sin:sr,cos:cr,round:lr,atan2:ur,cbrt:dr,sqrt:pr,PI:hr,abs:fr,sign:gr}=Math,{assign:mr,create:yr}=Object,br=/^([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,vr=/^([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,wr=["r","g","b","a"],$r=yr(null);function kr(e,t,...n){if(n.length>0)return kr(kr(e,t),...n);if(!t)return e;const r=[];for(let n=0;n<e.length;n++){r[n]=[];for(let a=0;a<t[0].length;a++){let o=0;for(let r=0;r<e[0].length;r++)o+=e[n][r]*t[r][a];r[n][a]=o}}return r}function xr(e){if(e in $r)return $r[e];let t,n=a("<p>").css("background-color",e).css("background-color");return t="transparent"===n?{r:0,g:0,b:0,a:0}:n.startsWith("rgb")?(n.match(/\d+/g)||[]).reduce((e,t,n)=>(e["rgb"[n]]=+t,e),{r:0,g:0,b:0}):{r:192,g:192,b:192},$r[e]=t,t}function Sr(e){return"string"!=typeof e?e:(e=(e=e.replace("#","")).replace(br,"$1$1$2$2$3$3"),{r:parseInt(e.slice(0,2),16),g:parseInt(e.slice(2,4),16),b:parseInt(e.slice(4,6),16)})}function Tr({r:e,g:t,b:n,a:r}){const a=or(e/=255,t/=255,n/=255),o=ir(e,t,n);let i=NaN,s=0,c=(o+a)/2,l=a-o;if(0!==l){switch(s=0===c||1===c?0:(a-c)/ir(c,1-c),a){case e:i=(t-n)/l+(t<n?6:0);break;case t:i=(n-e)/l+2;break;case n:i=(e-t)/l+4}i*=60}return s<0&&(i+=180,s=Math.abs(s)),i>=360&&(i-=360),{h:lr(i),s,l:c,a:r}}const Cr=[.9642956764295677,1,.8251046025104602],Nr=[[.41239079926595934,.357584339383878,.1804807884018343],[.21263900587151027,.715168678767756,.07219231536073371],[.01933081871559182,.11919477979462598,.9505321522496607]],jr=[[3.2409699419045226,-1.537383177570094,-.4986107602930034],[-.9692436362808796,1.8759675015077202,.04155505740717559],[.05563007969699366,-.20397695888897652,1.0569715142428786]],Ar=[[1.0479298208405488,.022946793341019088,-.05019222954313557],[.029627815688159344,.990434484573249,-.01707382502938514],[-.009243058152591178,.015055144896577895,.7518742899580008]],Er=[[.9554734527042182,-.023098536874261423,.0632593086610217],[-.028369706963208136,1.0099954580058226,.021041398966943008],[.012314001688319899,-.020507696433477912,1.3303659366080753]],Or=24389/27,Dr=216/24389,Ir=e=>e.map(e=>[e]),Mr=e=>e.map(e=>e[0]),Lr=e=>e<.04045?e/12.92:((e+.055)/1.055)**2.4;function Rr({r:e,g:t,b:n}){return Mr(kr(Nr,Ir([e/255,t/255,n/255].map(Lr))))}function Pr(e){const[t,n,r]=Mr(kr(jr,Ir(e))).map(e=>{return 255*(fr(t=e)>.0031308?gr(t)*(1.055*t**(1/2.4)-.055):12.92*t);var t});return{r:t,g:n,b:r}}function Vr(e){return Mr(kr(Ar,Ir(e)))}function Fr(e){return Mr(kr(Er,Ir(e)))}function Hr(e){const t=e.map((e,t)=>e/Cr[t]).map(e=>e>Dr?dr(e):(Or*e+16)/116),n=[116*t[1]-16,500*(t[0]-t[1]),200*(t[1]-t[2])],r=180*ur(n[2],n[1])/hr;return{l:n[0]/100,c:pr(n[1]**2+n[2]**2),h:r>=0?r:r+360}}function qr({l:e,c:t,h:n}){const r=[e*=100,t*cr(n*hr/180),t*sr(n*hr/180)],a=[];a[1]=(r[0]+16)/116,a[0]=r[1]/500+a[1],a[2]=a[1]-r[2]/200;return[a[0]**3>Dr?a[0]**3:(116*a[0]-16)/Or,e>8?((e+16)/116)**3:e/Or,a[2]**3>Dr?a[2]**3:(116*a[2]-16)/Or].map((e,t)=>e*Cr[t])}function zr(e){const t=Mr(kr([[.210454268309314,.7936177747023054,-.0040720430116193],[1.9779985324311684,-2.42859224204858,.450593709617411],[.0259040424655478,.7827717124575296,-.8086757549230774]],Ir(Mr(kr([[.819022437996703,.3619062600528904,-.1288737815209879],[.0329836539323885,.9292868615863434,.0361446663506424],[.0481771893596242,.2642395317527308,.6335478284694309]],Ir(e))).map(e=>dr(e))))),n=180*ur(t[2],t[1])/hr;return{l:t[0],c:pr(t[1]**2+t[2]**2),h:n>=0?n:n+360}}function Wr({l:e,c:t,h:n}){const r=[e,t*cr(n*hr/180),t*sr(n*hr/180)];return Mr(kr([[1.2268798758459243,-.5578149944602171,.2813910456659647],[-.0405757452148008,1.112286803280317,-.0717110580655164],[-.0763729366746601,-.4214933324022432,1.5869240198367816]],Ir(Mr(kr([[1,.3963377773761749,.2158037573099136],[1,-.1055613458156586,-.0638541728258133],[1,-.0894841775298119,-1.2914855480194092]],Ir(r))).map(e=>e**3))))}function Br(e,t){const n=Pr(Fr(qr(e)));return n.a=t,n}function Ur(e,t){const n=Pr(Wr(e));return n.a=t,n}function _r(e,t,n=!0){let r=n?Ur(e,t):Br(e,t);const a=e=>(r[e]||0)>=0&&(r[e]||0)<=255;if(wr.every(a))return r;let o=(e={...e}).c,i=0;for(e.c/=2;o-i>1e-5;)r=n?Ur(e,t):Br(e,t),wr.every(a)?i=e.c:o=e.c,e.c=(o+i)/2;let s=n?Ur(e,t):Br(e,t);return s.r=ir(255,or(0,s.r)),s.g=ir(255,or(0,s.g)),s.b=ir(255,or(0,s.b)),s}class Gr{a;get c(){throw Error()}set c(e){throw Error()}static{Object.assign(this.prototype,{typeID:"colour",typeName:"a colour",objectName:"a colour",properties:["h","s","l","r","g","b","a","lch","oklch"]})}debugName(){return`a colour ${this.print()}`}"+"(e){const t=this.toRGBA(),n=e.toRGBA();return new Gr({r:ir(lr(.6*(t.r+n.r)),255),g:ir(lr(.6*(t.g+n.g)),255),b:ir(lr(.6*(t.b+n.b)),255),a:(t.a+n.a)/2})}print(){return`<tw-colour style='background-color:${this.toCSSString()}'></tw-colour>`}is(e){if(!(e instanceof Gr))return!1;if(e.oklch&&this.oklch||e.lch&&this.lch){let t=this.oklch??this.lch,n=e.oklch??e.lch;return fr(n.l-t.l)<.001&&fr(n.c-t.c)<.001&&fr(n.h-t.h)<.001&&e.a===this.a}const t=this.toRGBA(),n=e.toRGBA();return fr(n.r-t.r)<.001&&fr(n.g-t.g)<.001&&fr(n.b-t.b)<.001&&n.a===t.a}clone(){return new Gr(this)}toCSSString(){if(this.oklch){const{l:e,c:t,h:n}=this.oklch;return`oklch(${e} ${t} ${n} / ${this.a})`}if(this.lch){const{l:e,c:t,h:n}=this.lch;return`lch(${100*e} ${t} ${n} / ${this.a})`}const{r:e,g:t,b:n,a:r}=this.toRGBA();return`rgba(${e}, ${t}, ${n}, ${r})`}toHSLA(){return Tr(this.toRGBA())}toRGBA(){return this.oklch?_r(this.oklch,this.a,!0):this.lch?_r(this.lch,this.a,!1):this}toLCHA(){return this.lch?{a:this.a,...this.lch}:this.oklch?function(e,t){const n=Hr(Vr(Wr(e)));return n.a=t,n}(this.oklch,this.a):function(e,t){const n=Hr(Vr(Rr(e)));return n.a=t,n}(this,this.a)}toOKLCHA(){return this.oklch?{a:this.a,...this.oklch}:this.lch?function(e,t){const n=zr(Fr(qr(e)));return n.a=t,n}(this.lch,this.a):function(e,t){const n=zr(Rr(e));return n.a=t,n}(this,this.a)}OKLCHRotate(e){e<0&&(e=360+e);const t=this.toOKLCHA();return t.h=(t.h+e)%360,new Gr({ok:!0,...t})}getProperty(e){if("lch"===e||"oklch"===e){const t="oklch"===e?this.toOKLCHA():this.toLCHA();return new Map([["l",t.l],["c",t.c],["h",t.h]])}const t=this.toRGBA();return"h"===e||"s"===e||"l"===e?Tr(t)[e]:"r"===e||"g"===e||"b"===e||"a"===e?t[e]:void 0}toSource(){if(0===this.a)return"transparent";let e;if(this.lch)e=[this.lch.l,this.lch.c,this.lch.h];else if(this.oklch)e=[this.oklch.l,this.oklch.c,this.oklch.h];else{const t=Tr(this);if(1===t.l&&!t.h&&!t.s)return"white";if(0===t.l&&!t.h&&!t.s)return"black";if(t.l>=.5&&t.l<.5334&&0===t.s)return"gray";if(.5===t.l&&t.s>=.8&&t.s<.804){const e={0:"red",30:"orange",60:"yellow",90:"lime",120:"green",180:"cyan",210:"blue",240:"navy",270:"purple",300:"magenta"}[t.h];if(e)return e}e=[t.h,t.s,t.l]}return`(${this.oklch?"oklch":this.lch?"lch":"hsl"}:${e}${1!==this.a?`,${this.a}`:""})`}constructor(e){"string"==typeof e&&(e=(Gr.isHexString(e)?Sr:xr)(e)),"h"in e&&"s"in e&&"l"in e&&!("r"in e)&&!("g"in e)&&!("b"in e)&&(e=function({h:e,s:t,l:n,a:r}){function a(r){let a=(r+e/30)%12,o=t*ir(n,1-n);return n-o*or(-1,ir(a-3,9-a,1))}return{r:lr(255*a(0)),g:lr(255*a(8)),b:lr(255*a(4)),a:r}}(e));let t=1;"a"in e&&"number"==typeof e.a&&(t=e.a),mr(this,"h"in e&&"c"in e&&!("s"in e)&&"l"in e?{[e.ok?"oklch":"lch"]:{l:e.l,c:e.c,h:e.h}}:e),this.a=t}static isHexString(e){return"string"==typeof e&&e.startsWith("#")&&(e.slice(1).match(br)||e.slice(1).match(vr))}static mixLCH(e,t,n,r,a=!0,o="shorter"){let i=1;if(t+r!==1&&(t+r<1&&(i=t+r),[t,r]=[t/(t+r),r/(t+r)]),e.c<(a?.001:2)||e.l<.01||e.l>.99?e.h=n.h:(n.c<(a?.001:2)||n.l<.01||n.l>.99)&&(n.h=e.h),e.l*=e.a,e.c*=e.a,n.l*=n.a,n.c*=n.a,"shorter"===o)n.h-e.h>180?e.h+=360:n.h-e.h<-180&&(n.h+=360);else if("longer"===o){const t=n.h-e.h;t<180&&t>0?e.h+=360:t>-180&&t<=0&&(n.h+=360)}else"increasing"===o&&n.h<e.h?n.h+=360:"decreasing"===o&&n.h>=e.h&&(e.h+=360);let s=e.a*t+n.a*r,c=(e.l*t+n.l*r)/s,l=(e.c*t+n.c*r)/s,u=e.h*t+n.h*r;return new Gr({l:c,c:l,h:u,a:s*i,ok:a})}static mixRGB(e,t,n,r){let a=1;t+r!==1&&(t+r<1&&(a=t+r),[t,r]=[t/(t+r),r/(t+r)]),e.r*=e.a,n.r*=n.a,e.g*=e.a,n.g*=n.a,e.b*=e.a,n.b*=n.a;let o=e.a*t+n.a*r;return new Gr({r:ir(lr((e.r*t+n.r*r)/o),255),g:ir(lr((e.g*t+n.g*r)/o),255),b:ir(lr((e.b*t+n.b*r)/o),255),a:(e.a+n.a)/2*a})}static mixHSL(e,t,n,r,a="shorter"){let o=1;if(t+r!==1&&(t+r<1&&(o=t+r),[t,r]=[t/(t+r),r/(t+r)]),e.s<.02||e.l<.01||e.l>.99?e.h=n.h:(n.s<.02||n.l<.01||n.l>.99)&&(n.h=e.h),e.s*=e.a,n.s*=n.a,e.l*=e.a,n.l*=n.a,"shorter"===a)n.h-e.h>180?e.h+=360:n.h-e.h<-180&&(n.h+=360);else if("longer"===a){const t=n.h-e.h;t<180&&t>0?e.h+=360:t>-180&&t<=0&&(n.h+=360)}else"increasing"===a&&n.h<e.h?n.h+=360:"decreasing"===a&&n.h>=e.h&&(e.h+=360);let i=e.a*t+n.a*r;return new Gr({h:e.h*t+n.h*r,s:(e.s*t+n.s*r)/i,l:(e.l*t+n.l*r)/i,a:(e.a+n.a)/2*o})}}Object.freeze(Gr),Object.freeze(Gr.prototype);class Xr{#a="";#i="";attachable;unstorable;#s;get objectName(){return`a (${this.#a}:) command`}get typeName(){return`a (${this.#a}:) command`}static{this.prototype.typeID="command"}print(){return`\`[A (${this.#a}:) command]\``}toSource(){return this.#i}is(e){return ut(this)===ut(e)}clone(){return new Xr({attachable:this.attachable,storable:!this.unstorable,runFn:this.#s,name:this.#a,source:this.#i})}runCommand(e,t){return this.#s(t,e)}static create(e){return new Xr(e)}constructor({attachable:e=!0,storable:t=!0,runFn:n,name:r,source:a}){this.attachable=e,this.unstorable=!1===t,void 0!==r&&(this.#a=r),void 0!==a&&(this.#i=a),this.#s=n}name(e,t){return this.#a=e,this.#i=t,this}}Object.freeze(Xr),Object.freeze(Xr.prototype);class Yr extends Xr{get objectName(){return"a custom command"}get typeName(){return"a custom command"}typeID="customcommand";print(){return"`[A custom command]`"}clone(){return new Yr(this.#c)}runCommand(e,t){const{variables:n,hook:r,changer:a}=this.#c,o={};for(let e in n.variableStore){const t=n.variableStore[e];null!==t&&(o[e]=[t])}const i={source:r,loopVars:o,section:e},s=t?Object.assign(t,i):new tr(i);if(a){const e=a.run(s);if(e instanceof qe)return e}return s}constructor(e){let t,n=e.changer?.clone(),r=n;for(;r;){if("output"===r.macroName){if(!t){n=r=r.next;continue}t.next=r.next}t=r,r=r.next}e.changer=n,super({attachable:!0,source:e.toSource}),this.#c=e}#c;customCommand(){return this.#c}}Object.freeze(Yr),Object.freeze(Yr.prototype);class Jr{message;constructor(e){this.message=e}render(){return a("<tw-notifier>").attr("message",this.message)}}Object.preventExtensions(Jr),Object.preventExtensions(Jr.prototype);const{assign:Kr,setPrototypeOf:Qr}=Object;function Zr(e){return e instanceof ia&&e.rest}const ea=e=>(t,...n)=>{e.called+=1;const{varNames:r,params:o,body:i}=e,s=new Oa(`${e.objectName} call #${e.called}`),c=[];let l,u=0,d=!1,p="";for(let e=0;e<n.length;e+=1){const t=n[e];p=r[u],s.typeDefs[p]=Zr(o[u].datatype)?new ia("array"):o[u].datatype;const a=Un.create(s,p);if(a instanceof qe)return a;if(Zr(o[u].datatype)){d=!0;const r=(s.variableStore[p]||[]).concat([t]);if(e<n.length-1){s.variableStore[p]=r;continue}a.set(r)}else a.set(t),u+=1;c.push(new Jr(`${it(a)} is now ${it(s.variableStore[p])}`))}if(!d&&Zr(o[u]?.datatype)){const e=Un.create(s,r[u]);if(e instanceof qe)return e;e.set([]),s.typeDefs[p]=new ia("array")}let h=a("<p>").append(dn.exec(i.code)),f=t.stack.length;t.stack.unshift({tempVariables:s,dom:h,output(e){l=e}});const{evalReplay:g}=t;for(t.evalReplay=void 0,t.execute();t.stack.length>f;)t.stack.shift();t.evalReplay=g;const m=h.find("tw-error");return m.length?(h.prepend(c.map(e=>e.render()),"<br>"),new qe("propagated",`${m.length} error${m.length>1?"s":""} occurred when running ${e.objectName}.`,void 0,h)):void 0===l?new qe("custommacro",`${e.objectName} didn't output any data or hooks using (output:) or (output-data:).`):"object"==typeof l&&"changer"in l?(l.toSource=`(${e.knownName||"unnamed"}:${n.map(ut)})`,new Yr(l)):l};class ta{static{Object.assign(this.prototype,{typeID:"colour",typeName:"a custom macro",properties:["params"]})}getProperty(e){if("params"===e)return[...this.params]}print(){return`\`[${this.objectName}]\``}clone(){const e=Qr({...this},ta.prototype);return e.fn=ea(e),e}toSource(){return`(macro:${this.params.map(e=>e.toSource()).concat("")}${this.body.toSource()})`}static createFromFn(e,t,n,r){return Qr({params:[],fn:e,typeSignature:r,objectName:t,toSource:n,knownName:""},ta.prototype)}constructor(e,t){Kr(this,{params:e,called:0,varNames:e.map(e=>e.varRef.propertyChain[0]),typeSignature:e.map(e=>{let t;return t=e.datatype instanceof ia?e.datatype.toTypeSignatureObject():{pattern:"range",range:t=>ft(e.datatype,t),name:st(e.datatype)},t}),body:t,knownName:"",objectName:`a custom macro (with ${e.length?A(e.map(ut)):"no params"})`}),this.fn=ea(this)}}Object.freeze(ta),Object.seal(ta.prototype);const{floor:na,abs:ra}=Math,aa={array:Array.isArray,dm:e=>e instanceof Map,ds:e=>e instanceof Set,datatype:e=>e instanceof ia,changer:e=>e instanceof rr,colour:e=>e instanceof Gr,gradient:e=>e instanceof la,image:e=>e instanceof Ca,lambda:e=>e instanceof va,macro:e=>e instanceof ta,codehook:e=>e instanceof ar,command:e=>e instanceof Xr,str:e=>"string"==typeof e,num:e=>"number"==typeof e,bool:e=>"boolean"==typeof e},oa={...aa,even:e=>!isNaN(e)&&na(ra(e))%2==0,odd:e=>!isNaN(e)&&na(ra(e))%2==1,empty:e=>e instanceof Map||e instanceof Set?!e.size:!(!Array.isArray(e)&&"string"!=typeof e)&&!e.length,int:e=>"number"==typeof e&&e===(0|e),uppercase:e=>"string"==typeof e&&1===[...e].length&&[...e].every(e=>e!==e.toLowerCase()),lowercase:e=>"string"==typeof e&&1===[...e].length&&[...e].every(e=>e!==e.toUpperCase()),whitespace:e=>"string"==typeof e&&!!e.match(`^${E}$`),digit:e=>"string"==typeof e&&!!e.match("^\\d$"),alnum:e=>"string"==typeof e&&!!e.match(`^${O}$`),anycase:e=>"string"==typeof e&&!!e.match(`^${d}$`),linebreak:e=>"string"==typeof e&&!!e.match("^(?:\\n|\\r|\\r\\n)$"),any:()=>!0,const:()=>!0,definition:()=>!0};class ia{static{Object.assign(this.prototype,{typeID:"datatype",typeName:"a datatype"})}print(){return`\`[${this.objectName}]\``}get objectName(){return`the ${this.rest?"...":""}${this.name} datatype`}is(e){return e instanceof ia&&e.name===this.name}clone(){return this.rest?this:Object.create(this)}toSource(){return(this.rest?"...":"")+this.name}constructor(e,t=!1){this.name="datamap"===e?"dm":"dataset"===e?"ds":"number"===e?"num":"string"===e?"str":"color"===e?"colour":"boolean"===e?"bool":"alphanumeric"===e?"alnum":"integer"===e?"int":"newline"===e?"linebreak":e,this.rest=t}static from(e){const t=Object.keys(aa).find(t=>aa[t](e));return H(void 0!==t,`invalid name '${e}'!`),new ia(t)}isTypeOf(e){const{name:t}=this;return!!oa[t]&&oa[t](e)}toTypeSignatureObject(){const{name:e}=this,t={pattern:"range",range:oa[e],name:`a ${"dm"===e?"datamap":"ds"===e?"dataset":"num"===e?`${e}ber`:"str"===e?`${e}ing`:"color"===e?"colour":"bool"===e?`${e}ean`:"alnum"===e?"alphanumeric character":"int"===e?`${e}eger`:"even"===e||"odd"===e?`${e} number`:e.endsWith("case")||"whitespace"===e?`${e} character`:"empty"===e?`${e} value`:e}`};return this.rest?{pattern:"zero or more",innerType:t}:t}}Object.freeze(ia),Object.seal(ia.prototype);const{create:sa}=Object;class ca extends ia{regExp;#l;#u;insensitive(){if(this.#l.insensitive)return this;return ca.create({name:this.name,...this.#l,insensitive:!0,args:this.#l.args.map(e=>e instanceof ca&&!e.#l.insensitive?e.insensitive():e)})}typedVars(){return this.#l.args.reduce((e,t)=>{if(t instanceof ka){let n=ca.create({name:"p-ins",args:[t.datatype],insensitive:!0});e=e.concat(this.#l.insensitive?ka.create(n,t.varRef):t),t=t.datatype}return t instanceof ca&&(e=e.concat(t.typedVars())),e},[])}destructure(e){if("string"!=typeof e)return new qe("operation",`I can't put ${it(e)} into ${this.toSource()} because it isn't a string.`);const t=this.typedVars();if(!t.length)return[];const n=(RegExp(`^${this.rest?"(?:":""}${this.regExp}${this.rest?")*":""}$`).exec(e)||[]).slice(1);return n.length?n.map((e,n)=>{let r=t[n];if(r)return r.datatype instanceof ia&&r.datatype.rest&&!(r.datatype instanceof ca)&&(r=r.clone(),r.datatype=ca.create({name:"p",args:[r.datatype]})),{dest:r,value:e||"",src:void 0}}).filter(Boolean):new qe("operation",`I can't put ${it(e)} because it doesn't match the pattern ${this.toSource()}.`)}isTypeOf(e){return this.#l.canBeUsedAlone?"string"==typeof e&&!!e.match(`^${this.rest?"(?:":""}${this.regExp}${this.rest?")*":""}$`):new qe("operation",`A (${this.name}:) datatype must only be used with a (p:) macro.`)}toTypeSignatureObject(){return{pattern:"range",name:this.name,range:e=>this.isTypeOf(e)}}toSource(){return`${this.rest?"...":""}(${this.name}:${this.#u})`}clone(){return ca.create({name:this.name,...this.#l})}get objectName(){return`a (${this.name}:) datatype`}constructor(e,t,n,r){super(e),this.regExp=t,this.#l=r,this.#u=n}static create(e){const{name:t,args:n,fullArgs:r=n,makeRegExpString:a=e=>e.join(""),insensitive:o=!1,canContainTypedVars:i=!0,canBeUsedAlone:s=!0,canContainTypedGlobals:c=!0}=e,p=sa(null),h=n.map(function e(n){if(n instanceof ka){if(!i)return new qe("operation",`Optional string patterns, like (${t}:)${"p-many"===t?" with a minimum of 0 matches":""}, can't have typed variables inside them.`);if(!(c||n.varRef.object instanceof Oa))return new qe("operation",`Only typed temp variables can be used in patterns given to (${t}:)`);const r=n.getName();if(r in p)return new qe("operation",`There's already a typed temp variable named _${r} inside this (${t}:) call.`);p[r]=!0;const a=e(n.datatype);return a instanceof qe?a:`(${a})`}if(n instanceof ia){if((!i||!c)&&n instanceof ca){const e=n.typedVars();if(!i&&e.length)return new qe("operation",`(${t}:) can't have typed variables inside its pattern.`);if(!c&&e.some(e=>e.varRef.object instanceof Oa&&"global"===e.varRef.object.type))return new qe("operation",`Only typed temp variables can be used in patterns given to (${t}:)`)}if(n instanceof ca&&n.regExp)return(n.rest?"(?:":"")+(o?n.insensitive().regExp:n.regExp)+(n.rest?")*":"");const e=n.name,r=n.rest?"*":"";return"alnum"===e?O+r:"whitespace"===e?E+r:"uppercase"===e?(o?d:l)+r:"lowercase"===e?(o?d:u)+r:"anycase"===e?d+r:"digit"===e?`\\d${r}`:"linebreak"===e?`(?:\\r|\\n|\\r\\n)${r}`:"str"===e?".*?":["even","odd","int","num"].includes(e)?new qe("datatype",`Please use string datatypes like 'digit' in (${t}:) instead of number datatypes.`):new qe("datatype",`The (${t}:) macro must only be given string-related datatypes, not ${it(n)}.`)}if("string"==typeof n)return n=n.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&"),o&&(n=n.replace(RegExp(`(${l}|${u})`,"g"),e=>`[${e.toUpperCase()}${e.toLowerCase()}]`)),n;throw Error(`given a non-string non-datatype pattern: ${n}`)});for(let e of h)if(e instanceof qe)return e;return new ca(t,a(h),`${r.map(ut)}`,{insensitive:o,canContainTypedVars:i,canBeUsedAlone:s,canContainTypedGlobals:c,makeRegExpString:a,args:n})}}Object.freeze(ca),Object.seal(ca.prototype);class la{static{Object.assign(this.prototype,{typeID:"gradient",typeName:"a gradient",objectName:"a gradient",properties:["angle","stops"]})}debugName(){return`a gradient ${this.print()}`}getProperty(e){return"angle"===e?this.angle:"stops"===e?this.stops.map(e=>new Map([[this.repeating?"pixels":"percent",e.stop],["colour",e.colour.clone()]])):void 0}toSource(){return`(gradient:${this.angle},${this.stops.map(e=>`${ut(e.stop)},${ut(e.colour)}`)})`}is(e){return e instanceof la&&e.angle===this.angle&&e.stops.length===this.stops.length&&e.stops.every(({colour:e,stop:t},n)=>this.stops[n].stop===t&&this.stops[n].colour.is(e))}clone(){return new la(this.angle,[...this.stops])}print(){return`<tw-colour style='background:${this.toLinearGradientString()}'></tw-colour>`}constructor(e,t,n=!1){Object.assign(this,{angle:e,stops:t,repeating:n})}multiply(e){return new la(this.angle,this.stops.map(({colour:t,stop:n})=>({colour:t,stop:n instanceof xa?n["*"](e):n*e})))}toLinearGradientString(){return`${this.repeating?"repeating-":""}linear-gradient(${this.angle}deg, ${this.stops.reduce((e,{colour:t,stop:n})=>`${e+t.toCSSString()} ${n instanceof xa?n.toCSSString():n*(this.repeating?1:100)+(this.repeating?"px":"%")},`,"").slice(0,-1)})`}}Object.freeze(la),Object.freeze(la.prototype);const{textNodeToChars:ua,realWhitespace:da,findTextInNodes:pa}=vn;function ha(e){if(!e)return[];const{selector:t,property:n,next:r}=e;return[JSON.stringify(["base"===t.type?ha(t.data):I(t.data),n]),...ha(r)].sort()}class fa{#d(e){const{dom:t}=e;let n=a();this.next&&(n=n.add(this.next.#d(e)));const r=(e,t)=>{if(Array.isArray(t))return t.reduce((t,n)=>t.add(e.get(n)||""),a());if("object"==typeof t){let{first:n,last:r}=t;const{length:o}=e;n<0&&(n+=o),r<0&&(r+=o);let i=[e.get(n)];for(;n!==r;)n+=Math.sign(r-n),i.push(e.get(n));return a(i)}if("string"==typeof t){if("chars"===t){let t=[];for(let n of e.textNodes(":not(tw-error, tw-error *)"))for(let e of ua(n))e.data.match(da)||t.push(e);return a(t)}if("links"===t)return e.findAndFilter("tw-link, .enchantment-link");if("visited"===t)return e.findAndFilter("tw-link.visited");if("lines"===t){const t=e.findAndFilter("br:not(tw-sidebar *),tw-consecutive-br:not(tw-sidebar *)").get();let n=[[]];e.contents().each(function e(r,o){const i=("tagName"in o&&o.tagName||"").toLowerCase();if("tw-sidebar"!==i)if("tw-passage"!==i&&"tw-transition-container"!==i){if(t.length){if(o===t[0])return t.shift(),void n.push([]);if(16&o.compareDocumentPosition(t[0]))return n.push([]),a(o).contents().each(e),void n.push([])}n[n.length-1].push(o)}else a(o).contents().each(e)});return a(n.map(e=>!!e.length&&a(e).wrapAll("<tw-pseudo-hook>").parent()[0]).filter(Boolean))}throw Error(`Invalid HookSet index ${t}!`)}return void 0===t?e:a(e.get(t))};if(this.selector){let o;if("string"===this.selector.type)o=function(e,t){const n=pa(t.textNodes(),e);let r=a();return n.forEach(e=>{r=r.add(a(e).wrapAll("<tw-pseudo-hook>").parent())}),r}(this.selector.data,t);else{if("base"===this.selector.type)return n.add(r(this.selector.data.#d(e),this.property));{const e=function(e){let t=`tw-hook[name="${e=I(e).replace(/"/g,"&quot;")}"],tw-enchantment[name="${e}"]`;return t+={page:", tw-story",passage:", tw-passage",sidebar:", tw-sidebar",link:", tw-link, .enchantment-link"}[e]||"",t}(this.selector.data);o=t.findAndFilter(e).add(t.parentsUntil(h.parent())).filter(e)}}n=this.property?n.add(r(o,this.property)):n.add(o)}return n=n.get().reduce((e,t)=>{let n=a(t);return e.add(n.is("tw-enchantment")&&n.contents().length<=1?n.contents():n)},a()),n}forEach(e,t){const n=this.#d(e).each((e,n)=>t(a(n),e));return e.dom.findAndFilter("tw-pseudo-hook").contents().unwrap(),n}hooks(e){return this.#d(e)}static{Object.assign(this.prototype,{typeID:"hookName",typeName:"a hook name (like ?this)",properties:["chars","links","lines","visited"],unstorable:!0})}get objectName(){return`the hook name ${this.toSource()}`}toSource(){let e="";const{type:t,data:n}=this.selector;return"name"===t?n.match(RegExp(`^${O}+$`))?e+=`?${n}`:e+=`(hooks-named:${JSON.stringify(n)})`:"string"===t?e+=JSON.stringify(n):"base"===t&&(e+=`${n.toSource()}'s ${ut(this.property,"property")}`),this.next&&(e+=` + ${this.next.toSource()}`),e}"+"(e){const t=this.clone();let n=t;for(;n.next;)n=n.next;return n.next=e,t}is(e){return`${ha(this)}`==`${ha(e)}`}getProperty(e){return new fa({type:"base",data:this},e,void 0)}clone(){return new fa(this.selector,this.property,this.next)}constructor(e,t,n){Object.assign(this,{selector:Object.freeze(e),property:t,next:n})}static from(e){return e instanceof fa?e:new fa({type:"string",data:e})}}Object.freeze(fa),Object.freeze(fa.prototype);const{setPrototypeOf:ga,assign:ma,freeze:ya}=Object;function ba(e,t,n){if(t)if(t instanceof ka){const r=Un.create(e,t.varRef.propertyChain);if(r instanceof qe)return r;let a=r.defineType(t.datatype);if(a instanceof qe)return a;if(a=r.set(n),a instanceof qe)return a}else e.set(t.getName(),n)}class va{source;loop;static{Object.assign(this.prototype,{typeID:"lambda",typeName:"a lambda"})}get objectName(){return`a "${"making"in this?"making ... ":""}${"each"in this?"each ... ":""}${"where"in this?"where ... ":""}${"when"in this?"when ... ":""}${"via"in this?"via ... ":""}" lambda`}print(){return"`[A lambda]`"}is(e){return e===this}toSource(){return this.source}static TypeSignature(...e){return{pattern:"lambda",innerType:va,clauses:e,typeName:`a "${e.concat("").join(" ...")}" lambda`}}clone(){return ga({...this},va.prototype)}static#p(e){const t=e instanceof ka?e.varRef:e;return void 0===t||t&&t instanceof Un&&t.object instanceof Oa&&"temp"===t.object.type&&1===t.propertyChain.length}static create(e,t,n,r){const a="temp variable, or typed temp variable";if(qe.containsError(e))return e;if("making"===t&&!va.#p(n))return new qe("syntax",`I need a ${a}, to the right of '${t}', not ${it(n)}.`);if(e instanceof va){if("when"===t||"when"in e)return new qe("syntax",`A 'when' lambda cannot have any other clauses, such as '${t}'.`);if(t in e)return new qe("syntax",`This lambda has two '${t}' clauses.`)}else{if("when"===t&&void 0!==e)return new qe("syntax","A 'when' lambda shouldn't begin with a temp variable (just use 'when' followed by the condition).");if(!va.#p(e))return new qe("syntax",`This lambda needs to start with a single ${a}, not ${it(e)}.`)}const o=e instanceof va?e.loop?.getName():e?.getName()||"";return"making"===t&&(n instanceof Un||n instanceof ka)&&n.getName()===o?new qe("syntax",`This lambda has two variables named '${n.getName()}'.`,"Lambdas should have all-unique parameter names."):new va(e,t,n,r)}constructor(e,t,n,r){e instanceof va?ma(this,e):this.loop=e,this.source=r.trim(),this[t]=n}apply(e,{loop:t,pos:n,making:r,ignoreVia:a=!1,tempVariables:o}){if(this.making&&void 0===r||this.loop&&void 0===t){let e=this.loop?"loop":"making";throw Error(`"${e}" lambda was given no ${e}Arg: ${this.toSource()}`)}if(o||=new Oa("this lambda's temp variables","temp",e.stack.length?e.stackTop.tempVariables:null),this.loop&&et(t))throw Error(`Loop lambda was given an unstorable value ${it(t)}`);let i=this.loop&&ba(o,this.loop,t);if(i instanceof qe)return i;if(i=this.making&&ba(o,this.making,r),i instanceof qe)return i;e.stack.unshift(ga({tempVariables:o,lambdaPos:this.when?void 0:n},e.stackTop||null)),void 0===t||this.making||this.when?e.Identifiers.it=new qe("operation",`I can't use 'it', or an implied 'it', in ${this.objectName}`):e.Identifiers.it=t;const s=!a&&this.via,c="where"in this||"when"in this,{evalReplay:l}=e;let u,d,p,h;var f,g,m;if(e.evalReplay=l?[]:void 0,c?(d=e.eval(this.where||this.when),p=e.evalReplay,e.evalReplay=p&&s?[]:void 0,!t||this.making||this.when||(e.Identifiers.it=t),f=d,g=!s||e.eval(s),m=null,u=f instanceof qe?f:"boolean"!=typeof f?new qe("operation",`This lambda's 'where' clause must evaluate to true or false, not ${it(f)}.`):f?g:m):d=u=!s||e.eval(s),h=s?e.evalReplay:void 0,e.stack.shift(),e.evalReplay=l,l&&(c||s)){let e=l[l.length-1];if(!e.lambda||e.lambda?.obj!==this){const t=l[l.length-1]?.code||"";e={lambda:{obj:this,loops:[]},code:t,fromCode:t,start:0,end:t.length,diff:0},l.push(e)}e.lambda.loops.push({it:t,pos:n,...void 0!==r&&{making:r},...s&&{viaReplay:h,viaResult:u},...c&&{whereReplay:p,whereResult:null!==d&&d}})}return u}filter(e,t,n){return t.reduce((t,r,a)=>{if(t instanceof qe)return t;const o=this.apply(e,{loop:r,pos:a+1,ignoreVia:!0,tempVariables:n});return o instanceof qe?o:t.concat(o?[r]:[])},[])}}ya(va),ya(va.prototype);const{freeze:wa,assign:$a}=Object;class ka{static{Object.assign(this.prototype,{typeID:"typedvar",typeName:"a TypedVar (typed variable name)",unstorable:!0,properties:["datatype","name"]})}get objectName(){const e=ut(this.datatype);return`the ${e.length<24?`${e}-`:""}typed variable name, ${this.varRef.toSource()}`}print(){return"`[A typed variable name]`"}clone(){return new ka(at(this.datatype),this.varRef)}toSource(){return`${ut(this.datatype)}-type ${this.varRef.toSource()}`}getProperty(e){return"name"===e?this.getName():this.datatype}isTypeOf(e){return ft(this.datatype,e)}toTypeSignatureObject(){return this.datatype instanceof ia?this.datatype.toTypeSignatureObject():{pattern:"matches",value:this.datatype}}get(){return this.varRef.get()}getName(){return this.varRef.getName()}defineType(){if(this.datatype instanceof ia&&"any"!==this.datatype.name)return this.varRef.defineType(this.datatype)}static create(e,t){let n;if(n=qe.containsError(e)||t.error)return n;if(t instanceof qe)return t;if(!(t instanceof Un))return new qe("syntax","The -type syntax must have a variable to its right.");const{object:r,compiledPropertyChain:a}=t;if(!(r&&r instanceof Oa&&1===a.length&&r.typeDefs))return new qe("unimplemented","I can only restrict the datatypes of variables, not data names or anything else.");const o=et(e);return!o||o instanceof ka?new ka(e,t):new qe("syntax",`The -type syntax can't have ${st(o)} to its left.`)}constructor(e,t){$a(this,{datatype:e,varRef:t})}}wa(ka),wa(ka.prototype);class xa{static{Object.assign(this.prototype,{typeID:"measure",typeName:"a measurement"})}get objectName(){return`a ${this.toSource()} measurement`}static Units=["em","px","rem","w","h","Lh"];toSource(){const{left:e,right:t,operator:n,value:r,unit:a,mult:o}=this;return e&&t?void 0!==o?`(${e.toSource()} ${n} ${t.toSource()}) * ${o}`:`${e.toSource()} ${n} ${t.toSource()}`:void 0!==o?`(${r}${a} * ${o})`:`${r}${a}`}print(){return this.toSource()}is(e){return e instanceof xa&&e.unit===this.unit&&e.value===this.value&&e.operator===this.operator&&e.mult===this.mult&&(e.left?e.left.is(this.left):!this.left)&&(e.right?e.right.is(this.right):!this.right)}#h(){const{left:e,right:t,operator:n,value:r,unit:a,mult:o}=this;return e&&t?void 0!==o?`(${e.toCSSString()} ${n} ${t.toCSSString()}) * ${o}`:`(${e.toCSSString()} ${n} ${t.toCSSString()})`:`${r}${"w"===a||"h"===a?"%":a}`}toCSSString(){return this.left&&this.right?`calc(${this.#h()})`:this.#h()}constructor(e,t,n,r,a,o){this.value=e,this.unit=t.toLowerCase().replace("lh","Lh"),n&&(this.mult=n),r&&(this.left=r),a&&(this.right=a),o&&(this.operator=o)}clone(){return new xa(this.value,this.unit,this.mult,this.left,this.right,this.operator)}pxLengthInElement(e,t=!1){return this.left&&this.right?this.left.pxLengthInElement(e,t)+this.right.pxLengthInElement(e,t)*("-"===this.operator?-1:1)*(this.mult??1):"em"===this.unit?+getComputedStyle(e).fontSize.replace("px","")*this.value:"rem"===this.unit?+getComputedStyle(document.documentElement).fontSize.replace("px","")*this.value:"Lh"===this.unit?+getComputedStyle(e).lineHeight.replace("px","")*this.value:"h"===this.unit?(e.scrollHeight-(t?e.clientHeight:0))*(this.value/100):"w"===this.unit?(e.scrollWidth-(t?e.clientWidth:0))*(this.value/100):this.value}"+"(e){return this.left||this.right||e.left||e.right||e.unit!==this.unit?new xa(0,"px",void 0,this,e,"+"):new xa(this.value+e.value,this.unit)}"-"(e){return this.left||this.right||e.left||e.right||e.unit!==this.unit?new xa(0,"px",void 0,this,e,"-"):new xa(this.value-e.value,this.unit)}"*"(e){if(!this.left&&!this.right)return new xa(this.value*e,this.unit);let t=this.clone();return t.mult=(this.mult??1)*e,t}"/"(e){if(!this.left&&!this.right)return new xa(this.value/e,this.unit);let t=this.clone();return t.mult=(this.mult??1)/e,t}containsUnits(...e){const{left:t,right:n,unit:r}=this;return t?.containsUnits(...e)||n?.containsUnits(...e)||e.includes(r)}}class Sa{left;centre;right;static{Object.assign(this.prototype,{typeID:"sizing",typeName:"a sizing"})}get objectName(){return`a (${this.left.toSource()}-${this.centre.toSource()}-${this.right.toSource()}) measurement`}constructor(e,t,n){this.left=e,this.centre=t,this.right=n}}Object.freeze(xa),Object.freeze(xa.prototype),Un.on("set",(e,t)=>{e instanceof Oa&&h.find("[data-2bind]").each((n,r)=>{let o=a(r);const i=o.data("twoWayBindEvent");"function"==typeof i&&i(o,e,t)})});class Ta{static{Object.assign(this.prototype,{typeID:"varbind",typeName:"a VarBind (bound variable name)",unstorable:!0})}get objectName(){return`a ${this.bind} bind to ${this.varRef.toSource()}`}print(){return"`[A bound variable name]`"}toSource(){return`${"two way"===this.bind?"2":""}bind ${this.varRef.toSource()}`}set(e){const t=this.varRef.set(e);if(t instanceof qe)return t}static create(e,t="one way"){if(e instanceof qe)return e;const n="Use 'bind' with variables like $this, or temp variables like _this.";return e instanceof Un?e.error?e.error:e.object instanceof Nn?new qe("operation","I can't 'bind' identifiers, only variables.",n):new Ta(e,t):new qe("operation",`I can only 'bind' a variable, not ${it(e)}.`,n)}constructor(e,t){Object.assign(this,{varRef:e,bind:t})}}Object.freeze(Ta),Object.freeze(Ta.prototype);class Ca{static{Object.assign(this.prototype,{typeID:"image",typeName:"an image",objectName:"an image",properties:["loaded","failed"]})}getProperty(e){return"loaded"===e?!!this.loaded:"failed"===e?!!this.failed:void 0}urls;fallback;loaded;failed;#f;knownName;toSource(){return this.knownName??`(image:${ut(this.urls)}${this.fallback?`, ${ut(this.fallback)}`:""})`}clone(){return this}print(){return this.loaded?`<img src='${this.loaded}'></img>`:this.fallback?.print()||""}fallbackCSS(){let{fallback:e}=this;return e?e instanceof la?e.toLinearGradientString():e.toCSSString():""}constructor(e,t){this.urls=e,this.fallback=t,this.failed=!1,this.loaded=!1,this.#f=!1}async#g(){let e=this.urls.slice();for(;e.length>0;){let t=e.shift();try{this.#f=!0;let e=await window.fetch(t);try{let t=await e.blob();return this.loaded=URL.createObjectURL(t),this.failed=!1,h.find("[data-img-fallback]").each((e,t)=>{const n=$(t),r=n.data("imageLoadEvent");"function"==typeof r&&r(n,this)}),!0}catch(e){this.failed=`The image file at "${t}" couldn't be decoded.`}}catch(e){this.failed=`The image URL "${t}" failed to resolve.`}}return!1}static loadAssets(){for(let e of Object.values(Ga.definitions.variableStore))e instanceof Ca&&!e.#f&&e.#g()}}const{collapse:Na}=vn;class ja{enchantments=a();constructor(e){Object.assign(this,{enchantments:a()},e)}enchantScope(){const{data:e,functions:t,section:n}=this;let{scope:r,localHook:o,lambda:i}=this,s=[],c=0;r.forEach(n,(l,u)=>{if(o){o="jquery"in o?o:o.hooks(n);const e=l.find(o);if(e.length)l=e;else if(!o.has(l[0]).length)return}if(l.is(":empty")&&!l.data("source")?.length)return;let d;c+=1,i?(d=i.apply(n,{loop:r.getProperty(u),pos:c}),d instanceof qe?(l.replaceWith(d.render()),i=d=void 0):d instanceof rr?d.canEnchant||(l.replaceWith(new qe("macrocall",`The lambda "${ut(i)}" can't be or include a revision, enchantment, or interaction changer like (replace:), (click:), or (link:).`).render()),i=d=void 0):(l.replaceWith(new qe("macrocall",`The lambda "${ut(i)}" must return a changer, not ${it(d)}.`).render()),i=d=void 0)):d=this.changer;const p=!e&&(!d||d.summary().every(e=>e.startsWith("transition"))),f=p?l:l.wrap("<tw-enchantment>").parent();if(e&&f.data(e),t&&t.forEach(e=>e(f)),d){const e=new tr({section:n,target:f});if(d.run(e),e.update(),l.is(h)){const t=Object.keys(Object.assign({},...e.styles??[]));l.css(t.reduce((e,n)=>("background-color"===n||"background-image"===n?(e["background-color"]="transparent",e["background-image"]="none",t.push("background-"+("background-color"===n?"image":"color"))):e[n]="inherit",e),{})),f.data({enchantedProperties:t})}else if(l.is("tw-passage")&&e.styles?.some(e=>"margin-left"in e||"margin"in e||"margin-right"in e)){const e="padding-left",t="padding-right";h.css(e,"0px").css(t,"0px"),f.data({enchantedProperties:[e,t]})}}l.is(h)&&f.css({"min-width":"100%","min-height":"100%"}),"true"===f.attr("collapsing")&&(f.find("[collapsing=false]").each(function(){a(this).removeAttr("collapsing")}),Na(f)),p||s.push(f)}),this.enchantments=a(s)}disenchant(){this.enchantments.each((e,t)=>{let n=a(t);n.contents().unwrap();const r=n.data("enchantedProperties");r&&h.css(r.reduce((e,t)=>(e[t]="",e),{}))})}}Object.freeze(ja),Object.freeze(ja.prototype);const{lex:Aa}=Ve,{create:Ea}=Object;class Oa{get objectName(){return this.name}typeDefs=Object.create(null);name;type;parent;variableStore;valueRefs;delete(e){this.variableStore[e]=null,delete this.typeDefs[e]}set(e,t){this.variableStore[e]=t}getProperty(e){const t=this.variableStore[e];return null===t?void 0:t}defineType(e,t){this.typeDefs[e]=t}constructor(e,t="temp",n=null){this.name=e,this.type=t,this.variableStore=Ea(n instanceof Oa?n.variableStore:null),n instanceof Oa&&(this.parent=n)}flatten(e){let t={};for(let n of e){for(let e in n.typeDefs)this.typeDefs[e]||=n.typeDefs[e];for(let e in n.variableStore)if(!(e in this.variableStore)&&(null===n.variableStore[e]&&(t[e]=!0),!t[e])){this.variableStore[e]=n.variableStore[e];const t=n.valueRefs?.[e];n.valueRefs&&t&&!("via"in t)&&(n.valueRefs[e]||=t)}}for(let e in this.valueRefs){const t=this.valueRefs[e];t&&"via"in t&&delete this.valueRefs[e]}}#m(){const e=this.variableStore,t={};for(const n in e){const r=e[n];if(r instanceof Yr){const e=r.customCommand();t[n]={changer:e.changer?ut(e.changer):"",toSource:e.toSource,hook:ut(e.hook),variables:e.variables.serialise()}}else this.valueRefs&&n in this.valueRefs?t[n]={...this.valueRefs[n]}:t[n]=null===r?null:ut(r)}return t}serialise(){const e={};for(let t in this.typeDefs)e[t]=ut(this.typeDefs[t]);return{typeDefs:e,values:this.#m()}}static deserialise(e="a past turn's variables",t="global",n,r,a){let o=new Oa(e,t),{values:i,typeDefs:s}=n;const c=`The variables on turn ${r.length+1} couldn't be reconstructed. `;for(let e in i){let t=i[e];if(null!==t)if("object"==typeof t&&"changer"in t){const n=""===t.changer?void 0:a.eval(Aa(t.changer,"","macro"));if(void 0!==n&&!(n instanceof rr))throw new q(`${c}This custom command's (output:)-attached changers couldn't be recreated: ${t.toSource}`);const i=a.eval(Aa(t.hook,"","macro"));if(i instanceof qe)throw new q(`${c}This custom command's hook couldn't be recreated: ${t.toSource}`);const s=new Yr({changer:n,hook:i,variables:Oa.deserialise("a custom command's variables","temp",t.variables,r,a),toSource:t.toSource});if(s instanceof qe)throw new q(`${c}This custom command couldn't be recreated: ${t.toSource}`);o.variableStore[e]=s}else if("object"==typeof t){const n=_t.dereference(e,t,r,a);if(n instanceof qe)throw new q(`${c}An error was produced when recreating a variable from a reference: ${n.message}`);o.variableStore[e]=n,(o.valueRefs||=Object.create(null))[e]=new _t(t)}else{const n=a.eval(Aa(t,"","macro"));if(n instanceof qe)throw new q(`${c}An error was produced when recreating a variable from a reference: ${n.message}`);let r;if(r=et(t))throw new q(`${c}A value was recreated that can't be stored in a variable: ${it(r)}`);o.variableStore[e]=n}}for(let e in s){const t=a.eval(Aa(s[e],"","macro"));if(t instanceof qe)throw new q(`${c}An error was produced when recreating a variable's datatype: ${t.message}`);let n;if(n=et(t))throw new q(`${c}A variable's datatype was recreated that can't be stored in a variable: ${it(n)}`);o.typeDefs[e]=t}return o}}class Da{value;static{Object.assign(this.prototype,{typeID:"spreader",typeName:"a spreaded '...' value",unstorable:!0})}get objectName(){return j("string"==typeof this.value||Array.isArray(this.value)?[...this.value].length:1,"spreaded '...' value")}toSource(){return`${"string"==typeof this.value||Array.isArray(this.value)?[...this.value].map(ut):`...${ut(this.value)}`}`}static create(e){if(e instanceof qe)return e;if(e instanceof ka||e instanceof ia){const t=at(e);return(t instanceof ka?t.datatype:t).rest=!0,t}return Array.isArray(e)||"string"==typeof e||e instanceof Set?new Da(e):new qe("operation",`I can't spread out ${it(e)}, because it is not a string, dataset, or array.`)}constructor(e){this.value=e}}class Ia{passage="";variables;constructor(e="",t=new Oa("a past turn's variables","global")){this.passage=e,this.variables=t}flatten(e){const t=[];this.forgetVisits=0,this.turns=0,this.pastVisits=[];for(let n=e.length-1;n>=0;n-=1){const r=e[n];for(let e of["mockVisits","mockTurns","seed","seedIter"])e in r&&void 0===this[e]&&(this[e]=r[e]);r.forgetVisits&&(this.forgetVisits=Math.max(this.forgetVisits,r.forgetVisits)),void 0!==r.turns&&(this.turns+=r.turns),n!==e.length-1&&(void 0!==e[n+1].visits&&Array.isArray(this.pastVisits[0])?this.pastVisits[0].unshift(r.passage):this.pastVisits.unshift(r.passage)),void 0!==r.pastVisits&&this.pastVisits.unshift(...r.pastVisits),void 0!==r.visits&&this.pastVisits.unshift(r.visits),t.push(r.variables)}this.variables.flatten(t)}#y(){return void 0===this.visits&&void 0===this.turns&&void 0===this.mockVisits&&void 0===this.forgetVisits&&void 0===this.pastVisits&&void 0===this.mockTurns&&void 0===this.seed&&void 0===this.seedIter&&0===Object.keys(this.variables.variableStore).length}serialise(){return this.#y()?this.passage:{...this,variables:this.variables.serialise()}}static deserialise(e,t,n){if("string"==typeof e){if(!Xe.hasValid(e))throw new q(`The data refers to a passage named \`"${e}"\`, but it isn't in this story.`);return new Ia(e)}if("object"!=typeof e||!("variables"in e))throw new q("One of the saved turns is unintelligible.");if(!Xe.hasValid(e.passage))throw new q(`The data refers to a passage named \`"${e.passage}"\`, but it isn't in this story.`);let r=new Ia(e.passage,Oa.deserialise("a past turn's variables","global",e.variables,t.map(e=>e.variables),n));for(let t of["turns","forgetVisits","seed","seedIter","mockVisits","mockTurns","visits","pastVisits"])t in e&&(r[t]=e[t]);return r}}const{assign:Ma,create:La,defineProperty:Ra}=Object,{isArray:Pa}=Array;Ra(Map.prototype,"toJSON",{value:void 0}),Ra(Set.prototype,"toJSON",{value:void 0});const Va=["localStorage","sessionStorage"].map(e=>{try{return!!window[e]&&(window[e].setItem("test","1"),window[e].removeItem("test"),!0)}catch(e){return!1}}),Fa={forward:[],back:[],load:[],beforeForward:[],beforeBack:[],beforeLoad:[],forgetUndos:[]};let Ha=[],qa=-1,za=new Ia,Wa="";const Ba=new Oa("definitions","global");let Ua=Ma(La(Ia.prototype),{reconstruct(e=[]){Ua.variables=new _a("this story's variables","global"),Ua.history=[],Ua.visits=[],Ua.mockVisits=void 0,Ua.mockTurns=void 0,Ua.flatten(e),Ua.variables.flatten([Ba]),Ua.mockVisits||=[],Ua.mockTurns||=0,Ua.reconstructHistory(),zt(Ua.seed,Ua.seedIter),Ua.seed=void 0,Ua.seedIter=void 0,Ua.passage=""},reconstructHistory(){Ua.history=(Ua.pastVisits||[]).slice(Ua.forgetVisits||0).reduce((e,t)=>e.concat(t),[]),Ua.mockVisits&&(Ua.history=(Ua.mockVisits||[]).concat(Ua.history))}});class _a extends Oa{delete(e){super.delete(e),za.variables.variableStore[e]=null,delete za.variables.valueRefs?.[e]}set(e,t,n){if(super.set(e,t,n),za.variables.variableStore[e]=t,n)(za.variables.valueRefs||=Object.create(null))[e]=n;else if((Pa(t)||t instanceof Map||t instanceof Set||"string"==typeof t)&&!g.uncompressedStructures)for(let n=qa;n>=0;n-=1){const r=Ha[n].variables.variableStore[e];if(null!=r){const n=_t.modifierRef(r,t,"it");n&&("it"===n.via?delete za.variables.variableStore[e]:(za.variables.valueRefs||=Object.create(null))[e]=n);break}}}defineType(e,t){super.defineType(e,t),za.variables.typeDefs[e]=t}}Ua.reconstruct(),za.seed=Pt,za.seedIter=Rt;const Ga={get passage(){return za.passage},get variables(){return Ua.variables},get pastLength(){return qa},get turns(){return qa+1+(Ua.turns||0)+(Ua.mockTurns||0)},get futureLength(){return Ha.length-1-qa},get mockVisits(){return Ua.mockVisits||[]},set mockVisits(e){Ua.mockVisits=e,za.mockVisits=e,Ua.reconstructHistory()},get mockTurns(){return Ua.mockTurns||0},set mockTurns(e){Ua.mockTurns=e,za.mockTurns=e},history:()=>Ua.history,forgetUndos(e){e<0&&(e=Ha.length+e);const t=Ha.splice(0,Math.min(Ha.length-1,e));if(!t.length)return;qa=Ha.length-1;const n=Ha[0];n.flatten(t),(n.pastVisits||=[]).push(t[t.length-1].passage),n.turns=(n.turns||0)+t.length,Ua.turns=(Ua.turns||0)+t.length,n.forgetVisits&&(n.pastVisits=n.pastVisits.slice(n.forgetVisits-n.turns),n.forgetVisits-=n.turns),Wa="",0===qa&&a("tw-link[undo], tw-icon[alt='Undo']",h).each((e,t)=>{(a(t).closest("tw-expression, tw-hook").data("forgetUndosEvent")||Object)(t)}),Fa.forgetUndos.forEach(e=>e())},forgetVisits(e){e<0&&(e=Ha.length+e),e>qa+(Ua.turns||0)&&(e=qa+(Ua.turns||0)),za.forgetVisits=Ua.forgetVisits=Math.max(Ua.forgetVisits||0,e),Ua.reconstructHistory()},passageNameVisited(e){let t=0;if(!Xe.get(e))return 0;for(let n=0;n<Ua.history.length;n++)t+=+(e===Ua.history[n]);return t},timeline:Ha,definitions:Ba,play(e){H(za,"present is undefined!"),Fa.beforeForward.forEach(e=>e()),za.passage&&(za.visits?.length&&Array.isArray(Ua.pastVisits)&&Array.isArray(Ua.pastVisits[Ua.pastVisits.length-1])?Ua.pastVisits[Ua.pastVisits.length-1].push(za.passage):(Ua.pastVisits||=[]).push(za.passage),(Ua.history||=[]).push(za.passage)),za.passage=e,Ha=Ha.slice(0,qa+1).concat(za),qa+=1,Xa(e),Fa.forward.forEach(t=>t(e))},redirect(e){H(za,"present is undefined!"),za.passage&&(za.visits?.length&&Array.isArray(Ua.pastVisits)&&Array.isArray(Ua.pastVisits[Ua.pastVisits.length-1])?Ua.pastVisits[Ua.pastVisits.length-1].push(za.passage):(Ua.pastVisits||=[]).push([za.passage]),(Ua.history||=[]).push(za.passage)),(za.visits||=[]).push(e),za.passage=e},rewind(e=1){let t=!1;for(;e>0&&qa>0;e--)t=!0,qa-=1;return t&&(Fa.beforeBack.forEach(e=>e()),Wa="",Xa(Ha[qa].passage),Ua.reconstruct(Ha.slice(0,qa+1)),Fa.back.forEach(e=>e())),t},fastForward(e=1){let t=!1;for(;e>0&&Ha.length>0;e--)t=!0,qa+=1;return t&&(Fa.beforeForward.forEach(e=>e()),Xa(Ha[qa].passage),Ua.reconstruct(Ha.slice(0,qa+1)),Fa.forward.forEach(e=>e(Ha[qa].passage,"fastForward"))),t},on:(e,t)=>("function"!=typeof t||Fa[e].includes(t)||Fa[e].push(t),Ga),reset(){Fa.beforeLoad.forEach(e=>e()),Ha=[],qa=-1,Ua.reconstruct(),za=new Ia,Object.keys(Ba.variableStore).forEach(e=>delete Ba.variableStore[e]),zt(),za.seed=Pt,za.seedIter=0,Wa="",Fa.load.forEach(e=>e(Ha))},hasStorage:Va[0],hasSessionStorage:Va[1],setSeed(e){zt(e),za.seed=e,za.seedIter=0},random:()=>{const e=qt();return za.seedIter=Rt,e},shuffled(...e){const t=e.reduce((e,t,n)=>{const r=this.random()*(n+1)|0;return r===n?e.push(t):(e.push(e[r]),e[r]=t),e},[]);return za.seedIter=Rt,t},addDefinitions(){Ua.variables.flatten([Ba])},serialise(e){let t=Ha.slice(Wa?e?qa-1:qa:0,qa+1),n=t.slice(0,-1),r=Wa;try{return n.length&&(r=(r?`${r.slice(0,-1)},`:"[")+JSON.stringify(n.map(e=>e.serialise())).slice(1)),{past:r,pastAndPresent:r.slice(0,-1)+(r?",":"[")+JSON.stringify(t.at(-1).serialise())+"]"}}catch(e){return{past:"",pastAndPresent:""}}},deserialise(e,t){let n;try{n=JSON.parse(t)}catch(e){throw new q("The save data is unintelligible.")}if(!Pa(n))throw new q("The save data isn't a sequence of past turns.");let r=[];for(let t=0;t<n.length;t+=1)r.push(Ia.deserialise(n[t],r,e));return Ha=r,qa=Ha.length-1,Fa.load.forEach(e=>e(Ha)),Wa="",Ua.reconstruct(Ha.slice(0,qa+1)),Xa(Ha[qa].passage),!0}};function Xa(e){let t;za=new Ia(e),({past:Wa,pastAndPresent:t}=Ga.serialise(!0)),function(e){if(Ga.hasSessionStorage)try{sessionStorage.setItem("Saved Session",e)}catch(e){return}}(t)}let Ya,Ja;function Ka(e,t,n){let r;if(n){const e=n.get("name"),a=Xe.getTree(e);a.children.length&&(r=Object.setPrototypeOf({type:"include",tag:t,name:e,children:a.children,text:a.text},Ee.prototype))}else r=Xe.getTree(t);r&&e.push(r)}function Qa(e,t={}){const{loadedGame:n}=t,r=Xe.get(e),o=h;let i=o.parent(),{stretch:s,transition:{depart:c="instant",arrive:l="dissolve",departOrigin:u,arriveOrigin:d,time:m}={}}=t;i.findAndFilter("tw-enchantment").each((e,t)=>{let n=a(t);const r=n.data("enchantedProperties");r&&o.css(r.reduce((e,t)=>(e[t]="",e),{})),n[0]===i[0]&&(i=o.unwrap().parent())}),H(!!r,`No passage named "${e}"!`);const y=o.children("tw-passage").not(".transition-out, .transition-out *"),b=(r.get("tags")||[]).join(" "),v=function(){const e=a("<tw-passage><tw-sidebar>"),t=e.children("tw-sidebar"),n=a('<tw-icon tabindex=0 alt="Undo" title="Undo">&#8630;</tw-icon>'),r=a('<tw-icon tabindex=0 alt="Redo" title="Redo">&#8631;</tw-icon>');return Ga.pastLength<=0&&n.css("visibility","hidden"),Ga.futureLength<=0&&r.css("visibility","hidden"),t.append(n,r),e}();let w=u?.call(y[0]),$=d?.call(v[0]);const k=!s&&c,S=k&&y.css("width");document.documentElement.contains(h[0])&&(f=h.parent(),h.detach()),v.appendTo(o).attr({tags:b}),k&&(((e,t,n,r=0,a=0,o=0,i)=>{if(0===e.length)return;n||=p(t),(e.length>1||!L(e)||!["tw-hook","tw-passage","tw-sidebar","tw-expression"].includes(e.tag()))&&(e=e.wrapAll("<tw-transition-container>").parent()),i&&("string"==typeof i||i instanceof Function?e.css("transform-origin",i):e.css(i)),e.attr("data-t8n",t).addClass("transition-out").css({"animation-duration":`${n}ms`,"animation-delay":-o+"ms","animation-play-state":"paused"}),requestAnimationFrame(()=>{L(e)?e.css("display","inline"):e.parent().is("tw-backdrop,tw-story")||e[0].setAttribute("style",`${e[0].getAttribute("style")}display:block !important;width:100%`)}),x(e,n,r-o,a,()=>{e.remove()})})(y,c,m,0,0,0,w),y.css({position:"absolute",width:()=>"0px"!==S?S:"100%"})),o.attr({tags:b});const T=new jn(v);n&&(T.loadedGame=!0);const C=[];if(Ga.pastLength<=0&&1===Ga.turns){for(let e of Xe.getTagged("startup"))Ka(C,"startup",e);if(g.debug)for(let e of Xe.getTagged("debug-startup"))Ka(C,"debug-startup",e)}for(let e of Xe.getTagged("header"))Ka(C,"header",e);if(g.debug)for(let e of Xe.getTagged("debug-header"))Ka(C,"debug-header",e);Ka(C,e);for(let e of Xe.getTagged("footer"))Ka(C,"footer",e);if(g.debug)for(let e of Xe.getTagged("debug-footer"))Ka(C,"debug-footer",e);T.renderInto(C,v,{transition:l,transitionTime:m,transitionOrigin:$}),T.loadedGame=!1,F(),scroll(0,s?v.offset().top-.05*a(window).height():o[0].getBoundingClientRect().top+document.body.scrollTop)}Object.seal(Ia),Ya={goBack(e){Ga.rewind()&&Qa(Ga.passage,e)},goForward(e){Ga.fastForward()&&Qa(Ga.passage,e)},goToPassage(e,t){Ga.play(e),Qa(e,t)},redirect(e,t){Ga.redirect(e),Qa(e,t)},toggleFullscreen(){const e=document.documentElement;document.fullscreenElement?document.exitFullscreen():e.requestFullscreen.call(e)},showPassage:Qa,enableDebugMode(){Ja&&Ja()},registerDebugMode(e){!Ja&&(Ja=e)}};var Za=Object.freeze(Ya);const eo=W();class to{constructor({className:e,rowWrite:t,rowCheck:n,rowSort:r,columnHead:o,tabName:i,tabNameCounter:s=!0,tabUpdate:c}){const l=a(`<div class='panel panel-${e}' style='${new.target.defaultMaxHeight?`max-height:${new.target.defaultMaxHeight}px`:""}' hidden><div class="resizer-v"></div><table class='panel-rows'></table></div>`),u=a(`<button class='tab tab-${e}'>${s?`0 ${i}s`:i}</button>`);u.click(()=>{u.toggleClass("enabled"),u.parent().siblings(".panel").attr("hidden",""),u.is(".enabled")&&(u.siblings(`.tab:not(.tab-${e})`).removeClass("enabled"),l.removeAttr("hidden"))}),l.on("click","th",({target:e})=>{let t=(e=a(e)).attr("data-order");t="desc"===t?"asc":"desc",this.sort(e.attr("data-col"),t),l.find("th[data-order]").removeAttr("data-order"),e.attr("data-order",t)}),c||(c=e=>u.text(s?`${e} ${i}${1!==e?"s":""}`:i)),Object.assign(this,{tabName:i,tab:u,panel:l,panelRows:l.find(".panel-rows"),rowWrite:t,rowSort:r,rowCheck:n,columnHead:o,tabUpdate:c})}sort(e,t){this.panelRows.children(":not(.panel-head, .panel-row-source)").get().sort((n,r)=>("desc"===t&&([n,r]=[r,n]),n=n.querySelector(`.${e}`),r=r.querySelector(`.${e}`),this.rowSort&&this.rowSort(e,a(n),a(r))||eo(n.textContent,r.textContent))).forEach(e=>{const t=a(e).next(".panel-row-source").get();this.panelRows.append(e,t)})}update(e,t=0){const{rowCheck:n,rowWrite:r,panelRows:o,columnHead:i,panel:s}=this,c=[],l=o.children();e.forEach(e=>{const t=l.get().filter(t=>n(e,a(t))),i=r(e,t.length?a(t):void 0);i&&(t.length||o.append(i),c.push(...i.get()))}),l.filter((e,t)=>!c.includes(t)&&!t.className.includes("panel-head")).remove(),this.tabUpdate(t),t>0&&!o.find(".panel-head").length?o.prepend(i()||""):0===t&&o.find(".panel-head").remove();const u=s.find("th[data-order]");u.length&&this.sort(u.attr("data-col"),u.attr("data-order"))}static defaultMaxHeight=300}const no={boolean:"color:hsla(0,0%,30%,1.0)",array:"color:hsla(0,100%,30%,1.0)",dataset:"color:hsla(30,100%,40%,1.0)",number:"color:hsla(30,100%,30%,1.0)",datamap:"color:hsla(60,100%,30%,1.0)",changer:"color:hsla(90,100%,30%,1.0)",lambda:"color:hsla(120,100%,40%,1.0)",hookName:"color:hsla(160,100%,30%,1.0)",string:"color:hsla(180,100%,30%,1.0)",identifier:"color:hsla(200,80%,40%,1.0)",variable:"color:hsla(200,100%,30%,1.0)",tempVariable:"color:hsla(200,70%,20%,1.0)",datatype:"color:hsla(220,100%,30%,1.0)",colour:"color:hsla(280,100%,30%,1.0)",macro:"color:hsla(320,80%,30%,1.0)",twineLink:"color:hsla(240,100%,20%,1.0)"};no.gradient=no.image=no.colour,no.command=no.twineLink,no.instant=no.metadata=no.any=no.customMacro=no.macro;const{min:ro}=Math,ao=(e,t,n)=>r=>`background-color: hsla(${e},${t}%,${n}%,${r});`,oo=ao(40,100,50),io=ao(220,100,50),so=/hsla\((\d+),\s*(\d+)%,\s*(\d+)%,\s*(\d+\.\d+)\)/g,co="cm-harlowe-4-",lo=`${{root:"box-sizing:border-box;",hook:oo(.05),"hook-2":oo(.1),"hook-3":oo(.15),"hook-4":oo(.2),"hook-5":oo(.25),"hook-6":oo(.3),"hook-7":oo(.35),"hook-8":oo(.4),"^=hook , ^=hook-":"font-weight:bold;",unclosedHook:`${oo(.05)}font-weight:bold;`,[`error:not([class*='${co}string'])`]:"background-color: hsla(17,100%,50%,0.5) !important;","^=macroName":"font-style:italic;","macroName-boolean":no.boolean,"macroName-array":no.array,"macroName-dataset":no.dataset,"macroName-datatype":no.datatype,"macroName-number":no.number,"macroName-datamap":no.datamap,"macroName-changer":no.changer,"macroName-string":no.string,"macroName-colour, macroName-gradient, macroName-image":no.colour,"macroName-command, macroName-instant, macroName-metadata":no.command,"macroName-custommacro, macroName-macro, macroName-any":no.macro,"^=macro ":`font-weight:bold;${no.macro}`,"comma, spread":no.macro,addition:no.any,"subtraction, multiplication, division":no.number,"is, and, or, not, isNot, contains, doesNotContain, isIn, isA, isNotA, isNotIn, matches, doesNotMatch":no.boolean,"bold, strong":"font-weight:bold;","italic, em":"font-style:italic;",sup:"vertical-align: super;font-size:0.8em;",strike:"text-decoration: line-through;",verbatim:"background-color: hsla(0,0%,50%,0.25); font:var(--font-monospaced)",comment:"color: hsla(120, 80%, 40%, 1); font-style:italic;","^=bold, ^=strong, ^=italic, ^=em, ^=sup, ^=verbatim, ^=strike":"font-weight:100; color: hsla(0,0%,0%,0.5)","^=collapsed":"font-weight:bold; color: hsla(201,100%,30%,1.0);",unclosedCollapsed:`${io(.025)}font-weight:bold; color: hsla(201,100%,30%,1.0);`,collapsed:io(.025),"collapsed.hook":io(.05),"collapsed.hook-2":io(.1),"collapsed.hook-3":io(.15),"collapsed.hook-4":io(.2),"collapsed.hook-5":io(.25),"collapsed.hook-6":io(.3),"collapsed.hook-7":io(.35),"collapsed.hook-8":io(.4),"twineLink:not(.text)":no.twineLink,"tag, scriptStyleTag, htmlComment":"color: hsla(240,34%,25%,1.0);",boolean:no.boolean,string:no.string,number:no.number,variable:no.variable,tempVariable:no.tempVariable,hookName:no.hookName,datatype:no.datatype,colour:no.colour,cssTime:no.number,passageString:`${no.variable};text-decoration:underline 1px;`,tagString:`${no.variable};text-decoration:underline 1px dotted;`,"variableOccurrence, hookOccurrence":"background: hsla(159,50%,75%,1.0) !important;","^=where, ^=via, ^=with, ^=making, ^=each, ^=when":`${no.lambda}; font-style:italic;`,heading:"font-weight:bold;",hr:"background-image: linear-gradient(0deg, transparent, transparent 45%, hsla(0,0%,75%,1.0) 45%, transparent 55%, transparent);",align:"color: hsla(14,99%,37%,1.0); background-color: hsla(14,99%,87%,0.1);",column:"color: hsla(204,99%,37%,1.0); background-color: hsla(204,99%,87%,0.1);",escapedLine:"font-weight:bold; color: hsla(51,100%,30%,1.0);","identifier, property, belongingProperty, itsProperty, belongingItProperty, belongingItOperator, possessiveOperator, belongingOperator":no.identifier,toString(){return Object.keys(this).reduce((e,t)=>{if("toString"===t)return e;const n=t.split(", ").map(function e(t){return t.includes(".")?t.split(/\./g).map(e).join(""):0===t.indexOf("^=")?`[class^='${co}${t.slice(2)}']`:`.${co}${t}`});return e+=`${n.join(", ")}{${this[t]}}`,this[t].match(so)&&[".theme-dark","[data-app-theme=dark]"].forEach(r=>{e+=`${n.map(e=>`${r} ${e}`).join(", ")}{${this[t].replace(so,(e,t,n,r,a)=>`hsla(${t},${ro(100,1.5*+n)}%,${100-r}%,${a})`)}}`}),e},"")}}}`,{lex:uo}=Ve;function po(e){let t={},n="";for(let r=0;r<e.length;r+=1){const{type:a,text:o}=e[r];"verbatim"!==a&&"comment"!==a||(n="");let i=co+a;switch(t[i]=(t[i]||0)+1,t[i]>1&&(i+=`-${t[i]}`),a){case"text":if(o.trim()){e.slice(r+1).reduce((e,t)=>void 0===e?"macro"===t.type||"hook"!==t.type&&e:e,void 0)&&(i+=` ${co}error`)}break;case"macroName":{const t=e[r].text[0];if("_"===t||"$"===t){i+=` ${co}customMacro ${co+("_"===t?"tempV":"v")}ariable`;break}const n=I(e[r].text.slice(0,-1));Et.has(n)?i+=`-${Et.get(n).returnType.toLowerCase()}`:i+=` ${co}error`;break}}n+=`${i} `}return n}function ho(e,t,n=0,r=e.length){if(e.length>9999)return[a("<span>").text(e)[0]];const o=uo(e,"",t||"macro"),i=[];let s="",c=[o];for(let e=o.start;e<o.end;e+=1){const t=o.pathAt(e);t[0]!==c[0]&&(i.length&&(i[i.length-1].textContent=s),s="",c=t,i.push(a(`<${r&&e>=n&&e<r?"mark":"span"} class="${po(c)}">`)[0])),s+=o.text[e-o.start]}return i.length&&(i[i.length-1].textContent=s),i}const{dialog:fo}=vn,go=a();let mo=(e,t)=>{const n=a(document.documentElement),r=W();let o={darkMode:!0,fadePanel:!0,evalReplay:!0,width:null,maxHeight:400};if(Ga.hasStorage)try{const e=localStorage.getItem(`(Debug Options ${g.ifid})`);e&&(o=JSON.parse(e))}catch(e){}function i(){if(Ga.hasStorage)try{localStorage.setItem(`(Debug Options ${g.ifid})`,JSON.stringify(o))}catch(e){}}to.defaultMaxHeight=o.maxHeight;let s=a(`<tw-debugger class="${[o.darkMode?"theme-dark":"",o.fadePanel?"fade-panel":""].join(" ")}" style="${o.width?`width:${o.width}px`:""}">\n<div class='panel panel-errors' hidden><table></table></div>\n<div class='tabs'></div>\n<label style='user-select:none'>Turns: </label><select class='turns' disabled></select>\n<button class='show-invisibles'>ð Debug View</button>\n<button class='show-dom'><span style="vertical-align:text-top">&lt;</span><span style="vertical-align:text-bottom">&gt;</span> DOM View</button>\n<button class='close'>â</button>\n<div class='resizer-h'>\n</tw-debugger>`);const c=s.find(".tabs"),l=s.find(".show-dom"),u=s.find(".show-invisibles"),d=s.find(".close"),p=s.find(".turns"),h=e=>P((...t)=>{if(g.debug)return e(...t)},{maxWait:2e3});a(document.documentElement).on("click","tw-expression, tw-error, tw-eval-explanation",P(e=>{const t=a(e.target||go).data("evalReplay");t&&function(e){let t=0;const n=fo({buttons:[{name:"Understood",confirm:!0,callback:()=>!s.find("tw-backdrop").length&&s.removeClass("show-dialog")}]}).addClass("eval-replay"),r=a(`<tw-eval-replay>${1===e.length?"":"<tw-eval-code></tw-eval-code>"}<tw-eval-explanation></tw-eval-explanation><tw-eval-it></tw-eval-it><tw-eval-reason></tw-eval-reason>${1===e.length?"":"<tw-dialog-links><tw-link style='visibility:hidden'>â 10</tw-link><tw-link style='visibility:hidden'>â â</tw-link><b></b><tw-link>â â</tw-link><tw-link>10 â</tw-link></tw-dialog-links>"}</tw-eval-replay>`);n.find("tw-dialog").css({width:"75vw","max-width":"75vw"}).prepend(r);const o=r.find("tw-link:first-of-type"),i=o.next(),c=i.next(),l=c.next(),u=l.next();function d(){const n=e[t],s=r.find("tw-eval-explanation").empty(),d=r.find("tw-eval-code");if(n.toCode||n.toDesc||n.error||n.lambda){if(r.find("tw-eval-code").empty().append(ho(n.code,"macro",t>0?n.start:void 0,t>0?n.end+n.diff:void 0)),s.append(n.lambda?"":`<code class='${n.fromCode.length>56?"from-block":"from-inline"}'></code>`,n.error?"<span> caused an error: </span>":n.lambda?"<span>The lambda <code class='to-lambda'></code> was run, producing these results.</span>":`<span> became${n.toDesc?"â¦":""} </span>${n.toDesc?`<span class='to-desc'>${D(n.toDesc)}.</span>`:"<code class='to-code'></code>"}`),n.error)s.append(n.error);else if(n.lambda){const e=(e,t)=>a(`<${e}><code></${e}>`).find("code").append(ho(t,"macro")).end();s.find(".to-lambda").append(ho(n.lambda.obj.source,"macro")).end().append(a("<table>").append(a("<tr>").append(e("th","pos"),n.lambda.obj.loop?e("th",`_${n.lambda.obj.loop.getName()}`).append(" / ",a("<code>").append(ho("it","macro"))):e("th","it"),n.lambda.obj.making?e("th",`_${n.lambda.obj.making.getName()}`):go,n.lambda.obj.where?e("th","where").append(" result"):go,n.lambda.obj.via?e("th","via").append(" result"):go),...n.lambda.loops.map(({it:t,pos:r,making:o,whereResult:i,whereReplay:s,viaResult:c,viaReplay:l})=>a("<tr>").append(e("td",ut(r)),e("td",ut(t)),void 0!==o?e("td",ut(o)):go,void 0!==i&&(i instanceof qe?a("<td>").append(i.render(n.lambda.obj.source,!0)):e("td",ut(i))).append(s&&a("<tw-open-button replay label='ð'>").data("evalReplay",s)||go)||go,null!=c&&(c instanceof qe?a("<td>").append(c.render(n.lambda.obj.source,!0)):e("td",ut(c))).append(l&&a("<tw-open-button replay label='ð'>").data("evalReplay",l)||go)||go))))}else n.toDesc||s.find(".to-code").append(ho(n.toCode,"macro"));s.next().html(n.itIdentifier?`(The <code class="cm-harlowe-4-identifier">it</code> identifier now refers to ${D(n.itIdentifier)}.)`:"").next().text(n.reason||"")}else d.empty().append(ho(n.code,"macro")),s.html("<center>First, there was <code></code>.</center>").next().empty().next().empty();!n.lambda&&s.find("code").first().append(ho(n.fromCode,"macro")),r.find("mark").each((e,t)=>{t.scrollIntoView()}),o.css("visibility",t<=9?"hidden":"visible"),i.css("visibility",t<=0?"hidden":"visible"),l.css("visibility",t>=e.length-1?"hidden":"visible"),u.css("visibility",t>=e.length-10?"hidden":"visible"),c.html(`( ${t+1}/${e.length} )`)}d(),o.on("click",()=>{t=Math.max(0,t-10),d()}),i.on("click",()=>{t=Math.max(0,t-1),d()}),l.on("click",()=>{t=Math.min(e.length-1,t+1),d()}),u.on("click",()=>{t=Math.min(e.length-1,t+10),d()}),s.find("tw-backdrop").length?s.find("tw-backdrop").before(n):s.addClass("show-dialog").append(n)}(t);const n=a(e.target||go).data("goto");if(n){let e=g.ignoreGotos;g.ignoreGotos=!1,n.command.runCommand(n.section),g.ignoreGotos=e}e.stopPropagation()})),s.find(".resizer-h").mousedown(e=>{if(1!==e.which)return!0;e.stopPropagation();const t=e.pageX,r=s.width();n.on("mousemove.debugger-resizer-h",({pageX:e})=>{s.width(r+t-(0|e)+"px")}).on("mouseup.debugger-resizer-h",()=>{n.off(".debugger-resizer-h"),o.width=s.width(),i()})}),s.on("mousedown",".resizer-v",e=>{if(1!==e.which)return!0;e.stopPropagation();const t=e.pageY,r=a(e.target.parentNode).height();n.on("mousemove.debugger-resizer-v",({pageY:e})=>{s.find(".panel").css("maxHeight",r+t-(0|e)+"px")}).on("mouseup.debugger-resizer-v",()=>{n.off(".debugger-resizer-v"),o.maxHeight=+s.find(".panel").css("maxHeight"),i()})}),u.click(()=>{n.toggleClass("debug-mode").removeClass("dom-debug-mode"),u.toggleClass("enabled"),l.removeClass("enabled")}),l.click(()=>{n.toggleClass("dom-debug-mode").removeClass("debug-mode"),l.toggleClass("enabled"),u.removeClass("enabled")}),d.click(()=>{n.removeClass("debug-mode dom-debug-mode"),s.detach(),Object.assign(g,{debug:!1,speedMultiplier:1,ignoreClickEvents:!1,ignoreGotos:!1})});const f=h(()=>{const e=p.children().get(),{timeline:t}=Ga;let n=0;t.forEach(({turns:t=0,passage:r},a)=>{n+=1+t;const o=`${n}: ${r}`;e[a]?e[a].textContent=o:p.append(`<option value='${a}'>${o}</option>`)}),t.length<e.length&&a(e.slice(t.length)).remove(),p[t.length>=1?"removeAttr":"attr"]("disabled"),p.val(Ga.pastLength)});p.change(({target:e})=>{let{value:t}=e;const n=+t-Ga.pastLength;0!==n&&(Ga[n<0?"rewind":"fastForward"](Math.abs(n)),Za.showPassage(Ga.passage))}),f(),Ga.on("forward",f).on("load",f).on("forgetUndos",()=>f).on("back",()=>{Ga.pastLength<=1&&p.attr("disabled"),p.find("[selected]").removeAttr("selected"),p.val(Ga.pastLength)});const m=e=>{const t=e.parents(".variable-row, .enchantment-row, .source-row");t.next(".panel-row-source").find("td").empty().append(ho(t.data("value")||ut(t.data("enchantment").changer),t.is("source-row")?"markup":"macro"))};let y=new Set;const b=new to({className:"variables",tabName:"Variable",rowWrite({name:e,dataset:t,path:n,value:r,tempScope:o,type:i},s){const c=D(it(r)),l=c.length>48&&!nt(r,"debugName"),u=nt(r,"debugName")?r.debugName():c;let d="";n.length&&(d=n.reduce((e,t)=>`${e+t}'s `,"")),t&&(e="???");const p=i?ut(i):"",h="object"==typeof r||l;if(s){s[0].firstChild.innerHTML=p||"",d&&a(s[0].firstChild).children(".variable-path").html((o?"_":"$")+D(d)),s[0].childNodes[1].lastChild.textContent=(d?"":o?"_":"$")+D(`${e}`),s[0].childNodes[2].textContent=o||"",s[0].childNodes[3].innerHTML=u;const t=a(s[0].lastChild.firstChild),n=t.is(".open");t[h?"show":"hide"]();const i=s.next(".panel-row-source");return n&&i.find("td").empty().append(ho(ut(r))),s.data("value",ut(r)),s.add(i)}return s=a('<div class="variable-row">').attr("data-name",e).attr("data-path",`${n}`).attr("data-scope",o||"").css("padding-left",`${Math.min(5,n.length)}em`).append(`<td class='variable-type'>${p||""}</td>`,`<td class='variable-name cm-harlowe-4-${o?"tempV":"v"}ariable'><span class='variable-path'>${d?(o?"_":"$")+D(d):""}</span> ${d?"":o?"_":"$"}${D(`${e}`)}</td>`,`<td class='temporary-variable-scope'>${o||""}</td>`,`<td class='variable-value cm-harlowe-4-macroName-${ct(r)}'>${u}</td><td class='panel-row-buttons'><tw-folddown tabindex=0 style='display:${h?"visible":"none"}'>(source:) </tw-folddown></td>`).data("value",ut(r)).find("tw-folddown").data("folddown",m).end().add("<tr class='variable-row panel-row-source' style='display:none'><td colspan='5'></td></tr>")},rowCheck:({name:e,path:t,tempScope:n},r)=>r[0]&&r[0].getAttribute("data-name")===e&&r[0].getAttribute("data-path")===`${t}`&&r[0].getAttribute("data-scope")===n,columnHead:()=>'<tr class="panel-head"><th data-col="variable-type">Type</th><th data-col="variable-name">Name</th><th data-col="temporary-variable-scope">Scope</th><th data-col="variable-value">Value</th></tr>',rowSort(e,t,n){if("variable-value"===e)return r(t.attr("class"),n.attr("class"))||r(t.parent().data("value"),n.parent().data("value"))}}),v=h(()=>{const e=[],t=Ga.variables;let n=e.length;function r(t){if(e.length>500)return;e.push(t);const n=t.path.concat(t.name),{value:a,tempScope:o}=t;n.length<=4&&(Array.isArray(a)?a.forEach((e,t)=>r({name:N(t+1),path:n,value:e,tempScope:o})):a instanceof Map?[...a].forEach(([e,t])=>r({name:e,path:n,value:t,tempScope:o})):a instanceof Set&&[...a].forEach((e,t)=>r({name:`${t}`,dataset:!0,path:n,value:e,tempScope:o})))}for(let e in t.variableStore){const a=t.variableStore[e];null!==a&&(n+=1,r({name:e,path:[],value:a,tempScope:"",type:t.typeDefs?.[e]}))}e.push(...y),n+=y.size,b.update(e,n),0===n!==b.panel[0].classList.contains("panel-variables-empty")&&b.panel.toggleClass("panel-variables-empty")});let w;Un.on("set",(e,t,n)=>{if(e instanceof Oa&&"temp"===e.type&&!e.name.match(/#\d+$/)){const r=e.name,a="string"==typeof t&&e.typeDefs?.[t],o=[...y].find(e=>e.name===t&&e.tempScope===r);o?o.value=n:y.add({name:`${t}`,path:[],value:n,tempScope:r,type:a})}v(),w()}).on("delete",()=>{v(),w()}),b.panel.append("<div class='panel-variables-bottom'>\n\t\t\t<button class='panel-variables-copy'>Copy $ variables as (set:) call</button>\n\t\t\t<input class='clipboard' type=\"text\" style='opacity:0;pointer-events:none;position:absolute;'></input>\n\t\t</div>").removeAttr("hidden"),b.tab.addClass("enabled");const $=b.panel.find(".clipboard");n.on("click",".panel-variables-copy",()=>{let e=[];for(let t in Ga.variables.variableStore)e.push(`$${t} to ${ut(Ga.variables.variableStore[t])}`);$.val(`(set:${e})`)[0].select(),document.execCommand("copy")});const k=new to({className:"enchantments",tabName:"Enchantment",rowWrite(e,t){const{scope:n,changer:r,lambda:o,name:i,localHook:s}=e;let c;return c=r?D(it(r)):o?D(ut(o)):`<em>enchanted with (${i}:)</em>`,t||a('<div class="enchantment-row">').data("enchantment",e).append(`<td><span class='enchantment-name'>${ut(n)}${s?`</span><span class='enchantment-local cm-harlowe-4-hookName'>${nt(s,"toSource")?s.toSource():"jquery"in s&&s.attr("name")?`?${s.attr("name")}`:"an unnamed hook"}`:""}</span></td><td class='enchantment-value cm-harlowe-4-macroName-${r?"changer":"command"} '>${c}</td>${r?"<td class='panel-row-buttons'><tw-folddown tabindex=0>(source:)</tw-folddown></td>":""}`).find("tw-folddown").data("folddown",m).end().add(r?a("<tr class='panel-row-source' style='display:none'><td colspan='3'></td></tr>"):"")},rowCheck:(e,t)=>t.data("enchantment")===e,columnHead:()=>'<tr class="panel-head"><th data-col="enchantment-name">Scope</th><th data-col="enchantment-value">Value</th></div>'}),x=h(e=>{k.update(e.enchantments,e.enchantments.length)});jn.on("add",x).on("remove",x);const S=new jn,T=new to({className:"storylets",tabName:"Storylet",rowWrite({name:e,active:t,storyletSource:n,exclusive:r,urgent:o},i){if(i)return i.toggleClass("storylet-closed",!t),i[0].firstChild.textContent=t?"â":"",i;const s=a(`<tr class="storylet-row ${t?"":"storylet-closed"}">`).attr("data-name",e).append(`<td class='storylet-open'>${t?"â":""}</td><td class='storylet-name'>${e}</td><td class='storylet-lambda'></td><td class='storylet-exclusive'>${r}</td><td class='storylet-urgent'>${o}</td>`);return s.find(".storylet-lambda").append(ho(n.replace(/^when\s+/i,""))),s},rowCheck:({name:e},t)=>t[0].getAttribute("data-name")===D(`${e}`),columnHead:()=>'<tr class="panel-head"><th data-col="storylet-open" data-order="desc">Open</th><th data-col="storylet-name">Name</th><th data-col="storylet-lambda">Condition</th><th data-col="storylet-exclusive" class=\'storylet-exclusive\'>Exclusivity</th><th data-col="storylet-urgent" class=\'storylet-urgent\'>Urgency</th></tr>'});T.tab.hide(),w=h(()=>{const e=Xe.getStorylets(S),t=e instanceof qe,n=Xe.allStorylets();let r=!1,a=!1;T.update(n.map(n=>{const o="number"==typeof n.get("exclusivity")?n.get("exclusivity"):0,i="number"==typeof n.get("urgency")?n.get("urgency"):0;return r||=o,a||=o,{name:n.get("name"),storyletSource:n.get("storylet").toSource(),active:!t&&e.some(e=>e.get("name")===n.get("name")),exclusive:o,urgent:i}}),t?0:e.length),T.panel.toggleClass("storylet-error",t),T.panel.toggleClass("panel-exclusive",r),T.panel.toggleClass("panel-urgent",a),n.length&&T.tab.show()});const C=new to({className:"source",tabName:"Source",tabNameCounter:!1,rowWrite({name:e,tag:t},n){if(n)return n.add(n.next(".panel-row-source"));const r=Xe.get(e).get("source");return a(`<div class="source-row" data-tag="${t}">`).data("value",r).append(`<td class="source-name">${e}</td><td class="source-tags">${t}</td><td class='panel-row-buttons'><tw-folddown class='${t?"":"open"}' tabindex=0></tw-folddown></td>`).find("tw-folddown").data("folddown",m).end().add(a(`<tr class='panel-row-source' style='${t?"display:none":""}'><td colspan='3'></td></tr>`).find("td").append(!t&&ho(r,"markup")||go).end())},rowCheck:({name:e},t)=>t[0].firstChild.textContent===D(`${e}`),tabUpdate:a.noop,columnHead:a.noop}),j=["debug-startup","startup","header","debug-header","footer","debug-footer"].reduce((e,t)=>e.concat(Xe.getTagged(t).map(e=>({name:e.get("name"),tag:t}))),[]),A=new to({className:"errors",tabName:"Error",rowWrite:a.noop,rowCheck:a.noop,columnHead:a.noop,tabUpdate:e=>A.tab.css({background:e?"rgba(230,101,204,0.3)":""}).text(`${e} Error${1!==e?"s":""}`)}),E=P(e=>{if(!g.debug)return;A.panelRows.append(e.reduce((e,[t,n])=>"propagated"===t.type?e:`${e}<tr class="error-row"><td class="error-passage">${Ga.passage}</td><td class="error-message" title="${D(n)}">${t.message}</td></tr>`,""));const t=A.panelRows.children(),n=t.length;n>500&&a(Array.prototype.slice.call(A.panelRows[0].childNodes,0,n-500)).remove(),A.tabUpdate(Math.min(500,t.length))},{batch:!0});qe.on(E),A.panel.append("<div class='panel-errors-bottom'>\n\t\t\t<button class='panel-errors-clean'>ð§¹ Clear this panel</button>\n\t\t</div>"),n.on("click",".panel-errors-clean",()=>{A.panelRows.empty(),A.tabUpdate(0)});const O=new to({className:"tools",tabName:"Tools",tabNameCounter:!1,rowWrite:({id:e,type:t,label:n,dropdownItems:r,dropdownValue:o},i)=>"checkbox"===t?i?i.find("input").prop("checked",!1):a(`<span><input id="debug-${e}" type="checkbox"></input><label for="debug-${e}">${n}</label></span>`):"dropdown"===t?i?i.find("input").prop("checked",!1):a(`<span>${n}<select style="width:3em" data-default="${o}" id="debug-${e}"></span>`).find("select").append(...r.map(e=>`<option value='${e}' ${e===o?"selected":""}>${e}x</option>`)).end():go,rowCheck:a.noop,columnHead:a.noop,tabUpdate:e=>O.tab.css({background:e?"hsla(210, 72%, 65%, .3)":""})});n.on("click, change",'.panel-tools [type="checkbox"], .panel-tools select',({target:e})=>{const t=(e=a(e)).attr("id"),r=e.is(":checked")||e.is("select")&&e.val()!==+e.attr("data-default");"debug-peekBehindDialogs"===t&&n.toggleClass("debug-dialogs",r),"debug-ignoreClickEvents"===t&&(g.ignoreClickEvents=r),"debug-ignoreGotos"===t&&(g.ignoreGotos=r),"debug-speedMultiplier"===t&&(g.speedMultiplier=+e.val()),O.tabUpdate(r)}),O.update([{id:"peekBehindDialogs",type:"checkbox",label:"See through and click through <code>(dialog:)</code> boxes"},{id:"ignoreClickEvents",type:"checkbox",label:"Stop links, <code>(click:)</code> and <code>(hover-style:)</code> from activating"},{id:"ignoreGotos",type:"checkbox",label:"Stop <code>(go-to:)</code>, <code>(undo:)</code>, <code>(redirect:)</code> and <code>(restart:)</code> from activating<br><small>(Click 'GO' buttons in Debug View to activate later)</small>"},{id:"speedMultiplier",label:"Speed of timed events (<code>time</code>, <code>(live:)</code>, <code>(after:)</code>): ",type:"dropdown",dropdownValue:1,dropdownItems:[.25,.5,.75,1,1.25,1.5,1.75,2,3,5,10]}]);const I=new to({className:"options",tabName:"âï¸",tabNameCounter:!1,rowWrite:({name:e,label:t},n)=>{const r={darkMode:o.darkMode,fadePanel:o.fadePanel,evalReplay:o.evalReplay}[e];return n?n.find("input").prop("checked",r):a(`<span><input id="debug-${e}" type="checkbox" ${r?"checked":""}></input><label for="debug-${e}">${t}</label></span>`)},rowCheck:a.noop,tabUpdate:a.noop,columnHead:a.noop});n.on("click",'.panel-options [type="checkbox"]',({target:e})=>{const t=(e=a(e)).attr("id"),n=e.is(":checked");"debug-darkMode"===t&&(o.darkMode=n,s.toggleClass("theme-dark",n)),"debug-fadePanel"===t&&(o.fadePanel=n,s.toggleClass("fade-panel",n)),"debug-evalReplay"===t&&(g.evalReplay=o.evalReplay=n),i()}),I.update([{name:"darkMode",label:"Debug panel is dark"},{name:"fadePanel",label:"Debug panel is transparent unless the cursor is over it"},{name:"evalReplay",label:"Record expression replays (viewable via ð buttons in Debug View; slower)"}]),s.prepend(b.panel,k.panel,A.panel,T.panel,C.panel,O.panel,I.panel),c.prepend(b.tab,k.tab,A.tab,T.tab,C.tab,O.tab,I.tab);const M=()=>y=new Set;Ga.on("beforeForward",M).on("beforeBack",M).on("beforeLoad",M);const L=h(()=>{v(),w(),k.panelRows.empty(),k.tabUpdate(0),Ga.passage&&Xe.get(Ga.passage)&&(C.update(j.concat({name:Ga.passage,tag:""})),C.panel.find('[data-tag=""], [data-tag=""] + .panel-row-source').insertBefore(C.panel.find('[data-tag="footer"]').first()))});Ga.on("forward",L).on("back",L).on("load",L);const R=()=>{a(document.body).append(s),g.debug=!0,g.evalReplay=o.evalReplay,g.speedMultiplier=1,g.ignoreClickEvents=!1,g.ignoreGotos=!1,L()};mo=R,a(document.head).append(a("<style>").html(lo)),R(),e&&E(e,t)};Za.registerDebugMode((e,t)=>g.debug?a.noop:mo(e,t));var yo=mo;const{rest:bo,zeroOrMore:vo,either:wo,optional:$o,insensitiveSet:ko,numberRange:xo,percent:So,nonNegativeInteger:To,positiveInteger:Co,Any:No}=Et.TypeSignature,{max:jo,min:Ao,round:Eo,floor:Oo,ceil:Do}=Math,{assign:Io}=Object;function Mo(e){return(...t)=>{const n=e(...t);return"number"!=typeof n||Number.isNaN(+n)||!Number.isFinite(+n)?new qe("macrocall","This mathematical expression doesn't compute!"):n}}Et.add(["str","string","text"],"String",(e,...t)=>t.map(e=>e instanceof ar?e.toSource():e).join(""),[vo(Et.TypeSignature.either(String,Number,Boolean,Array,ar))])("source","String",(e,t)=>ut(t),[No])("substring","String",(e,t,n,r)=>gt(t,n,r),[String,parseInt,parseInt])("lowercase","String",(e,t)=>t.toLowerCase(),[String])("uppercase","String",(e,t)=>t.toUpperCase(),[String])("lowerfirst","String",(e,t)=>t.replace(RegExp(`${O}+`),e=>{let t=Array.from(e);return t[0].toLowerCase()+t.slice(1).join("").toLowerCase()}),[String])("upperfirst","String",(e,t)=>t.replace(RegExp(`${O}+`),e=>{let t=Array.from(e);return t[0].toUpperCase()+t.slice(1).join("").toLowerCase()}),[String])("words","Array",(e,t)=>t.split(RegExp(`${E}+`)).filter(Boolean),[String])(["str-repeated","string-repeated"],"String",(e,t,n)=>0===n.length?new qe("macrocall","I can't repeat an empty string."):n.repeat(t),[To,String])(["str-reversed","string-reversed"],"String",(e,t)=>[...t].reverse().join(""),[String])("joined","String",(e,t,...n)=>n.join(t),[bo(String)])("plural","String",(e,t,n,r)=>n&&""!==r?j(t,n,r):new qe("macrocall","The (plural:) macro can't be given empty strings."),[parseInt,String,$o(String)])(["str-nth","string-nth"],"String",(e,t)=>N(t),[parseInt])("digit-format","String",(e,t,n)=>{if(Math.abs(n)>=1e21)return new qe("macrocall","The number given to (digit-format:) is too big.");const r=/([^#0])(?=[#0]*$)/g,a=(r.exec(t)||[])[1],o=(/^[#0]*([^#0])/g.exec(t)||[])[1];let i=[...t],s=i.length;a&&(","!==a||o&&","!==o)&&(s=r.lastIndex-1);let c=Math.abs(n).toFixed(16).replace(/(\.\d*?)0+$/,(e,t)=>t).replace(/^0+/,""),l=c.includes(".")?c.indexOf("."):c.length,u=0,d="";for(let e=i.length-1;e>=0;e-=1){const t=i[e];if("0"===t||"#"===t){const n=c[l-s+e+u];d=(n||("0"===t?"0":""))+d}else e<i.length-1&&e>0&&(d=t+d,u+=e===s?0:1)}return(n<0?"-":"")+d},[String,Number])(["num","number"],"Number",(e,t)=>Number.isNaN(+t)?new qe("macrocall",`I couldn't convert ${it(t)} to a number.`):+t,[String])("datatype","Datatype",(e,t)=>ia.from(t),[No])("datapattern","Any",(e,t)=>function e(t){let n;if(Array.isArray(t)){n=[];for(const r of t){const t=e(r);if(t instanceof qe)return t;n.push(t)}}else if(t instanceof Map){n=new Map;for(const[r,a]of t){const t=e(a);if(t instanceof qe)return t;n.set(r,t)}}else n=ia.from(t);return n}(t),[No])(["rgb","rgba"],"Colour",(e,...t)=>new Gr({r:t[0],g:t[1],b:t[2],a:t[3]}),[xo(0,255),xo(0,255),xo(0,255),$o(So)])(["hsl","hsla"],"Colour",(e,t,n,r,a)=>((t=Eo(t)%360)<0&&(t+=360),new Gr({h:t,s:n,l:r,a})),[Number,So,So,$o(So)])(["oklch","oklcha"],"Colour",(e,t,n,r,a)=>((r=Eo(r)%360)<0&&(r+=360),new Gr({l:t,c:n,h:r,a,ok:!0})),[So,So,Number,$o(So)])(["lch","lcha"],"Colour",(e,t,n,r,a)=>((r=Eo(r)%360)<0&&(r+=360),new Gr({l:t,c:n,h:r,a,ok:!1})),[So,xo(0,150),Number,$o(So)])("complement","Colour",(e,t)=>t.OKLCHRotate(180),[Gr]),Et.add("mix","Colour",(e,...t)=>{let n,r,a,o,i="oklch";"string"==typeof t[0]&&(i=I(t.shift()));const s=(e,t,n)=>`The ${N(e)} value given to (mix:) after the colour model string, ${it(t)}, should be a ${n}.`;if("number"!=typeof t[0])return new qe("datatype",s(0,t[0],"number"));if(!(t[1]instanceof Gr))return new qe("datatype",s(1,t[1],"colour"));if("number"!=typeof t[2])return new qe("datatype",s(2,t[2],"number"));if(!(t[3]instanceof Gr))return new qe("datatype",s(3,t[3],"colour"));[n,r,a,o]=t;const c=["rgb","hsl","lch","oklch"];if(!c.includes(i))return new qe("datatype",`(mix:) should be given one of ${A(c.map(e=>JSON.stringify(e)))}, not ${it(i)}`);if("rgb"===i){let e=r.toRGBA(),t=o.toRGBA();return Gr.mixRGB(e,n,t,a)}if("hsl"===i){let e=r.toHSLA(),t=o.toHSLA();return Gr.mixHSL(e,n,t,a)}if("lch"===i){let e=r.toLCHA(),t=o.toLCHA();return Gr.mixLCH(e,n,t,a,!1)}if("oklch"===i){let e=r.toOKLCHA(),t=o.toOKLCHA();return Gr.mixLCH(e,n,t,a)}return new Gr("#000000")},[wo(String,So),wo(So,Gr),wo(So,Gr),wo(So,Gr),$o(wo(So,Gr))])("palette","Array",(e,t,n)=>{const{l:r,h:a}=n.toLCHA(),o={l:r<=.75?.75+r/3:.75-3*(1-r),c:80,h:a,a:1};let i,s,c;return i=new Gr(o),o.l+=r<=.75?-.1:.1,o.l<.5&&(o.l*=.5/o.l),s=new Gr(o),o.l+=r<=.85?.15:-.15,c=new Gr(o),"adjacent"===t?(i=i.OKLCHRotate(-30),s=i.OKLCHRotate(30),c=i.OKLCHRotate(60)):"triad"===t&&(c=i.OKLCHRotate(180),s=i.OKLCHRotate(140),i=i.OKLCHRotate(-140)),[n,i,s,c]},[ko("mono","adjacent","triad"),Gr])("gradient","Gradient",(e,t,...n)=>{if((t=Eo(t)%360)<0&&(t+=360),n.length<4)return new qe("datatype","(gradient:) must be given at least 2 colour-stop pairs of numbers and colours.");let r;const a=[],o=n.reduce((e,t)=>{if(e instanceof qe)return e;if(void 0===r)r=t;else{if(!("number"==typeof r&&t instanceof Gr))return new qe("datatype","(gradient:) colour-stops should be pairs of numbers and colours, not colours and numbers.");a.push({stop:r,colour:at(t)}),r=void 0}return e},!0);return o instanceof qe?o:void 0!==r?new qe("macrocall","This gradient has a colour-stop percent without a colour."):new la(t,a.sort((e,t)=>e.stop-t.stop))},[Number,bo(wo(So,Gr))])("stripes","Gradient",(e,t,n,...r)=>{if("px"!==n.unit)return new qe("datatype",`(stripes:) must be given a measurement with px units, not ${n.unit}`);if(n.value<=0)return new qe("datatype",`(stripes:) must be given a positive measurement, not ${n.toSource()}`);(t=Eo(t)%360)<0&&(t+=360);let a=Io(n.clone(),{value:0});const o=[];return r.forEach((e,t)=>{o.push({stop:a,colour:at(e)}),a=Io(a.clone(),{value:n.value*(t+1)}),o.push({stop:a,colour:at(e)})}),new la(t,o,!0)},[Number,xa,Gr,bo(Gr)])("image","Image",(e,...t)=>{if("a (define:) macro"!==e.stackTop.evaluateOnly)return new qe("macrocall","(image:) can only be used inside a (define:) macro call","Store the image in a variable using (define:) in order to use it for other purposes.");let n,r=new Set;for(let e=0;e<t.length;e+=1){let a=t[e];if("string"!=typeof a){if(0===e)return new qe("macrocall","(image:) must be given at least one string URL, instead of just a fallback.");if(e<t.length-1)return new qe("macrocall",`The ${N(e+1)} value (of ${t.length}) given to (image:) was ${it(a)}, but all except the last value should be a string URL.`);n=t.pop()}else{if(""===a)return new qe("macrocall",`The ${N(e+1)} value given to (image:) was an empty string.`);if(r.has(a))return new qe("macrocall",`${it(a)} was given to (image:) twice.`);r.add(a)}}return new Ca(t,n)},[bo(wo(String,Gr,la))])("hooks-named","HookName",(e,t)=>t?new fa({type:"name",data:t}):new qe("datatype","(hooks-named:) can't be given an empty string."),[String])("cond","Any",(e,...t)=>{for(let e=0;e<t.length;e+=2){const n=t[e];if(e===t.length-1||n instanceof qe)return n;if("boolean"!=typeof n)return new qe("datatype",`(cond:)'s ${N(e+1)} value is ${it(n)}, but should be a boolean.`);if(n)return t[e+1]}return new qe("macrocall",`An odd number of values must be given to (cond:), not ${t.length}`,"(cond:) must be given one or more pairs of booleans and values, as well as one final value.")},[Boolean,No,bo(No)]);const Lo=e=>(t,...n)=>e(...n);for(let[e,t]of Object.entries({weekday:[()=>`${["Sun","Mon","Tues","Wednes","Thurs","Fri","Satur"][(new Date).getDay()]}day`,null],monthday:[()=>(new Date).getDate(),null],currenttime:[()=>{const e=new Date,t=e.getHours()<12;return`${e.getHours()%12||12}:${(e.getMinutes()<10?"0":"")+e.getMinutes()} ${t?"A":"P"}M`},null],currentdate:[()=>(new Date).toDateString(),null],min:[Ao,bo(Number)],max:[jo,bo(Number)],abs:[Math.abs,Number],sign:[Math.sign,Number],sin:[Math.sin,Number],cos:[Math.cos,Number],tan:[Math.tan,Number],floor:[Oo,Number],round:[Eo,Number],trunc:[Math.trunc,Number],ceil:[Do,Number],pow:[Mo(Math.pow),[Number,Number]],exp:[Math.exp,Number],sqrt:[Mo(Math.sqrt),Number],log:[Mo(Math.log),Number],log10:[Mo(Math.log10),Number],log2:[Mo(Math.log2),Number],random:[(e,t)=>{let n,r;return t?(n=Ao(e,t),r=jo(e,t)):(n=0,r=e),r+=1,~~(Ga.random()*(r-n))+n},[parseInt,Et.TypeSignature.optional(parseInt)]]}))Et.add(e,"Number",Lo(t[0]),t[1]);Et.add("either","Any",(e,...t)=>t[~~(Ga.random()*t.length)],bo(No))("nth","Any",(e,t,...n)=>n[(t-1)%n.length],[Co,bo(No)]);const{dialog:Ro,geomParse:Po,geomStringRegExp:Vo}=vn,{Any:Fo,Everything:Ho,rest:qo,either:zo,optional:Wo,zeroOrMore:Bo,percent:Uo,nonNegativeInteger:_o,positiveInteger:Go,positiveNumber:Xo}=Et.TypeSignature,{assign:Yo}=Object,{floor:Jo,ceil:Ko,abs:Qo,max:Zo,min:ei}=Math,{noop:ti}=a;function ni(e){return`(${e} ${g.ifid}) `}for(let e of["set","put","unpack"])Et.addCommand(e,(...t)=>{for(let n of t){if("into"===n.operator&&"set"===e)return new qe("macrocall","Please say 'to' when using the (set:) macro.");if("to"===n.operator&&"set"!==e)return new qe("macrocall","Please say 'into' when using the (put:) or (unpack:) macro.");if((n.dest instanceof Un||n.dest instanceof ka)==("unpack"===e))return new qe("macrocall","unpack"===e?"Please use the (unpack:) macro with arrays, datamaps or (p:) patterns containing variables to the right of 'into'.":`Please use the (${e}:) macro with just single variables and typed variables to the ${"set"===e?"left of 'to'.":"right of 'into'."}`,`You may wish to change this to the (${"unpack"!==e?"unpack":"to"===n.operator?"set":"put"}:) macro.`)}},(e,...t)=>{let n="";for(let e of t){const t=e.set();if(t instanceof qe)return t;n+=`${t}\n`}return new Jr(n)},[qo(Gn)],{attachable:!1,storable:!1});Et.addCommand("move",(...e)=>{for(let t of e)if("into"!==t.operator)return new qe("macrocall","Please say 'into' when using the (move:) macro.")},(e,...t)=>{let n="";for(let e of t){const t=e.set(!0);if(t instanceof qe)return t;n+=`${t}\n`}return new Jr(n)},[qo(Gn)],{attachable:!1,storable:!1})("display",e=>{if(!Xe.hasValid(e))return new qe("macrocall",`I can't (display:) the passage '${e}' because it doesn't exist.`)},(e,t,n)=>(e.source=[Xe.getTree(n)],e),[String])("print",ti,(e,t,n)=>Yo(e,{source:yt(n)}),[Fo])(["verbatim-print","v6m-print"],ti,(e,t,n)=>Yo(e,{verbatim:!0,source:yt(n)}),[Fo])(["verbatim-source","v6m-source"],ti,(e,t,n)=>Yo(e,{verbatim:!0,source:yt(ut(n))}),[Fo])("go-to",e=>{if(!Xe.hasValid(e))return new qe("macrocall",`I can't (go-to:) to the passage '${e}' because it doesn't exist.`,"Check that you didn't mistype the passage name, or rename the passage to something else.")},(e,t,n)=>{if(!g.ignoreGotos)return requestAnimationFrame(()=>Za.goToPassage(n,{transition:e.data.passageT8n})),{blocked:!0}},[String])("redirect",e=>{if(!Xe.hasValid(e))return new qe("macrocall",`I can't (redirect:) to the passage '${e}' because it doesn't exist.`,"Check that you didn't mistype the passage name, or rename the passage to something else.")},(e,t,n)=>{if(!g.ignoreGotos)return requestAnimationFrame(()=>Za.redirect(n,{transition:e.data.passageT8n})),{blocked:!0}},[String])("undo",ti,(e,t,n)=>Ga.pastLength<1?Yo(e,{source:n}):g.ignoreGotos?void 0:(requestAnimationFrame(()=>Za.goBack({transition:e.data.passageT8n})),{blocked:!0}),[Wo(String)])("debug",ti,Za.enableDebugMode,[],{attachable:!1}),V(()=>h.on("click.icon","tw-icon",function(e){const t=a(this),n=t.data("clickEvent"),r=t.attr("alt");n&&n(t),"Undo"===r&&(e.stopPropagation(),Za.goBack()),"Redo"===r&&(e.stopPropagation(),Za.goForward()),"Fullscreen"===r&&(e.stopPropagation(),Za.toggleFullscreen()),"Restart"===r&&(Ga.hasSessionStorage&&sessionStorage.removeItem("Saved Session"),window.location.reload())})),[["Undo","&#8630;",()=>Ga.pastLength>0],["Redo","&#8631;",()=>Ga.futureLength>0],["Fullscreen","&#9974;",()=>document.fullscreenEnabled],["Restart","&#10226;",Object]].forEach(([e,t,n])=>{Et.addCommand(`icon-${e.toLowerCase()}`,(t,n)=>{if("string"==typeof t&&"string"==typeof n){const r=[...t].length,a=[...n].length;if(r>1&&a>1)return new qe("datatype",`One of the two strings given to (icon-${e.toLowerCase()}:) should be 1 character long, for its icon.`);if(1===r&&1===a)return new qe("datatype",`One of the two strings given to (icon-${e.toLowerCase()}:) should be 2 or more characters long, for its label.`)}},(r,o,i,s)=>(("string"==typeof s&&1===[...s].length||"string"==typeof i&&[...i].length>1)&&([i,s]=[s,i]),"Undo"===e&&(r.data.forgetUndosEvent=e=>{r.section.whenUnblocked(()=>a(e).css("visibility","hidden"))}),Yo(r,{source:`<tw-icon tabindex=0 alt="${e}" ${s?`data-label="${s.replace('"',"&quot;")}"`:""} title="${e}" ${n()?"":'style="visibility:hidden"'}>${i||t}</tw-icon>`})),[Wo(String),Wo(String)])}),Et.addCommand("icon-counter",(e,t,n)=>{const r=" label string given to (icon-counter:) can't be empty or only whitespace.";return t?.trim()?"string"!=typeof n||n.trim()?void 0:new qe("datatype",`The 2nd ${r}`):new qe("datatype",`The 1st ${r}`)},(e,t,n,r,a)=>{e.attr.push({"data-2bind":!0}),e.data.twoWayBindEvent=(t,o,i)=>{if(n.varRef.matches(o,i)){const t=n.varRef.get();if("number"==typeof t){("function"==typeof e.target?e.target():e.target).children("tw-icon").text(t>0?Jo(t):Ko(t)).attr("data-label",1!==Qo(t)&&void 0!==a?a:r)}}};const o=n.varRef.get();return o instanceof qe?o:"number"!=typeof o?new qe("datatype",`(icon-counter:) can only be bound to a variable holding a number, not ${it(o)}.`):Yo(e,{source:`<tw-icon data-label="${D(1!==Qo(o)&&void 0!==a?a:r)}">${o>0?Jo(o):Ko(o)}</tw-icon>`})},[Ta,String,Wo(String)]),Et.addCommand("meter",(e,t,n,r)=>"two way"===e.bind?new qe("datatype","(meter:) shouldn't be given two-way bound variables.",'Change the "2bind" keyword to just "bind".'):"string"!=typeof r||r.trim()?-1===n.search(Vo)||!n.includes("=")&&n.length>1?new qe("datatype",`The (meter:) macro requires a sizing line("==X==", "==X", "=XXXX=" etc.) be provided, not ${JSON.stringify(n)}.`):void 0:new qe("datatype","The label string given to (meter:) can't be empty or only whitespace."),(e,t,n,r,a,o,i)=>{o&&"string"!=typeof o&&(i=o,o=void 0),i||(i=new Gr({h:0,s:0,l:.5,a:.5})),i instanceof Gr&&(i=new la(90,[{colour:i,stop:0},{colour:i,stop:1}]));const{marginLeft:s,size:c}=Po(a),l=s>0&&Math.ceil(s+c)<100,u=e=>{const t=Zo(0,ei(1,e/r)),n=i.repeating?i:i.multiply(r/e);return`height:100%;background-repeat:no-repeat;background-image:${(l?`${Yo(n,n.repeating?{}:{angle:270}).toLinearGradientString()}, `:"")+Yo(n,n.repeating?{}:{angle:l||0===s?90:270}).toLinearGradientString()};background-size:${l?Array(2).fill(50*t+"%"):100*t+"%"};background-position-x:${l?`${-100/(2-t)+100}%,${100/(2-t)}%`:0===s?"left":"right"};text-align:${l?"center":0===s?"left":"right"}`};e.styles.push({"margin-left":`${s}%`,width:`${c}%`,height:"1.5em",display:"block"}),e.attr.push({"data-2bind":!0});const d="string"==typeof o?t.stackTop.tempVariables:void 0;e.data.twoWayBindEvent=(t,r,a)=>{if(n.varRef.matches(r,a)){const t=n.varRef.get();if("number"==typeof t){const n=("function"==typeof e.target?e.target():e.target).children("tw-meter");n.attr("style",u(t)),o&&e.section.renderInto("",void 0,{source:o,target:n,append:"replace",transitionDeferred:!1},d)}}};let p=n.varRef.get();return p instanceof qe?p:"number"!=typeof p?new qe("datatype",`(meter:) can only be bound to a variable holding a number, not ${it(p)}.`):Yo(e,{source:`<tw-meter style="${u(p)}">${o||""}</tw-meter>`})},[Ta,Xo,String,Wo(zo(String,Gr,la)),Wo(zo(Gr,la))]),[["cycling-link"],["seq-link","sequence-link"]].forEach((e,t)=>Et.addCommand(e,(...n)=>""===n[0]?new qe("datatype",`The first string in a (${e[0]}:) can't be empty.`):n.length<=(n[0]instanceof Ta?2:1)?new qe("datatype",`I need two or more strings to ${t?"sequence":"cycle"} through, not just '${n[n.length-1]}'.`):void 0,(e,n,...r)=>{let a;r[0]instanceof Ta&&(a=r.shift());let o=0;if("two way"===a?.bind&&(e.attr.push({"data-2bind":!0}),a.varRef.has())){let e=a.varRef.get();if(e instanceof qe)return e;const t=r.indexOf(e);t>-1&&(o=t)}const{tempVariables:i}=n.stackTop;function s(n,s){const c=o>=r.length-1&&t;let l=""===r[o]?"":c?r[o]:`<tw-link>${r[o]}</tw-link>`;if(c&&(e.data.clickEvent=void 0),a&&!s){const e=a.set(r[o]);if(e instanceof qe)return void n.replaceWith(e.render(""))}const u={...e,source:l,transitionDeferred:!1};e.section.renderInto("",void 0,u,i)}r[o]&&(e.data.clickEvent=e=>{o=(o+1)%r.length,s(e,!1)})&&(e.data.twoWayBindEvent=(e,t,n)=>{if(a?.varRef.matches(t,n)){const t=a.varRef.get();if(t instanceof qe)return void e.replaceWith(t.render(""));const n=r.indexOf(t);n>-1&&n!==o&&(o=n,s(e,!0))}});let c=`<tw-link>${r[o]}</tw-link>`;if(a){const e=a.set(r[o]);if(e instanceof qe)return e}return Yo(e,{source:c,append:"replace",transitionDeferred:!0})},[zo(Ta,String),qo(String)])),V(()=>h.on("change.dropdown-macro","select",function(){const e=a(this),t=e.closest("tw-expression, tw-hook").data("dropdownEvent");t&&t(e)})),Et.addCommand(["pic","picture"],ti,(e,t,n)=>(n.loaded?e.source=`<img src="${n.loaded}">`:(e.source=`<tw-fallback style="display:inline-block; width: 64px; height: 64px; background:${n.fallbackCSS()||"#000"}">`,e.attr.push({"data-img-fallback":!0}),e.data.imageLoadEvent=(t,r)=>{r===n&&n.loaded&&(e.source=`<img src="${n.loaded}">`,e.render())}),e),[Ca]),Et.addCommand("dropdown",(e,...t)=>""===t[0]||""===t[t.length-1]?new qe("datatype","The first or last strings in a (dropdown:) can't be empty.","Because empty strings create separators within (dropdown:)s, having them at the start or end doesn't make sense."):t.length<=1?new qe("datatype",`I need two or more strings to create a (dropdown:) menu, not just ${t.length}.`):void 0,(e,t,n,...r)=>{let o=0;if("two way"===n.bind&&(e.attr.push({"data-2bind":!0}),n.varRef.has())){let e=n.varRef.get();if(e instanceof qe)return e;const t=r.indexOf(e);t>-1&&(o=t)}const i=Math.max(...r.map(e=>[...e].length));let s=`<select>${r.map((e,t)=>`<option${t===o?" selected":""}${""===e?" disabled":""}>${D(e||"â".repeat(i))}</option>`).join("\n")}</select>`;e.data.dropdownEvent=e=>{const t=e.val(),r=n.set(t);r instanceof qe&&e.replaceWith(r.render(""))},e.data.twoWayBindEvent=(e,t,a)=>{if(n.varRef.matches(t,a)){const t=n.varRef.get();t instanceof qe&&e.replaceWith(t.render(""));const a=r.indexOf(t);a>-1&&a!==o&&(e.find("select").val(t),o=a)}},e.styles.push({"background-color"(){return M(a(this)).backgroundColour||void 0}});const c=n.set(r[o]);return c instanceof qe?c:Yo(e,{source:s,append:"replace"})},[Ta,String,qo(String)]),V(()=>h.on("input.checkbox-macro","input[type=checkbox]",function(){const e=a(this),t=e.closest("tw-expression").data("checkboxEvent");t&&t(e)}));let ri=1;Et.addCommand("checkbox",ti,(e,t,n,r)=>{let a=!1,o="checkbox-"+ ++ri;if("two way"===n.bind){if(e.attr.push({"data-2bind":!0}),n.varRef.has()){const e=n.varRef.get();if(e instanceof qe)return e;"boolean"==typeof e&&(a=e)}e.data.twoWayBindEvent=(e,t,r)=>{if(n.varRef.matches(t,r)){const t=n.varRef.get();"boolean"==typeof t&&e.children("input[type=checkbox]").prop("checked",t)}}}e.data.checkboxEvent=e=>{const t=e.is(":checked"),r=n.set(t);r instanceof qe&&e.replaceWith(r.render(""))};const i=n.set(a);return i instanceof qe?i:Yo(e,{source:`<input id="${o}" type="checkbox" ${a?"checked":""}><label for="${o}">${r}</label>`,append:"replace"})},[Ta,String]),V(()=>a(document).on("fullscreenchange",()=>{a("input[type=checkbox][id^=fullscreen]",h).each((e,t)=>{(a(t).closest("tw-expression").data("fullscreenEvent")||Object)(t)})})),Et.addCommand("checkbox-fullscreen",ti,(e,t,n)=>{let r="fullscreenCheckbox-"+ ++ri;return e.data.fullscreenEvent=e=>a(e).prop("checked",!!document.fullscreenElement),e.data.checkboxEvent=()=>Za.toggleFullscreen(),Yo(e,{source:`<input id="${r}" type="checkbox" ${document.fullscreenEnabled?" ":"disabled "}${document.fullscreenElement?"checked":""}><label for="${r}">${n}</label>`,append:"replace"})},[String]),V(()=>h.on("input.input-box-macro","textarea, input[type=text]",function(){const e=a(this),t=e.closest("tw-expression").data("inputBoxEvent");t&&t(e)})),["input","force-input","input-box","force-input-box"].forEach(e=>Et.addCommand(e,(...t)=>{const n=e.endsWith("box"),r=t[0]instanceof Ta,a="string"==typeof t[+r],o=n&&t[+a+ +r]instanceof xa,i=a?t[+r]:t[+r+ +o],s=Po(i).size>0,c=s?t[+r+ +o+ +a]:i;if(e.startsWith("force")&&"string"!=typeof c)return new qe("datatype",`The (${e}:) macro requires a string of text to forcibly input.`);const l=+r+ +o+ +s+ +("string"==typeof c);return t.length>l?new qe("datatype",`An incorrect combination of values was given to this (${e}:) macro.`):void 0},(t,n,...r)=>{const a=e.startsWith("force"),o=e.endsWith("box"),i=r[0]instanceof Ta,s="string"==typeof r[+i],c=o&&r[+s+ +i]instanceof xa,l=i&&r[0],u=c?r[+s+ +i]:new xa(3,"Lh"),{marginLeft:d=0,size:p=0}=s?Po(r[+i]):{},h=(p?r[+i+ +c+ +s]:+s&&r[+i])||"";let f=a?"":h,g=!1;if(l&&"two way"===l.bind){if(t.attr.push({"data-2bind":!0}),l.varRef.has()){const e=l.varRef.get();if(e instanceof qe)return e;if("string"==typeof e){f=a?h.slice(0,e.length):e;const t=l.set(f);if(g=!0,t instanceof qe)return t}}t.data.twoWayBindEvent=(e,t,n)=>{if(l.varRef.matches(t,n)){const t=l.varRef.get();"string"==typeof t&&e.find(o?"textarea":"input").val(a?h.slice(0,t.length):t)}}}if(l&&!g){const e=l.set(a?"":h);if(e instanceof qe)return e}!a&&l&&(t.data.inputBoxEvent=e=>{const t=e.val(),n=l.set(t);n instanceof qe&&e.replaceWith(n.render(""))});let m=`<${o?"textarea":"input type=text"} style="width:100%;${o?`height:${u.toCSSString()}">`:'" value="'}${D(f)}${o?"</textarea>":'">'}`;if(a){const e=Array.from(h);t.data.inputBoxEvent=t=>{const{length:n}=t.val(),r=e.slice(0,n).join("");if(t.val(r),l){const e=l.set(r);e instanceof qe&&t.replaceWith(e.render(""))}return!0}}return t.styles.push({display:"block",...p?{"margin-left":`${d}%`}:void 0,width:p?`${p}%`:"100%",...c?{height:u.toCSSString()}:void 0,"border-style"(){return this.style.borderStyle||"solid"}}),Yo(t,{source:m,append:"replace"})},e.endsWith("box")?[zo(Ta,String),Wo(zo(xa,String)),Wo(zo(xa,String)),Wo(String)]:[Wo(zo(Ta,String)),Wo(String),Wo(String)])),["show","rerun"].forEach(e=>Et.addCommand(e,(...e)=>{let t;return e.some(function e({selector:n,next:r}){return"name"===n.type&&"page"===n.data?(t=new qe("macrocall","You can't (hide:) the ?page. Sorry."),!0):!!("base"===n.type&&e(n.data)||r&&e(r))||void 0}),t},(t,n,...r)=>(r.forEach(r=>r.forEach(n,r=>{const a=r.data("hidden");if(void 0!==a!=("rerun"===e))if(r.removeData("hidden"),"object"==typeof a&&"jquery"in a)r.empty().append(a);else{const e=r.data("tempVariables"),a="tw-passage"===r.tag(),o=a?Xe.getTree(Ga.passage):r.data("originalSource")||"";let i;a&&(i=r.find("tw-sidebar").detach()),n.renderInto("",void 0,{...t,append:"replace",source:o,target:r},e&&Object.create(e)),i&&r.prepend(i)}})),t),[qo(fa)]));const ai=e=>[`I can't use a dialog macro in ${e}.`,"Please rewrite this without putting such macros here."];Et.addCommand("hide",(...e)=>{let t;return e.some(function e({selector:n,next:r}){return"name"===n.type&&"page"===n.data?(t=new qe("macrocall","You can't (hide:) the ?page. Sorry."),!0):!!("base"===n.type&&e(n.data)||r&&e(r))||void 0}),t},(e,...t)=>{for(let n of t)n.forEach(e,e=>{e.data("hidden")||e.data("hidden",e.contents().detach())})},[qo(fa)],{attachable:!1});Et.addCommand(["scroll-to","scroll"],ti,(e,t,n)=>{requestAnimationFrame(()=>{t.forEach(e,t=>{if(n instanceof xa){let e=(e=>(e===h[0]&&e.scrollHeight===e.clientHeight&&(e=getComputedStyle(document.body).overflow.includes(" scroll")?document.body:document.documentElement),e))(t[0]);e.scrollTo?.(0,n.pxLengthInElement(e,!0))}else for(let r of n.hooks(e).get())if(t.find(r)){const e=[];let n=t[0];for(;(n=n.parentNode)&&n!==document.body;)e.push([n,n.scrollLeft,n.scrollTop]);r.scrollIntoView();for(let[t,n,r]of e)t.scrollLeft=n,t.scrollTop=r;break}})})},[fa,zo(xa,fa)],{attachable:!1})("scroll-by",ti,(e,t,n)=>{requestAnimationFrame(()=>{t.forEach(e,e=>{if(n instanceof xa){let t=(e=>(e===h[0]&&e.scrollHeight===e.clientHeight&&(e=getComputedStyle(document.body).overflow.includes(" scroll")?document.body:document.documentElement),e))(e[0]);t.scrollBy?.(0,n.pxLengthInElement(t,!0))}})})},[fa,xa],{attachable:!1})("stop",ti,ti,[],{attachable:!1})("load-game",ti,(e,t)=>{if(e.loadedGame)return new qe("infinite","I can't use (load-game:) immediately after loading a game.");const n=localStorage.getItem(ni("Saved Game")+t);if(!n)return new qe("saving",`I can't find a save slot named '${t}'!`);try{Ga.deserialise(e,n)}catch(n){if(!(n instanceof q))throw n;const r=Ro({message:`Sorry to interrupt... The story tried to load saved data, but there was a problem.\n${n.message}\n\nThat data might have been saved from a different version of this story. Should I delete it?\n(Type 'delete' and choose Yes to delete it.)\n\nEither way, the story will now continue without loading the data.`,defaultValue:"",buttons:[{name:"Yes",confirm:!0,callback:()=>{"delete"===r.find("input").last().val()&&localStorage.removeItem(ni("Saved Game")+t),e.unblock("")}},{name:"No",confirm:!1,callback:()=>e.unblock()}]});return{blocked:r}}requestAnimationFrame(Za.showPassage.bind(Za,Ga.passage,{loadedGame:!0}))},[String],{attachable:!1})("forget-undos",ti,(e,t)=>{Ga.futureLength||Ga.forgetUndos(t)},[parseInt],{attachable:!1})("forget-visits",ti,(e,t)=>{Ga.forgetVisits(t)},[parseInt],{attachable:!1})("mock-visits",(...e)=>{if(!g.debug)return new qe("debugonly","(mock-visits:) cannot be used outside of debug mode.");const t=e.find(e=>!Xe.hasValid(e));return t?new qe("datatype",`I can't mock-visit '${t}' because no passage with that name exists.`):void 0},(e,...t)=>{Ga.mockVisits=at(t)},[qo(String)],{attachable:!1})("mock-turns",()=>{if(!g.debug)return new qe("debugonly","(mock-turns:) cannot be used outside of debug mode.")},(e,t)=>{Ga.mockTurns=t},[_o],{attachable:!1})("seed",ti,(e,t)=>{Ga.setSeed(t)},[String],{attachable:!1})(["dialog","alert"],(e,t,...n)=>{if(e instanceof Ta){if("two way"===e.bind)return new qe("datatype","(dialog:) shouldn't be given two-way bound variables.",'Change the "2bind" keyword to just "bind".');if(void 0===t)return new qe("datatype","(dialog:) needs a message string or codehook to display.")}else void 0!==t&&n.unshift(t);const r=n.findIndex(e=>""===e);if(r>-1)return new qe("datatype",`(dialog:)'s ${N(r+1)} link text shouldn't be an empty string.`)},(e,t,n,r,...a)=>{n instanceof Ta||("string"==typeof r&&a.unshift(r),r=n,n=void 0),a.length||(a=["OK"]);return{blocked:Ro({section:t,message:r,cd:e,buttons:a.map(e=>({name:e,callback(){t.unblock(n?.set(e)||"")}}))})}},[zo(Ta,String,ar),Wo(zo(ar,String)),Bo(String)])("open-url",ti,(e,t)=>{window.open(t,"")},[String],{attachable:!1})(["restart","reload"],ti,()=>{if(!g.ignoreGotos){if(Ga.turns<=1)return new qe("infinite","I mustn't (restart:) the story in the starting passage.");Ga.hasSessionStorage&&sessionStorage.removeItem("Saved Session"),window.location.reload()}},[],{attachable:!1})("goto-url",ti,(e,t)=>{window.location.assign(t)},[String],{attachable:!1})("ignore",ti,ti,[Bo(Ho)])("assert-exists",e=>{if(""===e)return new qe("datatype","(assert-exists:) mustn't be given an empty string.")},(e,t,n)=>{let r=0;return("string"==typeof n?new fa({type:"string",data:n}):n).forEach(t,()=>{++r}),r?e:new qe("assertion",`I didn't see any ${"string"==typeof n?"text occurrences of":"hooks matching"} ${ut(n)} in this passage.`)},[zo(fa,String)])("assert",e=>e?void 0:new qe("assertion","An assertion failed"),ti,[Boolean],{storable:!1}),Et.add("save-game","Boolean",(e,t,n)=>{if(n||="",!Ga.hasStorage)return!1;const{pastAndPresent:r}=Ga.serialise(!1);if(""===r)return!1;try{return localStorage.setItem(ni("Saved Game")+t,r),localStorage.setItem(ni("Saved Game Filename")+t,n),!0}catch(e){return!1}},[String,Wo(String)])("prompt","String",(e,t,n,r,a)=>{if(e.stackTop?.evaluateOnly)return new qe("macrocall",...ai(e.stackTop.evaluateOnly));if(""===a)return new qe("datatype","The text for (prompt:)'s confirm link can't be blank.");const o=Ro({section:e,message:t,defaultValue:n,buttons:[{name:a||"OK",confirm:!0,callback:()=>e.unblock(o.find("input").last().val())}].concat(""===r?[]:{name:r||"Cancel",confirm:!1,callback:()=>e.unblock(n)})});return e.stackTop.blocked=o,0},[zo(String,ar),String,Wo(String),Wo(String)])("confirm","Boolean",(e,t,n,r)=>{if(e.stackTop?.evaluateOnly)return new qe("macrocall",...ai(e.stackTop.evaluateOnly));if(""===r)return new qe("datatype","The text for (confirm:)'s confirm link can't be blank.");const a=Ro({section:e,message:t,defaultValue:!1,buttons:[{name:r||"OK",confirm:!0,callback:()=>e.unblock(!0)}].concat(""===n?[]:{name:n||"Cancel",confirm:!1,callback:()=>e.unblock(!1)})});return e.stackTop.blocked=a,0},[zo(String,ar),Wo(String),Wo(String)])("page-url","String",()=>window.location.href,[]);const{optional:oi,rest:ii,either:si,zeroOrMore:ci,Any:li,nonNegativeInteger:ui}=Et.TypeSignature,di=W("en");Et.add(["a","array"],"Array",(e,...t)=>t,ci(si(ka,li)))("range","Array",(e,t,n)=>bt(t,n),[parseInt,parseInt])("subarray","Array",(e,t,n,r)=>gt(t,n,r),[Array,parseInt,parseInt])("reversed","Array",(e,...t)=>t.reverse().map(at),ci(li))("shuffled","Array",(e,...t)=>Ga.shuffled(...t).map(at),[ci(li)])("sorted","Array",(e,...t)=>{if(!(t[0]instanceof va)){const e=t.filter(e=>"string"!=typeof e&&"number"!=typeof e);return e?.length?1===e.length&&Array.isArray(e[0])?new qe("macrocall","Please give multiple numbers or strings to (sorted:), not a single array.","You can use the spread ... syntax to spread out the array's values into (sorted:)."):new qe("datatype",`If (sorted:) isn't given a 'via' lambda, it must be given only numbers and strings, not ${it(e[0])}.`):t.sort(di)}let n=t.shift();if("making"in n||"where"in n||"when"in n||!("via"in n))return new qe("datatype",`The optional lambda given to (sorted:) must be a 'via' lambda, not ${it(n)}.`);let r=[];for(let a=0;a<t.length;a+=1){const o=n.apply(e,{loop:t[a],pos:a+1});if(o instanceof qe)return o;if("string"!=typeof o&&"number"!=typeof o)return new qe("datatype",`The "via" lambda given to (sorted:) converted ${it(t[a])} into ${it(o)}, but it should have produced a string or number.`,"(sorted:) can only sort strings and numbers, so the lambda needs to convert values into either of those types.");r[a]=[t[a],o]}return r.sort((e,t)=>di(e[1],t[1])).map(e=>e[0])},[ci(li)])("rotated","Array",(e,t,...n)=>{if(0===t)return new qe("macrocall","I can't rotate these values by 0 positions.");const r=-1*(t=Math.abs(t)%n.length*Math.sign(t));return n.slice(r).concat(n.slice(0,r)).map(at)},[parseInt,ci(li)])("rotated-to","Array",(e,t,...n)=>{const r=t.filter(e,n);if(r instanceof qe)return r;if(!r.length)return new qe("macrocall",`None of these ${n.length} values matched the lambda, so I can't rotate them.`);const a=n.indexOf(r[0]);return n.slice(a).concat(n.slice(0,a)).map(at)},[va.TypeSignature("where"),ii(li)])("repeated","Array",(e,t,...n)=>{const r=[];if(!n.length)return r;for(;t-- >0;)r.push(...n);return r.map(at)},[ui,ii(li)])("interlaced","Array",(e,...t)=>{let n=Math.min(...t.map(e=>e.length));const r=[];for(let e=0;e<n;e+=1)for(let n=0;n<t.length;n+=1)r.push(at(t[n][e]));return r},[Array,ii(Array)])("permutations","Array",(e,...t)=>t.length?C(...t):[],[ci(li)])("unique","Array",(e,...t)=>t.filter(wt),[ci(li)])("altered","Array",(e,t,...n)=>n.reduce((n,r,a)=>{if(n instanceof qe)return n;const o=t.apply(e,{loop:r,pos:a+1});if(null===o)return n.push(r),n;if(o instanceof qe)return o;let i;return(i=et(o))?new qe("datatype",`(altered:)'s 'via' lambda produced ${it(i)}, which can't be stored in arrays.`):(n.push(o),n)},[]),[si(va.TypeSignature("via"),va.TypeSignature("where","via")),ci(li)])("find","Array",(e,t,...n)=>t.filter(e,n),[va.TypeSignature("where"),ci(li)])(["all-pass","pass"],"Boolean",(e,t,...n)=>{const r=t.filter(e,n);return r instanceof qe?r:r.length===n.length},[va.TypeSignature("where"),ci(li)])("some-pass","Boolean",(e,t,...n)=>{const r=t.filter(e,n);return r instanceof qe?r:r.length>0},[va.TypeSignature("where"),ci(li)])("none-pass","Boolean",(e,t,...n)=>{const r=t.filter(e,n);return r instanceof qe?r:0===r.length},[va.TypeSignature("where"),ci(li)])("folded","Any",(e,t,...n)=>n.reduce((n,r,a)=>{if(n instanceof qe)return n;if(r instanceof qe)return r;const o=t.apply(e,{making:n,loop:r,pos:a+1});if(o instanceof qe)return o;if(null===o)return n;let i;return(i=et(o))?new qe("datatype",`(folded:)'s 'via' lambda produced ${it(i)}, which can't be stored in arrays.`):o}),[si(va.TypeSignature("where","via","making"),va.TypeSignature("via","making")),ii(li)])(["dm-names","datamap-names","datanames"],"Array",(e,t)=>Array.from(t.keys()).sort(W("en")),[Map])(["dm-values","datamap-values","datavalues"],"Array",(e,t)=>Array.from(t.entries()).sort(W("en",e=>String(e[0]))).map(e=>at(e[1])),[Map])(["dm-entries","datamap-entries","dataentries"],"Array",(e,t)=>Array.from(t.entries()).sort((e,t)=>[e[0],t[0]].sort(W("en"))[0]===e[0]?-1:1).map(e=>new Map([["name",e[0]],["value",at(e[1])]])),[Map])(["dm-altered","datamap-altered"],"Datamap",(e,t,n)=>Array.from(n.entries()).sort((e,t)=>[e[0],t[0]].sort(W("en"))[0]===e[0]?-1:1).reduce((n,r,a)=>{if(n instanceof qe)return n;const o=new Map([["name",r[0]],["value",at(r[1])]]),i=t.apply(e,{loop:o,pos:a+1});if(i instanceof qe)return i;if(null===i)return n.set(r[0],r[1]);let s;return(s=et(i))?new qe("datatype",`(dm-altered:)'s 'via' lambda produced ${it(s)}, which can't be stored in datamaps.`):n.set(r[0],i)},new Map),[si(va.TypeSignature("via"),va.TypeSignature("where","via")),Map])("history","Array",(e,t)=>{const n=Ga.history();if(!t)return n;const r=t.filter(e,n.map(e=>Xe.get(e)));return r instanceof qe?r:r.map(e=>e.get("name"))},[oi(va.TypeSignature("where"))])("visited","Boolean",(e,t)=>{if("string"==typeof t)return Xe.has(t)?Ga.passageNameVisited(t)>0||Ga.passage===t:new qe("macrocall",`There's no passage named '${t}' in this story.`);let n=Ga.history(),r=t.filter(e,n.concat(Ga.passage).map(e=>Xe.get(e)));return r instanceof qe?r:r.length>0},[si(String,va.TypeSignature("where"))])("passage","Datamap",(e,t)=>at(Xe.get(t||Ga.passage))||new qe("macrocall",`There's no passage named '${t}' in this story.`),[oi(String)])("passages","Array",(e,t)=>{const n=W("en"),r=[...Xe.values()].map(e=>at(e)),a=t?t.filter(e,r):r;return a instanceof qe?a:a.sort((e,t)=>n(e.get("name"),t.get("name")))},[oi(va.TypeSignature("where"))])("open-storylets","Array",(e,t)=>{if(e.stackTop.evaluateOnly)return new qe("macrocall",`(open-storylets:) can't be used in ${e.stackTop.evaluateOnly}.`);const n=Xe.getStorylets(e,t);return n instanceof qe?n:n.map(at)},[oi(va.TypeSignature("where"))])("savedgames","Datamap",()=>{function e(e){return`(${e} ${g.ifid}) `}let t,n=0;const r=new Map;do{if(!Ga.hasStorage)break;t=localStorage.key(n),n+=1;const a=e("Saved Game");t?.startsWith(a)&&(t=t.slice(a.length),r.set(t,localStorage.getItem(e("Saved Game Filename")+t)))}while(t);return r},[])(["datamap","dm"],"Datamap",(e,...t)=>{let n;const r=new Map,a=t.reduce((e,t)=>{if(e instanceof qe)return e;if(void 0===n)n=t;else{let e=tt(r,n);if(e instanceof qe)return e;if(r.has(n))return new qe("macrocall",`You used the same data name (${it(n)}) twice in the same (datamap:) call.`);r.set(n,at(t)),n=void 0}return!0},!0);return a instanceof qe?a:void 0!==n?new qe("macrocall","This datamap has a data name without a value."):r},ci(si(ka,li)))(["dataset","ds"],"Dataset",(e,...t)=>new Set(t.filter(wt).map(at)),ci(li))("count","Number",function e(t,n,...r){if(r.length>1){const a=r.map(r=>e(t,n,r));for(let e of a)if(e instanceof qe)return e;return a.reduce((e,t)=>e+t,0)}const[a]=r;switch(Ze(n)){case"dataset":case"datamap":return new qe("macrocall","(count:) shouldn't be given a datamap or dataset.","You should use the 'contains' operator instead. For instance, write: $variable contains 'value'.");case"string":return"string"!=typeof a?new qe("macrocall",`${it(n)} can't contain ${it(a)} because it isn't also a string.`):a?n.split(a).length-1:0;case"array":return n.reduce((e,t)=>e+ +dt(t,a),0);default:return new qe("macrocall",`${it(n)} can't contain values, let alone ${it(a)}.`)}},[li,ii(li)]);const{geomParse:pi,geomStringRegExp:hi}=vn,{assign:fi}=Object,{either:gi,wrapped:mi,optional:yi,Any:bi,Everything:vi,zeroOrMore:wi,rest:$i,insensitiveSet:ki,positiveNumber:xi,nonNegativeNumber:Si,percent:Ti}=Et.TypeSignature,Ci=[mi(Boolean,'If you gave a number, you may instead want to check that the number is not 0. If you gave a string, you may instead want to check that the string is not "".')];V(()=>h.on("mouseenter.hover-macro","[hover=false]",function(){const e=a(this),t=e.data("hoverChanger");if(g.debug&&g.ignoreClickEvents&&!e.is("tw-backdrop.eval-replay *, tw-backdrop.harlowe-crash *"))return;e.data({mouseoutStyle:e.attr("style")||""});const n=new tr({target:e});t?.run(n),n.update(),e.attr("hover","true")}).on("mouseleave.hover-macro","[hover=true]",function(){const e=a(this),t=e.data("mouseoutStyle");e.attr("style",t).removeData("mouseoutStyle").attr("hover","false")})),qe.on(()=>{a("tw-expression, tw-hook",h).each((e,t)=>{let n=a(t);(n.data("errorEvent")||Object)(n)})});const Ni=ki("instant","dissolve","fade","rumble","shudder","pulse","zoom","flicker","slideleft","slideright","slideup","slidedown","fadeleft","faderight","fadeup","fadedown","blur"),ji=ki("dotted","dashed","solid","double","groove","ridge","inset","outset","none");Et.addChanger("if",(e,t)=>new rr("if",[t]),(e,t)=>{e.enabled&&=t},Ci)("unless",(e,t)=>new rr("unless",[t]),(e,t)=>{e.enabled&&=!t},Ci)("elseif",(e,t)=>void 0===e.stackTop.lastHookShown?new qe("macrocall","There's no (if:) or something else before this to do (else-if:) with."):new rr("elseif",[!1===e.stackTop.lastHookShown&&!!t]),(e,t)=>{e.enabled&&=t},Ci)("else",e=>void 0===e.stackTop.lastHookShown?new qe("macrocall","There's nothing before this to do (else:) with."):new rr("else",[!1===e.stackTop.lastHookShown]),(e,t)=>{e.enabled&&=t},null)("hidden",()=>new rr("hidden"),e=>{e.enabled=!1},null)(["verbatim","v6m"],()=>new rr("verbatim"),e=>{e.verbatim=!0},null)("live",(e,t)=>new rr("live",t?[t]:[]),(e,t)=>{e.enabled=!1,e.transitionDeferred=!0,e.data.live={delay:t}},yi(Number))("event",(e,t)=>new rr("event",[t]),(e,t)=>{e.enabled=!1,e.transitionDeferred=!0,e.data.live={event:t}},va.TypeSignature("when"))("more",()=>new rr("more"),e=>{e.enabled=!1,e.transitionDeferred=!0,e.data.live={event:{when:!0,filter:e=>0!==e.Identifiers.exits?[]:[!0]}}},null)("after",(e,t,n)=>new rr("after",[t].concat(void 0!==n?[n]:[])),(e,t,n)=>{e.enabled=!1,e.transitionDeferred=!0,e.data.live={event:{when:!0,filter:e=>(b+w>0&&n&&(t-=n),e.Identifiers.time>t?[!0]:[])}}},[xi,yi(Si)])("after-error",()=>new rr("after-error",[]),e=>{e.enabled=!1,e.transitionDeferred=!0;const{tempVariables:t}=e.section.stackTop;e.data.errorEvent=n=>{n.removeData("errorEvent");const r={...e,enabled:!0,transitionDeferred:!1};r.data&&(r.data.errorEvent=void 0),e.section.whenUnblocked(()=>e.section.renderInto("",void 0,r,t))}},[])("hook",(e,t)=>{if(!t)return new qe("datatype","The string given to (hook:) was empty.");const n=I(t);return n?new rr("hook",[n]):new qe("datatype",`The string given to (hook:), "${t}", contained only dashes and underscores.`)},(e,t)=>{e.attr.push({name:t})},[String])(["for","loop"],(e,t,...n)=>t.loop?new rr("for",[t].concat(n)):new qe("datatype","The lambda provided to (for:) must refer to a temp variable, not just 'it'."),(e,t,...n)=>{const r=t.filter(e.section,n);let a;if(a=qe.containsError(r))return a;(e.loopVars||=Object.create(null))[t.loop.getName()]=r||[]},[va.TypeSignature("where"),wi(bi)])(["transition","t8n"],(e,t)=>new rr("transition",[I(t)]),(e,t)=>{e.transition=t,"zoom"===t&&(e.transitionOrigin=function(){const{left:e=0,top:t=0}=a(this).offset()||{};return`${k.x-e}px ${k.y-t}px`})},[Ni])(["transition-time","t8n-time"],(e,t)=>new rr("transition-time",[t]),(e,t)=>{e.transitionTime=t,e.data.passageT8n={...e.data.passageT8n,time:t}},[xi])(["transition-delay","t8n-delay"],(e,t)=>new rr("transition-delay",[t]),(e,t)=>{e.transitionDelay=t},[Si])(["transition-skip","t8n-skip"],(e,t)=>new rr("transition-skip",[t]),(e,t)=>{e.transitionSkip=t},[xi])(["transition-depart","t8n-depart"],(e,t)=>new rr("transition-depart",[I(t)]),(e,t)=>{e.data.passageT8n={...e.data.passageT8n,depart:t,departOrigin:"zoom"===t?function(){const{left:e=0,top:t=0}=a(this).offset()||{};return`${k.x-e}px ${k.y-t}px`}:void 0}},[Ni])(["transition-arrive","t8n-arrive"],(e,t)=>new rr("transition-arrive",[I(t)]),(e,t)=>{e.data.passageT8n={...e.data.passageT8n,arrive:t,arriveOrigin:"zoom"===t?function(){const e=a(this),{left:t=0,top:n=0}=e.offset()||{},r=e.height()||1;return{"transform-origin":`${100*(k.x-t)/(e.width()||1)}% ${100*(k.y-n)/r}%`,height:`${r}px`}}:void 0}},[Ni])("button",(e,t)=>void 0===t||pi(t).size?new rr("button",t?[t]:[]):new qe("datatype",`The string given to (button:) should be a sizing line ("==X==", "==X", "=XXXX=" etc.), not ${JSON.stringify(t)}.`),(e,t)=>{const{marginLeft:n,size:r}=pi(t);e.attr.push({class(){return this.className+(this.classList.contains("enchantment-button")?"":`${" ".repeat(+(this.className.length>0))}enchantment-button`)}}),e.styles.push({...r?{"margin-left":`${n}%`}:void 0,width:r?`${r}%`:"100%"})},[yi(String)]);const Ai={click:{className:"enchantment-link",blockClassName:"enchantment-clickblock"},doubleclick:{className:"enchantment-dblclick",blockClassName:"enchantment-dblclickblock"},mouseover:{className:"enchantment-mouseover",blockClassName:"enchantment-mouseoverblock"},mouseout:{className:"enchantment-mouseout",blockClassName:"enchantment-mouseoutblock"}};Et.addChanger("action",(e,t)=>new rr("action",[I(t)]),(e,t)=>{e.attr.push({class(){const e=function e(t){const n=a(t);return n.is("tw-story, tw-sidebar, tw-passage")||["block","flex"].includes(n.css("display"))||n.children().get().some(e)}(this);return Array.from(this.classList).filter(e=>!Object.keys(Ai).some(t=>Ai[t].className===e||Ai[t].blockClassName===e)).concat(Ai[t][e?"blockClassName":"className"]).join(" ")}})},[ki(...Object.keys(Ai))])(["border","b4r"],(e,...t)=>new rr("border",t.map(I)),(e,...t)=>{e.styles.push({display(){let e=a(this).css("display");return t.every(e=>"none"===e)||!e.includes("inline")?e:"inline-block"},"border-style":t.join(" "),"border-width"(){return this.style.borderWidth||"2px"}})},[ji,...Array(3).fill(yi(ji))])(["border-size","b4r-size"],(e,...t)=>{for(let e of t)if(e.containsUnits("w","h","Lh"))return new qe("macrocall","(border-size:) can't be given measurements with w, h, or Lh units.");return new rr("border-size",t)},(e,...t)=>{e.styles.push({"border-width":t.map(e=>e.toCSSString()).join(" ")})},[xa,...Array(3).fill(yi(xa))])("corner-radius",(e,...t)=>new rr("corner-radius",t),(e,...t)=>{e.styles.push({"border-radius":t.map(e=>e.toCSSString()).join(" "),padding(){return this.style.padding||t.map(e=>e.toCSSString()).join(" ")}})},[xa,...Array(3).fill(yi(xa))])(["border-colour","b4r-colour","border-color","b4r-color"],(e,...t)=>new rr("border-colour",t.map(e=>e instanceof Gr?e.toCSSString():e)),(e,...t)=>{e.styles.push({"border-color":t.join(" ")})},[gi(String,Gr),...Array(3).fill(yi(gi(String,Gr)))])("opacity",(e,t)=>new rr("opacity",[t]),(e,t)=>{e.styles.push({opacity:t})},[Ti])("font",(e,t)=>new rr("font",[t]),(e,t)=>{e.styles.push({"font-family":t})},[String])("align",(e,t)=>/^(==+>|<=+|=+><=+|<==+>)$/.test(t)?new rr("align",[t]):new qe("datatype",`The (align:) macro requires an alignment arrow ("==>", "<==", "==><=" etc.) be provided, not "${t}"`),(e,t)=>{let n,r=t.indexOf("><");if(~r){const e=Math.round(r/(t.length-2)*50);n={"text-align":"center","max-width":"50%",...25===e?{"margin-left":"auto","margin-right":"auto"}:{"margin-left":`${e}%`}}}else n=t.startsWith("<")&&t.endsWith(">")?{"text-align":"justify","max-width":"50%"}:t.includes(">")?{"text-align":"right"}:{"text-align":"left"};n.display="block",e.styles.push(n)},[String])(["text-colour","text-color","color","colour"],(e,t)=>new rr("text-colour",[t]),(e,t)=>{t instanceof Gr&&(t=t.toCSSString()),e.styles.push({color:t})},[gi(String,Gr)])(["text-size","size"],(e,t,n)=>t.containsUnits("w","h")?new qe("datatype","The (text-size:) macro's 1st argument can't have w or h units."):t.value<=0||(n?.value??1)<=0?new qe("datatype",`The (text-size:) macro requires positive measures be given, not ${(t.value<=0?t:n).toSource()}`):new rr("text-size",[t].concat(n??[])),(e,t,n)=>{e.styles.push({"font-size":t.toCSSString(),"line-height":n?.toCSSString()??"1.5"})},[xa,yi(xa)])("text-indent",(e,t)=>new rr("text-indent",[t]),(e,t)=>{e.styles.push({"text-indent":t.toCSSString(),display:"inline-block"})},[xa])(["text-rotate-z","text-rotate"],(e,t)=>new rr("text-rotate-z",[t]),(e,t)=>{e.styles.push({display:"inline-block",transform(){let e=a(this).css("transform")||"";return"none"===e&&(e=""),`${e} rotate(${t}deg)`}})},[Number])("text-rotate-y",(e,t)=>new rr("text-rotate-y",[t]),(e,t)=>{e.styles.push({display:"inline-block",transform(){let e=a(this).css("transform")||"";return"none"===e&&(e=""),`${e} perspective(50vw) rotateY(${t}deg)`}})},[Number])("text-rotate-x",(e,t)=>new rr("text-rotate-x",[t]),(e,t)=>{e.styles.push({display:"inline-block",transform(){let e=a(this).css("transform")||"";return"none"===e&&(e=""),`${e} perspective(50vw) rotateX(${t}deg)`}})},[Number])(["background","bg"],(e,t)=>new rr("background",[t]),(e,t)=>{let n;t instanceof Ca&&(t=t.loaded||t.fallback||"#000"),t instanceof Gr?t=t.toCSSString():t instanceof la&&(t=t.toLinearGradientString()),n=/^\s*(?:repeating-)?(?:linear|radial|conic)-gradient\(/.test(t)?{"background-image":t}:Gr.isHexString(t)||/^\s*(?:\w+)\(/.test(t)?{"background-color":t}:{"background-size":"cover","background-image":`url(${t})`,"background-attachment":"fixed"},e.styles.push(n,{display(){const e=a(this);return!e.children().length||L(e)?a(this).css("display"):"block"}})},[gi(String,Gr,la,Ca)])(...(()=>{const e={color:()=>"transparent"},t=Object.setPrototypeOf({none:{},bold:{"font-weight":"bold"},italic:{"font-style":"italic"},underline:{"text-decoration":"underline"},doubleunderline:{"text-decoration":"underline","text-decoration-style":"double"},wavyunderline:{"text-decoration":"underline","text-decoration-style":"wavy"},strike:{"text-decoration":"line-through"},doublestrike:{"text-decoration":"line-through","text-decoration-style":"double"},wavystrike:{"text-decoration":"line-through","text-decoration-style":"wavy"},superscript:{"vertical-align":"super","font-size":".83em"},subscript:{"vertical-align":"sub","font-size":".83em"},blink:{animation:"fade-in-out 1s steps(1,end) infinite alternate"},shudder:{animation:"shudder linear 0.1s 0s infinite"},mark:{"background-color":"hsla(60, 100%, 50%, 0.6)"},condense:{"letter-spacing":"-0.08em"},expand:{"letter-spacing":"0.1em"},outline:[{"text-shadow"(){const e=a(this).css("color");return`-1px -1px 0 ${e}, 1px -1px 0 ${e},-1px  1px 0 ${e}, 1px  1px 0 ${e}`}},{color(){return M(a(this)).backgroundColour||void 0}}],shadow:{"text-shadow"(){return`0.08em 0.08em 0.08em ${a(this).css("color")}`}},emboss:{"text-shadow"(){return`0.04em 0.04em 0em ${a(this).css("color")}`}},smear:[{"text-shadow"(){const e=a(this).css("color");return`0em   0em 0.02em ${e},-0.2em 0em  0.5em ${e}, 0.2em 0em  0.5em ${e}`}},e],blur:[{"text-shadow"(){return`0em 0em 0.08em ${a(this).css("color")}`}},e],blurrier:[{"text-shadow"(){return`0em 0em 0.2em ${a(this).css("color")}`},"user-select":"none"},e],mirror:{display:"inline-block",transform:"scaleX(-1)"},upsidedown:{display:"inline-block",transform:"scaleY(-1)"},tall:{display:"inline-block",transform:"scaleY(1.5) translateY(-0.25ex)"},flat:{display:"inline-block",transform:"scaleY(0.5) translateY(0.25ex)"},fadeinout:{animation:"fade-in-out 2s ease-in-out infinite alternate"},rumble:{animation:"rumble linear 0.1s 0s infinite"},sway:{animation:"sway linear 2.5s 0s infinite"},buoy:{animation:"buoy linear 2.5s 0s infinite"},fidget:{animation:()=>`fidget step-end 60s ${60*-Math.random()}s infinite${Math.random()<.5?" reverse":""}`}},null);return["text-style",(e,...t)=>new rr("text-style",t.map(I)),(e,...n)=>{for(let r=0;r<n.length;r+=1)"none"===n[r]?e.styles=[]:e.styles=e.styles.concat(t[n[r]])},[$i(ki(...Object.keys(t)))]]})())(["scrollbar","scrollbar-y"],(e,t)=>new rr("scrollbar",[t]),(e,t)=>{e.styles.push({overflowY:{auto:"auto",off:"hidden",on:"scroll",never:"clip"}[t]})},[ki("auto","off","on","never")])("scrollbar-x",(e,t)=>new rr("scrollbar-x",[t]),(e,t)=>{e.styles.push({overflowX:{auto:"auto",off:"hidden",on:"scroll",never:"clip"}[t]})},[ki("auto","off","on","never")])("collapse",()=>new rr("collapse"),e=>{e.attr.push({collapsing:!0})},[])("hover-style",(e,t)=>{const n=new tr,r=(t.run(n),n.summary());return"styles"==`${r}`||r.every(e=>"styles"===e||"attr"===e)&&n.attr.every(e=>"style"==`${Object.keys(e)}`)?new rr("hover-style",[t]):new qe("datatype","The changer given to (hover-style:) must only change the hook's style.")},(e,t)=>{e.data.hoverChanger=t,e.attr.push({hover:(e,t)=>void 0!==t&&t})},[rr])("css",(e,t)=>(t.trim().endsWith(";")||(t+=";"),new rr("css",[t])),(e,t)=>{e.attr.push({style(){return(a(this).attr("style")||"")+t}})},[String])("test-true",()=>new rr("test-true",[]),e=>{e.enabled=!0},wi(vi))("test-false",()=>new rr("test-false",[]),e=>{e.enabled=!1},wi(vi)),Et.addCommand("animate",a.noop,(e,t,n,r,a)=>{n.forEach(t,t=>{let n;if("zoom"===r){const{left:e=0,top:r=0}=t.offset()||{};n=`${k.x-e}px ${k.y-r}px`}R(t,r,e.transitionTime||a,e.transitionDelay,e.transitionSkip,0,n)})},[fa,ki(...Ni.innerType.filter(e=>"instant"!==e)),yi(xi)]);for(const e of["box","float-box"])Et.addChanger(e,(t,n,r)=>{const a=-1===n.search(hi)||n.length>1&&!n.includes("="),o="string"==typeof r&&(-1===r.search(hi)||r.length>1&&!r.includes("="));return a||o?new qe("datatype",`The (${e}:) macro requires a sizing line("==X==", "==X", "=XXXX=" etc.) be provided, not "${a?n:r}".`):new rr(e,[n,r].filter(e=>void 0!==e))},(t,n,r)=>{const{marginLeft:o,size:i}=pi(n);let s,c;"float-box"===e?({marginLeft:s,size:c}=pi(r)):c=r;const l="box"===e?"%":"vw",u={display:"block",width:i+l,"max-width":i+l,["box"===e?"margin-left":"left"]:o+l,"overflow-y"(){const e=a(this).css("overflow-y");return e&&"visible"!==e?e:"auto"},padding(){const e=a(this).css("padding");return e&&"0px"!==e?e:"1em"}};void 0!==c&&(u.height="box"===e?c.toCSSString():`${c}vh`),"float-box"===e&&fi(u,{position:"fixed",top:`${s}vh`,"background-color"(){return M(a(this)).backgroundColour||void 0}}),t.styles.push(u)},[String,"box"===e?yi(xa):String]);const{either:Ei,rest:Oi,optional:Di}=Et.TypeSignature;function Ii(e,t){if(t instanceof rr&&!t.canEnchant)return new qe("datatype",`The changer given to (${e}:) can't include a revision, enchantment, or interaction changer like (replace:), (click:), or (link:).`)}["enchant","change"].forEach(e=>{Et.addCommand(e,(t,n)=>{const r=Ii(e,n);if(r)return r},(t,n,r)=>{const a=fa.from(n),o=[];if(r instanceof rr){const e=new tr({section:t});if(r.run(e),(e.innerEnchantments||[]).length>0){const t=e.innerEnchantments.map(e=>e(a));o.push(...t)}}o.push(new ja({scope:a,[r instanceof rr?"changer":"lambda"]:r,section:t})),o.forEach(n=>{"enchant"===e?(t.addEnchantment(n),t.updateEnchantments()):n.enchantScope()})},[Ei(fa,String),Ei(rr,va.TypeSignature("via"))],{attachable:!1})}),Et.addChanger("enchant-in",(e,t,n)=>{const r=Ii("enchant-in",n);return r||new rr("enchant-in",[t,n])},(e,t,n)=>{(e.innerEnchantments||=[]).push(r=>new ja({scope:fa.from(t),localHook:r,[n instanceof rr?"changer":"lambda"]:n,section:e.section}))},[Ei(fa,String),Ei(rr,va.TypeSignature("via"))]),[["link-style",new fa({type:"name",data:"link"})],["line-style",new fa({type:"base",data:new fa({type:"name",data:"page"})},"lines",void 0)],["char-style",new fa({type:"base",data:new fa({type:"name",data:"page"})},"chars",void 0)]].forEach(([e,t])=>{Et.addChanger(e,(t,n)=>{const r=Ii(e,n);return r||new rr(e,[n])},(e,n)=>{(e.innerEnchantments||=[]).push(r=>new ja({scope:t,localHook:r,[n instanceof rr?"changer":"lambda"]:n,section:e.section}))},[Ei(rr,va.TypeSignature("via"))])});const Mi=["replace","append","prepend"];function Li(e,t){return V(()=>{const t=e.classList.replace(/ /g,"."),n=e.blockClassList?e.blockClassList.replace(/ /g,"."):"",r=`.${t}${n?`,.${n}`:""}`;h.on(e.event.map(e=>`${e}.enchantment`).join(" "),r,function(){const e=a(this);if(g.debug&&g.ignoreClickEvents&&!e.is("tw-backdrop.eval-replay *, tw-backdrop.harlowe-crash *"))return;if(e.is("tw-open-button"))return;const t=a(Array.from(e.parents(r).add(this)).sort((e,t)=>8&e.compareDocumentPosition(t)?1:-1)[0]),n=t.data("enchantmentEvent");n&&n(t)})}),[(e,n,r)=>{if(!n)return new qe("datatype",`A string given to this (${t}:) macro was empty.`);if(r){const e=Ii(t,r);if(e)return e}return new rr(t,[fa.from(n)].concat(r?[r]:[]))},(n,r,a)=>{n.enabled=!1,n.transitionDeferred=!0,e.rerender&&(n.newTargets=(n.newTargets||[]).concat({target:r,append:e.rerender}));const o=n.section?.stackTop?n.section.stackTop.tempVariables:Object.create(null),i=new ja({functions:[t=>{t.attr("class",t.children().is("tw-story, tw-sidebar, tw-passage")||["block","flex"].includes(t.children().css("display"))?e.blockClassList:e.classList),t.attr({tabIndex:"0"})}],data:{enchantmentEvent(){n.section.stackTop?.blocked||(e.once&&n.section.removeEnchantment(i),e.goto?Za.goToPassage(e.goto,{transition:e.transition}):e.undo?Za.goBack({transition:e.transition}):n.section.renderInto(n.source,void 0,{...n,append:e.once?"append":"replace",enabled:!0,transitionDeferred:!1},o))}},scope:r,section:n.section,name:t,[a instanceof rr?"changer":"lambda"]:a});n.section&&(n.section.addEnchantment(i),i.enchantScope())},[Ei(fa,String),Di(Ei(rr,va.TypeSignature("via")))]]}Mi.forEach(e=>{Et.addChanger(e,(t,...n)=>n.every(Boolean)?new rr(e,n.map(fa.from),void 0,!1):new qe("datatype",`A string given to this (${e}:) macro was empty.`),(t,...n)=>{t.target?.parents().filter("tw-collapsed,[collapsing=true]").length>0||t.attr.some(e=>e.collapsing)||(t.attr=[...t.attr,{collapsing:!1}]),t.newTargets||=[],t.newTargets.push(...n.filter(n=>!t.newTargets?.some(({target:t,append:r})=>dt(n,t)&&e===r)).map(t=>({target:t,append:e,before:!0})))},Oi(Ei(fa,String)))(`${e}-with`,(t,n)=>new rr(`${e}-with`,[n],void 0,!1),(t,n)=>{t.appendSource=(t.appendSource||[]).concat({source:n instanceof ar?n.code:n,append:e})},Ei(ar,String))});const Ri="ontouchstart"in window||navigator.maxTouchPoints>0,Pi=[{name:"click",enchantDesc:{event:["click"],once:!0,rerender:"",classList:"link enchantment-link",blockClassList:"enchantment-clickblock"}},{name:"mouseover",enchantDesc:{event:["mouseenter",Ri?"click":""].filter(Boolean),once:!0,rerender:"",classList:"link enchantment-mouseover",blockClassList:"enchantment-mouseoverblock"}},{name:"mouseout",enchantDesc:{event:["mouseleave",Ri?"click":""].filter(Boolean),once:!0,rerender:"",classList:"link enchantment-mouseout",blockClassList:"enchantment-mouseoutblock"}},{name:"doubleclick",enchantDesc:{event:["dblclick"],once:!0,rerender:"",classList:"link enchantment-dblclick",blockClassList:"enchantment-dblclickblock"}}];Pi.forEach(e=>{"doubleclick"!==e.name&&(Et.addChanger(e.name,...Li(e.enchantDesc,e.name)),"click"===e.name&&Et.addChanger(`${e.name}-rerun`,...Li({...e.enchantDesc,once:!1},`${e.name}-rerun`)))}),V(()=>{Pi.forEach(({enchantDesc:e})=>{e.blockClassList&&h.on(e.event.map(e=>`${e}.enchantment`).join(" "),function(){const t=a(this);if(g.debug&&g.ignoreClickEvents&&!t.is("tw-backdrop.eval-replay *, tw-backdrop.harlowe-crash *"))return;if(t.is("tw-open-button"))return;const n=a(Array.from(t.parents(`.${e.blockClassList.replace(/ /g,".")}`)).sort((e,t)=>8&e.compareDocumentPosition(t)?1:-1)[0]),r=n.data("enchantmentEvent");r&&r(n)})})}),Mi.forEach(e=>{Pi.forEach(t=>{const n={...t.enchantDesc,rerender:e},r=`${t.name}-${e}`;Et.addChanger(r,...Li(n,r))})}),Pi.forEach(e=>{"doubleclick"!==e.name&&["goto","undo"].forEach(t=>{const n=`${e.name}-${t}`;Et.addCommand(n,(e,r)=>!e||!r&&"goto"===t?new qe("datatype",`A string given to this (${n}:) macro was empty.`):"goto"!==t||Xe.hasValid(r)?void 0:new qe("macrocall",`I can't (${n}:) the passage '${r}' because it doesn't exist.`),(r,a,o,i)=>{if("undo"===t&&Ga.pastLength<1)return new qe("macrocall","I can't (undo:) on the first turn.");const[,s]=Li({...e.enchantDesc,transition:r.data.passageT8n,..."undo"===t?{undo:!0}:{goto:i}},n);s({section:a},fa.from(o)),r.source=""},[Ei(fa,String),..."undo"===t?[]:[String]])})});const{zeroOrMore:Vi,Any:Fi}=Et.TypeSignature,Hi=e=>({typeID:"metadata",typeName:`a (${e}:) macro`,objectName:`a (${e}:) macro`,unstorable:!0,print:()=>""});for(let[e,t]of[["storylet",va.TypeSignature("when")],["urgency",Number],["exclusivity",Number]])Et.add(e,"Metadata",(t,n)=>t.stackTop.speculativePassage?n:Hi(e),t);Et.add("metadata","Metadata",(e,...t)=>{let n;const r=new Map,a=t.reduce((e,t)=>{if(e instanceof qe)return e;if(void 0===n)n=t;else{let e=tt(r,n);if(e instanceof qe)return e;if(r.has(n))return new qe("macrocall",`You used the same data name (${it(n)}) twice in the same (metadata:) call.`);r.set(n,at(t)),n=void 0}return e},!0);return a instanceof qe?a:void 0!==n?new qe("macrocall","This (metadata:) macro has a data name without a value."):e.stackTop.speculativePassage?r:Hi("metadata")},Vi(Fi))("define","Metadata",(e,...t)=>{if(!e.stackTop.speculativePassage)return Hi("metadata");for(let n of t){if("into"===n.operator)return new qe("macrocall","Please say 'to' when using the (define:) macro.");if(!(n.dest instanceof ka))return new qe("macrocall","Please use the (define:) macro with just single variables to the left of 'to'.");if(n.dest.varRef.object!==Ga.variables)return new qe("macrocall","Please use the (define:) macro with story-wide variables (like $this), not temp variables.");if(1!==n.dest.varRef.propertyChain.length)return new qe("macrocall","You can't use the (define:) macro with data names of other variables.");let r=n.dest.datatype instanceof ia&&n.dest.datatype.name;if(!r||"any"!==r&&"const"!==r)return new qe("macrocall","Don't use -type syntax with (define:) - each definition is always considered to be const-type.");let[a]=n.dest.varRef.propertyChain;if(a in Ga.definitions.variableStore)return new qe("macrocall",`The variable '$${a}' has already been used in another (define:) call.`);n.dest.varRef.object=Ga.definitions,n.dest.datatype=new ia("definition");const o=n.set();if(o instanceof qe)return o;function i(e,t){if(t instanceof Ca)t.knownName=e;else if(Array.isArray(t))for(let n=0;n<t.length;n+=1)i(`${e}'s ${N(n+1)}`,t[n]);else if(t instanceof Map)for(let[n,r]of t.entries())i(`${e}'s (${ut(n)})`,r);else if(t instanceof Set){t=mt(t);for(let n=0;n<t.length;n+=1)i(`(a:...${e})'s ${N(n)}`,t[n])}}i(`$${a}`,n.src)}return Hi("metadata")},[Et.TypeSignature.rest(Gn)]);const{rest:qi,either:zi,optional:Wi,nonNegativeInteger:Bi}=Et.TypeSignature,Ui=qi(zi(String,ia,ka));Et.add(["p","pattern"],"Datatype",(e,...t)=>ca.create({name:"p",args:t}),Ui)(["p-either","pattern-either"],"Datatype",(e,...t)=>ca.create({name:"p-either",args:t,canContainTypedVars:!1,makeRegExpString:e=>`(?:${e.join("|")})`}),Ui)(["p-opt","pattern-opt","p-optional","pattern-optional"],"Datatype",(e,...t)=>ca.create({name:"p-opt",args:t,canContainTypedVars:!1,makeRegExpString:e=>`(?:${e.join("")})?`}),Ui)(["p-not","pattern-not"],"Datatype",(e,...t)=>t.find(e=>"string"==typeof e?1!==[...e].length:e instanceof ia&&!(e instanceof ca)?e.rest||["str","empty"].includes(e.name):e instanceof ca)?new qe("datatype","(p-not:) should only be given single characters, or datatypes that match single characters"):ca.create({name:"p-not",args:t,canContainTypedVars:!1,makeRegExpString:e=>`[^${e.map(e=>e.startsWith("[")&&e.endsWith("]")?e.slice(1,-1):e).join("")}]`}),Ui)(["p-not-before","pattern-not-before"],"Datatype",(e,...t)=>ca.create({name:"p-not-before",args:t,canContainTypedVars:!1,makeRegExpString:e=>`(?!${e.join("")})`}),Ui)(["p-before","pattern-before"],"Datatype",(e,...t)=>ca.create({name:"p-before",args:t,canContainTypedVars:!1,makeRegExpString:e=>`(?=${e.join("")})`}),Ui)(["p-start","pattern-start"],"Datatype",(e,...t)=>ca.create({name:"p-start",args:t,makeRegExpString:e=>`^(?:${e.join("")})`}),Ui)(["p-end","pattern-end"],"Datatype",(e,...t)=>ca.create({name:"p-end",args:t,makeRegExpString:e=>`(?:${e.join("")})$`}),Ui)(["p-many","pattern-many"],"Datatype",(e,...t)=>{const n=t.slice();let r,a;if("number"==typeof t[0]&&(r=t.shift(),a="number"==typeof t[0]?t.shift():1/0),void 0!==a&&a<r)return new qe("datatype","The (p-many:) macro needs to be given string patterns, not just min and max numbers.");if(!t.length)return new qe("datatype","The (p-many:) macro needs to be given string patterns, not just min and max numbers.");const o=t.find(e=>!("string"==typeof e||e instanceof ia||e instanceof ka));return o?new qe("datatype",`This (p-many:) macro can only be given a min and max number followed by datatypes or strings, but was also given ${it(o)}.`):ca.create({name:"p-many",args:t,fullArgs:n,canContainTypedVars:!!r&&r>0,makeRegExpString:e=>`(?:${e.join("")})${void 0!==r?`{${r}${a===1/0?",":a!==r?`,${a}`:""}}`:"+"}`})},[qi(zi(Bi,String,ia,ka))])(["p-ins","pattern-ins","p-insensitive","pattern-insensitive"],"Datatype",(e,...t)=>ca.create({name:"p-ins",args:t,insensitive:!0}),Ui)(["split","splitted"],"Array",(e,t,n)=>{let r=ca.create({name:"split",args:[t],canContainTypedVars:!1});if(r instanceof qe)return r;if(!n)return[""];if(!(r instanceof ca&&r.regExp))return[...n];const a=RegExp(r.regExp),o=[];let i;for(;n&&(i=a.exec(n));){if(i.index+i[0].length===0)return o;o.push(n.slice(0,i.index)),n=n.slice(i.index+i[0].length)}return o.concat(n||[])},[zi(String,ia),String])("trimmed","String",(e,t,n)=>{if(t instanceof ia&&void 0===n)return new qe("datatype",`Only a trimming pattern, ${t.toSource()}, was given to (trimmed:)`);if(void 0===n||t instanceof ia&&"whitespace"===t.name)return(n||t).trim();let r=ca.create({name:"trimmed",args:[t],canContainTypedVars:!1});return r instanceof qe?r:r.regExp?n.replace(RegExp(`^(${r.regExp})*|(${r.regExp})*$`,"g"),""):n},[zi(String,ia),Wi(String)])(["str-find","string-find"],"String",(e,t,n)=>{let r=ca.create({name:"str-find",args:[t],canContainTypedGlobals:!1});if(r instanceof qe)return r;const a=r.typedVars();if(a instanceof qe)return a;const o=RegExp(r.regExp,"g");let i,s=[],{lastIndex:c}=o;for(;(i=o.exec(n))&&c!==o.lastIndex;)if(c=o.lastIndex,a.length){const e=new Map;for(let t=0;t<a.length;t+=1){if("match"===a[t].varRef.getName())return new qe("macrocall","There was a typed temp variable named _match in the pattern given to (str-find:)","The variable _match is reserved, and can't be used inside (str-find:)'s pattern.");e.set(a[t].varRef.getName(),i[t+1]),e.set("match",i[0])}s.push(e)}else s.push(i[0]);return s},[ia,String])(["str-replaced","string-replaced","replaced"],"String",(e,t,n,r,a)=>{if("number"!=typeof t){if(void 0!==a)return new qe("macrocall","1 too many values were given to (str-replaced:).","If this is given 5 values, the first value must be a number of replacements.");a=r,r=n,n=t,t=1/0}else if(void 0===a)return new qe("macrocall","The (str-replaced:) macro needs 1 more value.","The final string seems to be missing.");if(r instanceof ia)return new qe("datatype",`The replacement value for (str-replaced:) must be a string or lambda, not ${it(r)}`);if(a instanceof va||n instanceof va)return new qe("datatype",`The ${a instanceof va?"search pattern":"final string"} given to (str-replaced:) can't be a lambda.`,"Only the replacement value (after the search pattern) can be a 'via' lambda.");let o=ca.create({name:"str-replaced",args:[n],canContainTypedGlobals:!1});if(o instanceof qe)return o;if(!(o instanceof ca&&o.regExp))return a;const i=RegExp(o.regExp,"g"),s=r instanceof va?o.typedVars():[];let c,l=1,u=0,d="",{lastIndex:p}=i;for(;a&&(c=i.exec(a))&&t>0&&p!==i.lastIndex;){p=i.lastIndex;const n=Object.create(e.stack.length?e.stackTop.tempVariables:Oa);for(let e=0;e<s.length;e+=1){const t=s[e],r=Un.create(n,t.varRef.propertyChain);if(r instanceof qe)return r;const a=r.defineType(t.datatype);if(a instanceof qe)return a;r.set(c[e+1])}const o=r instanceof va?r.apply(e,{loop:c[0],pos:l,tempVariables:n}):r;if(o instanceof qe)return o;if("string"!=typeof o)return new qe("datatype",`(str-replaced:)'s lambda must produce a string, but it produced ${it(o)} when given "${c[0]}".`);d+=a.slice(u,c.index)+o,l+=1,t-=1,u=c.index+c[0].length}return d+=a.slice(u),d},[zi(Bi,String,ia),zi(ia,String,va.TypeSignature("via")),zi(String,va.TypeSignature("via")),Wi(String)]);const{optional:_i,rest:Gi,either:Xi}=Et.TypeSignature,Yi=["Links can't have empty strings for their displayed text.","In the link syntax, a link's displayed text is inside the [[ and ]], and on the non-pointy side of the -> or <- arrow if it's there."],{assign:Ji}=Object;function Ki(e,t,n=t){const r=Xe.hasValid(t)&&t===n;let a,o=e.evaluateTwineMarkup(unescape(n),"a link's passage name");if(r){let e=o.children().length>0?"`".repeat((n.match(/`+/)||[]).reduce((e,t)=>Math.max(e,t.length+1),1)):"";t=e+"\0".repeat(+!!e)+t+"\0".repeat(+!!e)+e}else o.findAndFilter("tw-error").length&&(a=o.findAndFilter("tw-error").data("TwineError")),n=o.text();return{text:t,passage:n,error:a}}V(()=>{const e="ontouchstart"in window||navigator.maxTouchPoints>0;function t(e){const t=a(this),n=t.closest("tw-expression"),r=t.closest("tw-expression, tw-hook"),o=r.data("clickEvent"),i=r.data("section");if(g.debug&&g.ignoreClickEvents&&!t.is("tw-backdrop.eval-replay *, tw-backdrop.harlowe-crash *"))return;if(t.is("tw-open-button"))return;if(i?.stackTop?.blocked&&(!(i.stackTop.blocked instanceof a)||!i.stackTop.blocked.find(t).length))return;if(o){if(t.find("tw-error").length>0)return;return e.stopPropagation(),void o(t)}const s=n.data("linkPassageName");let c={...n.data("passageT8n")||{}};return n.find("tw-enchantment").each((e,t)=>{Object.assign(c,a(t).data("passageT8n")||{})}),s?(e.stopPropagation(),void Za.goToPassage(s,{transition:c})):t.is("[undo]")?(e.stopPropagation(),void Za.goBack({transition:c})):t.is("[fullscreen]")?(e.stopPropagation(),void Za.toggleFullscreen()):void 0}h.on("click.passage-link","tw-link"+(e?"":":not(.enchantment-mouseover):not(.enchantment-mouseout):not(.enchantment-dblclick)"),t).on("mouseover.passage-link","tw-link.enchantment-mouseover, tw-expression.enchantment-mouseover > tw-link",t).on("mouseout.passage-link","tw-link.enchantment-mouseout, tw-expression.enchantment-mouseout > tw-link",t).on("dblclick.passage-link","tw-link.enchantment-dblclick, tw-expression.enchantment-dblclick > tw-link",t),a(document).on("fullscreenchange",()=>{a("tw-link[fullscreen]",h).each((e,t)=>{(a(t).closest("tw-expression, tw-hook").data("fullscreenEvent")||Object)(t)})})}),[["link","link-replace"],["link-reveal","link-append"],["link-repeat"],["link-rerun"]].forEach(e=>Et.addChanger(e,(t,n,r)=>n?r&&!r.canEnchant?new qe("datatype",`The changer given to (${e[0]}:) can't be (or include) a revision, enchantment, or interaction changer like (replace:), (click:), or (link:).`):new rr(e[0],[n].concat(r||[]),void 0,!0):new qe("datatype",Yi[0]),(t,n,r)=>{const a=e[0],o=t.section?.stackTop?t.section.stackTop.tempVariables:Object.create(null),i=new tr({source:`<tw-link tabindex=0>${n}</tw-link>`,target:t.target instanceof Function?t.target:()=>t.target,append:"replace",data:{section:t.section,clickEvent:e=>{t.enablers=t.enablers.filter(e=>e.descriptor!==i),"link-reveal"===a&&e.contents().unwrap();let n=e.parentsUntil(":not(tw-enchantment)").parent();if(n.length||(n=e.parent()),"link-rerun"===a){const t=e.parentsUntil(":not(tw-enchantment)");e.detach(),t.remove()}"link"!==a&&"link-rerun"!==a||n.empty(),t.section.renderInto("",void 0,t,o),"link-rerun"===a&&n.prepend(e)}}});t.enablers=(t.enablers||[]).concat({descriptor:i,changer:r})},[String,_i(rr)])),Et.addCommand("link-goto",e=>{if(!e)return new qe("datatype",...Yi)},(e,t,n,r)=>{let a,o;if(({text:n,passage:r,error:a}=Ki(t,n,r)),a)return a;if(e.transition){const e="transition";return new qe("datatype",`Please attach (${e}-depart:) or (${e}-arrive:) to a passage link, not (${e}:).`)}return Xe.hasValid(r)||(o=`<tw-broken-link passage-name="${escape(r)}">${n}</tw-broken-link>`),o||=`<tw-link tabindex=0 ${Ga.passageNameVisited(r)>0?'class="visited" ':""}>${n}</tw-link>`,e.data.linkPassageName=r,e.data.section=t,Ji(e,{source:o,transitionDeferred:!0})},[String,_i(String)])("link-storylet",(...e)=>{const t=e[1===e.length||"string"!=typeof e[0]?0:1];if(!t||"string"==typeof t)return new qe("datatype","(link-storylet:) should be given one index number or one 'where' lambda, after the optional link text string.")},(e,t,...n)=>{const r=n["string"==typeof n[0]?1:0];let a="string"==typeof n[0]&&n[0];const o=n[n.length-1]!==r&&n[n.length-1];if(e.transition){const e="transition";return new qe("datatype",`Please attach (${e}-depart:) or (${e}-arrive:) to (link-storylet:), not (${e}:).`)}const i=r instanceof va,s=Xe.getStorylets(t,i?r:void 0);if(s instanceof qe)return s;let c,l=s[i?0:r<0?s.length+r:r-1];if(l){let n=l.get("name");a||=n,c||=`<tw-link tabindex=0 ${Ga.passageNameVisited(n)>0?'class="visited" ':""}>${a}</tw-link>`,e.data.linkPassageName=n,e.data.section=t}else{if(!o)return e;c=o}return Ji(e,{source:c,transitionDeferred:!0})},[Xi(parseInt,String,va.TypeSignature("where")),_i(Xi(parseInt,String,va.TypeSignature("where"))),_i(String)])("link-undo",e=>{if(!e)return new qe("datatype",Yi[0])},(e,t,n,r="")=>{if(Ga.pastLength<1)return Ji(e,{source:r});e.data.section=t;const{tempVariables:a}=t.stackTop;return e.data.forgetUndosEvent=()=>e.data.section.whenUnblocked(()=>{const t={...e,append:"replace",source:r,transitionDeferred:!1};e.section.renderInto("",void 0,t,a)}),Ji(e,{source:`<tw-link tabindex=0 undo>${n}</tw-link>`,transitionDeferred:!0})},[String,_i(String)])("link-show",e=>{if(!e)return new qe("datatype",Yi[0])},(e,t,n,...r)=>(e.data.section=t,e.data.clickEvent=n=>{n.contents().unwrap(),r.forEach(n=>n.forEach(t,n=>{const r=n.data("originalSource")||"",a=n.data("hidden");if(a)if(n.removeData("hidden"),"object"==typeof a&&"jquery"in a)n.empty().append(a);else{const a=n.data("tempVariables");t.renderInto("",void 0,{...e,source:r,target:n,transitionDeferred:!1},a&&Object.create(a))}}))},Ji(e,{source:`<tw-link tabindex=0>${n}</tw-link>`,transitionDeferred:!0})),[String,Gi(fa)])("link-fullscreen",(e,t)=>{if(!e||!t)return new qe("datatype",Yi[0])},(e,t,n,r)=>{const a=()=>document.fullscreenEnabled?`<tw-link tabindex=0 fullscreen>${document.fullscreenElement?r:n}</tw-link>`:r?`<tw-broken-link>${r}</tw-broken-link>`:"",{tempVariables:o}=t.stackTop;return e.data.section=t,e.data.fullscreenEvent=()=>{document.fullscreenEnabled&&e.data.section.whenUnblocked(()=>{const t={...e,append:"replace",source:a(),transitionDeferred:!1};e.section.renderInto("",void 0,t,o)})},Ji(e,{source:a(),transitionDeferred:!0})},[String,String,_i(String)]),Et.addChanger(["link-reveal-goto"],(e,t,n,r)=>{if(!t)return new qe("datatype",...Yi);if(n instanceof rr){if(r instanceof rr)return new qe("datatype","You mustn't give two changers to (link-reveal-goto:)");r=n,n=void 0}if(r&&!r.canEnchant)return new qe("datatype","The changer given to (link-reveal-goto:) can't include a revision, enchantment, or interaction changer like (replace:), (click:), or (link:).");let a;return({text:t,passage:n,error:a}=Ki(e,t,n)),a||new rr("link-reveal-goto",[t,n,r].filter(e=>void 0!==e),void 0,!1)},(e,t,n,r)=>{if(!Xe.hasValid(n))return void(e.source=`<tw-broken-link passage-name="${escape(n)}">${t}</tw-broken-link>`);const a=Ga.passageNameVisited(n),o=e.section?.stackTop?e.section.stackTop.tempVariables:Object.create(null),i=new tr({source:`<tw-link tabindex=0 ${a>0?'class="visited" ':""}>${t}</tw-link>`,target:e.target,append:"replace",data:{section:e.section,clickEvent:t=>{e.enablers=e.enablers.filter(e=>e.descriptor!==i),t.contents().unwrap(),e.section.renderInto("",void 0,e,o),e.section.whenUnblocked(()=>Za.goToPassage(n,{transition:e.data.passageT8n}))}}});e.enablers=(e.enablers||[]).concat({descriptor:i,changer:r})},[String,_i(Xi(rr,String)),_i(rr)]);const{add:Qi,addChanger:Zi,addCommand:es,TypeSignature:{rest:ts,either:ns,Any:rs,Everything:as,zeroOrMore:os}}=Et;Qi("macro","CustomMacro",(e,...t)=>{let n;const r=[];for(n=0;n<t.length;n+=1){const e=n===t.length-1,a=t[n];if(a instanceof ka===e)return new qe("datatype",`The ${e?"":`${N(t.length-n+1)}-`}last value given to (macro:) should be a ${e?"code hook":"datatyped variable"}, not ${it(t[n])}`);if(!e){const e="A custom macro";if(a.varRef.object===Ga.variables)return new qe("datatype",`${e}'s typed variables must be temp variables (with a '_'), not global variables (with a '$').`,"Write them with a _ symbol at the start instead of a $ symbol.");if(a.varRef.propertyChain.length>1)return new qe("datatype",`${e}'s typed variables can't be properties inside a data structure.`);if(a.datatype instanceof ia&&a.datatype.rest&&n!==t.length-2)return new qe("datatype",`${e} can only have one spread variable, and it must be its last variable.`);const o=a.getName();if(r.includes(o))return new qe("datatype",`${e}'s typed variables can't both be named '${o}'.`);r.push(o)}}return new ta(t.slice(0,-1),t[t.length-1])},[ts(ns(ka,ar))]);const is=(e,t,n)=>{if(!t.some(e=>{if("function"==typeof e.output)return e.output(n),!0}))return new qe("macrocall",`(${e}:) should only be used inside a code hook passed to (macro:).`)};es(["output-data","out-data"],a.noop,({stack:e},t)=>is("output-data",e,t)||{blocked:!0},[rs],{attachable:!1}),Zi(["output","out"],()=>Object.assign(new rr("output",[])),(e,t)=>{if(!e.section)return;const{section:{stack:n,stackTop:r}}=e,a=r.tempVariables,o=Array.isArray(e.source)?`[${e.source.map(e=>e.text).join("")}]`:e.source;is("output",n,{changer:t,hook:o,variables:a}),e.output=!0,r.blocked=!0},[]),es("error",e=>{if(!e)return new qe("datatype","This (error:) macro was given an empty string.")},({stack:e},t)=>is("error",e,new qe("user",t))||{blocked:!0},[String],{attachable:!1}),Qi("partial","CustomMacro",(e,t,...n)=>{const r="string"!=typeof t?t:void 0,a="string"==typeof t&&t;if(!r){if("string"!=typeof a||!Et.has(a))return new qe("macrocall",`The macro name given to (partial:), "${t}", isn't the name of a built-in macro.`);if("Metadata"===Et.get(a).returnType)return new qe("macrocall",`(partial:) can't be used with metadata macros such as (${t}:)`)}const o=`(partial:${ut(t)},${n.map(e=>ut(e))})`,i=ta.createFromFn((e,...r)=>{const a="string"==typeof t?Et.run(t,e,n.concat(r)):Et.runCustom(t,e,n.concat(r));return a instanceof qe&&(a.message=`An error occurred while running the (partial:)-created macro, ${i.objectName}:\n${a.message}`),a},"a (partial:) custom macro of "+(r&&!r.knownName?"another unnamed custom macro":`(${a||r.knownName}:${n.map(e=>ut(e))})`),()=>o,(a?Et.get(a).typeSignature:r.typeSignature).filter((e,t)=>t>=n.length||"pattern"in e&&("rest"===e.pattern||"zero or more"===e.pattern)));return i},[ns(String,ta),os(as)]),a.prototype.extend({popAttr(e){const t=this.attr(e);return this.removeAttr(e),t},popData(e){const t=this.data(e);return this.removeData(e),t},tag(){return this[0]?.tagName?.toLowerCase()},textNodes(e="*"){return 1===this.length&&this[0]&&this[0].nodeType===Node.TEXT_NODE?[this[0]]:this.get().concat(this.contents().get(),this.find(e).contents().get()).filter((e,t,n)=>e?.nodeType===Node.TEXT_NODE&&n.indexOf(e)===t).sort((e,t)=>2&e.compareDocumentPosition(t)?1:-1)},findAndFilter(e){const t=this.find(e),n=this.filter(e);return n.length?t.add(n):t}}),V(()=>setTimeout(()=>{g.debug&&Object.assign(globalThis,{REPL(e){let t=new jn,n=t.eval(Ve.lex(`(print:${e})`));return"object"==typeof n&&"runCommand"in n&&"function"==typeof n.runCommand?n.runCommand(t).source:n},LEX(e){let t=Ve.lex(e);return 1===t.children?.length?t.children[0]:t}})}));const{dialog:ss}=vn;function cs(e){let t=`${e.name}: ${e.message}`;if(e.stack){const n=e.stack.split("\n"),r=n.findIndex(e=>e.includes("__HarloweEval"));t+=`\n${n.slice(0,r).join("\n").replace(/\([^)]+\)/g,"")}`}return`<div style='font-family:monospace;overflow-y:scroll;max-height:30vh'>\`\`\`${t}\`\`\`</div>`}var ls;window.$=a,ls=window.onerror,window.onerror=function(...e){window.onerror=ls,h.parent().append(ss({message:`Sorry to interrupt, but this page's code has got itself in a mess.\n\n${e[4]?cs(e[4]):""}\n(This is probably due to a bug in the Harlowe game engine.)`}).addClass("harlowe-crash")),"function"==typeof ls&&ls(...e)},V(()=>{const e=a("tw-storydata");if(0===e.length)return;g.ifid=e.attr("ifid"),(e.attr("tags")||"").split(/\s/).forEach(e=>{"uncompressed-pure-values"!==e&&"uncompressed-saves"!==e||(g.uncompressedPureValues=!0),"uncompressed-structures"!==e&&"uncompressed-saves"!==e||(g.uncompressedStructures=!0)}),(e.attr("options")||"").split(/\s/).forEach(e=>{e&&(g[e]=!0),"debug"===e&&yo()});let t=e.attr("startnode");void 0===t&&(t=a("tw-passagedata").get().reduce((e,t)=>{const n=t.getAttribute("pid")||"";return!Number.isNaN(n)&&+n<e?+n:e},1/0));let n=a(`tw-passagedata[pid='${t}']`).attr("name");a(document.documentElement).on("keydown",e=>{13===e.which&&"0"===e.target.getAttribute("tabindex")&&a(e.target).trigger("click")});let r=!1;a("[role=script]").each(function(e){try{t=a(this).html(),Function("script","DebugMode","Renderer","State","Section","Engine","Passages","Utils","RenderUtils","ImageAsset","arguments=void 0;eval([script,script=void 0][0]);")(t,yo,dn,Ga,jn,Za,Xe,{options:g,onStartup:V,storyElement:h,nth:N},vn,Ca)}catch(t){r||(r=!0,ss({parent:h.parent(),message:`There is a problem with this story's ${N(e+1)} script:\n\n${cs(t)}`}))}var t}),a("[role=stylesheet]").each((e,t)=>{a(document.head).append(`<style data-title="Story stylesheet '${e+1}'">${a(t).html()}`)});const o=new jn;o.stack=[new xn({tempVariables:new Oa("")})];const i=Xe.loadMetadata(o);if(i.length){const e=ss({parent:h.parent(),message:"These errors occurred when running the `(metadata:)` macro calls in this story's passages:<p></p>"});i.forEach(t=>e.find("p").append(t.render()))}Ca.loadAssets();const s=!g.debug&&Ga.hasSessionStorage&&sessionStorage.getItem("Saved Session");s&&!0===Ga.deserialise(o,s)?Za.showPassage(Ga.passage):Za.goToPassage(n)})}();//# sourceMappingURL=harlowe-min.js.map
